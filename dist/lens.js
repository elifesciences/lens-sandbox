!function t(e,n,r){function i(s,a){if(!n[s]){if(!e[s]){var c="function"==typeof require&&require;if(!a&&c)return c(s,!0);if(o)return o(s,!0);throw new Error("Cannot find module '"+s+"'")}var p=n[s]={exports:{}};e[s][0].call(p.exports,function(t){var n=e[s][1][t];return i(n?n:t)},p,p.exports,t,e,n,r)}return n[s].exports}for(var o="function"==typeof require&&require,s=0;s<r.length;s++)i(r[s]);return i}({1:[function(t){window.Lens=t("./src/lens")},{"./src/lens":226}],2:[function(t,e){e.exports={env:"development",library_url:"/data/lens_library.json"}},{}],3:[function(t,e){e.exports=[{route:":collection/:document/:context/:node/:resource/:fullscreen",name:"document-resource",command:"openReader"},{route:":collection/:document/:context/:node/:resource",name:"document-resource",command:"openReader"},{route:":collection/:document/:context/:node/:resource",name:"document-resource",command:"openReader"},{route:":collection/:document/:context/:node",name:"document-node",command:"openReader"},{route:":collection/:document/:context",name:"document-context",command:"openReader"},{route:":collection/:document",name:"document",command:"openReader"},{route:":collection",name:"library",command:"openLibrary"},{route:"",name:"library",command:"openAbout"},{route:"tests",name:"tests",command:"openTestCenter"},{route:"tests/:suite",name:"tests",command:"openTestCenter"}]},{}],4:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util"),i=t("substance-document"),o=function(t){t=t||{},t.schema=r.deepclone(i.schema),t.schema.id="lens-article",t.schema.version="0.1.0",n.each(o.types,function(e,n){t.schema.types[n]=e}),n.each(o.annotations,function(e,n){t.schema.types[n]=e}),n.each(o.nodeTypes,function(e,n){t.schema.types[n]=e.Model.type}),n.each(o.indexes,function(e,n){t.schema.indexes[n]=e}),i.call(this,t),this.bySourceId=this.addIndex("by_source_id",{types:["content"],property:"source_id"}),this.nodeTypes=o.nodeTypes,void 0===t.seed&&(this.create({id:"document",type:"document",guid:t.id,creator:t.creator,created_at:t.created_at,views:["content"],title:"","abstract":""}),n.each(o.views,function(t){this.create({id:t,type:"view",nodes:[]})},this))};o.Renderer=function(t,e){this.docCtrl=t,this.nodeTypes=o.nodeTypes,this.options=e||{},this.nodes={},n.each(this.docCtrl.getNodes(),function(t){this.nodes[t.id]=this.createView(t)},this)},o.Renderer.Prototype=function(){this.createView=function(t){var e=this.nodeTypes[t.type].View;if(!e)throw new Error('Node type "'+t.type+'" not supported');var n=new e(t,this);return n.listenTo(this.docCtrl,"operation:applied",n.onGraphUpdate),n},this.render=function(){n.each(this.nodes,function(t){t.dispose()});var t=document.createDocumentFragment(),e=this.docCtrl.container.getTopLevelNodes();return n.each(e,function(e){var n=this.createView(e);t.appendChild(n.render().el),this.options.afterRender&&this.options.afterRender(this.docCtrl,n)},this),t}},o.Renderer.prototype=new o.Renderer.Prototype,o.Prototype=function(){this.fromSnapshot=function(t,e){return o.fromSnapshot(t,e)},this.getNodeBySourceId=function(t){var e=this.bySourceId.get(t),n=Object.keys(e)[0],r=e[n];return r}},o.fromSnapshot=function(t,e){return e=e||{},e.seed=t,new o(e)},o.views=["content","figures","citations","info"],o.nodeTypes=t("./nodes"),o.annotations={strong:{parent:"annotation",properties:{}},emphasis:{properties:{},parent:"annotation"},subscript:{properties:{},parent:"annotation"},superscript:{properties:{},parent:"annotation"},underline:{properties:{},parent:"annotation"},code:{parent:"annotation",properties:{}},link:{parent:"annotation",properties:{url:"string"}},idea:{parent:"annotation",properties:{}},error:{parent:"annotation",properties:{}},question:{parent:"annotation",properties:{}},person_reference:{parent:"annotation",properties:{target:"person"}},figure_reference:{parent:"annotation",properties:{target:"figure"}},citation_reference:{parent:"annotation",properties:{target:"content"}},cross_reference:{parent:"annotation",properties:{target:"content"}},formula_reference:{parent:"annotation",properties:{target:"content"}}},o.types={annotation:{properties:{path:["array","string"],range:"object"}},figure:{properties:{}},institution:{properties:{}},email:{properties:{}},funding:{properties:{}},caption:{properties:{}},citation:{properties:{}},document:{properties:{views:["array","view"],guid:"string",creator:"string",title:"string",authors:["array","person"],"abstract":"string"}},comment:{properties:{content:"string",created_at:"string",creator:"string",node:"node"}}};var s={id:"lens_article",nodes:{document:{type:"document",id:"document",views:["content"],title:"The Anatomy of a Lens Article",authors:["person_1","person_2","person_3"],guid:"lens_article"},content:{type:"view",id:"content",nodes:["cover"]},cover:{id:"cover",type:"cover"},person_1:{id:"person_1",type:"person",name:"Michael Aufreiter"},person_2:{id:"person_2",type:"person",name:"Ivan Grubisic"},person_3:{id:"person_3",type:"person",name:"Rebecca Close"}}};o.describe=function(){var t=new o({seed:s}),e=0;return n.each(o.nodeTypes,function(r){r=r.Model,console.log("NAME",r.description.name,r.type.id);var i="heading_"+r.type.id;t.create({id:i,type:"heading",content:r.description.name,level:1});var o=r.description.remarks.join(" "),s="text_"+r.type.id+"_intro";t.create({id:s,type:"text",content:o}),t.show("content",[i,s],-1),t.create({id:i+"_properties",type:"text",content:r.description.name+" uses the following properties:"}),t.show("content",[i+"_properties"],-1);var a=[];n.each(r.description.properties,function(n,r){var i="text_"+ ++e;t.create({id:i,type:"text",content:r+": "+n}),t.create({id:e+"_annotation",type:"code",path:[i,"content"],range:[0,r.length]}),a.push(i)}),t.create({id:i+"_property_list",type:"list",items:a,ordered:!1}),t.show("content",[i+"_property_list"],-1),t.create({id:i+"_example",type:"text",content:"Here's an example:"}),t.create({id:i+"_example_codeblock",type:"codeblock",content:JSON.stringify(r.example,null,"  ")}),t.show("content",[i+"_example",i+"_example_codeblock"],-1)}),t},o.Prototype.prototype=i.prototype,o.prototype=new o.Prototype,o.prototype.constructor=o,Object.defineProperties(o.prototype,{id:{get:function(){return this.get("document").guid},set:function(t){this.get("document").guid=t}},creator:{get:function(){return this.get("document").creator},set:function(t){this.get("document").creator=t}},created_at:{get:function(){return this.get("document").created_at},set:function(t){this.get("document").created_at=t}},title:{get:function(){return this.get("document").title},set:function(t){this.get("document").title=t}},"abstract":{get:function(){return this.get("document").abstract},set:function(t){this.get("document").abstract=t}},authors:{get:function(){var t=this.get("document");return t.authors?n.map(t.authors,function(t){return this.get(t)},this):""},set:function(t){var e=this.get("document");e.authors=n.clone(t)}},views:{get:function(){return this.get("document").views.slice(0)}}}),e.exports=o},{"./nodes":30,"substance-document":133,"substance-util":219,underscore:225}],5:[function(t,e){"use strict";var n=t("./article");e.exports=n},{"./article":4}],6:[function(t,e){"use strict";var n=t("substance-document").Node,r=t("underscore"),i=function(t,e){n.call(this,t,e)};i.type={id:"affiliation",parent:"content",properties:{source_id:"string",city:"string",country:"string",department:"string",institution:"string",label:"string"}},i.description={name:"Affiliation",description:"Person affiliation",remarks:["Name of a institution or organization, such as a university or corporation, that is the affiliation for a contributor such as an author or an editor."],properties:{coming:"soon"}},i.example={id:"affiliation_1",source_id:"aff1",city:"Jena",country:"Germany",department:"Department of Molecular Ecology",institution:"Max Planck Institute for Chemical Ecology",label:"1",type:"affiliation"},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i;var o={};r.each(i.type.properties,function(t,e){o[e]={get:function(){return this.properties[e]}}}),Object.defineProperties(i.prototype,o),e.exports=i},{"substance-document":133,underscore:225}],7:[function(t,e){"use strict";e.exports={Model:t("./affiliation")}},{"./affiliation":6}],8:[function(t,e){"use strict";var n=t("substance-document"),r=function(t,e){n.Composite.call(this,t,e)};r.type={id:"caption",parent:"content",properties:{source_id:"string",title:"paragraph",children:["array","paragraph"]}},r.description={name:"Caption",remarks:["Container element for the textual description that is associated with a Figure, Table, Video node etc.","This is the title for the figure or the description of the figure that prints or displays with the figure."],properties:{title:"Caption title (optional)",children:"0..n Paragraph nodes"}},r.example={no_example:"yet"},r.Prototype=function(){this.hasTitle=function(){return!!this.properties.title},this.getNodes=function(){var t=[];return this.properties.children&&(t=t.concat(this.properties.children)),t},this.getTitle=function(){return this.properties.title?this.document.get(this.properties.title):void 0}},r.Prototype.prototype=n.Composite.prototype,r.prototype=new r.Prototype,r.prototype.constructor=r,n.Node.defineProperties(r.prototype,["title","children"]),e.exports=r},{"substance-document":133}],9:[function(t,e){"use strict";var n=t("../composite").View;t("substance-document").List;var r=t("substance-application").$$,i=function(t,e){n.call(this,t,e)};i.Prototype=function(){this.render=function(){this.content=r("div.content");var t;for(t=0;t<this.childrenViews.length;t++)this.childrenViews[t].dispose();var e=this.node.getTitle();if(e){var n=this.viewFactory.createView(e),i=n.render().el;i.classList.add("caption-title"),this.content.appendChild(i)}var o=this.node.getNodes();for(t=0;t<o.length;t++){var s=this.node.document.get(o[t]),a=this.viewFactory.createView(s),c=a.render().el;this.content.appendChild(c),this.childrenViews.push(a)}return this.el.appendChild(this.content),this},this.onNodeUpdate=function(t){t.path[0]===this.node.id&&"items"===t.path[1]&&this.render()}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"../composite":16,"substance-application":63,"substance-document":133}],10:[function(t,e){"use strict";e.exports={Model:t("./caption"),View:t("./caption_view")}},{"./caption":8,"./caption_view":9}],11:[function(t,e){var n=t("underscore"),r=t("substance-document").Node,i=function(t){r.call(this,t)};i.type={id:"article_citation",parent:"content",properties:{source_id:"string",title:"string",label:"string",authors:["array","string"],doi:"string",source:"string",volume:"string",fpage:"string",lpage:"string",year:"string",citation_urls:["array","string"]}},i.description={name:"Citation",remarks:["A journal citation.","This element can be used to describe all kinds of citations."],properties:{title:"The article's title",label:"Optional label (could be a number for instance)",doi:"DOI reference",source:"Usually the journal name",volume:"Issue number",fpage:"First page",lpage:"Last page",year:"The year of publication",citation_urls:"A list of links for accessing the article on the web"}},i.example={id:"article_nature08160",type:"article_citation",label:"5",title:"The genome of the blood fluke Schistosoma mansoni",authors:["M Berriman","BJ Haas","PT LoVerde"],doi:"http://dx.doi.org/10.1038/nature08160",source:"Nature",volume:"460",fpage:"352",lpage:"8",year:"1984",citation_urls:["http://www.ncbi.nlm.nih.gov/pubmed/19606141"]},i.Prototype=function(){this.urls=function(){return this.properties.citation_urls.length>0?this.properties.citation_urls:[this.properties.doi]}},i.Prototype.prototype=r.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i;var o={header:{get:function(){return this.properties.title}}};n.each(i.type.properties,function(t,e){o[e]={get:function(){return this.properties[e]}}}),Object.defineProperties(i.prototype,o),e.exports=i},{"substance-document":133,underscore:225}],12:[function(t,e){"use strict";t("underscore");var n=t("substance-util");n.html;var r=t("../node").View,i=t("substance-application").$$,o=function(t){var e=document.createDocumentFragment(),n=t.node;return e.appendChild(i(".authors",{html:n.authors.join(", ")})),e.appendChild(i(".source",{html:[[n.source,n.volume].join(", ")+": ",[n.fpage,n.lpage].join("-")+", ",n.year].join("")})),n.doi&&e.appendChild(i(".doi",{children:[i("b",{text:"DOI: "}),i("a",{href:n.doi,target:"_new",text:n.doi})]})),e},s=function(t){r.call(this,t),this.$el.attr({id:t.id}),this.$el.addClass("citation")};s.Prototype=function(){this.render=function(){return r.prototype.render.call(this),this.content.appendChild(new o(this)),this}},s.Prototype.prototype=r.prototype,s.prototype=new s.Prototype,s.prototype.constructor=s,e.exports=s},{"../node":32,"substance-application":63,"substance-util":219,underscore:225}],13:[function(t,e){"use strict";e.exports={Model:t("./citation"),View:t("./citation_view")}},{"./citation":11,"./citation_view":12}],14:[function(t,e){"use strict";var n=t("../text").View,r=function(t){n.call(this,t),this.$el.addClass("content-node codeblock")};r.Prototype=function(){},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"../text":46}],15:[function(t,e){"use strict";var n=t("substance-nodes");e.exports={Model:n.codeblock.Model,View:t("./codeblock_view")}},{"./codeblock_view":14,"substance-nodes":156}],16:[function(t,e){"use strict";var n=t("substance-nodes");e.exports=n.composite},{"substance-nodes":156}],17:[function(t,e){var n=t("underscore"),r=t("substance-document").Node,i=function(t,e){r.call(this,t,e)};i.type={id:"cover",parent:"content",properties:{source_id:"string",authors:["array","paragraph"]}},i.description={name:"Cover",remarks:["Virtual view on the title and authors of the paper."],properties:{authors:"A paragraph that has the authors names plus references to the person cards"}},i.example={id:"cover",type:"cover"},i.Prototype=function(){this.getAuthors=function(){return n.map(this.properties.authors,function(t){return this.document.get(t)},this)}},i.Prototype.prototype=r.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,Object.defineProperties(i.prototype,{title:{get:function(){return this.document.title}},authors:{get:function(){return this.document.authors}}}),e.exports=i},{"substance-document":133,underscore:225}],18:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util");r.html;var i=t("../node").View,o=t("substance-application").$$,s=function(t,e){i.call(this,t,e),this.$el.attr({id:t.id}),this.$el.addClass("content-node cover")};s.Prototype=function(){this.render=function(){i.prototype.render.call(this);var t=this.node;this.content.appendChild(o(".title",{text:t.title}));var e=o(".authors",{children:n.map(t.getAuthors(),function(t){var e=this.viewFactory.createView(t),n=e.render().el;return this.content.appendChild(n),n},this)});return this.content.appendChild(e),this}},s.Prototype.prototype=i.prototype,s.prototype=new s.Prototype,e.exports=s},{"../node":32,"substance-application":63,"substance-util":219,underscore:225}],19:[function(t,e){"use strict";e.exports={Model:t("./cover"),View:t("./cover_view")}},{"./cover":17,"./cover_view":18}],20:[function(t,e){"use strict";var n=t("substance-document"),r=function(t,e){n.Composite.call(this,t,e)};r.type={parent:"content",properties:{source_id:"string",label:"string",url:"string",caption:"caption"}},r.config={zoomable:!0},r.description={name:"Figure",remarks:["A figure is a figure is figure."],properties:{}},r.example={no_example:"yet"},r.Prototype=function(){this.hasCaption=function(){return!!this.properties.caption},this.getNodes=function(){var t=[];return this.properties.caption&&t.push(this.properties.caption),t},this.getCaption=function(){return this.properties.caption?this.document.get(this.properties.caption):void 0}},r.Prototype.prototype=n.Composite.prototype,r.prototype=new r.Prototype,r.prototype.constructor=r,n.Node.defineProperties(r.prototype,["source_id","label","url","caption"]),Object.defineProperties(r.prototype,{header:{get:function(){return this.properties.label}}}),e.exports=r},{"substance-document":133}],21:[function(t,e){"use strict";var n=t("../composite").View,r=t("substance-application").$$,i=function(t,e){n.call(this,t,e)};i.Prototype=function(){this.render=function(){this.el.innerHTML="",this.content=r("div.content");var t=r(".image-wrapper",{children:[r("img",{src:this.node.url})]});this.content.appendChild(t);var e=this.node.getCaption();if(e){var n=this.viewFactory.createView(e),i=n.render().el;this.content.appendChild(i),this.childrenViews.push(n)}return this.el.appendChild(this.content),this}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"../composite":16,"substance-application":63}],22:[function(t,e){"use strict";e.exports={Model:t("./figure"),View:t("./figure_view")}},{"./figure":20,"./figure_view":21}],23:[function(t,e){var n=t("underscore"),r=t("substance-document").Node,i=function(t){r.call(this,t)};i.type={id:"formula",parent:"content",properties:{source_id:"string",label:"string",data:"string",format:"string",inline:"boolean"}},i.description={name:"Formula",remarks:["Can either be expressed in MathML format or using an image url"],properties:{label:"Formula label (4)",data:"Formula data, either MathML or image url",format:"Can either be `mathml` or `image`"}},i.example={type:"formula",id:"formula_eqn1",label:"(1)",content:"<mml:mrow>...</mml:mrow>",format:"mathml"},i.Prototype=function(){this.inline=!1},i.Prototype.prototype=r.prototype,i.prototype=new i.Prototype,i.prototype.constuctor=new i;var o={};n.each(i.type.properties,function(t,e){o[e]={get:function(){return this.properties[e]}}}),Object.defineProperties(i.prototype,o),e.exports=i},{"substance-document":133,underscore:225}],24:[function(t,e){"use strict";var n=t("../node").View,r=function(t){n.call(this,t),this.$el.attr({id:t.id}),this.$el.addClass("content-node formula"),this.node.inline&&this.$el.addClass("inline")};r.Prototype=function(){this.render=function(){return"mathml"===this.node.format?this.$el.html(this.node.data):"image"===this.node.format&&this.$el.append('<img src="'+this.node.url+'"/>'),this.node.label&&this.$el.append($('<div class="label">').html(this.node.label)),this}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"../node":32}],25:[function(t,e){"use strict";e.exports={Model:t("./formula"),View:t("./formula_view")}},{"./formula":23,"./formula_view":24}],26:[function(t,e){"use strict";var n=t("substance-nodes");e.exports=n.heading},{"substance-nodes":156}],27:[function(t,e){"use strict";var n=t("substance-document").Node,r=function(t,e){n.call(this,t,e)};r.type={id:"image",parent:"content",properties:{source_id:"string",data:"string",url:"string"}},r.config={zoomable:!0},r.description={name:"Image",description:"An image",remarks:["This element can be used to describe images in your document."],properties:{data:"Base64 encoded string of medium sized image version",url:"URL to image resource"}},r.example={type:"image",id:"image_fig3",url:"http://elife.elifesciences.org/content/elife/1/e00311/F3.medium.gif"},r.Prototype=function(){this.getLength=function(){return this.hasCaption()?this.document.get(this.properties.caption)+1:1},this.insertOperation=function(t,e){if(0===t)throw new Error("The image char is not addressable.");return this.hasCaption()?this.caption.insertOperation(t-1,e):null},this.deleteOperation=function(t,e){return 0===t?(console.log("Tried to delete the image char. Don't do that, hmmmkay?"),void 0):this.hasCaption()?this.caption.deleteOperation(t-1,e-1):null},this.hasCaption=function(){return!!this.properties.caption}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,r.prototype.constructor=r,Object.defineProperties(r.prototype,{header:{get:function(){return this.properties.label}},label:{get:function(){return this.properties.label}},title:{get:function(){return this.properties.title}},medium:{get:function(){return this.properties.medium}},large:{get:function(){return this.properties.large}},url:{get:function(){return this.properties.url}},large_url:{get:function(){return this.properties.large_url}},caption:{get:function(){return this.properties.caption?this.document.get(this.properties.caption):""}}}),e.exports=r},{"substance-document":133}],28:[function(t,e){"use strict";var n=t("../node").View,r=t("substance-application").$$,i=function(t,e){n.call(this,t,e),this.$el.addClass("image"),this.$el.attr("id",this.node.id)};i.Prototype=function(){Array.prototype.indexOf,this.render=function(){n.prototype.render.call(this),this.captionView&&this.captionView.dispose();var t=r(".image-char");this._imgChar=t;var e=r("img.medium",{src:this.node.url||this.node.medium,alt:this.node.title,title:this.node.title});if(t.appendChild(e),this.content.appendChild(t),this.node.caption){var i=this.viewFactory.createView(this.node.caption);this.content.appendChild(i.render().el),this.captionView=i}return this},this.dispose=function(){n.prototype.dispose.call(this),console.log("disposing image view..."),this.captionView&&this.captionView.dispose()},this.delete=function(t,e){for(var n=this.$(".content")[0],r=n.childNodes,i=e-1;i>=0;i--)n.removeChild(r[t+i])},this.getCharPosition=function(t,e){if(t===this._imgChar)return e>this._imgPos?1:0;var n=this.captionView.getCharPosition(t,e);return 0>n?n:n+1},this.getDOMPosition=function(t){if(0===t){var e=this.$(".content")[0],n=document.createRange();return n.setStartBefore(e.childNodes[0]),n}return this.captionView.getDOMPosition(t-1)}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"../node":32,"substance-application":63}],29:[function(t,e){"use strict";e.exports={Model:t("./image"),View:t("./image_view")}},{"./image":27,"./image_view":28}],30:[function(t,e){"use strict";e.exports={publication_info:t("./publication_info"),affiliation:t("./affiliation"),cover:t("./cover"),text:t("./text"),paragraph:t("./paragraph"),heading:t("./heading"),figure:t("./figure"),caption:t("./caption"),image:t("./image"),table:t("./table"),supplement:t("./supplement"),video:t("./video"),person:t("./person"),citation:t("./citation"),formula:t("./formula"),list:t("./list"),codeblock:t("./codeblock")}},{"./affiliation":7,"./caption":10,"./citation":13,"./codeblock":15,"./cover":19,"./figure":22,"./formula":25,"./heading":26,"./image":29,"./list":31,"./paragraph":33,"./person":34,"./publication_info":37,"./supplement":40,"./table":43,"./text":46,"./video":47}],31:[function(t,e){"use strict";var n=t("substance-nodes");e.exports=n.list},{"substance-nodes":156}],32:[function(t,e){"use strict";var n=t("substance-nodes");e.exports=n.node},{"substance-nodes":156}],33:[function(t,e){"use strict";var n=t("substance-nodes");e.exports=n.paragraph},{"substance-nodes":156}],34:[function(t,e){"use strict";e.exports={Model:t("./person"),View:t("./person_view")}},{"./person":35,"./person_view":36}],35:[function(t,e){var n=t("underscore"),r=t("substance-document").Node,i=function(t,e){r.call(this,t,e)};i.type={id:"person",parent:"content",properties:{source_id:"string",name:"string",role:"string",affiliations:["array","affiliation"],fundings:["array","string"],image:"string",emails:["array","string"],contribution:"string"}},i.description={name:"Person",remarks:["A person entity."],properties:{name:"Full name."}},i.example={id:"person_1",type:"person",name:"John Doe"},i.Prototype=function(){this.getAffiliations=function(){return n.map(this.properties.affiliations,function(t){return this.document.get(t)},this)}},i.Prototype.prototype=r.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i;var o={},o={header:{get:function(){return this.properties.name}}};n.each(i.type.properties,function(t,e){o[e]={get:function(){return this.properties[e]}}}),Object.defineProperties(i.prototype,o),e.exports=i},{"substance-document":133,underscore:225}],36:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util");r.html;var i=t("../node").View,o=t("substance-application").$$,s=function(t){i.call(this,t),this.$el.attr({id:t.id}),this.$el.addClass("content-node person")};s.Prototype=function(){this.render=function(){return i.prototype.render.call(this),this.content.appendChild(o(".affiliations",{children:n.map(this.node.getAffiliations(),function(t){var e=n.compact([t.department,t.institution,t.city,t.country]).join(", ");return o(".affiliation",{text:e})})})),this.content.appendChild(o(".label",{text:"Contribution"})),this.content.appendChild(o(".contribution",{text:this.node.contribution})),this.node.fundings.length>0&&(this.content.appendChild(o(".label",{text:"Funding"})),this.content.appendChild(o(".fundings",{children:n.map(this.node.fundings,function(t){return o(".funding",{text:t})})}))),this.node.emails.length>0&&(this.content.appendChild(o(".label",{text:"For correspondence"})),this.content.appendChild(o(".label",{children:n.map(this.node.emails,function(t){return o("a",{href:"mailto:x@example.com",text:t})})}))),this}},s.Prototype.prototype=i.prototype,s.prototype=new s.Prototype,e.exports=s},{"../node":32,"substance-application":63,"substance-util":219,underscore:225}],37:[function(t,e){"use strict";e.exports={Model:t("./publication_info"),View:t("./publication_info_view")}},{"./publication_info":38,"./publication_info_view":39}],38:[function(t,e){"use strict";var n=t("substance-document").Node,r=t("underscore"),i=function(t,e){n.call(this,t,e)};i.type={id:"publication_info",parent:"content",properties:{received_on:"string",accpeted_on:"string",published_on:"string",journal:"string",article_type:"string",keywords:["array","string"],research_organisms:["array","string"],subjects:["array","string"],pdf_link:"string",xml_link:"string",json_link:"string",doi:"string"}},i.description={name:"PublicationInfo",description:"PublicationInfo Node",remarks:["Summarizes the article's meta information. Meant to be customized by publishers"],properties:{received_on:"Submission received",accpeted_on:"Paper accepted on",published_on:"Paper published on",journal:"The Journal",article_type:"Research Article vs. Insight, vs. Correction etc.",keywords:"Article's keywords",research_organisms:"Research Organisms",subjects:"Article Subjects",pdf_link:"A link referencing the PDF version for print",xml_link:"A link referencing the original NLM XML file",json_link:"A link pointing to the JSON version of the article",doi:"Article DOI"}},i.example={id:"publication_info",received_on:"2012-06-20",accepted_on:"2012-09-05",published_on:"2012-11-13",journal:"eLife",article_type:"Research Article",keywords:["innate immunity","histones","lipid droplet","anti-bacterial"],research_organisms:["B. subtilis","D. melanogaster","E. coli","Mouse"],subjects:["Immunology","Microbiology and infectious disease"],pdf_link:"http://elife.elifesciences.org/content/1/e00003.full-text.pdf",xml_link:"https://s3.amazonaws.com/elife-cdn/elife-articles/00003/elife00003.xml",json_link:"http://cdn.elifesciences.org/documents/elife/00003.json",doi:"http://dx.doi.org/10.7554/eLife.00003"},i.Prototype=function(){},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i;var o={};r.each(i.type.properties,function(t,e){o[e]={get:function(){return this.properties[e]}}}),Object.defineProperties(i.prototype,o),e.exports=i},{"substance-document":133,underscore:225}],39:[function(t,e){"use strict";var n=t("../node").View,r=t("substance-application").$$,i=function(t,e){n.call(this,t,e),this.$el.addClass("publication-info"),this.$el.attr("id",this.node.id)};i.Prototype=function(){this.render=function(){n.prototype.render.call(this);var t=[r("tr",{children:[r("td",{children:[r("div.label",{text:"Subject"}),r("div.value",{text:this.node.subjects.join(", ")})]}),r("td",{children:[r("div.label",{text:"Organism"}),r("div.value",{text:this.node.research_organisms.join(", ")})]})]}),r("tr",{children:[r("td",{colspan:2,children:[r("div.label",{text:"Keywords"}),r("div.value",{text:this.node.keywords.join(", ")})]})]})],e=r("table.categorization",{children:[r("tbody",{children:t})]});this.el.appendChild(e),this.el.appendChild(r(".label.links",{text:"Links"}));var i=JSON.stringify(this.node.document.toJSON(),null,"  "),o=new Blob([i],{type:"application/json"}),s=r(".links",{children:[r("a.link pdf-link",{href:this.node.pdf_link,html:'<i class="icon-download-alt"></i> PDF'}),r("a.link.json-link",{href:window.URL.createObjectURL(o),html:'<i class="icon-download-alt"></i> JSON'}),r("a.link.xml-link",{href:this.node.xml_link,html:'<i class="icon-download-alt"></i> XML'}),r("a.link.doi-link",{href:this.node.doi,html:'<i class="icon-external-link-sign"></i> DOI'})]});this.el.appendChild(s);var a=[r("tr",{children:[r("td",{children:[r("div.label",{text:"Received"}),r("div.value",{text:this.node.received_on})]}),r("td",{children:[r("div.label",{text:"Accepted"}),r("div.value",{text:this.node.accepted_on})]}),r("td",{children:[r("div.label",{text:"Published"}),r("div.value",{text:this.node.published_on})]})]})],c=r("table.dates",{children:[r("tbody",{children:a})]});return this.el.appendChild(c),this},this.dispose=function(){n.prototype.dispose.call(this)}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"../node":32,"substance-application":63}],40:[function(t,e){"use strict";e.exports={Model:t("./supplement"),View:t("./supplement_view")}},{"./supplement":41,"./supplement_view":42}],41:[function(t,e){var n=t("underscore"),r=t("substance-document"),i=function(t,e){r.Composite.call(this,t,e)};i.type={id:"supplement",parent:"content",properties:{source_id:"string",label:"string",url:"string",caption:"caption"}},i.description={name:"Supplement",remarks:["A Supplement entity."],properties:{source_id:"Supplement id as it occurs in the source NLM file",label:"Supplement label",caption:"References a caption node, that has all the content",url:"URL of downloadable file"}},i.example={id:"supplement_1",source_id:"SD1-data",type:"supplement",label:"Supplementary file 1.",url:"http://myserver.com/myfile.pdf",caption:"caption_supplement_1"},i.Prototype=function(){this.getNodes=function(){var t=[];return this.properties.caption&&t.push(this.properties.caption),t},this.getCaption=function(){return this.properties.caption?this.document.get(this.properties.caption):null}},i.Prototype.prototype=r.Composite.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i;var o={};n.each(i.type.properties,function(t,e){o[e]={get:function(){return this.properties[e]}}}),o.header={get:function(){return this.properties.label}},Object.defineProperties(i.prototype,o),e.exports=i},{"substance-document":133,underscore:225}],42:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util");r.html;var i=t("../composite").View,o=t("substance-application").$$,s=function(t,e){i.call(this,t,e),this.$el.attr({id:t.id}),this.$el.addClass("content-node supplement")};s.Prototype=function(){this.render=function(){var t=this.node;this.content=o("div.content");var e=t.getCaption();if(e){var r=this.viewFactory.createView(e),i=r.render().el;this.content.appendChild(i),this.childrenViews.push(r)}var s=n.last(t.url.split(".")),a=o("div.file",{children:[o("a",{href:t.url,html:'<i class="icon-download-alt"/> Download '+s.toUpperCase()})]});return this.content.appendChild(a),this.el.appendChild(this.content),this}},s.Prototype.prototype=i.prototype,s.prototype=new s.Prototype,s.prototype.constructor=s,e.exports=s},{"../composite":16,"substance-application":63,"substance-util":219,underscore:225}],43:[function(t,e){"use strict";e.exports={Model:t("./table"),View:t("./table_view")}},{"./table":44,"./table_view":45}],44:[function(t,e){var n=t("underscore"),r=t("substance-document").Node,i=function(t,e){r.call(this,t,e)};i.type={id:"table",parent:"content",properties:{source_id:"string",label:"string",content:"string",footers:["array","string"],caption:"caption"}},i.config={zoomable:!0},i.description={name:"Table",remarks:["A table figure which is expressed in HTML notation"],properties:{source_id:"string",label:"Label shown in the resource header.",title:"Full table title",content:"HTML data",footers:"Table footers expressed as an array strings",caption:"References a caption node, that has all the content"}},i.example={id:"table_1",type:"table",label:"Table 1.",title:"Lorem ipsum table",content:"<table>...</table>",footers:[],caption:"caption_1"},i.Prototype=function(){this.getCaption=function(){return this.properties.caption?this.document.get(this.properties.caption):void 0
}},i.Prototype.prototype=r.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i;var o={header:{get:function(){return this.properties.label}}};n.each(i.type.properties,function(t,e){o[e]={get:function(){return this.properties[e]}}}),Object.defineProperties(i.prototype,o),e.exports=i},{"substance-document":133,underscore:225}],45:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util");r.html;var i=t("../node").View,o=t("substance-application").$$,s=function(t,e){i.call(this,t),this.viewFactory=e,this.$el.attr({id:t.id}),this.$el.addClass("content-node table")};s.Prototype=function(){this.render=function(){var t=this.node;i.prototype.render.call(this);var e=o(".table-wrapper",{html:t.content});this.content.appendChild(e);var r=o(".footers",{children:n.map(t.footers,function(t){return o(".footer",{html:"<b>"+t.label+"</b> "+t.content})})}),s=this.node.getCaption();if(s){var a=this.viewFactory.createView(s),c=a.render().el;this.content.appendChild(c)}return this.content.appendChild(r),this}},s.Prototype.prototype=i.prototype,s.prototype=new s.Prototype,e.exports=s},{"../node":32,"substance-application":63,"substance-util":219,underscore:225}],46:[function(t,e){"use strict";var n=t("substance-nodes");e.exports=n.text},{"substance-nodes":156}],47:[function(t,e){"use strict";e.exports={Model:t("./video"),View:t("./video_view")}},{"./video":48,"./video_view":49}],48:[function(t,e){var n=t("underscore"),r=t("substance-document").Node,i=function(t,e){r.call(this,t,e)};i.type={id:"video",parent:"content",properties:{source_id:"string",label:"string",url:"string",url_webm:"string",url_ogv:"string",caption:"caption",poster:"string"}},i.config={zoomable:!0},i.description={name:"Video",remarks:["A video type intended to refer to video resources.","MP4, WebM and OGV formats are supported."],properties:{label:"Label shown in the resource header.",url:"URL to mp4 version of the video.",url_webm:"URL to WebM version of the video.",url_ogv:"URL to OGV version of the video.",poster:"Video poster image.",caption:"References a caption node, that has all the content"}},i.example={id:"video_1",type:"video",label:"Video 1.",url:"http://cdn.elifesciences.org/video/eLifeLensIntro2.mp4",url_webm:"http://cdn.elifesciences.org/video/eLifeLensIntro2.webm",url_ogv:"http://cdn.elifesciences.org/video/eLifeLensIntro2.ogv",poster:"http://cdn.elifesciences.org/video/eLifeLensIntro2.png",caption:"caption_25"},i.Prototype=function(){},i.Prototype.prototype=r.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i;var o={};n.each(i.type.properties,function(t,e){o[e]={get:function(){return this.properties[e]}}}),Object.defineProperties(i.prototype,n.extend(o,{header:{get:function(){return this.properties.label}},caption:{get:function(){return this.properties.caption?this.document.get(this.properties.caption):""}}})),e.exports=i},{"substance-document":133,underscore:225}],49:[function(t,e){"use strict";t("underscore");var n=t("substance-util");n.html;var r=t("../node").View,i=t("substance-application").$$,o=function(t,e){r.call(this,t,e),this.$el.attr({id:t.id}),this.$el.addClass("content-node video")};o.Prototype=function(){this.render=function(){r.prototype.render.call(this);var t=this.node,e=[i("source",{src:t.url,type:"video/mp4; codecs=&quot;avc1.42E01E, mp4a.40.2&quot;"})];t.url_ogv&&e.push(i("source",{src:t.url_ogv,type:"video/ogg; codecs=&quot;theora, vorbis&quot;"})),t.url_webm&&e.push(i("source",{src:t.url_webm,type:"video/webm; codecs=&quot;vp8, vorbis%quot;"}));var n=i(".video-wrapper",{children:[i("video",{controls:"controls",poster:t.poster,preload:"none",children:e})]});if(this.content.appendChild(n),t.title&&this.content.appendChild(i(".title",{text:t.title})),this.node.caption){var o=this.viewFactory.createView(this.node.caption);this.content.appendChild(o.render().el),this.captionView=o}return t.doi&&this.content.appendChild(i(".doi",{children:[i("b",{text:"DOI: "}),i("a",{href:t.doi,target:"_new",text:t.doi})]})),this}},o.Prototype.prototype=r.prototype,o.prototype=new o.Prototype,e.exports=o},{"../node":32,"substance-application":63,"substance-util":219,underscore:225}],50:[function(t,e){"use strict";var n=t("./src/lens_converter");e.exports=n},{"./src/lens_converter":55}],51:[function(t,e){var n=function(){};n.Prototype=function(){this.enhanceSupplement=function(){},this.enhanceTable=function(){},this.enhanceVideo=function(){},this.enhanceFigure=function(){},this.enhanceArticle=function(){},this.extractPublicationInfo=function(){}},n.prototype=new n.Prototype,e.exports=n},{}],52:[function(t,e){"use strict";var n=t("substance-util"),r=t("underscore"),i=t("./default"),o=function(){};o.Prototype=function(){this.enhanceFigure=function(t,e,n){var r=n.querySelector("graphic"),i=r.getAttribute("xlink:href");i=["http://cdn.elifesciences.org/elife-articles/",t.doc.id,"/svg/",i,".svg"].join(""),e.url=i},this.enhanceVideo=function(t,e,n){n.querySelector("media")||n;var r=n.getAttribute("xlink:href").split("."),i=r[0];e.url="http://static.movie-usa.glencoesoftware.com/mp4/10.7554/"+i+".mp4",e.url_ogv="http://static.movie-usa.glencoesoftware.com/ogv/10.7554/"+i+".ogv",e.url_webm="http://static.movie-usa.glencoesoftware.com/webm/10.7554/"+i+".webm",e.poster="http://static.movie-usa.glencoesoftware.com/jpg/10.7554/"+i+".jpg"},this.enhanceSupplement=function(t,e){e.url=["http://cdn.elifesciences.org/elife-articles/",t.doc.id,"/supplements/",e.url].join("")},this.extractPublicationInfo=function(t,e,n){function i(t){if(!t)return null;var e=t.querySelector("day").textContent,n=t.querySelector("month").textContent,r=t.querySelector("year").textContent;return[r,n,e].join("-")}var o=e.doc,s=n.querySelector("article-meta"),a=s.querySelector("pub-date"),c=s.querySelector("date[date-type=received]"),p=s.querySelector("date[date-type=accepted]"),u=s.querySelectorAll("kwd-group[kwd-group-type=author-keywords] kwd"),h=s.querySelectorAll("kwd-group[kwd-group-type=research-organism] kwd"),l=s.querySelectorAll("subj-group[subj-group-type=heading] subject"),d=s.querySelector("subj-group[subj-group-type=display-channel] subject"),f=n.querySelector("journal-title"),g=n.querySelector("article-id[pub-id-type=doi]"),y=n.querySelector("self-uri[content-type=pdf]");console.log("PDFURI",y);var m=["http://cdn.elifesciences.org/elife-articles/",e.doc.id,"/pdf/",y?y.getAttribute("xlink:href"):"#"].join(""),v={id:"publication_info",type:"publication_info",published_on:i(a),received_on:i(c),accepted_on:i(p),keywords:r.pluck(u,"textContent"),research_organisms:r.pluck(h,"textContent"),subjects:r.pluck(l,"textContent"),article_type:d?d.textContent:"",journal:f?f.textContent:"",pdf_link:m,xml_link:"https://s3.amazonaws.com/elife-cdn/elife-articles/"+e.doc.id+"/elife"+e.doc.id+".xml",json_link:"http://mickey.com/mouse.json",doi:g?["http://dx.doi.org/",g.textContent].join(""):""};o.create(v),o.show("info",v.id,0)},this.enhanceInfo=function(t,e,r){var i=e.doc,o={id:"articleinfo",type:"paragraph",children:[]},s=o.children,a=r.querySelectorAll("meta-value"),c=a[1],p={type:"heading",id:e.nextId("heading"),level:1,content:"Impact"};if(i.create(p),s.push(p.id),c){var u=t.paragraphGroup(e,c);s.push(u[0].id)}for(var h=r.querySelectorAll("fn"),l=0;l<h.length;l++){var d=h[l],f=d.getAttribute("fn-type");if("conflict"===f){var p={type:"heading",id:e.nextId("heading"),level:1,content:"Competing Interests"};i.create(p),s.push(p.id);var u=t.bodyNodes(e,n.dom.getChildren(d));s.push(u[0].id)}}for(var g=r.querySelectorAll("sec"),l=0;l<g.length;l++){var y=g[l],f=y.getAttribute("sec-type");if("datasets"===f){console.log("getting data");var p={type:"heading",id:e.nextId("heading"),level:1,content:"Major Datasets"};i.create(p),s.push(p.id);for(var m=t.datasets(e,n.dom.getChildren(y)),v=0;v<m.length;v++)m[v]&&s.push(m[v])}}var b=r.querySelector("ack");if(b){var p={type:"heading",id:e.nextId("heading"),level:1,content:"Acknowledgements"};i.create(p),s.push(p.id);var u=t.bodyNodes(e,n.dom.getChildren(b));s.push(u[0].id)}var S=r.querySelector("permissions");if(S){var p={type:"heading",id:e.nextId("heading"),level:1,content:"Copyright and License"};i.create(p),s.push(p.id);var w=S.querySelector("copyright-statement");if(w){var u=t.paragraphGroup(e,w);s.push(u[0].id)}for(var _=S.querySelector("license"),x=n.dom.getChildren(_),l=0;l<x.length;l++){var E=x[l],f=n.dom.getNodeType(E);if("p"===f||"license-p"===f){var u=t.paragraphGroup(e,E);s.push(u[0].id)}}}i.create(o),console.log(JSON.stringify(o)),i.show("info",o.id)},this.enhanceArticle=function(t,e,r){var i=[],o=r.querySelector("#SA1");if(o){var s={id:e.nextId("heading"),type:"heading",level:1,content:"Article Commentary"};doc.create(s),i.push(s);var s={id:e.nextId("heading"),type:"heading",level:2,content:"Decision letter"};doc.create(s),i.push(s);var a=o.querySelector("body");i=i.concat(t.bodyNodes(e,n.dom.getChildren(a)))}var c=r.querySelector("#SA2");if(c){var s={id:e.nextId("heading"),type:"heading",level:2,content:"Author response"};doc.create(s),i.push(s);var a=c.querySelector("body");i=i.concat(t.bodyNodes(e,n.dom.getChildren(a)))}i.length>0&&t.show(e,i),this.enhanceInfo(t,e,r)}},o.Prototype.prototype=i.prototype,o.prototype=new o.Prototype,o.prototype.constructor=o,e.exports=o},{"./default":51,"substance-util":219,underscore:225}],53:[function(t,e){var n=t("./default"),r=function(){};r.Prototype=function(){var t={CC:"cc",INTV:"intravital",CIB:"cib"};n.prototype,this.enhanceSupplement=function(e,n,r){var i=r.querySelector("graphic, media")||r,o=i.getAttribute("xlink:href"),s=e.xmlDoc.querySelector("journal-id").textContent,o=["https://www.landesbioscience.com/journals/",t[s],"/",o].join("");n.url=o},this.enhanceVideo=function(t,e){e.url="provide_url_here"},this.enhanceFigure=function(e,n,r){var i=r.querySelector("graphic"),o=i.getAttribute("xlink:href"),s=e.xmlDoc.querySelector("journal-id").textContent,o=["https://www.landesbioscience.com/article_figure/journals/",t[s],"/",o].join("");if(n.url=o,!n.label){var a=n.type;n.label=a.charAt(0).toUpperCase()+a.slice(1)}}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,r.prototype.constructor=r,e.exports=r},{"./default":51}],54:[function(t,e){var n=t("./default"),r=function(){};r.Prototype=function(){this.enhanceFigure=function(t,e,n){var r=n.querySelector("graphic"),i=r.getAttribute("xlink:href");i=["http://www.plosone.org/article/fetchObject.action?uri=",i,"&representation=PNG_M"].join(""),e.url=i},this.enhanceVideo=function(t,e){e.url="http://mickey.com/mouse.mp4"}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,r.prototype.constructor=r,e.exports=r},{"./default":51}],55:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util"),i=r.errors,o=i.define("ImporterError"),s=t("./configurations/elife"),a=t("./configurations/landes"),c=t("./configurations/default"),p=t("./configurations/plos"),u=function(t){this.options=t};u.Prototype=function(){var e=function(t){var e=[],n=t.querySelector("surname"),r=t.querySelector("given-names");return r&&e.push(r.textContent),n&&e.push(n.textContent),e.join(" ")},i=function(t){var e=document.createElement("DIV");return e.appendChild(t.cloneNode(!0)),e.innerHTML};this.import=function(t,e){var r;if(n.isString(t)){var i=new DOMParser;r=i.parseFromString(t,"text/xml")}else r=t;var o=this.createDocument();window.doc=o;var s=new u.State(r,o,e);return this.document(s,r)},this.createDocument=function(){var e=t("lens-article"),n=new e;return n};var h={supplement:"figures",figure:"figures",table:"figures",video:"figures"};this.show=function(t,e){var r=t.doc;n.each(e,function(t){var e=h[t.type]||"content";r.show(e,t.id)})},this.extractCover=function(t){var e=t.doc,r=e.get("document"),i={id:"cover",type:"cover",title:r.title,authors:[],"abstract":r.abstract};n.each(r.authors,function(n){var r=e.get(n),o={id:"text_"+n+"_reference",type:"text",content:r.name};e.create(o),i.authors.push(o.id);var s={id:t.nextId("person_reference"),type:"person_reference",path:["text_"+n+"_reference","content"],range:[0,r.name.length],target:n};e.create(s)},this),e.create(i),e.show("content",i.id,0)},this.contribGroup=function(t,e){var n,r=e.querySelectorAll("aff");for(n=0;n<r.length;n++)this.affiliation(t,r[n]);var i=e.querySelectorAll("contrib");for(n=0;n<i.length;n++)this.contributor(t,i[n])},this.affiliation=function(t,e){var n=t.doc,r=e.querySelector("institution"),i=e.querySelector("country"),o=e.querySelector("label"),s=e.querySelector("addr-line named-content[content-type=department]"),a=e.querySelector("addr-line named-content[content-type=city]"),c={id:t.nextId("affiliation"),type:"affiliation",source_id:e.getAttribute("id"),label:o?o.textContent:null,department:s?s.textContent:null,city:a?a.textContent:null,institution:r?r.textContent:null,country:i?i.textContent:null};n.create(c)},this.contributor=function(t,r){var i=t.doc,o=t.nextId("person"),s={id:o,source_id:r.getAttribute("id"),type:"person",name:"",affiliations:[],fundings:[],image:"",emails:[],contribution:""},a=r.querySelector("name");s.name=e(a);var c=r.querySelectorAll("xref");n.each(c,function(e){if("aff"===e.getAttribute("ref-type")){var n=e.getAttribute("rid"),r=i.getNodeBySourceId(n);r&&s.affiliations.push(r.id)}else if("other"===e.getAttribute("ref-type")){var o=t.xmlDoc.getElementById(e.getAttribute("rid"));if(!o)return;var a=o.querySelector("funding-source");if(!a)return;s.fundings.push(a.textContent)}else if("corresp"===e.getAttribute("ref-type")){var c=t.xmlDoc.getElementById(e.getAttribute("rid"));if(!c)return;var p=c.querySelector("email");if(!p)return;s.emails.push(p.textContent)}else if("fn"===e.getAttribute("ref-type")){var u=t.xmlDoc.getElementById(e.getAttribute("rid"));u&&"con"===u.getAttribute("fn-type")&&(s.contribution=u.textContent)}}),"author"===r.getAttribute("contrib-type")&&i.nodes.document.authors.push(o),i.create(s),i.show("info",s.id)};var l={bold:"strong",italic:"emphasis",monospace:"code",sub:"subscript",sup:"superscript",underline:"underline","ext-link":"link",xref:""};this.isAnnotation=function(t){return void 0!==l[t]},this.createAnnotation=function(t,e,r,i){var o=e.tagName.toLowerCase(),s={path:n.last(t.stack).path,range:[r,i]};if("xref"===o){var a=e.getAttribute("ref-type"),c=e.getAttribute("rid");s.type="bibr"===a?"citation_reference":"fig"===a||"table"===a||"supplementary-material"===a?"figure_reference":"figure_reference",c&&(s.target=c.split(" ")[0])}else{if(void 0===l[o])return console.log("Ignoring annotation: ",o,e),void 0;s.type=l[o],"ext-link"===o&&(s.url=e.getAttribute("xlink:href"),"doi"===e.getAttribute("ext-link-type")&&(s.url=["http://dx.doi.org/",s.url].join("")))}s.id=t.nextId(s.type),t.annotations.push(s)},this.annotatedText=function(t,e,n,i){var s="";for(void 0===n&&(n=0);e.hasNext();){var a=e.next();if(a.nodeType===Node.TEXT_NODE)s+=a.textContent,n+=a.textContent.length;else{var c=r.dom.getNodeType(a);if(!this.isAnnotation(c)){if(i)throw new o("Node not yet supported in annoted text: "+c);e.back();break}var p=n,u=new r.dom.ChildNodeIterator(a),h=this.annotatedText(t,u,n,"nested");s+=h,n+=h.length,this.createAnnotation(t,a,p,n)}}return s},this.document=function(t,e){var r=e.querySelector("publisher-name").textContent;t.config="Landes Bioscience"===r?new a:"eLife Sciences Publications, Ltd"===r?new s:"Public Library of Science"===r?new p:new c;var i=t.doc,u=e.querySelector("article");if(!u)throw new o("Expected to find an 'article' element.");this.article(t,u);for(var h=0;h<t.annotations.length;h++){var l=t.annotations[h];if(l.target){var d=t.doc.getNodeBySourceId(l.target);d&&(l.target=d.id)}i.create(t.annotations[h])}return n.each(i.views,function(t){i.get(t).rebuild()}),i},this.extractContributors=function(t,e){var n=e.querySelector("article-meta contrib-group");n&&this.contribGroup(t,n)},this.extractFigures=function(t,e){for(var n,i=e.querySelectorAll("fig, table-wrap, supplementary-material, media[mimetype=video]"),o=[],s=0;s<i.length;s++){var a=i[s],c=r.dom.getNodeType(a);"fig"===c?(n=this.figure(t,a),n&&o.push(n)):"table-wrap"===c?(n=this.tableWrap(t,a),n&&o.push(n)):"media"===c?(n=this.video(t,a),n&&o.push(n)):"supplementary-material"===c&&(n=this.supplement(t,a),n&&o.push(n))}o.length>0&&this.show(t,o)},this.extractCitations=function(t,e){var n=e.querySelector("ref-list");n&&this.refList(t,n)},this.figure=function(t,e){var n=t.doc,r=e.querySelector("label"),i={type:"figure",id:t.nextId("figure"),source_id:e.getAttribute("id"),label:r?r.textContent:"",url:"http://images.wisegeek.com/young-calico-cat.jpg",caption:null},o=e.querySelector("caption");if(o){var s=this.caption(t,o);s&&(i.caption=s.id)}return t.config.enhanceFigure(t,i,e),n.create(i),i},this.supplement=function(t,e){var n=t.doc,r=e.querySelector("label"),i="http://meh.com",o=e.querySelector("media"),i=o?o.getAttribute("xlink:href"):null,s=e.querySelector("object-id[pub-id-type='doi']");s=s?"http://dx.doi.org/"+s.textContent:"";var a={id:t.nextId("supplement"),source_id:e.getAttribute("id"),type:"supplement",label:r?r.textContent:"",url:i,caption:null},c=e.querySelector("caption");if(c){var p=this.caption(t,c);p&&(a.caption=p.id)}return t.config.enhanceSupplement(t,a,e),n.create(a),a},this.caption=function(t,e){var r=t.doc,i=e.querySelector("title"),o=n.select(e.querySelectorAll("p"),function(t){return t.parentNode===e});if(0===o.length)return null;var s={id:t.nextId("caption"),source_id:e.getAttribute("id"),type:"caption",title:"",children:[]};if(i){var a=this.paragraph(t,i);a&&(s.title=a.id)}var c=[];return n.each(o,function(e){var n=this.paragraph(t,e);n&&c.push(n.id)},this),s.children=c,r.create(s),s},this.video=function(t,e){var n=t.doc,r=e.querySelector("label").textContent,i=t.nextId("video"),o={id:i,source_id:e.getAttribute("id"),type:"video",label:r,title:"",caption:null,poster:""},s=e.querySelector("caption");if(s){var a=this.caption(t,s);a&&(o.caption=a.id)}return t.config.enhanceVideo(t,o,e),n.create(o),o},this.tableWrap=function(t,e){var n=t.doc,r=e.querySelector("label"),o={id:t.nextId("table"),source_id:e.getAttribute("id"),type:"table",title:"",label:r?r.textContent:"Table",content:"",caption:null,footers:[]},s=e.querySelector("table");o.content=i(s);var a=e.querySelector("caption");if(a){var c=this.caption(t,a);c&&(o.caption=c.id)}return t.config.enhanceTable(t,o,e),n.create(o),o},this.article=function(t,e){var n=t.doc,i=e.querySelector("article-id");n.id=i?i.textContent:r.uuid(),this.extractContributors(t,e),this.extractCitations(t,e),this.extractFigures(t,e),this.extractCover(t,e),this.extractArticleMeta(t,e);var o=e.querySelector("body");o&&this.body(t,o),t.config.enhanceArticle(this,t,e)},this.extractArticleMeta=function(t,e){var r=e.querySelector("article-meta");if(!r)throw new o("Expected element: 'article-meta'");var i=r.querySelectorAll("article-id");this.articleIds(t,i);var s=r.querySelector("title-group");s&&this.titleGroup(t,s);var a=r.querySelectorAll("pub-date");this.pubDates(t,a);var c=r.querySelectorAll("abstract");n.each(c,function(e){this.abstract(t,e)},this),t.config.extractPublicationInfo(this,t,e)},this.articleIds=function(t,e){var n=t.doc;n.id=e.length>0?e[0].textContent:r.uuid()},this.titleGroup=function(t,e){var n=t.doc,r=e.querySelector("article-title");r&&(n.title=r.textContent)},this.pubDates=function(t,e){var n=t.doc;if(e.length>0){var r=this.pubDate(t,e[0]);n.created_at=r.date}},this.pubDate=function(t,e){var i=-1,o=-1,s=-1;n.each(r.dom.getChildren(e),function(t){var e=r.dom.getNodeType(t),n=t.textContent;"day"===e?i=parseInt(n,10):"month"===e?o=parseInt(n,10):"year"===e&&(s=parseInt(n,10))},this);var a=new Date(s,o,i);return{date:a}},this.abstract=function(t,e){var n=t.doc,i=[],o=e.querySelector("title"),s={id:t.nextId("heading"),type:"heading",level:1,content:o?o.textContent:"Abstract"};n.create(s),i.push(s),i=i.concat(this.bodyNodes(t,r.dom.getChildren(e))),i.length>0&&this.show(t,i)},this.body=function(t,e){var n=this.bodyNodes(t,r.dom.getChildren(e));n.length>0&&this.show(t,n)},this.bodyNodes=function(t,e,n){var i,o=[];n=n||0;for(var s=n;s<e.length;s++){var a=e[s],c=r.dom.getNodeType(a);"p"===c?o=o.concat(this.paragraphGroup(t,a)):"sec"===c?o=o.concat(this.section(t,a)):"list"===c?(i=this.list(t,a),i&&o.push(i)):"disp-formula"===c?(i=this.formula(t,a),i&&o.push(i)):"boxed-text"===c&&(o=o.concat(this.bodyNodes(t,r.dom.getChildren(a))))}return o},this.datasets=function(t,e){for(var n=[],i=0;i<e.length;i++){var o=e[i],s=r.dom.getNodeType(o);if("p"===s){var a=o.querySelector("related-object");if(a)n=n.concat(this.indivdata(t,a));else{var c=this.paragraphGroup(t,o);n.push(c[0].id)}}}return n},this.indivdata=function(t,e){var n={type:"paragraph",id:t.nextId("paragraph"),children:[]},i={type:"text",id:t.nextId("text"),content:""};n.children.push(i.id);for(var o=r.dom.getChildren(e),s=0;s<o.length;s++){var a=o[s],c=r.dom.getNodeType(a);if("name"===c)for(var p=r.dom.getChildren(a),u=0;u<p.length;u++){var h=p[u];i.content+=0===u?h.textContent+", ":h.textContent}else if("comment"===c){var l=this.paragraphGroup(t,a);n.children.push(l[0].children[0])}else i.content+=a.textContent}return doc.create(n),doc.create(i),n.id},this.section=function(t,e){t.sectionLevel++;var n=t.doc,i=r.dom.getChildren(e),o=i[0],s={id:t.nextId("heading"),source_id:e.getAttribute("id"),type:"heading",level:t.sectionLevel,content:o.textContent};n.create(s);var a=this.bodyNodes(t,i,1);return a.unshift(s),t.sectionLevel--,a},this.ignoredParagraphElements={comment:!0,"supplementary-material":!0,fig:!0,"fig-group":!0,"table-wrap":!0,media:!0},this.acceptedParagraphElements={list:{handler:"list"},"disp-formula":{handler:"formula"}},this.inlineParagraphElements={"inline-graphic":!0,"inline-formula":!0},this.segmentParagraphElements=function(t){for(var e=[],i="",o=new r.dom.ChildNodeIterator(t);o.hasNext();){var s=o.next(),a=r.dom.getNodeType(s);this.ignoredParagraphElements[a]||("text"===a||this.isAnnotation(a)||this.inlineParagraphElements[a]?("paragraph"!==i&&(e.push({handler:"paragraph",nodes:[]}),i="paragraph"),n.last(e).nodes.push(s)):(this.acceptedParagraphElements[a]&&e.push(n.extend({node:s},this.acceptedParagraphElements[a])),i=a))}return e},this.paragraphGroup=function(t,e){for(var n=[],r=this.segmentParagraphElements(e),i=0;i<r.length;i++){var o,s=r[i];"paragraph"===s.handler?(o=this.paragraph(t,s.nodes),o&&(o.source_id=e.getAttribute("id"))):o=this[s.handler](t,s.node),o&&n.push(o)}return n},this.paragraph=function(t,e){for(var i=t.doc,o={id:t.nextId("paragraph"),type:"paragraph",children:null},s=[],a=new r.dom.ChildNodeIterator(e);a.hasNext();){var c=a.next(),p=r.dom.getNodeType(c);if("text"===p||this.isAnnotation(p)){var u={id:t.nextId("text"),type:"text",content:null};t.stack.push({node:u,path:[u.id,"content"]});var h=this.annotatedText(t,a.back(),0);h.length>0&&(u.content=h,i.create(u),s.push(u)),t.stack.pop()}else if("inline-graphic"===p){var l=c.getAttribute("xlink:href"),d={id:t.nextId("image"),type:"image",url:l};i.create(d),s.push(d)}else if("inline-formula"===p){var f=this.formula(t,c,"inline");f&&s.push(f)}}return 0===s.length?null:(o.children=n.map(s,function(t){return t.id}),i.create(o),o)},this.list=function(t,e){var n=t.doc,i={id:t.nextId("list"),source_id:e.getAttribute("id"),type:"list",items:[],ordered:!1};"ordered"===e.getAttribute("list-type")&&(i.ordered=!0);for(var o=e.querySelectorAll("list-item"),s=0;s<o.length;s++)for(var a=o[s],c=this.bodyNodes(t,r.dom.getChildren(a),0),p=0;p<c.length;p++)i.items.push(c[p].id);return n.create(i),i};var d=function(t,e){for(var n=r.dom.getChildren(t),o=0;o<n.length;o++){var s=n[o],a=r.dom.getNodeType(s);if("mml:math"===a)return e||s.setAttribute("display","block"),{format:"mathml",data:i(s)};if("tex-math"===a)return{format:"latex",data:s.textContent}}return null};this.formula=function(t,e,n){var r=t.doc,i=n?t.nextId("inline_formula"):t.nextId("formula"),o={id:i,source_id:e.getAttribute("id"),type:"formula",label:"",data:"",format:""};n&&(o.inline=!0);var s=e.querySelector("label");s&&(o.label=s.textContent);var a=d(e,n);return a?(o.format=a.format,o.data=a.data,r.create(o),o):null},this.refList=function(t,e){for(var n=e.querySelectorAll("ref"),r=0;r<n.length;r++)this.ref(t,n[r])},this.ref=function(t,e){for(var n=r.dom.getChildren(e),i=0;i<n.length;i++){var o=n[i],s=r.dom.getNodeType(o);"mixed-citation"===s||"element-citation"===s?this.citation(t,e,o):"label"===s||console.error("Not supported in 'ref': ",s)}},this.citation=function(t,n,r){var i,o,s=t.doc,a=t.nextId("article_citation"),c=r.querySelector("person-group");if(!c)return console.error("FIXME: there is one of those 'mixed-citation' without any structure. Skipping ...",r),void 0;i={id:a,source_id:n.getAttribute("id"),type:"citation",title:"N/A",label:"",authors:[],doi:"",source:"",volume:"",fpage:"",lpage:"",citation_urls:[]};var p=c.querySelectorAll("name");for(o=0;o<p.length;o++)i.authors.push(e(p[o]));var u=r.querySelector("article-title");u?i.title=u.textContent:console.error("FIXME: this citation has no title",r);var h=r.querySelector("source");h&&(i.source=h.textContent);var l=r.querySelector("volume");l&&(i.volume=l.textContent);var d=r.querySelector("fpage");d&&(i.fpage=d.textContent);var f=r.querySelector("lpage");f&&(i.lpage=f.textContent);var g=r.querySelector("year");g&&(i.year=g.textContent);var y=n.querySelector("label");y&&(i.label=y.textContent);var m=r.querySelector("pub-id[pub-id-type='doi'], ext-link[ext-link-type='doi']");m&&(i.doi="http://dx.doi.org/"+m.textContent),s.create(i),s.show("citations",a)}},u.State=function(t,e,n){this.xmlDoc=t,this.doc=e,this.options=n||{},this.annotations=[],this.stack=[],this.sectionLevel=0;var r={};this.nextId=function(t){return r[t]=r[t]||0,r[t]++,t+"_"+r[t]}},u.prototype=new u.Prototype,e.exports={Importer:u}},{"./configurations/default":51,"./configurations/elife":52,"./configurations/landes":53,"./configurations/plos":54,"lens-article":5,"substance-util":219,underscore:225}],56:[function(t){var e="/node_modules/lens-converter/tests",n=t("substance-test");n.assert;var r=n.registerTest,i=t("../src/lens_converter").Importer,o=t("substance-util/src/fs"),s=t("substance-data"),a=function(){this.setup=function(){this.importer=new i},this.importFixture=function(t,n){o.readFile(e,t,{encoding:"utf8"},function(t,e){if(t)return n(t);try{this.doc=this.importer.import(e),this.annotations=new s.Graph.Index(this.doc,{types:["annotation"],property:"path"}),n(null)}catch(t){n(t)}},this)},this.actions=["Import: Article 'lorem_ipsum.xml'",function(t){this.importFixture("../data/lorem_ipsum.xml",t)}]};r(["Lens.Converter","Fundamentals"],new a)},{"../src/lens_converter":55,"substance-data":119,"substance-test":210,"substance-util/src/fs":222}],57:[function(t){var e=self;e.window&&t("./converter_test")},{"./converter_test":56}],58:[function(t,e){"use strict";var n=t("./outline");e.exports=n},{"./outline":59}],59:[function(t,e){"use strict";var n=t("substance-application").View,r=t("substance-application").$$,i=t("underscore"),o=function(t){n.call(this),this.surface=t,this.state={selectedNode:null,highlightedNodes:[]},this.$el.addClass("lens-outline"),i.bindAll(this,"mouseDown","mouseUp","mouseMove","updateVisibleArea"),this.$el.mousedown(this.mouseDown),this.$el.mousemove(this.mouseMove),this.$el.mouseup(this.mouseUp)};o.Prototype=function(){this.render=function(){var t=this,e=0,n=document.createDocumentFragment();n.appendChild(r(".visible-area"));var o=this.surface.$(".nodes").height(),s=this.surface.$el.height(),a=o/s;this.factor=a;var c=this.surface.doc.container,p=c.getTopLevelNodes();i.each(p,function(t){var r=this.surface.$("#"+t.id),i=r.outerHeight(!0)/a,o=$('<div class="node">').attr({id:"outline_"+t.id}).css({position:"absolute",height:i-1,top:e}).addClass(t.type).append('<div class="arrow">');n.appendChild(o[0]),e+=i},this);var u=t.surface.$el.scrollTop(),t=this;return t.el.innerHTML="",t.el.appendChild(n),t.updateVisibleArea(u),this},this.updateVisibleArea=function(t){this.$(".visible-area").css({top:t/this.factor,height:this.surface.$el.height()/this.factor})},this.update=function(t){this.render(),this.state=t,this.$(".node").removeClass("selected").removeClass("highlighted"),this.$el.removeClass("figures").removeClass("citations"),this.$el.addClass(t.context),this.$("#outline_"+t.selectedNode).addClass("selected"),i.each(t.highlightedNodes,function(t){this.$("#outline_"+t).addClass("highlighted")},this)},this.mouseDown=function(t){this._mouseDown=!0;var e=t.pageY;return this.offset=e-$(".visible-area").position().top,!1},this.mouseUp=function(){this._mouseDown=!1},this.mouseMove=function(t){if(this._mouseDown){var e=t.pageY,n=(e-this.offset)*this.factor;this.surface.$el.scrollTop(n)}}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,e.exports=o},{"substance-application":63,underscore:225}],60:[function(t,e){"use strict";var n={Controller:t("./reader_controller"),View:t("./reader_view")};e.exports=n},{"./reader_controller":61,"./reader_view":62}],61:[function(t,e){"use strict";var n=t("substance-document"),r=t("substance-application").Controller,i=t("./reader_view");t("substance-util");var o=function(t,e){this.__document=t,this.content=new n.Controller(t,{view:"content"}),t.get("figures")&&(this.figures=new n.Controller(t,{view:"figures"})),t.get("citations")&&(this.citations=new n.Controller(t,{view:"citations"})),t.get("info")&&(this.info=new n.Controller(t,{view:"info"})),this.state=e,this.currentContext="toc"};o.Prototype=function(){this.createView=function(){return this.view=new i(this),this.view},this.switchContext=function(t){this.currentContext=t,this.modifyState({context:t,node:null,resource:null})},this.modifyState=function(t){r.prototype.modifyState.call(this,t)},this.getActiveControllers=function(){var t=[];return t.push(["article",this]),t.push(["reader",this.content]),t}},o.Prototype.prototype=r.prototype,o.prototype=new o.Prototype,e.exports=o},{"./reader_view":62,"substance-application":63,"substance-document":133,"substance-util":219}],62:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util");r.html;var i=t("substance-surface"),o=t("lens-outline"),s=t("substance-application").View,a=t("substance-toc"),c=t("substance-data"),p=c.Graph.Index,u=t("substance-application").$$,h=-100,l={node:{icon:"icon-anchor"},figure:{icon:"icon-camera"},citation:{icon:"icon-link"}},d={formula:["node"],heading:["node"],paragraph:["node"],list:["node"]},f=function(t,e){var r=e.node,i=d[r.type]||[];if(0!==i.length){var o=[];n.each(i,function(e){var n=l[e],i=t.getAnnotations({node:r.id,filter:function(t){return t.type===e+"_reference"}}),s=Object.keys(i).length;if(s>0||"node"===e){var a="node"===e?"toc":e+"s";o.push(u("div",{"sbs-click":"toggleNode("+a+","+r.id+")","class":"focus-mode "+e,html:'<div class="arrow"></div><i class="'+n.icon+'"></i>'+(s>0?s:""),title:"Show relevant"+e}))}});var s=u("div.focus",{children:o});s.appendChild(u(".stripe")),e.el.appendChild(s)}},g=function(t,e){var n=e.node;if(n.constructor.description,"info"!==t.view||"person"===n.type){var r=[u("a.name",{href:"#",text:n.header,"sbs-click":"toggleResource("+n.id+")"})],i=n.constructor.config;i&&i.zoomable&&r.push(u("a.toggle-fullscreen",{href:"#",html:'<i class="icon-resize-full"></i><i class="icon-resize-small"></i>',"sbs-click":"toggleFullscreen("+n.id+")"}));var o=u(".resource-header",{children:r});e.el.insertBefore(o,e.content)}},y=function(t){var e=document.createDocumentFragment(),n=u(".document");n.appendChild(t.contentView.render().el);var r=[u(".context-toggle.toc",{"sbs-click":"switchContext(toc)",html:'<i class="icon-align-left"></i><span> Contents</span>'})];t.figuresView&&r.push(u(".context-toggle.figures",{"sbs-click":"switchContext(figures)",html:'<i class="icon-camera"></i><span> Figures</span>'})),t.citationsView&&r.push(u(".context-toggle.citations",{"sbs-click":"switchContext(citations)",html:'<i class="icon-link"></i><span> References</span>'})),t.infoView&&r.push(u(".context-toggle.info",{"sbs-click":"switchContext(info)",html:'<i class="icon-info-sign"></i><span> Article Info</span>'}));
var i=u(".context-toggles",{children:r}),o=u(".resources");return o.appendChild(i),o.appendChild(t.tocView.render().el),t.figuresView&&o.appendChild(t.figuresView.render().el),t.citationsView&&o.appendChild(t.citationsView.render().el),t.infoView&&o.appendChild(t.infoView.render().el),e.appendChild(n),e.appendChild(o),e},m=function(t){s.call(this),this.$el.addClass("article"),this.readerCtrl=t;var e=this.readerCtrl.content.__document.constructor.Renderer;this.contentView=new i(this.readerCtrl.content,{editable:!1,renderer:new e(this.readerCtrl.content,{afterRender:f})}),this.tocView=new a(this.readerCtrl),this.tocView.$el.addClass("resource-view"),this.readerCtrl.figures&&(this.figuresView=new i(this.readerCtrl.figures,{editable:!1,renderer:new e(this.readerCtrl.figures,{afterRender:g})}),this.figuresView.$el.addClass("resource-view")),this.readerCtrl.citations&&(this.citationsView=new i(this.readerCtrl.citations,{editable:!1,renderer:new e(this.readerCtrl.citations,{afterRender:g})}),this.citationsView.$el.addClass("resource-view")),this.readerCtrl.info&&(this.infoView=new i(this.readerCtrl.info,{editable:!1,renderer:new e(this.readerCtrl.info,{afterRender:g})}),this.infoView.$el.addClass("resource-view")),this.listenTo(this.readerCtrl,"state-changed",this.updateState),this.resources=new p(this.readerCtrl.__document,{types:["figure_reference","citation_reference","person_reference"],property:"target"}),this.outline=new o(this.contentView),this.contentView.$el.on("scroll",n.bind(this.onContentScroll,this)),this.$el.on("click",".annotation.figure_reference",n.bind(this.toggleFigureReference,this)),this.$el.on("click",".annotation.citation_reference",n.bind(this.toggleCitationReference,this)),this.$el.on("click",".annotation.person_reference",n.bind(this.togglePersonReference,this)),this.$el.on("click",".annotation.cross_reference",n.bind(this.followCrossReference,this)),this.outline.$el.on("click",".node",n.bind(this._jumpToNode,this))};m.Prototype=function(){this.toggleFullscreen=function(t){var e=this.readerCtrl.state;this.readerCtrl.modifyState({resource:t,fullscreen:!e.fullscreen})},this._jumpToNode=function(t){var e=$(t.currentTarget).attr("id").replace("outline_","");return this.jumpToNode(e),!1},this.toggleFigureReference=function(t){this.toggleResourceReference("figures",t)},this.toggleCitationReference=function(t){this.toggleResourceReference("citations",t)},this.togglePersonReference=function(t){this.toggleResourceReference("info",t)},this.toggleResourceReference=function(t,e){var n=this.readerCtrl.state,r=$(e.currentTarget).attr("id"),i=this.readerCtrl.__document.get(r),o=this.readerCtrl.content.container.getRoot(i.path[0]),s=i.target;s===n.resource?this.readerCtrl.modifyState({context:this.readerCtrl.currentContext,node:null,resource:null}):(this.readerCtrl.modifyState({context:t,node:o,resource:s}),this.jumpToResource(s))},this.followCrossReference=function(t){var e=$(t.currentTarget).attr("id"),n=this.readerCtrl.__document.get(e);this.jumpToNode(n.target)},this.onContentScroll=function(){var t=this.contentView.$el.scrollTop();this.outline.updateVisibleArea(t),this.markActiveHeading(t)},this.markActiveHeading=function(t){var e=$(".nodes").height();if(0!==this.tocView.headings.length){var r=n.first(this.tocView.headings).id;this.contentView.$(".content-node.heading").each(function(){t>=$(this).position().top+h&&(r=this.id)}),t+this.contentView.$el.height()>=e&&(r=n.last(this.tocView.headings).id),this.tocView.setActiveNode(r)}},this.toggleResource=function(t){var e=this.readerCtrl.state;e.resource===t&&(t=null),this.readerCtrl.modifyState({fullscreen:!1,resource:t})},this.jumpToNode=function(t){var e=$("#"+t);if(e.length>0){var n=e.position().top+h;this.contentView.$el.scrollTop(n)}},this.jumpToResource=function(t){var e=$("#"+t);if(e.length>0){var n=e.position().top;this.figuresView&&this.figuresView.$el.scrollTop(n),this.citationsView&&this.citationsView.$el.scrollTop(n),this.infoView&&this.infoView.$el.scrollTop(n)}},this.toggleNode=function(t,e){var n=this.readerCtrl.state;n.node===e&&n.context===t?this.readerCtrl.modifyState({context:this.readerCtrl.currentContext,node:null,resource:null}):this.readerCtrl.modifyState({context:t,node:e,resource:null})},this.switchContext=function(t){this.readerCtrl.switchContext(t)},this.updateState=function(t){t=t||{};var e=this.readerCtrl.state;this.$el.removeClass("toc figures citations info"),this.contentView.$(".content-node.active").removeClass("active"),this.$el.addClass(e.context),e.node&&this.contentView.$("#"+e.node).addClass("active"),this.updateResource()},this.updateResource=function(){var t=this.readerCtrl.state;if(this.$(".resources .content-node.active").removeClass("active fullscreen"),this.contentView.$(".annotation.active").removeClass("active"),t.resource){var e=this.$("#"+t.resource);e.addClass("active"),t.fullscreen&&e.addClass("fullscreen");var r=this.resources.get(t.resource);n.each(r,function(t){this.contentView.$("#"+t.id).addClass("active")},this)}this.updateOutline()},this.updateOutline=function(){var t=this,e=this.readerCtrl.state,r=this.readerCtrl.content.container,i=n.filter(this.readerCtrl.content.getAnnotations(),function(t){return t.target&&t.target===e.resource},this),o=n.uniq(n.map(i,function(t){var e=r.getRoot(t.path[0]);return e}));t.outline.update({context:e.context,selectedNode:e.node,highlightedNodes:o})},this.annotate=function(t){return this.readerCtrl.content.annotate(t),!1},this.render=function(){var t=this,e=this.readerCtrl.state;this.el.appendChild(new y(this)),this.$(".document").append(t.outline.el),n.delay(function(){t.updateLayout(),t.updateState(),MathJax.Hub.Queue(["Typeset",MathJax.Hub])},1),n.delay(function(){t.updateOutline()},2e3);var r=n.debounce(function(){t.updateLayout(),t.updateOutline()},1);return e.node&&n.delay(function(){t.jumpToNode(e.node),e.resource&&t.jumpToResource(e.resource)},100),$(window).resize(r),this},this.updateLayout=function(){var t=this.$(".document").width();this.contentView.$(".nodes > .content-node").css("width",t-15)},this.dispose=function(){this.contentView.dispose(),this.figuresView&&this.figuresView.dispose(),this.citationsView&&this.citationsView.dispose(),this.infoView&&this.infoView.dispose(),this.stopListening()}},m.Prototype.prototype=s.prototype,m.prototype=new m.Prototype,m.prototype.constructor=m,e.exports=m},{"lens-outline":58,"substance-application":63,"substance-data":119,"substance-surface":205,"substance-toc":217,"substance-util":219,underscore:225}],63:[function(t,e){"use strict";var n=t("./src/application");n.View=t("./src/view"),n.Router=t("./src/router"),n.Controller=t("./src/controller"),n.ElementRenderer=t("./src/renderers/element_renderer"),n.$$=n.ElementRenderer.$$,e.exports=n},{"./src/application":64,"./src/controller":65,"./src/renderers/element_renderer":66,"./src/router":67,"./src/view":68}],64:[function(t,e){"use strict";var n=t("./view"),r=t("./router");t("substance-util");var i=t("underscore"),o=function(t){n.call(this),this.config=t};o.Prototype=function(){this.initRouter=function(){this.router=new r,i.each(this.config.routes,function(t){this.router.route(t.route,t.name,i.bind(this.controller[t.command],this.controller))},this),r.history.start()},this.start=function(){this.$el=$("body"),this.el=this.$el[0],this.render(),this.initRouter()}},o.Prototype.prototype=n.prototype,o.prototype=new o.Prototype,e.exports=o},{"./router":67,"./view":68,"substance-util":219,underscore:225}],65:[function(t,e){"use strict";var n=t("substance-util"),r=t("underscore"),i=function(){this.state={},this.context=null};i.Prototype=function(){this.updateState=function(t,e){console.error("updateState is deprecated, use modifyState. State is now a rich object where context replaces the old state variable");var n=this.context;this.context=t,this.state=e,this.trigger("state-changed",this.context,n,e)},this.modifyState=function(t){var e=this.state.context;r.extend(this.state,t),t.context&&t.context!==e&&this.trigger("context-changed",t.context),this.trigger("state-changed",this.state.context)}},i.Prototype.prototype=n.Events,i.prototype=new i.Prototype,e.exports=i},{"substance-util":219,underscore:225}],66:[function(t,e){"use strict";var n=t("substance-util"),r=t("substance-regexp"),i=function(t){return this.attributes=t,this.tagName=t.tag,this.children=t.children||[],this.text=t.text||"",this.html=t.html,delete t.children,delete t.text,delete t.html,delete t.tag,this.render()};i.Prototype=function(){this.render=function(){var t=document.createElement(this.tagName);this.html?t.innerHTML=this.html:t.textContent=this.text;for(var e in this.attributes){var n=this.attributes[e];t.setAttribute(e,n)}for(var r=0;r<this.children.length;r++){var i=this.children[r];t.appendChild(i)}return this.el=t,t}};var o=function(t,e){var e=e||{},n=/^([a-zA-Z0-9]*)/.exec(t);e.tag=n&&n[1]?n[1]:"div";var o=/#([a-zA-Z0-9_]*)/.exec(t);o&&o[1]&&(e.id=o[1]);var s=new r(/\.([a-zA-Z0-9_-]*)/g);return e.class||(e.class=s.match(t).map(function(t){return t.match[1]}).join(" ")),new i(e)};i.$$=o,i.Prototype.prototype=n.Events,i.prototype=new i.Prototype,e.exports=i},{"substance-regexp":195,"substance-util":219}],67:[function(t,e){"use strict";var n=t("substance-util"),r=t("underscore"),i=function(t){t||(t={}),t.routes&&(this.routes=t.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},o=/\((.*?)\)/g,s=/(\(\?)?:\w+/g,a=/\*\w+/g,c=/[\-{}\[\]+?.,\\\^$|#\s]/g;r.extend(i.prototype,n.Events,{initialize:function(){},route:function(t,e,n){r.isRegExp(t)||(t=this._routeToRegExp(t)),r.isFunction(e)&&(n=e,e=""),n||(n=this[e]);var o=this;return i.history.route(t,function(r){var s=o._extractParameters(t,r);n&&n.apply(o,s),o.trigger.apply(o,["route:"+e].concat(s)),o.trigger("route",e,s),i.history.trigger("route",o,e,s)}),this},navigate:function(t,e){return i.history.navigate(t,e),this},_bindRoutes:function(){if(this.routes){this.routes=r.result(this,"routes");for(var t,e=r.keys(this.routes);null!=(t=e.pop());)this.route(t,this.routes[t])}},_routeToRegExp:function(t){return t=t.replace(c,"\\$&").replace(o,"(?:$1)?").replace(s,function(t,e){return e?t:"([^/]+)"}).replace(a,"(.*?)"),new RegExp("^"+t+"$")},_extractParameters:function(t,e){var n=t.exec(e).slice(1);return r.map(n,function(t){return t?decodeURIComponent(t):null})}});var p=i.History=function(){this.handlers=[],r.bindAll(this,"checkUrl"),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)},u=/^[#\/]|\s+$/g,h=/^\/+|\/+$/g,l=/msie [\w.]+/,d=/\/$/;p.started=!1,r.extend(p.prototype,n.Events,{interval:50,getHash:function(t){var e=(t||this).location.href.match(/#(.*)$/);return e?e[1]:""},getFragment:function(t,e){if(null==t)if(this._hasPushState||!this._wantsHashChange||e){t=this.location.pathname;var n=this.root.replace(d,"");t.indexOf(n)||(t=t.substr(n.length))}else t=this.getHash();return t.replace(u,"")},start:function(t){if(p.started)throw new Error("Router.history has already been started");p.started=!0,this.options=r.extend({},{root:"/"},this.options,t),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var e=this.getFragment(),n=document.documentMode,i=l.exec(navigator.userAgent.toLowerCase())&&(!n||7>=n);this.root=("/"+this.root+"/").replace(h,"/"),i&&this._wantsHashChange&&(this.iframe=$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(e)),this._hasPushState?$(window).on("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!i?$(window).on("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=e;var o=this.location,s=o.pathname.replace(/[^\/]$/,"$&/")===this.root;return this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!s?(this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0):(this._wantsPushState&&this._hasPushState&&s&&o.hash&&(this.fragment=this.getHash().replace(u,""),this.history.replaceState({},document.title,this.root+this.fragment+o.search)),this.options.silent?void 0:this.loadUrl())},stop:function(){$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),p.started=!1},route:function(t,e){this.handlers.unshift({route:t,callback:e})},checkUrl:function(){var t=this.getFragment();return t===this.fragment&&this.iframe&&(t=this.getFragment(this.getHash(this.iframe))),t===this.fragment?!1:(this.iframe&&this.navigate(t),this.loadUrl()||this.loadUrl(this.getHash()),void 0)},loadUrl:function(t){var e=this.fragment=this.getFragment(t),n=r.any(this.handlers,function(t){return t.route.test(e)?(t.callback(e),!0):void 0});return n},navigate:function(t,e){if(!p.started)return!1;if(e&&e!==!0||(e={trigger:e}),t=this.getFragment(t||""),this.fragment!==t){this.fragment=t;var n=this.root+t;if(this._hasPushState)this.history[e.replace?"replaceState":"pushState"]({},document.title,n);else{if(!this._wantsHashChange)return this.location.assign(n);this._updateHash(this.location,t,e.replace),this.iframe&&t!==this.getFragment(this.getHash(this.iframe))&&(e.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,t,e.replace))}e.trigger&&this.loadUrl(t)}},_updateHash:function(t,e,n){if(n){var r=t.href.replace(/(javascript:|#).*$/,"");t.replace(r+"#"+e)}else t.hash="#"+e}}),i.history=new p,e.exports=i},{"substance-util":219,underscore:225}],68:[function(t,e){"use strict";var n=t("substance-util"),r=function(){this.$el=$("<div/>"),this.el=this.$el[0],this.dispatchDOMEvents()};r.Prototype=function(){this.$=function(t){return this.$el.find(t)},this.dispatchDOMEvents=function(){function t(t){var e=/(\w+)\((.*)\)/.exec(t);if(!e)throw new Error("Invalid click handler '"+t+"'");return{method:e[1],args:e[2].split(",")}}var e=this;this.$el.delegate("[sbs-click]","click",function(n){var r=t($(n.currentTarget).attr("sbs-click")),i=e[r.method];return i?(i.apply(e,r.args),!1):void 0})}},r.Prototype.prototype=n.Events,r.prototype=new r.Prototype,e.exports=r},{"substance-util":219}],69:[function(t){"use strict";var e=t("substance-test"),n=e.assert,r=e.registerTest,i=t("../src/renderers/element_renderer"),o=i.$$,s=function(){this.setup=function(){},this.actions=["Render a div with id and class attributes",function(){var t=new i({tag:"div",id:"john","class":"foo"});n.isEqual("foo",t.className),n.isEqual("john",t.id)},"Test nested composition of DOM elements",function(){new i({tag:"ul",id:"my_list",children:[new i({tag:"li","class":"item-1",text:"A"}),new i({tag:"li",text:"B"})]})},"Test deeply nested composition of DOM elements",function(){var t=new i({tag:"ul",id:"my_list",children:[new i({tag:"li",text:"A"}),new i({tag:"li",text:"B",children:[new i({tag:"li","class":"item-1",text:"B1"}),new i({tag:"li",text:"B2"})]})]}),e=t.querySelectorAll("li.item-1");n.isEqual(1,e.length);var r=t.querySelectorAll("li");n.isEqual(4,r.length)},"Test shortcut version",function(){o("div#bar.foo")},"Test depely nested composition with short syntax",function(){var t=o("ul#my_list",{children:[o("li.foo",{text:"A"}),o("li.foo",{text:"B",children:[o("li.item-1",{text:"B1"}),o("li",{text:"B2"})]})]}),e=t.querySelectorAll("li.foo");n.isEqual(2,e.length);var r=t.querySelectorAll("li");n.isEqual(4,r.length)},"Render some images",function(){var t=o("#images",{children:[o("img#img_1.cat-1",{src:"http://foo.com/bar.jpg"}),o("img#img_2.cat-1",{src:"http://bar.at/foo.png"})]});console.log("IMAGES",t)}]};r(["Substance.Application","Element Renderer"],new s)},{"../src/renderers/element_renderer":66,"substance-test":210}],70:[function(t){"use strict";t("./element_renderer_test")},{"./element_renderer_test":69}],71:[function(t,e){"use strict";var n=t("./src/article");n.Renderer=t("./src/renderer"),e.exports=n},{"./src/article":74,"./src/renderer":75}],72:[function(t,e){"use strict";var n=t("substance-document"),r=function(t,e){n.Composite.call(this,t,e)};r.type={parent:"content",properties:{image:"image",caption:"paragraph"}},r.Prototype=function(){this.insertOperation=function(){return null},this.deleteOperation=function(){return null},this.hasCaption=function(){return!!this.properties.caption},this.getNodes=function(){var t=[this.properties.image];return this.properties.caption&&t.push(this.properties.caption),t},this.getImage=function(){return this.properties.image?this.document.get(this.properties.image):void 0},this.getCaption=function(){return this.properties.caption?this.document.get(this.properties.caption):void 0}},r.Prototype.prototype=n.Composite.prototype,r.prototype=new r.Prototype,r.prototype.constructor=r,n.Node.defineProperties(r.prototype,["image","caption"]),e.exports=r},{"substance-document":133}],73:[function(t,e){"use strict";var n=t("underscore"),r={};n.each(t("substance-nodes"),function(t,e){r[e]=n.clone(t)}),r.figure={Model:t("./figure/figure"),View:r.composite.View},e.exports=r},{"./figure/figure":72,"substance-nodes":156,underscore:225}],74:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util"),i=t("substance-document"),o=function(t){t=t||{},t.schema=r.deepclone(i.schema),t.schema.id="substance-article",t.schema.version="0.1.0",n.each(o.types,function(e,n){t.schema.types[n]=e}),n.each(o.annotations,function(e,n){t.schema.types[n]=e}),n.each(o.nodeTypes,function(e,n){t.schema.types[n]=e.Model.type}),n.each(o.indexes,function(e,n){t.schema.indexes[n]=e}),i.call(this,t),this.nodeTypes=o.nodeTypes,void 0===t.seed&&(this.create({id:"document",type:"document",guid:t.id,creator:t.creator,created_at:t.created_at,views:["content"],title:"","abstract":""}),n.each(o.views,function(t){this.create({id:t,type:"view",nodes:[]})},this))};o.Prototype=function(){this.fromSnapshot=function(t,e){return o.fromSnapshot(t,e)}},o.fromSnapshot=function(t,e){return e=e||{},e.seed=t,new o(e)},o.views=["content"],o.nodeTypes=t("../nodes"),o.annotations={strong:{parent:"annotation",properties:{}},emphasis:{properties:{},parent:"annotation"},code:{parent:"annotation",properties:{}},link:{parent:"annotation",properties:{url:"string"}},idea:{parent:"annotation",properties:{}},error:{parent:"annotation",properties:{}},question:{parent:"annotation",properties:{}}},o.types={annotation:{properties:{path:["array","string"],range:"object"}},document:{properties:{views:["array","view"],guid:"string",creator:"string",title:"string","abstract":"string",meta:"object"}},comment:{properties:{content:"string",created_at:"string",creator:"string",node:"node"}}},o.indexes={comments:{type:"comment",properties:["node"]}},o.Prototype.prototype=i.prototype,o.prototype=new o.Prototype,o.prototype.constructor=o,Object.defineProperties(o.prototype,{id:{get:function(){return this.get("document").guid},set:function(t){this.get("document").guid=t}},creator:{get:function(){return this.get("document").creator},set:function(t){this.get("document").creator=t}},created_at:{get:function(){return this.get("document").created_at},set:function(t){this.get("document").created_at=t}},title:{get:function(){return this.get("document").title},set:function(t){this.get("document").title=t}},"abstract":{get:function(){return this.get("document").abstract},set:function(t){this.get("document").abstract=t}},views:{get:function(){return this.get("document").views.slice(0)}}}),e.exports=o},{"../nodes":73,"substance-document":133,"substance-util":219,underscore:225}],75:[function(t,e){var n=t("./article"),r=t("underscore"),i=function(t,e){this.docController=t,this.options=e||{},this.nodeTypes=n.nodeTypes,this.nodes={}};i.Prototype=function(){this.createView=function(t){var e=this.nodeTypes[t.type].View;if(!e)throw new Error('Node type "'+t.type+'" not supported');var n=new e(t,this);return n.listenTo(this.docController,"operation:applied",n.onGraphUpdate),this.nodes[t.id]=n,n},this.render=function(){r.each(this.nodes,function(t){t.dispose()});var t=document.createDocumentFragment(),e=this.docController.container.getTopLevelNodes();return r.each(e,function(e){var n=this.createView(e);t.appendChild(n.render().el),this.options.afterRender&&this.options.afterRender(this.docController,n)},this),t}},i.prototype=new i.Prototype,e.exports=i},{"./article":74,underscore:225}],76:[function(t,e){"use strict";var n=t("./src/chronicle");n.IndexImpl=t("./src/index_impl"),n.ChronicleImpl=t("./src/chronicle_impl"),n.DiffImpl=t("./src/diff_impl"),n.TmpIndex=t("./src/tmp_index"),n.create=n.ChronicleImpl.create,n.Index.create=n.IndexImpl.create,n.Diff.create=n.DiffImpl.create,n.ArrayOperationAdapter=t("./src/array_adapter"),n.TextOperationAdapter=t("./src/text_adapter"),e.exports=n},{"./src/array_adapter":77,"./src/chronicle":78,"./src/chronicle_impl":79,"./src/diff_impl":80,"./src/index_impl":81,"./src/text_adapter":82,"./src/tmp_index":83}],77:[function(t,e){"use strict";var n=t("substance-util"),r=t("./chronicle"),i=t("substance-operator").ArrayOperation,o=function(t,e){r.Versioned.call(this,t),this.array=e};o.Prototype=function(){var t=n.prototype(this);this.apply=function(t){i.fromJSON(t).apply(this.array)},this.invert=function(t){return i.fromJSON(t).invert()},this.transform=function(t,e,n){return i.transform(t,e,n)},this.reset=function(){for(t.reset.call(this);this.array.length>0;)this.array.shift()}},o.Prototype.prototype=r.Versioned.prototype,o.prototype=new o.Prototype,e.exports=o},{"./chronicle":78,"substance-operator":184,"substance-util":219}],78:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util"),i=r.errors;i.define("ChronicleError",-1),i.define("ChangeError",-1);var o=function(t,e,n){if(this.type="change",!t)throw new i.ChangeError("Every change needs a unique id.");if(this.id=t,!e)throw new i.ChangeError("Every change needs a parent.");this.parent=e,this.data=n,this.uuid=r.uuid};o.prototype={toJSON:function(){return{type:this.type,id:this.id,parent:this.parent,data:this.data}}},o.fromJSON=function(t){return t.type===c.TYPE?new c(t):t.type===p.TYPE?new p(t):new o(t.parent,t.data,t)};var s="ROOT",a=new o(s,!0,null);a.parent=s;var c=function(t,e,n){if(o.call(this,t,e),this.type=c.TYPE,!n)throw new i.ChangeError("Missing branches.");this.branches=n};c.Prototype=function(){var t=r.prototype(this);this.toJSON=function(){var e=t.toJSON.call(this);return e.type=c.TYPE,e.branches=this.branches,e}},c.Prototype.prototype=o.prototype,c.prototype=new c.Prototype,c.TYPE="merge",c.fromJSON=function(t){if(t.type!==c.TYPE)throw new i.ChangeError("Illegal data for deserializing a Merge node.");return new c(t.parent,t.branches,t)};var p=function(t,e,n,r){o.call(this,t,e,n),this.type=p.TYPE,this.original=r};p.Prototype=function(){var t=r.prototype(this);this.toJSON=function(){var e=t.toJSON.call(this);return e.type=p.TYPE,e.original=this.original,e}},p.TYPE="transformed",p.fromJSON=function(t){if(t.type!==p.TYPE)throw new i.ChangeError("Illegal data for deserializing a Transformed node.");return new p(t.parent,t.data,t.original,t)},p.Prototype.prototype=o.prototype,p.prototype=new p.Prototype;var u=function(){};u.prototype={hasReverts:function(){throw new i.SubstanceError("Not implemented.")},reverts:function(){throw new i.SubstanceError("Not implemented.")},hasApplies:function(){throw new i.SubstanceError("Not implemented.")},applies:function(){throw new i.SubstanceError("Not implemented.")},sequence:function(){throw new i.SubstanceError("Not implemented.")},mine:function(){throw new i.SubstanceError("Not implemented.")},theirs:function(){throw new i.SubstanceError("Not implemented.")},root:function(){throw new i.SubstanceError("Not implemented.")},start:function(){throw new i.SubstanceError("Not implemented.")},end:function(){throw new i.SubstanceError("Not implemented.")},inverted:function(){throw new i.SubstanceError("Not implemented.")}},u.create=function(){throw new i.SubstanceError("Not implemented.")};var h=function(t,e){e=e||{},this.index=t,this.versioned=null,this.__mode__=e.mode||h.DEFAULT_MODE};h.Prototype=function(){this.record=function(){throw new i.SubstanceError("Not implemented.")},this.open=function(){throw new i.SubstanceError("Not implemented.")},this.step=function(){throw new i.SubstanceError("Not implemented.")},this.forward=function(t){var e=this.versioned.getState();if(e!==t){var n=this.index.children[e];if(0!==n.length){var r;if(1===n.length)r=n[0];else if(t){var i=this.index.shortestPath(e,t);i.shift(),r=i.shift()}else r=n[n.length-1];return r?this.step(r):void 0}}},this.rewind=function(){var t,e=this.index.get(this.versioned.getState());return e.id===s?null:(t=e.parent,this.step(t))},this.merge=function(){throw new i.SubstanceError("Not implemented.")},this.manage=function(t){this.versioned=t},this.mark=function(t){this.index.setRef(t,this.versioned.getState())},this.find=function(t){this.index.getRef(t)},this.getState=function(){return this.versioned.getState()},this.getChanges=function(t,e){var r=[],i=this.path(t,e);return n.each(i,function(t){r.push(this.index.get(t))},this),r}},h.prototype=new h.Prototype,h.PEDANTIC_RECORD=2,h.PEDANTIC_IMPORT=4,h.HYSTERICAL=h.PEDANTIC_RECORD|h.PEDANTIC_IMPORT,h.DEFAULT_MODE=h.PEDANTIC_IMPORT,h.create=function(){throw new i.SubstanceError("Not implemented.")};var l=function(){this.__id__=r.uuid(),this.changes={},this.refs={},this.children={},this.changes[s]=a,this.children[s]=[]};l.Prototype=function(){this.add=function(){throw new i.SubstanceError("Not implemented.")},this.remove=function(){throw new i.SubstanceError("Not implemented.")},this.contains=function(){throw new i.SubstanceError("Not implemented.")},this.path=function(){throw new i.SubstanceError("Not implemented.")},this.get=function(){throw new i.SubstanceError("Not implemented.")},this.getChildren=function(){throw new i.SubstanceError("Not implemented.")},this.list=function(){throw new i.SubstanceError("Not implemented.")},this.diff=function(){throw new i.SubstanceError("Not implemented.")},this.setRef=function(t,e){if(void 0===this.changes[e])throw new i.ChronicleError("Unknown change: "+e);this.refs[t]=e},this.getRef=function(t){return this.refs[t]},this.listRefs=function(){return Object.keys(this.refs)},this.import=function(){throw new i.SubstanceError("Not implemented.")}},l.prototype=new l.Prototype,l.INVALID="INVALID",l.ROOT=a,l.create=function(){throw new i.SubstanceError("Not implemented.")};var d=function(t){this.chronicle=t,this.state=s,t.manage(this)};d.Prototype=function(){this.apply=function(){throw new i.SubstanceError("Not implemented.")},this.revert=function(t){t=this.invert(t),this.apply(t)},this.invert=function(){throw new i.SubstanceError("Not implemented.")},this.transform=function(){throw new i.SubstanceError("Not implemented.")},this.getState=function(){return this.state},this.setState=function(t){this.state=t},this.reset=function(){this.state=s}},d.prototype=new d.Prototype,h.Change=o,h.Merge=c,h.Transformed=p,h.Diff=u,h.Index=l,h.Versioned=d,h.ROOT=s,h.mergeConflict=function(t,e){var n=new i.MergeConflict("Merge conflict: "+JSON.stringify(t)+" vs "+JSON.stringify(e));return n.a=t,n.b=e,n},e.exports=h},{"substance-util":219,underscore:225}],79:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util"),i=r.errors,o=t("./chronicle"),s=function(t,e){o.call(this,t,e)};s.Prototype=function(){var t=new s.__private__,e=o.Index.ROOT.id;this.uuid=r.uuid,this.internal_uuid=r.uuid,this.record=function(t){(this.__mode__&o.PEDANTIC_RECORD)>0&&(this.versioned.revert(t),this.versioned.apply(t));var e=this.versioned.getState(),n=this.uuid(),r=new o.Change(n,e,t);return this.index.add(r),this.versioned.setState(n),n},this.reset=function(e,n){if(n=n||this.index,!n.contains(e))throw new i.ChronicleError("Invalid argument: unknown change "+e);var r=this.versioned.getState(),o=n.shortestPath(r,e);t.applySequence.call(this,o,n)},this.open=this.reset,this.path=function(t,n){if(n){if(!t)throw new i.ChronicleError("Illegal argument: "+t);return this.index.shortestPath(t,n)}var r=this.index.shortestPath(e,t||this.versioned.getState());return r.shift(),r},this.apply=function(e){return n.isArray(e)?t.applySequence.call(this,e):t.applySequence.call(this,arguments)},this.step=function(t){var e=this.index,n=this.versioned.getState();try{var r=e.get(n);if(r.id===t)return null;var o,s=e.get(t);if(r.parent===t)o=this.versioned.invert(r.data);else{if(s.parent!==r.id)throw new i.ChronicleError("Invalid apply sequence: "+t+" is not parent or child of "+r.id);o=s.data}return this.versioned.apply(o),this.versioned.setState(t),o}catch(a){throw this.reset(n,e),a}},this.merge=function(e,n,r){if(!this.index.contains(e))throw new i.ChronicleError("Invalid argument: unknown change "+e);1==arguments.length&&(n="auto",r={}),r=r||{};var s=this.versioned.getState(),a=this.index.diff(s,e);if(!a.hasApplies())return s;if(!a.hasReverts()&&!r.no_ff)return t.applyDiff.call(this,a),this.versioned.getState();var c;if("mine"===n)c=new o.Merge(this.uuid(),s,[s,e]);else if("theirs"===n)c=new o.Merge(this.uuid(),e,[s,e]);else{if("manual"!==n)throw new i.ChronicleError("Unsupported merge strategy: "+n);if(!r.sequence)throw new i.ChronicleError("Invalid argument: sequence is missing for manual merge");var p=r.sequence;c=t.manualMerge.call(this,s,e,a,p,r)}return this.index.add(c),this.reset(c.id),c.id},this.import=function(e){var n=this.index.import(e);(this.__mode__&o.PEDANTIC_IMPORT)>0&&t.importSanityCheck.call(this,n)}},s.__private__=function(){var t=this;this.applyDiff=function(e,n){if(n=n||this.index,e){var r=this.versioned.getState();if(r!==e.start())throw new i.ChronicleError("Diff can not applied on to this state. Expected: "+e.start()+", Actual: "+r);var s=null,a=[],c=[];try{var p,u,h=e.reverts(),l=e.applies();for(p=0;p<h.length;p++)u=h[p],t.revertTo.call(this,u,n),a.push(u);for(p=0;p<l.length;p++)u=l[p],t.apply.call(this,u,n),c.push(u)}catch(d){s=d}if(s&&(a.length>0||c.length>0)){var f=o.Diff.create(e.start(),a,c),g=f.inverted();try{t.applyDiff.call(this,g,n)}catch(d){console.log("Ohohhhh.... could not rollback partially applied diff.","Without bugs and in HYSTERICAL mode this should not happen.","Resetting to original state"),this.versioned.reset(),this.reset(r,n)}}if(s)throw s}},this.applySequence=function(e,r){r=r||this.index;var o=this.versioned.getState();try{var s=r.get(o);n.each(e,function(e){if(s.id!==e){var n=r.get(e);if(s.parent===e)t.revertTo.call(this,e,r);else{if(n.parent!==s.id)throw new i.ChronicleError("Invalid apply sequence: "+e+" is not parent or child of "+s.id);t.apply.call(this,e,r)}s=n}},this)}catch(a){throw this.reset(o,r),a}},this.revertTo=function(t,e){e=e||this.index;var n=this.versioned.getState(),r=e.get(n);if(!r)throw new i.ChangeError("Illegal state. 'head' is unknown: "+n);if(r.parent!==t)throw new i.ChangeError("Can not revert: change is not parent of current");r.data&&this.versioned.revert(r.data),this.versioned.setState(t)},this.apply=function(t,e){e=e||this.index;var n=e.get(t);if(!n)throw new i.ChangeError("Illegal argument. change is unknown: "+t);n.data&&this.versioned.apply(n.data),this.versioned.setState(t)},this.eliminate=function(e,n,r,s,a){if(!(s instanceof o.TmpIndex))throw new i.ChronicleError("'eliminate' must be called on a TmpIndex instance");var c,p,u=s.get(n),h=s.get(e);return c=new o.Change(this.internal_uuid(),n,this.versioned.invert(u.data)),s.add(c),p=t.rebase0.call(this,c.id,h.id,r,s,a,!0),s.reconnect(p,u.parent),h=s.get(p),h.id},this.rebase0=function(t,e,n,r,s,a){r=r||this.index;var c=r.get(t),p=r.get(e);if(c.parent!==p.parent)throw new i.ChronicleError("Illegal arguments: principal rebase can only be applied on siblings.");for(var u,h,l,d,f,g=[[c.data,c.id,p]],y=null,m=[];g.length>0;){u=g.pop(),h=u[0],t=u[1],p=u[2],l=p.data;var v;if(p instanceof o.Merge)v=[h],d=new o.Merge(this.uuid(),t,p.branches),m.push(d);else{v=this.versioned.transform(h,l,{check:a});var b=p instanceof o.Transformed?p.original:p.id;
d=new o.Transformed(this.internal_uuid(),t,v[1],b),n[b]=d.id}n[p.id]=d.id,y||(y=d),r.add(d);var S=r.getChildren(p.id);for(f=0;f<S.length;f++){var w=r.get(S[f]);if(s){var _=w instanceof o.Transformed?w.original:w.id;if(!s[_])continue}g.unshift([v[0],d.id,w])}}for(f=0;f<m.length;f++){for(var x=m[f],E=[],C=0;C<x.branches.length;C++)E.push(n[x.branches[C]]);x.branches=E}return y.id},this.eliminateToSelection=function(e,r,i,s){var a=new o.TmpIndex(s),c=n.intersection(e,r);if(0===c.length)return null;var p=n.difference(e,r).reverse();if(0===p.length)return i[c[0]];for(var u,h,l,d=0,f=0,g=null;d<e.length&&f<p.length;)h=e[e.length-1-d],l=p[f],h===l?(g&&(g=t.eliminate.call(this,g,h,i,a,i)),d++,f++):(g=h,d++);for(u=0;u<c.length;u++)h=c[u],a.save(i[h]);return i[c[0]]},this.manualMerge=function(e,r,s,a,c){if(0===a.length)throw new i.ChronicleError("Nothing selected for merge.");var p=n.intersection(a,s.sequence());if(p.length!==a.length)throw new i.ChronicleError("Illegal merge selection: contains changes that are not contained in the merged branches.");var u=new o.TmpIndex(this.index),h=s.mine(),l=s.theirs(),d=n.object(a,a);t.eliminateToSelection.call(this,h,a,d,u),t.eliminateToSelection.call(this,l,a,d,u),h=n.intersection(h,a),l=n.intersection(l,a);for(var f=0;f<a.length;f++){var g,y,m=a[f];if(0===h.length||0===l.length)break;if(h[0]===m)h.shift(),g=d[m],y=d[l[0]];else{if(l[0]!==m)throw new i.ChronicleError("Reordering of commmits is not supported.");l.shift(),g=d[m],y=d[h[0]]}t.rebase0.call(this,g,y,d,u,null,!c.force)}var v=d[n.last(a)];try{this.reset(v,u)}catch(b){throw this.reset(e,u),b}for(f=0;f<a.length;f++)u.save(d[a[f]]);return new o.Merge(this.uuid(),v,[e,r])},this.importSanityCheck=function(t){var e,n=this.versioned.getState(),r=null;try{for(e=0;e<t.length;e++)this.reset(t[e])}catch(o){r=o,console.log(r.stack)}if(this.reset(n),r){for(t.reverse(),e=0;e<t.length;e++)this.index.remove(t[e]);if(r)throw new i.ChronicleError("Import did not pass sanity check: "+r.toString())}}},s.Prototype.prototype=o.prototype,s.prototype=new s.Prototype,s.create=function(t){t=t||{};var e=o.Index.create(t);return new s(e,t)},e.exports=s},{"./chronicle":78,"substance-util":219,underscore:225}],80:[function(t,e){var n=t("underscore"),r=t("./chronicle"),i=function(t){this.data=t};i.Prototype=function(){this.reverts=function(){return this.data[1].slice(1,this.data[0]+1)},this.applies=function(){return this.data[1].slice(this.data[0]+1)},this.hasReverts=function(){return this.data[0]>0},this.hasApplies=function(){return this.data[1].length-1-this.data[0]>0},this.start=function(){return this.data[1][0]},this.end=function(){return n.last(this.data[1])},this.root=function(){return this.data[1][this.data[0]]},this.sequence=function(){return this.data[1].slice(0)},this.mine=function(){return this.data[1].slice(0,this.data[0]).reverse()},this.theirs=function(){return this.applies()},this.inverted=function(){return new i([this.data[1].length-1-this.data[0],this.data[1].slice(0).reverse()])},this.toJSON=function(){return{data:this.data}}},i.Prototype.prototype=r.Diff.prototype,i.prototype=new i.Prototype,i.create=function(t,e,n){return new i([e.length,[t].concat(e).concat(n)])},e.exports=i},{"./chronicle":78,underscore:225}],81:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util"),i=r.errors,o=t("./chronicle"),s=function(){o.Index.call(this)};s.Prototype=function(){var t=new s.__private__,e=o.ROOT;this.add=function(t){t.data=r.freeze(t.data);var e=t.id;if(!t.parent)throw new i.ChronicleError("Change does not have a parent.");if(!this.contains(t.parent))throw new i.ChronicleError("Illegal change: parent is unknown - change="+e+", parent="+t.parent);this.changes[e]=t,this.children[e]=[],this.children[t.parent]||(this.children[t.parent]=[]),this.children[t.parent].push(e)},this.remove=function(t){if(this.children[t].length>0)throw new i.ChronicleError("Can not remove: other changes depend on it.");var e=this.changes[t];delete this.changes[t],delete this.children[t],this.children[e.parent]=n.without(this.children[e.parent],t)},this.contains=function(t){return!!this.changes[t]},this.get=function(t){return this.changes[t]},this.list=function(){return n.keys(this.changes)},this.getChildren=function(t){return this.children[t]},this.diff=function(n,r){var i,s,a=t.getPathToRoot.call(this,n),c=t.getPathToRoot.call(this,r),p=[],u=[],h={};for(s=0;s<c.length;s++)h[c[s]]=!0;for(s=0;s<a.length&&(i=a[s],s>0&&p.push(i),!h[i]);s++);var l=i;for(s=0;s<c.length&&(i=c[s],i!==l&&i!==e);s++)u.unshift(i);return o.Diff.create(n,p,u)},this.shortestPath=function(n,r){if(n===r)return[];if(r===e)return t.getPathToRoot.call(this,n).slice(1);if(n===e)return t.getPathToRoot.call(this,r).reverse().slice(1);for(var o,s,a,c,p,u,h,l={},d=[[n,n]];d.length>0;)if(o=d.shift(),s=o[0],a=o[1],c=this.get(a),!l[a]){if(l[a]=s,a===r){for(var f,g=[];a!==n;)if(g.unshift(a),f=l[a],l[a]=null,a=f,!a)throw new i.SubstanceError("Illegal state: bug in implementation of Index.shortestPath.");return g}for(l[c.parent]||d.push([a,c.parent]),h=this.getChildren(a),p=0;p<h.length;p++)u=h[p],l[u]||d.push([a,u])}throw new i.SubstanceError("Illegal state: no path found.")},this.import=function(e){var r=n.difference(e.list(),this.list());if(0!==r.length){var i=t.computeDependencyOrder.call(this,e,r);r.sort(function(t,e){return i[t]-i[e]});for(var o=0;o<r.length;o++)this.add(e.get(r[o]));return r}}},s.__private__=function(){var t=o.ROOT;this.getPathToRoot=function(e){var n=[];if(e===t)return n;var r=this.get(e);if(!r)throw new i.ChronicleError("Unknown change: "+e);for(var o;;){if(n.push(r.id),r.id===t)break;o=r.parent,r=this.get(o)}return n},this.computeDependencyOrder=function(e,n){function r(n){if(i[n])return i[n];if(n===t)return 0;var o=e.get(n),s=r(o.parent)+1;return i[n]=s,s}for(var i={},o=0;o<n.length;o++)r(n[o]);return i}},s.Prototype.prototype=o.Index.prototype,s.prototype=new s.Prototype;var a=function(t,e){t.store=e,t.__changes__=e.hash("changes"),t.__refs__=e.hash("refs"),t.__changes__.list=t.__changes__.keys;var r=t.add;t.add=function(t){r.call(this,t),this.__changes__.set(t.id,t)};var i=t.remove;t.remove=function(t){i.call(this,t),this.__changes__.delete(t)};var o=t.setRef;t.setRef=function(t,e){o.call(this,t,e),this.__refs__.set(t,e)},t.load=function(){this.import(this.__changes__),n.each(this.__refs__.keys(),function(t){this.setRef(t,this.__refs__.get(t))},this)},t.load()};s.create=function(t){t=t||{};var e=new s;return t.store&&a(e,t.store),e},e.exports=s},{"./chronicle":78,"substance-util":219,underscore:225}],82:[function(t,e){"use strict";var n=t("substance-util"),r=t("./chronicle"),i=t("substance-operator").TextOperation,o=function(t,e){r.Versioned.call(this,t),this.doc=e};o.Prototype=function(){var t=n.prototype(this);this.apply=function(t){this.doc.setText(t.apply(this.doc.getText()))},this.invert=function(t){return t.invert()},this.transform=function(t,e,n){return i.transform(t,e,n)},this.reset=function(){t.reset.call(this),this.doc.setText("")}},o.Prototype.prototype=r.Versioned.prototype,o.prototype=new o.Prototype,e.exports=o},{"./chronicle":78,"substance-operator":184,"substance-util":219}],83:[function(t,e){var n=t("underscore"),r=t("substance-util"),i=r.errors,o=t("./index_impl"),s=function(t){o.call(this),this.index=t};s.Prototype=function(){var t=r.prototype(this);this.get=function(e){return t.contains.call(this,e)?t.get.call(this,e):this.index.get(e)},this.contains=function(e){return t.contains.call(this,e)||this.index.contains(e)},this.getChildren=function(e){var n=t.getChildren.call(this,e)||[];return this.index.contains(e)&&(n=n.concat(this.index.getChildren(e))),n},this.list=function(){return t.list.call(this).concat(this.index.list())},this.save=function(t,e){if(e)for(var n,r,i=[t];i.length>0;){n=i.pop(),r=this.changes[n],this.changes[n]&&this.index.add(r);for(var o=0;o<r.children;o++)i.unshift(r.children[o])}else this.changes[t]&&this.index.add(this.changes[t])},this.reconnect=function(t,e){if(!this.changes[t])throw new i.ChronicleError("Change does not exist to this index.");var r=this.get(t);if(!this.contains(e))throw new i.ChronicleError("Illegal change: parent is unknown parent="+e);this.children[r.parent]||(this.children[r.parent]=[]),this.children[r.parent]=n.without(this.children[r.parent],r.id),r.parent=e,this.children[r.parent]||(this.children[r.parent]=[]),this.children[r.parent].push(t)}},s.Prototype.prototype=o.prototype,s.prototype=new s.Prototype,e.exports=s},{"./index_impl":81,"substance-util":219,underscore:225}],84:[function(t){"use strict";var e=t("underscore"),n=t("substance-util"),r=n.errors,i=t("substance-test"),o=i.assert,s=i.registerTest,a=t("../index"),c=t("./chronicle_test"),p=a.ROOT,u=new a.Change("01",p,"bla"),h=function(t,e,n,r){var i={op:t,val:e};return new a.Change(n,r,i)},l=function(t,e){return h("plus",1,t,e)},d=function(){c.call(this),this.default_fixture=this.fixture,this.fixture=function(){},this.actions=["Index: add",function(){this.index.add(u),o.isTrue(this.index.contains(u.id)),o.exception(r.ChronicleError,function(){this.index.add(l("bla","doesnotexist"))},this)},"Index: get",function(){var t=this.index.get(u.id);o.isEqual(u.id,t.id),o.isEqual(u.data,t.data)},"Index: list",function(){o.isArrayEqual([p,u.id],this.index.list())},"Every Ref should reference an existing change",function(){o.exception(r.ChronicleError,function(){this.index.setRef("FAIL","balla")},this)},"Record",function(){var t=this.next_uuid();this.chronicle.record({op:"plus",val:1}),o.isTrue(this.index.contains(t))},"Should not record failing changes",function(){var t=this.next_uuid();o.exception(function(){this.chronicle.record({op:"div",val:0})},this),o.isFalse(this.index.contains(t))},"Import",function(){var t=a.Index.create();t.add(l("1",p)),t.add(l("2","1")),t.add(l("3","2")),t.add(l("4",p)),this.chronicle.import(t);for(var e=1;5>e;e++)o.isTrue(this.index.contains(""+e))},"Reject Imports with Failing changes",function(){this.setup();var t=a.Index.create();t.add(l("1",p)),t.add(h("div",0,"2","1")),t.add(l("3","2")),o.exception(r.ChronicleError,function(){this.chronicle.import(t)},this)},"Load default fixture",function(){this.setup(),this.default_fixture()},"Reset",function(){this.comp.reset();var t=["07","05","04",p,"06","08","03","01","02"];e.each(t,function(t){this.chronicle.open(t),o.isEqual(this.RESULTS[t],this.comp.result),o.isEqual(t,this.comp.getState())},this)},"Transition: simple forward",function(){this.chronicle.open(p),this.chronicle.apply("01","02","03"),o.isEqual("03",this.comp.getState()),o.isEqual(this.RESULTS["03"],this.comp.result)},"Transition: simple revert",function(){this.chronicle.open("02"),this.chronicle.apply("01"),o.isEqual("01",this.comp.getState()),o.isEqual(this.RESULTS["01"],this.comp.result)},"Transition: revert and apply",function(){this.chronicle.open("04"),this.chronicle.apply("03","05"),o.isEqual("05",this.comp.getState()),o.isEqual(this.RESULTS["05"],this.comp.result)},"Transition: across ROOT",function(){this.chronicle.open("01"),this.chronicle.apply(p,"07"),o.isEqual("07",this.comp.getState()),o.isEqual(this.RESULTS["07"],this.comp.result)}]};d.prototype=c.prototype,s(["Substance.Chronicle","Basics"],new d)},{"../index":76,"./chronicle_test":90,"substance-test":210,"substance-util":219,underscore:225}],85:[function(t){"use strict";var e=t("substance-test"),n=e.assert,r=e.registerTest,i=t("../index"),o=t("./chronicle_test"),s=i.Index.ROOT.id,a=function(){o.call(this),this.actions=["Diff (01 -> 02)",function(){var t="01",e="02",r=this.index.diff(t,e),i=this.index.shortestPath(t,e);n.isArrayEqual([t,e],r.sequence()),n.isEqual(0,r.reverts().length),n.isArrayEqual([e],r.applies()),n.isArrayEqual(r.sequence().slice(1),i)},"Diff (02 -> 01)",function(){var t="02",e="01",r=this.index.diff(t,e),i=this.index.shortestPath(t,e);n.isArrayEqual([t,e],r.sequence()),n.isEqual(0,r.applies().length),n.isArrayEqual([e],r.reverts()),n.isArrayEqual(r.sequence().slice(1),i)},"Diff to ROOT (01 -> ROOT)",function(){var t="01",e="ROOT",r=this.index.diff("01",s),i=this.index.shortestPath(t,e);n.isArrayEqual([t,e],r.sequence()),n.isEqual(0,r.applies().length),n.isArrayEqual([e],r.reverts()),n.isArrayEqual(r.sequence().slice(1),i)},"Diff from ROOT (ROOT -> 08)",function(){var t="ROOT",e="08",r=this.index.diff(t,e),i=this.index.shortestPath(t,e);n.isArrayEqual([s,"07","08"],r.sequence()),n.isArrayEqual([],r.reverts()),n.isArrayEqual(["07","08"],r.applies()),n.isArrayEqual(r.sequence().slice(1),i)},"No Diff (02 -> 02)",function(){var t="02",e="02",r=this.index.diff(t,e),i=this.index.shortestPath(t,e);n.isArrayEqual(["02"],r.sequence()),n.isArrayEqual([],r.reverts()),n.isArrayEqual([],r.applies()),n.isArrayEqual(r.sequence().slice(1),i)},"Diff with reverts and applies (04 -> 05)",function(){var t="04",e="05",r=this.index.diff(t,e),i=this.index.shortestPath(t,e);n.isArrayEqual(["04","03","05"],r.sequence()),n.isArrayEqual(["03"],r.reverts()),n.isArrayEqual(["05"],r.applies()),n.isArrayEqual(r.sequence().slice(1),i)},"Diff across ROOT (07 -> 01)",function(){var t="07",e="01",r=this.index.diff(t,e),i=this.index.shortestPath(t,e);n.isArrayEqual(["07",s,"01"],r.sequence()),n.isArrayEqual([s],r.reverts()),n.isArrayEqual(["01"],r.applies()),n.isArrayEqual(r.sequence().slice(1),i)}]};a.prototype=o.prototype,r(["Substance.Chronicle","Diff"],new a)},{"../index":76,"./chronicle_test":90,"substance-test":210}],86:[function(t){"use strict";var e=t("substance-test"),n=e.assert,r=e.registerTest,i=t("../index"),o=t("./chronicle_test"),s=i.Index.ROOT.id,a=function(){o.call(this),this.actions=["Merge 01 into 02 (nothing to be done)",function(){this.chronicle.open("02");var t=this.index.list().length;this.chronicle.merge("01"),n.isEqual(t,this.index.list().length)},"Merge 02 into 01 (fast-forward, no extra change)",function(){this.chronicle.open("01");var t=this.index.list().length;this.chronicle.merge("02"),n.isEqual(t,this.index.list().length),n.isEqual("02",this.comp.getState())},"Merge 08 into 02 by rejecting theirs",function(){this.chronicle.open("02"),this.M1=this.chronicle.merge("08","mine"),n.isTrue(this.index.contains(this.M1)),n.isEqual(this.M1,this.comp.getState()),this.chronicle.open(s),this.chronicle.open(this.M1),n.isEqual(this.M1,this.comp.getState()),n.isEqual(this.RESULTS["02"],this.comp.result)},"Merge 08 into 02 by rejecting mine",function(){this.chronicle.open("02"),this.M2=this.chronicle.merge("08","theirs"),n.isTrue(this.index.contains(this.M2)),n.isEqual(this.M2,this.comp.getState()),this.chronicle.open(s),this.chronicle.open(this.M2),n.isEqual(this.M2,this.comp.getState()),n.isEqual(this.RESULTS["08"],this.comp.result)},"Traversal across merge (reverting the merge)",function(){this.chronicle.open(this.M1);for(var t=0;2>t;t++)this.op(t);this.chronicle.open("08"),n.isEqual("08",this.comp.getState()),n.isEqual(this.RESULTS["08"],this.comp.result)},"Manual merging",function(){this.chronicle.open("04"),this.op(5);var t=this.comp.result;this.chronicle.open("04"),this.M3=this.chronicle.merge("06","manual",{sequence:["04","06"]}),n.isTrue(this.index.contains(this.M3)),n.isEqual(this.M3,this.comp.getState()),n.isEqual(t,this.comp.result)},"Manual Merge - theirs after mine",function(){this.chronicle.open("02"),this.M4=this.chronicle.merge("08","manual",{sequence:["01","02","07","08"]}),n.isTrue(this.index.contains(this.M4)),n.isEqual(-1,this.comp.result)},"Traversal across manual merge",function(){this.chronicle.open(this.M3),this.chronicle.open("05"),n.isEqual("05",this.comp.getState()),n.isEqual(this.RESULTS["05"],this.comp.result)}]};a.prototype=o.prototype,r(["Substance.Chronicle","Merge"],new a)},{"../index":76,"./chronicle_test":90,"substance-test":210}],87:[function(t){"use strict";var e,n=t("substance-util"),r=n.errors,i=t("substance-test"),o=i.assert,s=i.registerTest,a=t("../index"),c=t("substance-operator").TextOperation,p="Lorem amet",u="Lorem ipsum amet",h="Lorem ipsum dolor amet",l="Lorem ipsum dolor sit amet",d="Lorem sit amet",f="Lorem ipsum sit amet",g=c.Insert(0,"Lorem amet"),y=c.Insert(5," ipsum"),m=c.Insert(12,"dolor "),v=c.Insert(18,"sit "),b=c.Insert(5," sit"),S=c.Insert(6,"sit "),w=function(){var t=1;this.uuid=function(){return""+t++},this.setup=function(){this.chronicle=a.create({mode:a.HYSTERICAL}),this.index=this.chronicle.index,t=1,this.chronicle.uuid=this.uuid,this.document=new e(this.chronicle),this.fixture()},this.fixture=function(){this.ID1=this.document.apply(g),this.ID2=this.document.apply(y),this.ID3=this.document.apply(m),this.ID4=this.document.apply(v),this.chronicle.open(this.ID1),this.ID5_1=this.document.apply(b),this.chronicle.open(this.ID1),this.ID5_2=this.document.apply(S),this.chronicle.open("ROOT")},this.actions=["Basic checkout",function(){this.chronicle.open(this.ID4),o.isEqual(l,this.document.getText()),this.chronicle.open(this.ID1),o.isEqual(p,this.document.getText()),this.chronicle.open(this.ID5_1),o.isEqual(d,this.document.getText()),this.chronicle.open(this.ID3),o.isEqual(h,this.document.getText()),this.chronicle.open(this.ID2),o.isEqual(u,this.document.getText())},"Merge (simple)",function(){this.chronicle.open(this.ID2),o.exception(r.MergeConflict,function(){this.chronicle.merge(this.ID5_1,"manual",{sequence:[this.ID2,this.ID5_1]})},this),this.M1=this.chronicle.merge(this.ID5_2,"manual",{sequence:[this.ID2,this.ID5_2]}),this.chronicle.open(this.M1),o.isEqual(f,this.document.getText())}]};e=function(t){this.text="",this.chronicle=t,t.manage(new a.TextOperationAdapter(t,this)),this.setText=function(t){this.text=t},this.getText=function(){return this.text},this.apply=function(t){return this.text=t.apply(this.text),this.chronicle.record(t)}},s(["Substance.Chronicle","Text Operation"],new w)},{"../index":76,"substance-operator":184,"substance-test":210,"substance-util":219}],88:[function(t){"use strict";var e=t("substance-test"),n=e.assert,r=e.registerTest,i=t("../index"),o=t("substance-operator"),s=o.ArrayOperation,a=s.Insert(0,1),c=s.Insert(1,3),p=s.Insert(1,2),u=s.Move(0,2),h=s.Delete(1,3),l=s.Insert(1,4),d=[1],f=[1,3],g=[1,2,3],y=[2,3,1],m=[2,1],v=[3,4,1],b=function(){var t=1;this.uuid=function(){return""+t++},this.apply=function(t){return this.adapter.apply(t),this.chronicle.record(t)},this.fixture=function(){this.ID1=this.apply(a),this.ID2=this.apply(c),this.ID3=this.apply(p),this.ID4=this.apply(u),this.ID5=this.apply(h),this.chronicle.reset(this.ID1),this.ID6=this.apply(l),this.chronicle.reset("ROOT")},this.setup=function(){this.chronicle=i.create({mode:i.HYSTERICAL}),this.index=this.chronicle.index,t=1,this.chronicle.uuid=this.uuid,this.array=[],this.adapter=new i.ArrayOperationAdapter(this.chronicle,this.array),this.fixture()},this.actions=["Basic checkout",function(){this.chronicle.open(this.ID4),n.isArrayEqual(y,this.array),this.chronicle.open(this.ID1),n.isArrayEqual(d,this.array),this.chronicle.open(this.ID5),n.isArrayEqual(m,this.array),this.chronicle.open(this.ID3),n.isArrayEqual(g,this.array),this.chronicle.open(this.ID2),n.isArrayEqual(f,this.array)},"Manual merge",function(){this.chronicle.open(this.ID4),this.ID_M1=this.chronicle.merge(this.ID6,"manual",{sequence:[this.ID2,this.ID6,this.ID4],force:!0}),this.chronicle.open("ROOT"),this.chronicle.open(this.ID_M1),n.isArrayEqual(v,this.array)}]};r(["Substance.Chronicle","Array Operation"],new b)},{"../index":76,"substance-operator":184,"substance-test":210}],89:[function(t){"use strict";function e(){this.setup=function(){this.store=new s,this.chronicle=o.create({store:this.store}),this.index=this.chronicle.index,this.changes=this.index.__changes__,this.refs=this.index.__refs__},this.actions=["Add should store change",function(){this.index.add(new a(1,"ROOT",{val:1})),this.index.add(new a(2,1,{val:2})),this.index.add(new a(3,2,{val:3})),this.index.add(new a(4,1,{val:4}));var t=this.changes.keys().slice(0);r.isArrayEqual([1,2,3,4],t.sort());for(var e=1;4>=e;e++){var n=this.changes.get(e);r.isDeepEqual({val:e},n.data)}},"Persistent refs",function(){this.index.setRef("/remote/origin/master",1),this.index.setRef("master:HEAD",2),this.index.setRef("master:LAST",3),this.index.setRef("other",4),r.isEqual(1,this.refs.get("/remote/origin/master")),r.isEqual(2,this.refs.get("master:HEAD")),r.isEqual(3,this.refs.get("master:LAST")),r.isEqual(4,this.refs.get("other"))},"Remove change",function(){this.index.add(new a(5,1,{val:5})),r.isDefined(this.changes.get(5)),this.index.remove(5),r.isUndefined(this.changes.get(5))},"Import from store",function(){var t=o.Index.create({store:this.store});r.isArrayEqual(["1","2","3","4","ROOT"],t.list().sort()),r.isArrayEqual(["/remote/origin/master","master:HEAD","master:LAST","other"],t.listRefs().sort())}]}var n=t("substance-test"),r=n.assert,i=n.registerTest,o=t("../index"),s=t("substance-store").MemoryStore,a=o.Change;i(["Substance.Chronicle","Persistent Index"],new e)},{"../index":76,"substance-store":197,"substance-test":210}],90:[function(t,e){"use strict";function n(t){return l[t][c]}function r(t){return l[t][p]}var i=t("underscore"),o=t("../index"),s=t("./example"),a=0,c=1,p=2,u=3,h=o.ROOT,l=[["01","plus",5,5],["02","minus",3,2],["03","times",3,6],["04","div",2,3],["05","plus",1,7],["06","plus",2,9],["07","minus",1,-1],["08","minus",2,-3]],d=1,f=function(){function t(t){return 10>t?"0"+t:""+t}this.RESULTS=i.reduce(l,function(t,e){return t[e[a]]=e[u],t},{}),this.RESULTS[h]=0,this.uuid=function(){return t(d++)},this.next_uuid=function(){return t(d)},this.op=function(t){this.comp[n(t)](r(t))},this.setup=function(){d=1,this.chronicle=o.create({mode:o.HYSTERICAL}),this.index=this.chronicle.index,this.comp=new s.ChronicleAdapter(this.chronicle),this.chronicle.uuid=this.uuid,this.fixture()},this.fixture=function(){var t;for(t=0;4>t;t++)this.comp[n(t)](r(t));for(this.chronicle.reset("03"),t=4;6>t;t++)this.comp[n(t)](r(t));for(this.chronicle.reset(h),t=6;8>t;t++)this.comp[n(t)](r(t));this.comp.reset()}};e.exports=f},{"../index":76,"./example":91,underscore:225}],91:[function(t,e){"use strict";var n=t("underscore"),r=t("../index"),i=t("substance-util"),o=function(){this.result=0};o.prototype={plus:function(t){this.result+=t},minus:function(t){this.result-=t},times:function(t){this.result*=t},div:function(t){if(1e-7>t)throw new Error("Value too small.");this.result/=t}};var s=function(t){o.call(this),r.Versioned.call(this,t)};s.Prototype=function(){function t(t){return function(n){e[t].call(this,n),this.chronicle.record({op:t,val:n})}}var e=i.prototype(this),n={plus:"minus",minus:"plus",times:"div",div:"times"};this.plus=t("plus"),this.minus=t("minus"),this.div=t("div"),this.times=function(t){var n=this.result;e.times.call(this,t);var r={op:"times",val:t};1e-7>t&&(r.orig=n),this.chronicle.record(r)},this.transform=function(t,e){return[t,e]},this.apply=function(t){e[t.op].call(this,t.val)},this.revert=function(t){t.orig?this.result=t.orig:e[n[t.op]].call(this,t.val)},this.invert=function(t){var e={};return e.op=n[t.op],t.orig?(e.val=t.orig,e.orig=t.val):e.val=t.val,e},this.reset=function(){e.reset.call(this),this.result=0}},s.Prototype.prototype=n.extend({},o.prototype,r.Versioned.prototype),s.prototype=new s.Prototype,o.ChronicleAdapter=s,e.exports=o},{"../index":76,"substance-util":219,underscore:225}],92:[function(t){t("./001-basics"),t("./002-diff"),t("./003-merge"),t("./004-text"),t("./005-array"),t("./006-persistent-index")},{"./001-basics":84,"./002-diff":85,"./003-merge":86,"./004-text":87,"./005-array":88,"./006-persistent-index":89}],93:[function(t,e){"use strict";e.exports={Keyboard:t("./src/keyboard"),Mousetrap:t("./src/mousetrap")}},{"./src/keyboard":95,"./src/mousetrap":96}],94:[function(){!function(){function t(t,e,n){return t.addEventListener?(t.addEventListener(e,n,!1),void 0):(t.attachEvent("on"+e,n),void 0)}function e(t){if("keypress"==t.type){var e=String.fromCharCode(t.which);return t.shiftKey||(e=e.toLowerCase()),e}return S[t.which]?S[t.which]:w[t.which]?w[t.which]:String.fromCharCode(t.which).toLowerCase()}function n(t,e){return t.sort().join(",")===e.sort().join(",")}function r(t){t=t||{};var e,n=!1;for(e in P)t[e]?n=!0:P[e]=0;n||(T=!1)}function i(t,e,r,i,o,s){var a,c,u=[],h=r.type;if(!E[t])return[];for("keyup"==h&&p(t)&&(e=[t]),a=0;a<E[t].length;++a)if(c=E[t][a],(i||!c.seq||P[c.seq]==c.level)&&h==c.action&&("keypress"==h&&!r.metaKey&&!r.ctrlKey||n(e,c.modifiers))){var l=!i&&c.combo==o,d=i&&c.seq==i&&c.level==s;(l||d)&&E[t].splice(a,1),u.push(c)}return u}function o(t){var e=[];return t.shiftKey&&e.push("shift"),t.altKey&&e.push("alt"),t.ctrlKey&&e.push("ctrl"),t.metaKey&&e.push("meta"),e}function s(t,e,n){I.stopCallback(e,e.target||e.srcElement,n)||t(e,n)===!1&&(e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),e.returnValue=!1,e.cancelBubble=!0)}function a(t,e,n){var o,a=i(t,e,n),c={},u=0,h=!1;for(o=0;o<a.length;++o)a[o].seq&&(u=Math.max(u,a[o].level));for(o=0;o<a.length;++o)if(a[o].seq){if(a[o].level!=u)continue;h=!0,c[a[o].seq]=1,s(a[o].callback,n,a[o].combo)}else I.TRIGGER_PREFIX_COMBOS?s(a[o].callback,n,a[o].combo):h||s(a[o].callback,n,a[o].combo);var l="keypress"==n.type&&O;return n.type!=T||p(t)||l||r(c),O=h&&"keydown"==n.type,a.length>0}function c(t){"number"!=typeof t.which&&(t.which=t.keyCode);var n=e(t);if(n)return"keyup"==t.type&&k===n?(k=!1,void 0):(I.handleKey(n,o(t),t),void 0)}function p(t){return"shift"==t||"ctrl"==t||"alt"==t||"meta"==t}function u(){clearTimeout(b),b=setTimeout(r,1e3)}function h(){if(!v){v={};for(var t in S)t>95&&112>t||S.hasOwnProperty(t)&&(v[S[t]]=t)}return v}function l(t,e,n){return n||(n=h()[t]?"keydown":"keypress"),"keypress"==n&&e.length&&(n="keydown"),n}function d(t,n,i,o){function a(e){return function(){T=e,++P[t],u()}}function c(n){s(i,n,t),"keyup"!==o&&(k=e(n)),setTimeout(r,10)}P[t]=0;for(var p=0;p<n.length;++p){var h=p+1===n.length,l=h?c:a(o||g(n[p+1]).action);y(n[p],l,o,t,p)}}function f(t){return"+"===t?["+"]:t.split("+")}function g(t,e){var n,r,i,o=[];for(n=f(t),i=0;i<n.length;++i)r=n[i],x[r]&&(r=x[r]),e&&"keypress"!=e&&_[r]&&(r=_[r],o.push("shift")),p(r)&&o.push(r);return e=l(r,o,e),{key:r,modifiers:o,action:e}}function y(t,e,n,r,o){C[t+":"+n]=e,t=t.replace(/\s+/g," ");var s,a=t.split(" ");return a.length>1?(d(t,a,e,n),void 0):(s=g(t,n),E[s.key]=E[s.key]||[],i(s.key,s.modifiers,{type:s.action},r,t,o),E[s.key][r?"unshift":"push"]({callback:e,modifiers:s.modifiers,action:s.action,seq:r,level:o,combo:t}),void 0)}function m(t,e,n){for(var r=0;r<t.length;++r)y(t[r],e,n)}for(var v,b,S={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",224:"meta"},w={106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},_={"~":"`","!":"1","@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\"},x={option:"alt",command:"meta","return":"enter",escape:"esc",mod:/Mac|iPod|iPhone|iPad/.test(navigator.platform)?"meta":"ctrl"},E={},C={},P={},k=!1,O=!1,T=!1,q=1;20>q;++q)S[111+q]="f"+q;for(q=0;9>=q;++q)S[q+96]=q;t(document,"keypress",c),t(document,"keydown",c),t(document,"keyup",c);var I={bind:function(t,e,n){return t=t instanceof Array?t:[t],m(t,e,n),this},unbind:function(t,e){return I.bind(t,function(){},e)},trigger:function(t,e){return C[t+":"+e]&&C[t+":"+e]({},t),this},reset:function(){return E={},C={},this},stopCallback:function(t,e){return(" "+e.className+" ").indexOf(" mousetrap ")>-1?!1:"INPUT"==e.tagName||"SELECT"==e.tagName||"TEXTAREA"==e.tagName||e.contentEditable&&"true"==e.contentEditable},handleKey:a,TRIGGER_PREFIX_COMBOS:!1};window.Mousetrap=I,"function"==typeof define&&define.amd&&define(I)}()},{}],95:[function(t,e){"use strict";t("../lib/mousetrap");var n=window.Mousetrap,r=function(t){this.__bindings={},this.__mainControl=t,this.__controls=[],this.__defaultHandler=null};r.Prototype=function(){function t(t,e){for(var n=e.split("."),r=t.__bindings,i=0;i<n.length;i++){var o=n[i];r.contexts=r.contexts||{},r.contexts[o]=r.contexts[o]||{},r=r.contexts[o]}return r}function e(e,n){var r=t(e,n.context);r.commands=r.commands||[],r.commands=r.commands.concat(n.commands)}function r(t,e){var n=t;e.scope&&(n=t[e.scope]);var r="false"!==e.preventDefault;return function(t){n[e.command].apply(n,e.args),r&&t.preventDefault()}}function i(t,e){if(void 0!==e)for(var i=0;i<e.length;i++){var o=e[i];n.bind(o.keys,r(t,o))}}function o(t){if(t&&0!==t.length){var e=function(e,n,r){if(!a(e,n,r))for(var i=t.length-1;i>=0;i--){var o=t[i],s=o.handler(e,n,r);if(s){var c=o.control,p=s.command,u=s.args;return c[p].apply(c,u),void 0}}};n.handleKey=e}}function s(t){function e(t,e,n){i(e,n.commands),void 0!==n.default&&r.push({context:t,control:e,handler:n.default})}n.reset(),n.handleKey=a;var r=[],s=t.__controls,c=t.__bindings,p="",u=t.__mainControl;e(p,u,c);for(var h=0;h<s.length&&(p=s[h][0],u=s[h][1],void 0!==c.contexts&&void 0!==c.contexts[p]);h++)c=c.contexts[p],e(p,u,c);o(r)}var a=n.handleKey;this.registerBindings=function(t){console.log("Keyboard.registerBindings: definition=",t);for(var n=0;n<t.length;n++){var r=t[n];e(this,r)}this.stateChanged()},this.setDefaultHandler=function(e,n){var r=t(this,e);r.default=n},this.stateChanged=function(){this.__controls=this.__mainControl.getActiveControllers(),s(this)},this.enter=function(t,e){this.__controls.push([t,e]),s(this)},this.exit=function(t){for(var e=-1,n=this.__controls.length-1;n>=0;n--)if(this.__controls[n][0]===t){e=n;break}if(0>e)throw new Error("Unknown context: "+t,", expected one of: "+JSON.stringify(this.__contexts));this.__controls=this.__controls.slice(0,e),s(this)},this.set=function(t,e){n[t]=e}},r.prototype=new r.Prototype,e.exports=r},{"../lib/mousetrap":94}],96:[function(t,e){"use strict";function n(t,e,n){t.addEventListener?t.addEventListener(e,n,!1):t.attachEvent("on"+e,n)}function r(t,e,n){t.removeEventListener?t.removeEventListener(e,n,!1):t.detachEvent("on"+e,n)}function i(t){if("keypress"==t.type){var e=String.fromCharCode(t.which);return t.shiftKey||(e=e.toLowerCase()),e}return p[t.which]?p[t.which]:u[t.which]?u[t.which]:String.fromCharCode(t.which).toLowerCase()}function o(t,e){return t.sort().join(",")===e.sort().join(",")}function s(t){var e=[];return t.shiftKey&&e.push("shift"),t.altKey&&e.push("alt"),t.ctrlKey&&e.push("ctrl"),t.metaKey&&e.push("meta"),e}function a(t){return"shift"==t||"ctrl"==t||"alt"==t||"meta"==t}function c(t){return"+"===t?["+"]:t.split("+")}for(var p={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",224:"meta"},u={106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},h={"~":"`","!":"1","@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\"},l={option:"alt",command:"meta","return":"enter",escape:"esc",mod:/Mac|iPod|iPhone|iPad/.test(navigator.platform)?"meta":"ctrl"},d=1;20>d;++d)p[111+d]="f"+d;for(d=0;9>=d;++d)p[d+96]=d;var f=function(){this._REVERSE_MAP={},this._callbacks={},this._directMap={},this._sequenceLevels={},this._resetTimer=null,this._ignoreNextKeyup=!1,this._ignoreNextKeypress=!1,this._nextExpectedAction=!1,this._handler=this._handleKeyEvent.bind(this)};f.Prototype=function(){function t(t){t=t||{};var e,n=!1;for(e in this._sequenceLevels)t[e]?n=!0:this._sequenceLevels[e]=0;n||(this._nextExpectedAction=!1)}function e(t,e,n,r,i,s){var c,p,u=[],h=n.type;if(!this._callbacks[t])return[];for("keyup"==h&&a(t)&&(e=[t]),c=0;c<this._callbacks[t].length;++c)if(p=this._callbacks[t][c],(r||!p.seq||this._sequenceLevels[p.seq]==p.level)&&h==p.action&&("keypress"==h&&!n.metaKey&&!n.ctrlKey||o(e,p.modifiers))){var l=!r&&p.combo==i,d=r&&p.seq==r&&p.level==s;
(l||d)&&this._callbacks[t].splice(c,1),u.push(p)}return u}function u(t,e,n){this.NOT_IN_EDITABLES&&this.stopCallback(e,e.target||e.srcElement,n)||t.call(this,e,n)===!1&&(e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),e.returnValue=!1,e.cancelBubble=!0)}function d(t,e){var n,r,i,o=[];for(n=c(t),i=0;i<n.length;++i)r=n[i],l[r]&&(r=l[r]),e&&"keypress"!=e&&h[r]&&(r=h[r],o.push("shift")),a(r)&&o.push(r);return e=b.call(this,r,o,e),{key:r,modifiers:o,action:e}}function g(t,n,r,i,o){this._directMap[t+":"+r]=n,t=t.replace(/\s+/g," ");var s,a=t.split(" ");return a.length>1?(S.call(this,t,a,n,r),void 0):(s=d.call(this,t,r),this._callbacks[s.key]=this._callbacks[s.key]||[],e.call(this,s.key,s.modifiers,{type:s.action},i,t,o),this._callbacks[s.key][i?"unshift":"push"]({callback:n,modifiers:s.modifiers,action:s.action,seq:i,level:o,combo:t}),void 0)}function y(t,e,n){for(var r=0;r<t.length;++r)g.call(this,t[r],e,n)}function m(){clearTimeout(this._resetTimer),this._resetTimer=setTimeout(t.bind(this),1e3)}function v(){if(!this._REVERSE_MAP){this._REVERSE_MAP={};for(var t in p)t>95&&112>t||p.hasOwnProperty(t)&&(this._REVERSE_MAP[p[t]]=t)}return this._REVERSE_MAP}function b(t,e,n){return n||(n=v.call(this)[t]?"keydown":"keypress"),"keypress"==n&&e.length&&(n="keydown"),n}function S(e,n,r,o){function s(t){return function(){c._nextExpectedAction=t,++c._sequenceLevels[e],m.call(c)}}function a(n){u.call(this,r,n,e),"keyup"!==o&&(this._ignoreNextKeyup=i(n)),setTimeout(t.bind(this),10)}var c=this;this._sequenceLevels[e]=0;for(var p=0;p<n.length;++p){var h=p+1===n.length,l=h?a:s.call(this,o||d(n[p+1]).action);g.call(this,n[p],l,o,e,p)}}this.handleKey=function(n,r,i){var o,s=e.call(this,n,r,i),c={},p=0,h=!1;for(o=0;o<s.length;++o)s[o].seq&&(p=Math.max(p,s[o].level));for(o=0;o<s.length;++o)if(s[o].seq){if(s[o].level!=p)continue;h=!0,c[s[o].seq]=1,u.call(this,s[o].callback,i,s[o].combo)}else f.TRIGGER_PREFIX_COMBOS?u.call(this,s[o].callback,i,s[o].combo):h||u.call(this,s[o].callback,i,s[o].combo);var l="keypress"==i.type&&this._ignoreNextKeypress;return i.type!=this._nextExpectedAction||a(n)||l||t.call(this,c),this._ignoreNextKeypress=h&&"keydown"==i.type,s.length>0},this._handleKeyEvent=function(t){"number"!=typeof t.which&&(t.which=t.keyCode);var e=i(t);if(e)return"keyup"==t.type&&this._ignoreNextKeyup===e?(this._ignoreNextKeyup=!1,void 0):(this.handleKey(e,s(t),t),void 0)},this.bind=function(t,e,n){return t=t instanceof Array?t:[t],y.call(this,t,e,n),this},this.unbind=function(t,e){return this.bind(t,function(){},e)},this.trigger=function(t,e){return this._directMap[t+":"+e]&&this._directMap[t+":"+e].call(this,{},t),this},this.reset=function(){return this._callbacks={},this._directMap={},this},this.stopCallback=function(t,e){return(" "+e.className+" ").indexOf(" mousetrap ")>-1?!1:"INPUT"==e.tagName||"SELECT"==e.tagName||"TEXTAREA"==e.tagName||e.contentEditable&&"true"==e.contentEditable},this.connect=function(t){this._el=t,n(this._el,"keypress",this._handler),n(this._el,"keydown",this._handler),n(this._el,"keyup",this._handler)},this.disconnect=function(){r(this._el,"keypress",this._handler),r(this._el,"keydown",this._handler),r(this._el,"keyup",this._handler)},this.TRIGGER_PREFIX_COMBOS=!1,this.NOT_IN_EDITABLES=!1},f.prototype=new f.Prototype,e.exports=f},{}],97:[function(t,e){e.exports=[{unMeta:{}},[{contents:[[{contents:[{contents:"I",tag:"Str"},{contents:[],tag:"Space"},{contents:"am",tag:"Str"},{contents:[],tag:"Space"},{contents:"a",tag:"Str"},{contents:[],tag:"Space"},{contents:"listitem",tag:"Str"}],tag:"Plain"}],[{contents:[{contents:"Me",tag:"Str"},{contents:[],tag:"Space"},{contents:[{contents:"too",tag:"Str"}],tag:"Emph"}],tag:"Plain"}],[{contents:[{contents:"Me",tag:"Str"},{contents:[],tag:"Space"},{contents:[{contents:"three",tag:"Str"}],tag:"Strong"}],tag:"Plain"}]],tag:"BulletList"}]]},{}],98:[function(t,e){e.exports=[{unMeta:{}},[{contents:[{contents:"I",tag:"Str"},{contents:[],tag:"Space"},{contents:"am",tag:"Str"},{contents:[],tag:"Space"},{contents:"an",tag:"Str"},{contents:[],tag:"Space"},{contents:[{contents:"annotated",tag:"Str"}],tag:"Emph"},{contents:[],tag:"Space"},{contents:[{contents:"paragraph",tag:"Str"}],tag:"Strong"},{contents:".",tag:"Str"}],tag:"Para"}]]},{}],99:[function(t,e){e.exports=[{unMeta:{}},[{contents:[{contents:[{contents:"This",tag:"Str"},{contents:[],tag:"Space"},{contents:"is",tag:"Str"},{contents:[],tag:"Space"},{contents:"a",tag:"Str"},{contents:[],tag:"Space"},{contents:"blockquote",tag:"Str"}],tag:"Para"},{contents:[{contents:"...with",tag:"Str"},{contents:[],tag:"Space"},{contents:"two",tag:"Str"},{contents:[],tag:"Space"},{contents:"paragraphs.",tag:"Str"}],tag:"Para"}],tag:"BlockQuote"}]]},{}],100:[function(t,e){e.exports=[{unMeta:{}},[{contents:[1,["heading",[],[]],[{contents:"Heading",tag:"Str"}]],tag:"Header"},{contents:[{contents:"And",tag:"Str"},{contents:[],tag:"Space"},{contents:"a",tag:"Str"},{contents:[],tag:"Space"},{contents:"paragraph",tag:"Str"}],tag:"Para"},{contents:[2,["heading-2",[],[]],[{contents:"Heading",tag:"Str"},{contents:[],tag:"Space"},{contents:"2",tag:"Str"}]],tag:"Header"},{contents:[3,["heading-3",[],[]],[{contents:"Heading",tag:"Str"},{contents:[],tag:"Space"},{contents:"3",tag:"Str"}]],tag:"Header"}]]},{}],101:[function(t,e){e.exports=[{unMeta:{}},[{contents:[{contents:"Paragaph",tag:"Str"},{contents:[],tag:"Space"},{contents:"1",tag:"Str"}],tag:"Para"},{contents:[],tag:"HorizontalRule"},{contents:[{contents:"Paragaph",tag:"Str"},{contents:[],tag:"Space"},{contents:"2",tag:"Str"}],tag:"Para"}]]},{}],102:[function(t,e){e.exports=[{unMeta:{}},[{contents:[{contents:"Don't",tag:"Str"},{contents:[],tag:"Space"},{contents:"call",tag:"Str"},{contents:[],tag:"Space"},{contents:"me",tag:"Str"},{contents:[],tag:"Space"},{contents:[["",[],[]],"foo()"],tag:"Code"},{contents:",",tag:"Str"},{contents:[],tag:"Space"},{contents:"fool",tag:"Str"}],tag:"Para"}]]},{}],103:[function(t,e){e.exports=[{unMeta:{}},[{contents:[{contents:"This",tag:"Str"},{contents:[],tag:"Space"},{contents:"is",tag:"Str"},{contents:[],tag:"Space"},{contents:[[{contents:"an",tag:"Str"},{contents:[],tag:"Space"},{contents:"example",tag:"Str"}],["http://example.com/",""]],tag:"Link"},{contents:[],tag:"Space"},{contents:"inline",tag:"Str"},{contents:[],tag:"Space"},{contents:"link.",tag:"Str"}],tag:"Para"}]]},{}],104:[function(t,e){e.exports=[{unMeta:{}},[{contents:[{contents:"A",tag:"Str"},{contents:[],tag:"Space"},{contents:"quadratic",tag:"Str"},{contents:[],tag:"Space"},{contents:["InlineMath","x^2"],tag:"Math"},{contents:[],tag:"Space"},{contents:"is",tag:"Str"},{contents:[],tag:"Space"},{contents:"a",tag:"Str"},{contents:[],tag:"Space"},{contents:"polynomial",tag:"Str"},{contents:[],tag:"Space"},{contents:"function",tag:"Str"},{contents:[],tag:"Space"},{contents:"of",tag:"Str"},{contents:[],tag:"Space"},{contents:["InlineMath","x"],tag:"Math"},{contents:".",tag:"Str"}],tag:"Para"}]]},{}],105:[function(t,e){e.exports=[{unMeta:{}},[{contents:[1,["lens",[],[]],[{contents:"Lens",tag:"Str"}]],tag:"Header"},{contents:[["",[],[]],"####################################################################################\n##### Lens is currently undergoing a huge refactor in the `modularize` branch.\n##### The cutting edge build can be considered broken for next 1-2 weeks.\n#####\n#####  For a stable version check the `gh-pages` branch.\n####################################################################################"],tag:"CodeBlock"},{contents:[{contents:[{contents:"eLife",tag:"Str"},{contents:[],tag:"Space"},{contents:"Lens",tag:"Str"}],tag:"Strong"},{contents:[],tag:"Space"},{contents:"provides",tag:"Str"},{contents:[],tag:"Space"},{contents:"a",tag:"Str"},{contents:[],tag:"Space"},{contents:"novel",tag:"Str"},{contents:[],tag:"Space"},{contents:"way",tag:"Str"},{contents:[],tag:"Space"},{contents:"of",tag:"Str"},{contents:[],tag:"Space"},{contents:"looking",tag:"Str"},{contents:[],tag:"Space"},{contents:"at",tag:"Str"},{contents:[],tag:"Space"},{contents:"content",tag:"Str"},{contents:[],tag:"Space"},{contents:"on",tag:"Str"},{contents:[],tag:"Space"},{contents:"the",tag:"Str"},{contents:[],tag:"Space"},{contents:"web.",tag:"Str"},{contents:[],tag:"Space"},{contents:"It",tag:"Str"},{contents:[],tag:"Space"},{contents:"is",tag:"Str"},{contents:[],tag:"Space"},{contents:"designed",tag:"Str"},{contents:[],tag:"Space"},{contents:"to",tag:"Str"},{contents:[],tag:"Space"},{contents:"make",tag:"Str"},{contents:[],tag:"Space"},{contents:"life",tag:"Str"},{contents:[],tag:"Space"},{contents:"easier",tag:"Str"},{contents:[],tag:"Space"},{contents:"for",tag:"Str"},{contents:[],tag:"Space"},{contents:"researchers,",tag:"Str"},{contents:[],tag:"Space"},{contents:"reviewers,",tag:"Str"},{contents:[],tag:"Space"},{contents:"authors",tag:"Str"},{contents:[],tag:"Space"},{contents:"and",tag:"Str"},{contents:[],tag:"Space"},{contents:"readers.",tag:"Str"},{contents:[],tag:"Space"},{contents:"For",tag:"Str"},{contents:[],tag:"Space"},{contents:"example,",tag:"Str"},{contents:[],tag:"Space"},{contents:"have",tag:"Str"},{contents:[],tag:"Space"},{contents:"you",tag:"Str"},{contents:[],tag:"Space"},{contents:"tried",tag:"Str"},{contents:[],tag:"Space"},{contents:"to",tag:"Str"},{contents:[],tag:"Space"},{contents:"look",tag:"Str"},{contents:[],tag:"Space"},{contents:"at",tag:"Str"},{contents:[],tag:"Space"},{contents:"a",tag:"Str"},{contents:[],tag:"Space"},{contents:"figure",tag:"Str"},{contents:[],tag:"Space"},{contents:"in",tag:"Str"},{contents:[],tag:"Space"},{contents:"an",tag:"Str"},{contents:[],tag:"Space"},{contents:"online",tag:"Str"},{contents:[],tag:"Space"},{contents:"article,",tag:"Str"},{contents:[],tag:"Space"},{contents:"while",tag:"Str"},{contents:[],tag:"Space"},{contents:"at",tag:"Str"},{contents:[],tag:"Space"},{contents:"the",tag:"Str"},{contents:[],tag:"Space"},{contents:"same",tag:"Str"},{contents:[],tag:"Space"},{contents:"time",tag:"Str"},{contents:[],tag:"Space"},{contents:"trying",tag:"Str"},{contents:[],tag:"Space"},{contents:"to",tag:"Str"},{contents:[],tag:"Space"},{contents:"see",tag:"Str"},{contents:[],tag:"Space"},{contents:"what",tag:"Str"},{contents:[],tag:"Space"},{contents:"the",tag:"Str"},{contents:[],tag:"Space"},{contents:"author",tag:"Str"},{contents:[],tag:"Space"},{contents:"says",tag:"Str"},{contents:[],tag:"Space"},{contents:"about",tag:"Str"},{contents:[],tag:"Space"},{contents:"the",tag:"Str"},{contents:[],tag:"Space"},{contents:"figure,",tag:"Str"},{contents:[],tag:"Space"},{contents:"jumping",tag:"Str"},{contents:[],tag:"Space"},{contents:"all",tag:"Str"},{contents:[],tag:"Space"},{contents:"around",tag:"Str"},{contents:[],tag:"Space"},{contents:"the",tag:"Str"},{contents:[],tag:"Space"},{contents:"article,",tag:"Str"},{contents:[],tag:"Space"},{contents:"losing",tag:"Str"},{contents:[],tag:"Space"},{contents:"track",tag:"Str"},{contents:[],tag:"Space"},{contents:"of",tag:"Str"},{contents:[],tag:"Space"},{contents:"what",tag:"Str"},{contents:[],tag:"Space"},{contents:"you",tag:"Str"},{contents:[],tag:"Space"},{contents:"were",tag:"Str"},{contents:[],tag:"Space"},{contents:"looking",tag:"Str"},{contents:[],tag:"Space"},{contents:"for",tag:"Str"},{contents:[],tag:"Space"},{contents:"in",tag:"Str"},{contents:[],tag:"Space"},{contents:"the",tag:"Str"},{contents:[],tag:"Space"},{contents:"first",tag:"Str"},{contents:[],tag:"Space"},{contents:"place?",tag:"Str"},{contents:[],tag:"Space"},{contents:"The",tag:"Str"},{contents:[],tag:"Space"},{contents:"reason",tag:"Str"},{contents:[],tag:"Space"},{contents:"for",tag:"Str"},{contents:[],tag:"Space"},{contents:"this",tag:"Str"},{contents:[],tag:"Space"},{contents:"is",tag:"Str"},{contents:[],tag:"Space"},{contents:"that",tag:"Str"},{contents:[],tag:"Space"},{contents:"most",tag:"Str"},{contents:[],tag:"Space"},{contents:"online",tag:"Str"},{contents:[],tag:"Space"},{contents:"research",tag:"Str"},{contents:[],tag:"Space"},{contents:"articles",tag:"Str"},{contents:[],tag:"Space"},{contents:"are",tag:"Str"},{contents:[],tag:"Space"},{contents:"published",tag:"Str"},{contents:[],tag:"Space"},{contents:"in",tag:"Str"},{contents:[],tag:"Space"},{contents:"a",tag:"Str"},{contents:[],tag:"Space"},{contents:"fixed",tag:"Str"},{contents:[],tag:"Space"},{contents:"digital",tag:"Str"},{contents:[],tag:"Space"},{contents:"version",tag:"Str"},{contents:[],tag:"Space"},{contents:"of",tag:"Str"},{contents:[],tag:"Space"},{contents:"the",tag:"Str"},{contents:[],tag:"Space"},{contents:"original",tag:"Str"},{contents:[],tag:"Space"},{contents:"paper.",tag:"Str"},{contents:[],tag:"Space"},{contents:"With",tag:"Str"},{contents:[],tag:"Space"},{contents:"eLife",tag:"Str"},{contents:[],tag:"Space"},{contents:"Lens,",tag:"Str"},{contents:[],tag:"Space"},{contents:"we",tag:"Str"},{contents:[],tag:"Space"},{contents:"take",tag:"Str"},{contents:[],tag:"Space"},{contents:"full",tag:"Str"},{contents:[],tag:"Space"},{contents:"advantage",tag:"Str"},{contents:[],tag:"Space"},{contents:"of",tag:"Str"},{contents:[],tag:"Space"},{contents:"the",tag:"Str"},{contents:[],tag:"Space"},{contents:"internets",tag:"Str"},{contents:[],tag:"Space"},{contents:"flexibility.",tag:"Str"}],tag:"Para"},{contents:[{contents:"For",tag:"Str"},{contents:[],tag:"Space"},{contents:"a",tag:"Str"},{contents:[],tag:"Space"},{contents:"demo",tag:"Str"},{contents:[],tag:"Space"},{contents:"and",tag:"Str"},{contents:[],tag:"Space"},{contents:"more",tag:"Str"},{contents:[],tag:"Space"},{contents:"information",tag:"Str"},{contents:[],tag:"Space"},{contents:"see:",tag:"Str"},{contents:[],tag:"Space"},{contents:"http://lens.elifesciences.org",tag:"Str"}],tag:"Para"},{contents:[3,["the-lens-article-format",[],[]],[{contents:"The",tag:"Str"},{contents:[],tag:"Space"},{contents:"Lens",tag:"Str"},{contents:[],tag:"Space"},{contents:"Article",tag:"Str"},{contents:[],tag:"Space"},{contents:"Format",tag:"Str"}]],tag:"Header"},{contents:[{contents:"The",tag:"Str"},{contents:[],tag:"Space"},{contents:[[{contents:"Lens",tag:"Str"},{contents:[],tag:"Space"},{contents:"Article",tag:"Str"},{contents:[],tag:"Space"},{contents:"Format",tag:"Str"}],["http://github.com/elifesciences/lens-article",""]],tag:"Link"},{contents:[],tag:"Space"},{contents:"is",tag:"Str"},{contents:[],tag:"Space"},{contents:"a",tag:"Str"},{contents:[],tag:"Space"},{contents:"JSON",tag:"Str"},{contents:[],tag:"Space"},{contents:"based",tag:"Str"},{contents:[],tag:"Space"},{contents:"document",tag:"Str"},{contents:[],tag:"Space"},{contents:"model",tag:"Str"},{contents:[],tag:"Space"},{contents:"designed",tag:"Str"},{contents:[],tag:"Space"},{contents:"for",tag:"Str"},{contents:[],tag:"Space"},{contents:"representing",tag:"Str"},{contents:[],tag:"Space"},{contents:"scientific",tag:"Str"},{contents:[],tag:"Space"},{contents:"content.",tag:"Str"},{contents:[],tag:"Space"},{contents:"It",tag:"Str"},{contents:[],tag:"Space"},{contents:"features",tag:"Str"},{contents:[],tag:"Space"},{contents:"basic",tag:"Str"},{contents:[],tag:"Space"},{contents:"content",tag:"Str"},{contents:[],tag:"Space"},{contents:"types",tag:"Str"},{contents:[],tag:"Space"},{contents:"such",tag:"Str"},{contents:[],tag:"Space"},{contents:"as",tag:"Str"},{contents:[],tag:"Space"},{contents:"paragraphs,",tag:"Str"},{contents:[],tag:"Space"},{contents:"headings,",tag:"Str"},{contents:[],tag:"Space"},{contents:"and",tag:"Str"},{contents:[],tag:"Space"},{contents:"various",tag:"Str"},{contents:[],tag:"Space"},{contents:"figure",tag:"Str"},{contents:[],tag:"Space"},{contents:"types",tag:"Str"},{contents:[],tag:"Space"},{contents:"such",tag:"Str"},{contents:[],tag:"Space"},{contents:"as",tag:"Str"},{contents:[],tag:"Space"},{contents:"images,",tag:"Str"},{contents:[],tag:"Space"},{contents:"tables",tag:"Str"},{contents:[],tag:"Space"},{contents:"and",tag:"Str"},{contents:[],tag:"Space"},{contents:"videos",tag:"Str"},{contents:[],tag:"Space"},{contents:"complete",tag:"Str"},{contents:[],tag:"Space"},{contents:"with",tag:"Str"},{contents:[],tag:"Space"},{contents:"captions",tag:"Str"},{contents:[],tag:"Space"},{contents:"and",tag:"Str"},{contents:[],tag:"Space"},{contents:"cross-references.",tag:"Str"}],tag:"Para"},{contents:[{contents:"We're",tag:"Str"},{contents:[],tag:"Space"},{contents:"working",tag:"Str"},{contents:[],tag:"Space"},{contents:"on",tag:"Str"},{contents:[],tag:"Space"},{contents:"releasing",tag:"Str"},{contents:[],tag:"Space"},{contents:"the",tag:"Str"},{contents:[],tag:"Space"},{contents:"first",tag:"Str"},{contents:[],tag:"Space"},{contents:"official",tag:"Str"},{contents:[],tag:"Space"},{contents:"verison",tag:"Str"},{contents:[],tag:"Space"},{contents:"of",tag:"Str"},{contents:[],tag:"Space"},{contents:"the",tag:"Str"},{contents:[],tag:"Space"},{contents:"spec.",tag:"Str"}],tag:"Para"},{contents:[3,["install",[],[]],[{contents:"Install",tag:"Str"}]],tag:"Header"},{contents:[[1,"Decimal","Period"],[[{contents:[{contents:"Install",tag:"Str"},{contents:[],tag:"Space"},{contents:"the",tag:"Str"},{contents:[],tag:"Space"},{contents:"Substance",tag:"Str"},{contents:[],tag:"Space"},{contents:"Screwdriver",tag:"Str"},{contents:[],tag:"Space"},{contents:"command",tag:"Str"},{contents:[],tag:"Space"},{contents:"line",tag:"Str"},{contents:[],tag:"Space"},{contents:"utility",tag:"Str"}],tag:"Plain"}]]],tag:"OrderedList"},{contents:[{contents:[["",[],[]],"bash    $ git clone https://github.com/substance/screwdriver.git    $ cd screwdriver    $ sudo python setup.py install"],tag:"Code"}],tag:"Para"},{contents:[[2,"Decimal","Period"],[[{contents:[{contents:"Clone",tag:"Str"},{contents:[],tag:"Space"},{contents:"the",tag:"Str"},{contents:[],tag:"Space"},{contents:"repository",tag:"Str"}],tag:"Plain"}]]],tag:"OrderedList"},{contents:[{contents:[["",[],[]],"bash    $ git clone https://github.com/elifesciences/lens.git"],tag:"Code"}],tag:"Para"},{contents:[[3,"Decimal","Period"],[[{contents:[{contents:"Run",tag:"Str"},{contents:[],tag:"Space"},{contents:"the",tag:"Str"},{contents:[],tag:"Space"},{contents:"update",tag:"Str"},{contents:[],tag:"Space"},{contents:"command,",tag:"Str"},{contents:[],tag:"Space"},{contents:"which",tag:"Str"},{contents:[],tag:"Space"},{contents:"pulls",tag:"Str"},{contents:[],tag:"Space"},{contents:"in",tag:"Str"},{contents:[],tag:"Space"},{contents:"all",tag:"Str"},{contents:[],tag:"Space"},{contents:"the",tag:"Str"},{contents:[],tag:"Space"},{contents:"dependencies",tag:"Str"}],tag:"Plain"}]]],tag:"OrderedList"},{contents:[{contents:[["",[],[]],"bash    $ cd lens    $ substance --update"],tag:"Code"}],tag:"Para"},{contents:[[4,"Decimal","Period"],[[{contents:[{contents:"Finally",tag:"Str"},{contents:[],tag:"Space"},{contents:"start",tag:"Str"},{contents:[],tag:"Space"},{contents:"the",tag:"Str"},{contents:[],tag:"Space"},{contents:"server",tag:"Str"},{contents:[],tag:"Space"},{contents:"and",tag:"Str"},{contents:[],tag:"Space"},{contents:"point",tag:"Str"},{contents:[],tag:"Space"},{contents:"your",tag:"Str"},{contents:[],tag:"Space"},{contents:"browser",tag:"Str"},{contents:[],tag:"Space"},{contents:"to",tag:"Str"},{contents:[],tag:"Space"},{contents:[["",[],[]],"http://localhost:4000"],tag:"Code"}],tag:"Plain"}]]],tag:"OrderedList"},{contents:[{contents:[["",[],[]],"bash    $ substance"],tag:"Code"}],tag:"Para"},{contents:[3,["participating-and-contributing",[],[]],[{contents:"Participating",tag:"Str"},{contents:[],tag:"Space"},{contents:"and",tag:"Str"},{contents:[],tag:"Space"},{contents:"Contributing",tag:"Str"}]],tag:"Header"},{contents:[{contents:"Participation",tag:"Str"},{contents:[],tag:"Space"},{contents:"is",tag:"Str"},{contents:[],tag:"Space"},{contents:"highly",tag:"Str"},{contents:[],tag:"Space"},{contents:"encouraged.",tag:"Str"}],tag:"Para"},{contents:[{contents:"To",tag:"Str"},{contents:[],tag:"Space"},{contents:"suggest",tag:"Str"},{contents:[],tag:"Space"},{contents:"a",tag:"Str"},{contents:[],tag:"Space"},{contents:"feature,",tag:"Str"},{contents:[],tag:"Space"},{contents:"report",tag:"Str"},{contents:[],tag:"Space"},{contents:"a",tag:"Str"},{contents:[],tag:"Space"},{contents:"bug:",tag:"Str"},{contents:[],tag:"Space"},{contents:"http://github.com/elifesciences/lens/issues/",tag:"Str"}],tag:"Para"},{contents:[{contents:"For",tag:"Str"},{contents:[],tag:"Space"},{contents:"general",tag:"Str"},{contents:[],tag:"Space"},{contents:"discussion",tag:"Str"},{contents:[],tag:"Space"},{contents:"join",tag:"Str"},{contents:[],tag:"Space"},{contents:"the",tag:"Str"},{contents:[],tag:"Space"},{contents:"mailing",tag:"Str"},{contents:[],tag:"Space"},{contents:"list/web",tag:"Str"},{contents:[],tag:"Space"},{contents:"forum:",tag:"Str"},{contents:[],tag:"Space"},{contents:"https://groups.google.com/forum/#!forum/elife-lens",tag:"Str"}],tag:"Para"},{contents:[{contents:"To",tag:"Str"},{contents:[],tag:"Space"},{contents:"get",tag:"Str"},{contents:[],tag:"Space"},{contents:"an",tag:"Str"},{contents:[],tag:"Space"},{contents:"overview",tag:"Str"},{contents:[],tag:"Space"},{contents:"of",tag:"Str"},{contents:[],tag:"Space"},{contents:"what",tag:"Str"},{contents:[],tag:"Space"},{contents:"we",tag:"Str"},{contents:[],tag:"Space"},{contents:"are",tag:"Str"},{contents:[],tag:"Space"},{contents:"currently",tag:"Str"},{contents:[],tag:"Space"},{contents:"working",tag:"Str"},{contents:[],tag:"Space"},{contents:"on",tag:"Str"},{contents:[],tag:"Space"},{contents:"now,",tag:"Str"},{contents:[],tag:"Space"},{contents:"and",tag:"Str"},{contents:[],tag:"Space"},{contents:"to",tag:"Str"},{contents:[],tag:"Space"},{contents:"see",tag:"Str"},{contents:[],tag:"Space"},{contents:"what",tag:"Str"},{contents:[],tag:"Space"},{contents:"we",tag:"Str"},{contents:[],tag:"Space"},{contents:"would",tag:"Str"},{contents:[],tag:"Space"},{contents:"like",tag:"Str"},{contents:[],tag:"Space"},{contents:"to",tag:"Str"},{contents:[],tag:"Space"},{contents:"work",tag:"Str"},{contents:[],tag:"Space"},{contents:"on",tag:"Str"},{contents:[],tag:"Space"},{contents:"in",tag:"Str"},{contents:[],tag:"Space"},{contents:"the",tag:"Str"},{contents:[],tag:"Space"},{contents:"future",tag:"Str"},{contents:[],tag:"Space"},{contents:"have",tag:"Str"},{contents:[],tag:"Space"},{contents:"a",tag:"Str"},{contents:[],tag:"Space"},{contents:"look",tag:"Str"},{contents:[],tag:"Space"},{contents:"at",tag:"Str"},{contents:[],tag:"Space"},{contents:"our",tag:"Str"},{contents:[],tag:"Space"},{contents:"roadmap:",tag:"Str"},{contents:[],tag:"Space"},{contents:"https://github.com/elifesciences/lens/wiki/Product-Roadmap",tag:"Str"}],tag:"Para"},{contents:[{contents:"To",tag:"Str"},{contents:[],tag:"Space"},{contents:"contribute",tag:"Str"},{contents:[],tag:"Space"},{contents:"to",tag:"Str"},{contents:[],tag:"Space"},{contents:"the",tag:"Str"},{contents:[],tag:"Space"},{contents:"project,",tag:"Str"},{contents:[],tag:"Space"},{contents:"please",tag:"Str"},{contents:[],tag:"Space"},{contents:"fork",tag:"Str"},{contents:[],tag:"Space"},{contents:"the",tag:"Str"},{contents:[],tag:"Space"},{contents:"project,",tag:"Str"},{contents:[],tag:"Space"},{contents:"and",tag:"Str"},{contents:[],tag:"Space"},{contents:"submit",tag:"Str"},{contents:[],tag:"Space"},{contents:"your",tag:"Str"},{contents:[],tag:"Space"},{contents:"pull",tag:"Str"},{contents:[],tag:"Space"},{contents:"requests.",tag:"Str"},{contents:[],tag:"Space"},{contents:"We",tag:"Str"},{contents:[],tag:"Space"},{contents:"will",tag:"Str"},{contents:[],tag:"Space"},{contents:"code",tag:"Str"},{contents:[],tag:"Space"},{contents:"review",tag:"Str"},{contents:[],tag:"Space"},{contents:"submissions,",tag:"Str"},{contents:[],tag:"Space"},{contents:"and",tag:"Str"},{contents:[],tag:"Space"},{contents:"a",tag:"Str"},{contents:[],tag:"Space"},{contents:"track",tag:"Str"},{contents:[],tag:"Space"},{contents:"record",tag:"Str"},{contents:[],tag:"Space"},{contents:"of",tag:"Str"},{contents:[],tag:"Space"},{contents:"good",tag:"Str"},{contents:[],tag:"Space"},{contents:"submissions",tag:"Str"},{contents:[],tag:"Space"},{contents:"will",tag:"Str"},{contents:[],tag:"Space"},{contents:"build",tag:"Str"},{contents:[],tag:"Space"},{contents:"confidence,",tag:"Str"},{contents:[],tag:"Space"},{contents:"and",tag:"Str"},{contents:[],tag:"Space"},{contents:"gain",tag:"Str"},{contents:[],tag:"Space"},{contents:"you",tag:"Str"},{contents:[],tag:"Space"},{contents:"access",tag:"Str"},{contents:[],tag:"Space"},{contents:"to",tag:"Str"},{contents:[],tag:"Space"},{contents:"direct",tag:"Str"},{contents:[],tag:"Space"},{contents:"access",tag:"Str"},{contents:[],tag:"Space"},{contents:"to",tag:"Str"},{contents:[],tag:"Space"},{contents:"the",tag:"Str"},{contents:[],tag:"Space"},{contents:"repo.",tag:"Str"}],tag:"Para"},{contents:[{contents:"The",tag:"Str"},{contents:[],tag:"Space"},{contents:"core",tag:"Str"},{contents:[],tag:"Space"},{contents:"team",tag:"Str"},{contents:[],tag:"Space"},{contents:"meets",tag:"Str"},{contents:[],tag:"Space"},{contents:"on",tag:"Str"},{contents:[],tag:"Space"},{contents:"a",tag:"Str"},{contents:[],tag:"Space"},{contents:"google+",tag:"Str"},{contents:[],tag:"Space"},{contents:"hangout",tag:"Str"},{contents:[],tag:"Space"},{contents:"regularly.",tag:"Str"},{contents:[],tag:"Space"},{contents:"If",tag:"Str"},{contents:[],tag:"Space"},{contents:"you",tag:"Str"},{contents:[],tag:"Space"},{contents:"would",tag:"Str"},{contents:[],tag:"Space"},{contents:"like",tag:"Str"},{contents:[],tag:"Space"},{contents:"to",tag:"Str"},{contents:[],tag:"Space"},{contents:"join",tag:"Str"},{contents:[],tag:"Space"},{contents:"the",tag:"Str"},{contents:[],tag:"Space"},{contents:"core",tag:"Str"},{contents:[],tag:"Space"},{contents:"team,",tag:"Str"},{contents:[],tag:"Space"},{contents:"please",tag:"Str"},{contents:[],tag:"Space"},{contents:"consider",tag:"Str"},{contents:[],tag:"Space"},{contents:"supporting",tag:"Str"},{contents:[],tag:"Space"},{contents:"the",tag:"Str"},{contents:[],tag:"Space"},{contents:"project",tag:"Str"},{contents:[],tag:"Space"},{contents:"through",tag:"Str"},{contents:[],tag:"Space"},{contents:"either",tag:"Str"},{contents:[],tag:"Space"},{contents:"code",tag:"Str"},{contents:[],tag:"Space"},{contents:"contributions,",tag:"Str"},{contents:[],tag:"Space"},{contents:"or",tag:"Str"},{contents:[],tag:"Space"},{contents:"a",tag:"Str"},{contents:[],tag:"Space"},{contents:"finanial",tag:"Str"},{contents:[],tag:"Space"},{contents:"commitment",tag:"Str"},{contents:[],tag:"Space"},{contents:"to",tag:"Str"},{contents:[],tag:"Space"},{contents:"support",tag:"Str"},{contents:[],tag:"Space"},{contents:"development.",tag:"Str"}],tag:"Para"},{contents:[3,["forking",[],[]],[{contents:"Forking",tag:"Str"}]],tag:"Header"},{contents:[{contents:"To",tag:"Str"},{contents:[],tag:"Space"},{contents:"contribute",tag:"Str"},{contents:[],tag:"Space"},{contents:"to",tag:"Str"},{contents:[],tag:"Space"},{contents:"Lens",tag:"Str"},{contents:[],tag:"Space"},{contents:"you",tag:"Str"},{contents:[],tag:"Space"},{contents:"should",tag:"Str"},{contents:[],tag:"Space"},{contents:"clone",tag:"Str"},{contents:[],tag:"Space"},{contents:"the",tag:"Str"},{contents:[],tag:"Space"},{contents:"full",tag:"Str"},{contents:[],tag:"Space"},{contents:"Lens",tag:"Str"},{contents:[],tag:"Space"},{contents:"project",tag:"Str"},{contents:[],tag:"Space"},{contents:"first.",tag:"Str"}],tag:"Para"},{contents:[{contents:"Then",tag:"Str"},{contents:[],tag:"Space"},{contents:"you",tag:"Str"},{contents:[],tag:"Space"},{contents:"can",tag:"Str"},{contents:[],tag:"Space"},{contents:"create",tag:"Str"},{contents:[],tag:"Space"},{contents:"your",tag:"Str"},{contents:[],tag:"Space"},{contents:"personal",tag:"Str"},{contents:[],tag:"Space"},{contents:"fork",tag:"Str"},{contents:[],tag:"Space"},{contents:"of",tag:"Str"},{contents:[],tag:"Space"},{contents:"the",tag:"Str"},{contents:[],tag:"Space"},{contents:"module",tag:"Str"},{contents:[],tag:"Space"},{contents:"you",tag:"Str"},{contents:[],tag:"Space"},{contents:"want",tag:"Str"},{contents:[],tag:"Space"},{contents:"contribute",tag:"Str"},{contents:[],tag:"Space"},{contents:"to:",tag:"Str"},{contents:[],tag:"Space"},{contents:"see",tag:"Str"},{contents:[],tag:"Space"},{contents:[[{contents:"here",tag:"Str"}],["https://help.github.com/articles/fork-a-repo",""]],tag:"Link"},{contents:[],tag:"Space"},{contents:"for",tag:"Str"},{contents:[],tag:"Space"},{contents:"explanations.",tag:"Str"}],tag:"Para"},{contents:[{contents:"After",tag:"Str"},{contents:[],tag:"Space"},{contents:"that",tag:"Str"},{contents:[],tag:"Space"},{contents:"you",tag:"Str"},{contents:[],tag:"Space"},{contents:"should",tag:"Str"},{contents:[],tag:"Space"},{contents:"adapt",tag:"Str"},{contents:[],tag:"Space"},{contents:"the",tag:"Str"},{contents:[],tag:"Space"},{contents:[["",[],[]],"project.json"],tag:"Code"},{contents:[],tag:"Space"},{contents:"to",tag:"Str"},{contents:[],tag:"Space"},{contents:"use",tag:"Str"},{contents:[],tag:"Space"},{contents:"your",tag:"Str"},{contents:[],tag:"Space"},{contents:"personal",tag:"Str"},{contents:[],tag:"Space"},{contents:"fork.",tag:"Str"},{contents:[],tag:"Space"},{contents:"E.g.,",tag:"Str"}],tag:"Para"},{contents:[["",["json"],[]],'{\n  "modules": [\n    ...\n    {\n      "repository": "git@github.com:your_user/lens-article.git",\n      "folder": "node_modules/lens-article",\n      "branch": "my_feature"\n    },\n    ...\n  ]\n}'],tag:"CodeBlock"},{contents:["html","<!--\n#### Work with feature branches\n\nA good start is working with fresh feature branches.\n\n1. Create a feature branch across all sub-modules.\n\n   ```bash\n   $ substance --git -- checkout -b <feature_branch_name>\n   ```\n\n2. Edit `project.json` manually (replace branch: master with your feature-branch-name)\n\n3. Checkout configured branches of sub-modules\n \n   ```bash\n   $ substance --checkout\n   ```\n-->\n"],tag:"RawBlock"},{contents:[4,["to-pull-in-upstream-changes-from-master-for-the-entire-project.",[],[]],[{contents:"To",tag:"Str"},{contents:[],tag:"Space"},{contents:"pull",tag:"Str"},{contents:[],tag:"Space"},{contents:"in",tag:"Str"},{contents:[],tag:"Space"},{contents:"upstream",tag:"Str"},{contents:[],tag:"Space"},{contents:"changes",tag:"Str"},{contents:[],tag:"Space"},{contents:"from",tag:"Str"},{contents:[],tag:"Space"},{contents:"master",tag:"Str"},{contents:[],tag:"Space"},{contents:"for",tag:"Str"},{contents:[],tag:"Space"},{contents:"the",tag:"Str"},{contents:[],tag:"Space"},{contents:"entire",tag:"Str"},{contents:[],tag:"Space"},{contents:"project.",tag:"Str"}]],tag:"Header"},{contents:[["",[],[]],"substance --git -- pull origin master:<feature_branch_name>"],tag:"CodeBlock"},{contents:[3,["deployment",[],[]],[{contents:"Deployment",tag:"Str"}]],tag:"Header"},{contents:[{contents:"This",tag:"Str"},{contents:[],tag:"Space"},{contents:"is",tag:"Str"},{contents:[],tag:"Space"},{contents:"not",tag:"Str"},{contents:[],tag:"Space"},{contents:"yet",tag:"Str"},{contents:[],tag:"Space"},{contents:"implemented,",tag:"Str"},{contents:[],tag:"Space"},{contents:"but",tag:"Str"},{contents:[],tag:"Space"},{contents:"soon",tag:"Str"},{contents:[],tag:"Space"},{contents:"you'll",tag:"Str"},{contents:[],tag:"Space"},{contents:"be",tag:"Str"},{contents:[],tag:"Space"},{contents:"able",tag:"Str"},{contents:[],tag:"Space"},{contents:"to",tag:"Str"},{contents:[],tag:"Space"},{contents:"bundle",tag:"Str"},{contents:[],tag:"Space"},{contents:"Lens",tag:"Str"},{contents:[],tag:"Space"},{contents:"as",tag:"Str"},{contents:[],tag:"Space"},{contents:"a",tag:"Str"},{contents:[],tag:"Space"},{contents:"static",tag:"Str"},{contents:[],tag:"Space"},{contents:"web",tag:"Str"},{contents:[],tag:"Space"},{contents:"page",tag:"Str"},{contents:[],tag:"Space"},{contents:"as",tag:"Str"},{contents:[],tag:"Space"},{contents:"simple",tag:"Str"},{contents:[],tag:"Space"},{contents:"as",tag:"Str"},{contents:[],tag:"Space"},{contents:"this:",tag:"Str"}],tag:"Para"},{contents:[["",["bash"],[]],"$ substance --bundle"],tag:"CodeBlock"},{contents:[{contents:"It",tag:"Str"},{contents:[],tag:"Space"},{contents:"creates",tag:"Str"},{contents:[],tag:"Space"},{contents:"a",tag:"Str"},{contents:[],tag:"Space"},{contents:[["",[],[]],"dist"],tag:"Code"},{contents:[],tag:"Space"},{contents:"folder",tag:"Str"},{contents:[],tag:"Space"},{contents:"with",tag:"Str"},{contents:[],tag:"Space"},{contents:"everything",tag:"Str"},{contents:[],tag:"Space"},{contents:"you",tag:"Str"},{contents:[],tag:"Space"},{contents:"need.",tag:"Str"}],tag:"Para"},{contents:[3,["roadmap",[],[]],[{contents:"Roadmap",tag:"Str"}]],tag:"Header"},{contents:[{contents:"The",tag:"Str"},{contents:[],tag:"Space"},{contents:"Roadmap",tag:"Str"},{contents:[],tag:"Space"},{contents:"is",tag:"Str"},{contents:[],tag:"Space"},{contents:"covered",tag:"Str"},{contents:[],tag:"Space"},{contents:"on",tag:"Str"},{contents:[],tag:"Space"},{contents:"the",tag:"Str"},{contents:[],tag:"Space"},{contents:[[{contents:"project",tag:"Str"},{contents:[],tag:"Space"},{contents:"wiki",tag:"Str"}],["https://github.com/elifesciences/lens/wiki/Product-Roadmap",""]],tag:"Link"}],tag:"Para"}]]
},{}],106:[function(t,e){e.exports=[{unMeta:{}},[{contents:[[{contents:[{contents:"I",tag:"Str"},{contents:[],tag:"Space"},{contents:"am",tag:"Str"},{contents:[],tag:"Space"},{contents:"a",tag:"Str"},{contents:[],tag:"Space"},{contents:"listitem",tag:"Str"}],tag:"Plain"}],[{contents:[{contents:"Me",tag:"Str"},{contents:[],tag:"Space"},{contents:"too",tag:"Str"}],tag:"Plain"}],[{contents:[{contents:"Me",tag:"Str"},{contents:[],tag:"Space"},{contents:"three",tag:"Str"}],tag:"Plain"}]],tag:"BulletList"}]]},{}],107:[function(t,e){e.exports=[{unMeta:{}},[{contents:[{contents:[{contents:"This",tag:"Str"},{contents:[],tag:"Space"},{contents:"is",tag:"Str"},{contents:[],tag:"Space"},{contents:"the",tag:"Str"},{contents:[],tag:"Space"},{contents:"first",tag:"Str"},{contents:[],tag:"Space"},{contents:"level",tag:"Str"},{contents:[],tag:"Space"},{contents:"of",tag:"Str"},{contents:[],tag:"Space"},{contents:"quoting.",tag:"Str"}],tag:"Para"},{contents:[{contents:[{contents:"This",tag:"Str"},{contents:[],tag:"Space"},{contents:"is",tag:"Str"},{contents:[],tag:"Space"},{contents:"nested",tag:"Str"},{contents:[],tag:"Space"},{contents:"blockquote.",tag:"Str"}],tag:"Para"}],tag:"BlockQuote"},{contents:[{contents:"Back",tag:"Str"},{contents:[],tag:"Space"},{contents:"to",tag:"Str"},{contents:[],tag:"Space"},{contents:"the",tag:"Str"},{contents:[],tag:"Space"},{contents:"first",tag:"Str"},{contents:[],tag:"Space"},{contents:"level.",tag:"Str"}],tag:"Para"}],tag:"BlockQuote"}]]},{}],108:[function(t,e){e.exports=[{unMeta:{}},[{contents:[{contents:[{contents:"This",tag:"Str"},{contents:[],tag:"Space"},{contents:"is",tag:"Str"},{contents:[],tag:"Space"},{contents:"the",tag:"Str"},{contents:[],tag:"Space"},{contents:"first",tag:"Str"},{contents:[],tag:"Space"},{contents:[{contents:"level",tag:"Str"}],tag:"Emph"},{contents:[],tag:"Space"},{contents:"of",tag:"Str"},{contents:[],tag:"Space"},{contents:"quoting.",tag:"Str"}],tag:"Para"},{contents:[{contents:[{contents:"This",tag:"Str"},{contents:[],tag:"Space"},{contents:"is",tag:"Str"},{contents:[],tag:"Space"},{contents:"nested",tag:"Str"},{contents:[],tag:"Space"},{contents:[{contents:"blockquote",tag:"Str"}],tag:"Strong"},{contents:".",tag:"Str"}],tag:"Para"},{contents:[{contents:[{contents:"And",tag:"Str"},{contents:[],tag:"Space"},{contents:"a",tag:"Str"},{contents:[],tag:"Space"},{contents:[{contents:"another",tag:"Str"}],tag:"Emph"},{contents:[],tag:"Space"},{contents:"level",tag:"Str"},{contents:[],tag:"Space"},{contents:"is",tag:"Str"},{contents:[],tag:"Space"},{contents:"here.",tag:"Str"}],tag:"Para"}],tag:"BlockQuote"}],tag:"BlockQuote"},{contents:[{contents:"Back",tag:"Str"},{contents:[],tag:"Space"},{contents:"to",tag:"Str"},{contents:[],tag:"Space"},{contents:"the",tag:"Str"},{contents:[],tag:"Space"},{contents:[{contents:"first",tag:"Str"}],tag:"Emph"},{contents:[],tag:"Space"},{contents:"level.",tag:"Str"}],tag:"Para"}],tag:"BlockQuote"}]]},{}],109:[function(t,e){e.exports=[{unMeta:{}},[{contents:[{contents:"This",tag:"Str"},{contents:[],tag:"Space"},{contents:"is",tag:"Str"},{contents:[],tag:"Space"},{contents:"a",tag:"Str"},{contents:[],tag:"Space"},{contents:"normal",tag:"Str"},{contents:[],tag:"Space"},{contents:"paragraph:",tag:"Str"}],tag:"Para"},{contents:[["",[],[]],'function foo() {\n  returb "bar";\n}'],tag:"CodeBlock"}]]},{}],110:[function(t,e){e.exports=[{unMeta:{}},[{contents:[{contents:"This",tag:"Str"},{contents:[],tag:"Space"},{contents:"is",tag:"Str"},{contents:[],tag:"Space"},{contents:"paragraph",tag:"Str"},{contents:[],tag:"Space"},{contents:"1.",tag:"Str"}],tag:"Para"},{contents:[{contents:[[{contents:"lens",tag:"Str"}],["http://backbonejs.org/docs/images/lens.png","fig:"]],tag:"Image"}],tag:"Para"},{contents:[{contents:"This",tag:"Str"},{contents:[],tag:"Space"},{contents:"is",tag:"Str"},{contents:[],tag:"Space"},{contents:"paragraph",tag:"Str"},{contents:[],tag:"Space"},{contents:"2.",tag:"Str"}],tag:"Para"}]]},{}],111:[function(t,e){e.exports=[{unMeta:{}},[{contents:[{contents:"I",tag:"Str"},{contents:[],tag:"Space"},{contents:"am",tag:"Str"},{contents:[],tag:"Space"},{contents:"a",tag:"Str"},{contents:[],tag:"Space"},{contents:"paragraph",tag:"Str"}],tag:"Para"},{contents:[[{contents:[{contents:"List",tag:"Str"},{contents:[],tag:"Space"},{contents:"item",tag:"Str"},{contents:[],tag:"Space"},{contents:"1",tag:"Str"}],tag:"Plain"}],[{contents:[{contents:"List",tag:"Str"},{contents:[],tag:"Space"},{contents:"item",tag:"Str"},{contents:[],tag:"Space"},{contents:"2",tag:"Str"}],tag:"Plain"}],[{contents:[{contents:"List",tag:"Str"},{contents:[],tag:"Space"},{contents:"item",tag:"Str"},{contents:[],tag:"Space"},{contents:"3",tag:"Str"}],tag:"Plain"}]],tag:"BulletList"}]]},{}],112:[function(t,e){e.exports=[{unMeta:{author:{contents:{address:{contents:{state:{contents:[{contents:"Phantasia",tag:"Str"}],tag:"MetaInlines"},street:{contents:[{contents:"The",tag:"Str"},{contents:[],tag:"Space"},{contents:"Street",tag:"Str"},{contents:[],tag:"Space"},{contents:"111",tag:"Str"}],tag:"MetaInlines"},zip:{contents:"123",tag:"MetaString"}},tag:"MetaMap"},name:{contents:[{contents:"Mickey",tag:"Str"},{contents:[],tag:"Space"},{contents:"Mouse",tag:"Str"}],tag:"MetaInlines"}},tag:"MetaMap"},keywords:{contents:[{contents:[{contents:"yaml",tag:"Str"}],tag:"MetaInlines"},{contents:[{contents:"meta",tag:"Str"}],tag:"MetaInlines"}],tag:"MetaList"},title:{contents:[{contents:"MyDoc",tag:"Str"}],tag:"MetaInlines"}}},[{contents:[{contents:"This",tag:"Str"},{contents:[],tag:"Space"},{contents:"is",tag:"Str"},{contents:[],tag:"Space"},{contents:"document",tag:"Str"},{contents:[],tag:"Space"},{contents:"with",tag:"Str"},{contents:[],tag:"Space"},{contents:"a",tag:"Str"},{contents:[],tag:"Space"},{contents:"yaml",tag:"Str"},{contents:[],tag:"Space"},{contents:"meta",tag:"Str"},{contents:[],tag:"Space"},{contents:"header.",tag:"Str"}],tag:"Para"}]]},{}],113:[function(t,e){var n=t("substance-util");t("underscore");var r=n.errors,i=r.define("ImporterError"),o=r.define("ExporterError");e.exports={ImporterError:i,ExporterError:o}},{"substance-util":219,underscore:225}],114:[function(t,e){"use strict";var n=t("substance-document"),r=n.Annotator,i=[["Emph","emphasis"],["Strong","strong"],["Code","code"],["Link","link"]],o=function(t){for(var e=0;e<i.length;e++)if(i[e][1]===t)return i[e][0];return void 0},s=function(){};s.Prototype=function(){this.export=function(t){var e=[],n={unMeta:{}};e.push(n);var i={};i.article=t,i.annotationIndex=r.createIndex(t);var o=this.document(i);return e.push(o),e},this.document=function(t){for(var e=[],n=t.article.query(["content","nodes"]),r=0;r<n.length;r++){var i=n[r];"text"===i.type?e.push(this.paragraph(t,i)):"heading"===i.type?e.push(this.heading(t,i)):"codeblock"==i.type?e.push(this.codeblock(t,i)):"image"==i.type?e.push(this.image(t,i)):"figure"==i.type?e.push(this.figure(t,i)):"list"==i.type&&e.push(this.list(t,i))}return e},this.paragraph=function(t,e){var n=t.annotationIndex.get(e.id),r=this.annotated_text(t,e.content,n),i={contents:r,tag:"Para"};return i},this.plain=function(t,e){var n=t.annotationIndex.get(e.id),r=this.annotated_text(t,e.content,n),i={contents:r,tag:"Plain"};return i},this.heading=function(t,e){var n=t.annotationIndex.get(e.id),r=e.content.toLowerCase().split(" ").join("-"),i=[r,[],[]],o=this.annotated_text(t,e.content,n),s={contents:[e.level,i,o],tag:"Header"};return s},this.codeblock=function(t,e){var n=e.content,r={contents:[["",[],[]],n],tag:"CodeBlock"};return r},this.image=function(t,e){var n={contents:[{tag:"Image",contents:[[{contents:[],tag:"Str"}],[e.url,"fig:"]]}],tag:"Para"};return n},this.figure=function(t,e){var n;if(""!==e.caption){var r=this.paragraph(t,e.getCaption());n=r.contents}else n=[{contents:[],tag:"Str"}];var i=e.getImage(),o={contents:[{contents:[n,[i.url,"fig:"]],tag:"Image"}],tag:"Para"};return o},this.list=function(t,e){var n=[];if(e.items!=[])for(var r=e.getItems(),i=0;i<e.items.length;i++){var o=this.plain(t,r[i]);n.push([o])}var s;return s=e.properties.ordered?{tag:"OrderedList",contents:[[1,"Decimal","Period"],n]}:{tag:"BulletList",contents:n}},this.annotated_text=function(t,e,n){var i={tag:"ROOT",contents:[]},s=new r.Fragmenter({levels:{emphasis:1,strong:1,code:1,link:1}});return s.onText=function(t,e){var n=t.tag;if("Code"===n)return t.contents.push(e),void 0;var r=t.contents;"Link"===n&&(r=r[0]);for(var i=e.split(" "),o=0;o<i.length;o++)o>0&&r.push({contents:[],tag:"Space"}),i[o].length>0&&r.push({contents:i[o],tag:"Str"})},s.onEnter=function(e,n){var r=o(e.type);if(void 0===r)return n;var i={tag:r,contents:[]};return"Link"==r?i.contents=[[],[t.article.get([e.id,"url"]),""]]:"Code"==r&&(i.contents=[["",[],[]]]),n.contents.push(i),i},s.start(i,e,n),i.contents}},s.prototype=new s.Prototype,e.exports=s},{"substance-document":133}],115:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-article"),i=t("./converter_errors").ImporterError,o=function(){var t={};this.nextId=function(e){return t[e]=t[e]||0,t[e]++,e+"_"+t[e]};var e=[];this.current=function(){return e[e.length-1]},this.push=function(t){e.push(t)},this.pop=function(){return e.pop()},this.annotations=[]},s={Emph:"emphasis",Strong:"strong",Link:"link",Code:"code"},a=function(t){return void 0!==s[t]},c=function(){};c.Prototype=function(){var t=function(t){for(var e=[],n={tag:"",contents:null},r=!1,i=0;i<t.length;i++){var o,s=t[i],a=s.tag;switch(a){case"Str":case"Space":case"Emph":case"Strong":case"Code":case"Link":o=!0;break;default:r=!0,o=!1}o?("Para"!==n.tag&&(n={tag:"Para",contents:[]},e.push(n)),n.contents.push(s)):(e.push(s),n=s)}return{isRichParagraph:r,blocks:e}};this.import=function(t){var e=new o;return this.document(e,t)},this.document=function(e,n){var i=n[0],o=new r({id:i.doc_id});e.doc=o,i.unMeta&&this.meta(e,i.unMeta);var s,a=[];for(s=0;s<n[1].length;s++){var c=n[1][s];if("Para"===c.tag){var p=t(c.contents);a=a.concat(p.blocks)}else a.push(c)}for(s=0;s<a.length;s++){var u=this.topLevelNode(e,a[s]);u&&o.show("content",u.id,s)}for(s=0;s<e.annotations.length;s++)o.create(e.annotations[s]);return o},this.topLevelNode=function(t,e){var n=e.tag,r=e.contents;switch(n){case"HorizontalRule":return!1;case"Header":return this.header(t,r);case"Para":return this.paragraph(t,r);case"CodeBlock":return this.codeblock(t,r);case"RawBlock":return this.rawblock(t,r);case"BlockQuote":return this.blockquote(t,r);case"BulletList":return this.list(t,r,!1);case"OrderedList":return this.list(t,r,!0);case"Image":return this.figure(t,r);case"Math":return this.math(t,r);default:throw new i("Node not supported: "+n)}},this.header=function(t,e){var n=t.doc,r=e[0],i=t.nextId("header"),o={id:i,type:"heading",level:r,content:null};return t.push(o),o.content=this.text(t,e[2]),t.pop(),n.create(o)},this.paragraph=function(e,n){var r=t(n);return r.isRichParagraph?this.richParagraph(e,r.blocks):this.simpleParagraph(e,r.blocks[0])},this.richParagraph=function(t,e){for(var r=t.doc,i=[],o=0;o<e.length;o++){var s=e[o],a=this.topLevelNode(s);a&&i.push(a)}if(i.length<2)return i[1];var c=t.nextId("paragraph"),p={id:c,type:"paragraph",content:n.map(i,function(t){return t.id})};return r.create(p)},this.simpleParagraph=function(t,e){var n=t.doc,r=t.nextId("text"),i={id:r,type:"text"};return t.push(i),i.content=this.text(t,e.contents),t.pop(),n.create(i)},this.rawblock=function(t,e){var n=t.doc,r=t.nextId("text"),i={id:r,type:"text",content:e[1]};return n.create(i)},this.codeblock=function(t,e){var n=t.doc,r=t.nextId("codeblock"),i={id:r,type:"codeblock",content:e[1]};return n.create(i)},this.blockquote=function(t,e){for(var n=t.doc,r=0;r<e.length;r++){var o,s=e[r],a=s.tag,c=s.contents;if("Para"===a)o=this.paragraph(t,c),n.show("content",o.id,-1);else{if("BlockQuote"!==a)throw new i("Node not supported as blockquote: "+JSON.stringify(o));this.blockquote(t,c)}}return!1},this.figure=function(t,e){var n=t.doc,r=t.nextId("image"),i=e[1][0],o={id:r,type:"image",url:i};n.create(o);var s=this.caption(t,e[0]),a=t.nextId("figure"),c={id:a,type:"figure",image:r,caption:s};return n.create(c)},this.caption=function(t,e){var n=t.doc,r=t.nextId("text"),i={id:r,type:"text",content:null};return t.push(i),i.content=this.text(t,e),t.pop(),n.create(i),r},this.list=function(t,e,n){var r=t.doc,o=t.nextId("list"),s={id:o,type:"list",items:[],ordered:n};t.push(s),n&&(e=e[1]);for(var a=0;a<e.length;a++){var c,p=e[a][0],u=p.tag,h=p.contents;if("Plain"!==u)throw new i("Node not supported as list item: "+JSON.stringify(p));c=this.paragraph(t,h),s.items.push(c.id)}return t.pop(),r.create(s)},this.math=function(t,e){var n=t.doc,r="InlineMath"===e[0],i=e[1],o=t.nextId("formula"),s={id:o,type:"formula",data:i,format:"latex",inline:r};return n.create(s)},this.text=function(t,e,n){for(var r,o=[],s=n||0,c=0;c<e.length;c++){var p=e[c],u=p.tag,h=p.contents;switch(u){case"Space":o.push(" "),s++;break;case"Str":r=h,o.push(r),s+=r.length;break;default:if(!a(u))throw new i("Unsupported fragment for textish: "+p);r=this.annotation(t,p,s),o.push(r),s+=r.length}}return o.join("")},this.annotation=function(t,e,r){var o=t.current();if(void 0===o)throw new i("No target for annotation available");var a,c={},p=e.tag,u=e.contents;"Link"===p?(c.url=u[1][0],a=this.text(t,u[0],r)):a="Code"===p?u[1]:this.text(t,u,r);var h=r+a.length,l=s[p],d=t.nextId(l),f=n.extend({id:d,type:l,path:[o.id,"content"],range:[r,h]},c);return t.annotations.push(f),a},this.meta=function(t,e){var r=t.doc;if(0!==Object.keys(e).length){var i;n.isObject(e)&&(i=this.metaMap(t,e)),i&&(console.log("setting meta data",i),r.set(["document","meta"],i))}},this.getMetaValue=function(t,e){var n,r=e.tag,i=e.contents;switch(r){case"MetaMap":n=this.metaMap(t,i);break;case"MetaList":n=this.metaList(t,i);break;case"MetaInlines":n=this.metaInlines(t,i);break;default:n=i}return n},this.metaMap=function(t,e){var r={};return n.each(e,function(e,n){r[n]=this.getMetaValue(t,e)},this),r},this.metaList=function(t,e){var r=[];return n.each(e,function(e){r.push(this.getMetaValue(t,e))},this),r},this.metaInlines=function(t,e){for(var n=[],r=0;r<e.length;r++){var i=e[r],o=i.tag;switch(o){case"Space":n.push(" ");break;case"Str":n.push(i.contents);break;default:console.error("Unknown type for MetaInlines ",o)}}return n.join("")}},c.prototype=new c.Prototype,e.exports=c},{"./converter_errors":113,"substance-article":71,underscore:225}],116:[function(t){var e=self;t("./pandoc_importer_test"),t("./pandoc_exporter_test"),e.window},{"./pandoc_exporter_test":117,"./pandoc_importer_test":118}],117:[function(t){"use strict";var e=t("substance-test"),n=e.assert,r=e.registerTest,i=t("../src/pandoc_importer"),o=t("../src/pandoc_exporter"),s=function(){this.setup=function(){this.importer=new i,this.exporter=new o},this.actions=["Paragraph and Heading",function(){var e=t("../data/pandoc/1_12/heading_and_paragraph.json"),r=this.importer.import(e),i=this.exporter.export(r);n.isDeepEqual(e[1],i[1])},"Annotated Paragraph",function(){var e=t("../data/pandoc/1_12/annotated_paragraph.json"),r=this.importer.import(e),i=this.exporter.export(r);n.isDeepEqual(e[1],i[1])},"List",function(){var e=t("../data/pandoc/1_12/list.json"),r=this.importer.import(e),i=this.exporter.export(r);n.isDeepEqual(e[1],i[1])},"Paragraph and List",function(){var e=t("../data/pandoc/1_12/paragraph_and_list.json"),r=this.importer.import(e),i=this.exporter.export(r);n.isDeepEqual(e[1],i[1])},"Codeblock",function(){var e=t("../data/pandoc/1_12/paragraph_and_codeblock.json"),r=this.importer.import(e),i=this.exporter.export(r);n.isDeepEqual(e[1],i[1])},"Links",function(){var e=t("../data/pandoc/1_12/inline_link.json"),r=this.importer.import(e),i=this.exporter.export(r);n.isDeepEqual(e[1],i[1])},"Inline code",function(){var e=t("../data/pandoc/1_12/inline_code.json"),r=this.importer.import(e),i=this.exporter.export(r);n.isDeepEqual(e[1],i[1])},"Paragraph with Image and caption",function(){var e=t("../data/pandoc/1_12/paragraph_and_image.json"),r=this.importer.import(e),i=this.exporter.export(r);n.isDeepEqual(e[1],i[1])},"Annotated List",function(){var e=t("../data/pandoc/1_12/annotated_list.json"),r=this.importer.import(e),i=this.exporter.export(r);n.isDeepEqual(e[1],i[1])}]};r(["Substance.Converter","Pandoc Exporter"],new s)},{"../data/pandoc/1_12/annotated_list.json":97,"../data/pandoc/1_12/annotated_paragraph.json":98,"../data/pandoc/1_12/heading_and_paragraph.json":100,"../data/pandoc/1_12/inline_code.json":102,"../data/pandoc/1_12/inline_link.json":103,"../data/pandoc/1_12/list.json":106,"../data/pandoc/1_12/paragraph_and_codeblock.json":109,"../data/pandoc/1_12/paragraph_and_image.json":110,"../data/pandoc/1_12/paragraph_and_list.json":111,"../src/pandoc_exporter":114,"../src/pandoc_importer":115,"substance-test":210}],118:[function(t){"use strict";var e=t("substance-test"),n=e.assert,r=e.registerTest,i=t("../src/pandoc_importer"),o=t("substance-document"),s=o.Annotator,a=function(){this.setup=function(){this.importer=new i},this.actions=["Heading and Paragraph",function(){var e=t("../data/pandoc/1_12/heading_and_paragraph.json"),r=this.importer.import(e),i=r.get("header_1"),o=r.get("text_1"),s=r.get("header_2"),a=r.get("header_3");n.isDefined(i),n.isDefined(o),n.isDefined(s),n.isDefined(a),n.isEqual("Heading",i.content),n.isEqual("And a paragraph",o.content),n.isEqual(1,i.level),n.isEqual(2,s.level),n.isEqual(3,a.level),n.isArrayEqual(["header_1","text_1","header_2","header_3"],r.get("content").nodes)},"Annotated Paragraph",function(){var e=t("../data/pandoc/1_12/annotated_paragraph.json"),r=this.importer.import(e),i=s.createIndex(r),o=r.get("text_1");n.isDefined(o),n.isEqual("I am an annotated paragraph.",o.content),n.isArrayEqual(["text_1"],r.get("content").nodes);var a=i.get("text_1");n.isDefined(a.emphasis_1),n.isDefined(a.strong_1),n.isArrayEqual(["text_1","content"],a.emphasis_1.path),n.isArrayEqual([8,17],a.emphasis_1.range)},"List",function(){var e=t("../data/pandoc/1_12/list.json"),r=this.importer.import(e),i=r.get("list_1"),o=i.getItems();n.isDefined(i),n.isEqual(3,o.length),n.isEqual("I am a listitem",o[0].content),n.isEqual("Me too",o[1].content),n.isEqual("Me three",o[2].content)},"Paragraph and List",function(){var e=t("../data/pandoc/1_12/paragraph_and_list.json"),r=this.importer.import(e),i=r.get("text_1"),o=r.get("list_1"),s=o.getItems();n.isDefined(i),n.isDefined(o),n.isEqual(3,s.length),n.isEqual("I am a paragraph",i.content),n.isEqual("List item 1",s[0].content),n.isEqual("List item 2",s[1].content),n.isEqual("List item 3",s[2].content)},"Blockquotes are flattened into Paragraphs (for now)",function(){var e=t("../data/pandoc/1_12/block_quote.json"),r=this.importer.import(e),i=r.get("text_1"),o=r.get("text_2");n.isEqual("This is a blockquote",i.content),n.isEqual("...with two paragraphs.",o.content),n.isArrayEqual(["text_1","text_2"],r.get("content").nodes)},"Even nested Blockquotes are flattened.",function(){var e=t("../data/pandoc/1_12/nested_block_quotes.json"),r=this.importer.import(e),i=r.get("text_1"),o=r.get("text_2"),s=r.get("text_3");n.isEqual("This is the first level of quoting.",i.content),n.isEqual("This is nested blockquote.",o.content),n.isEqual("Back to the first level.",s.content),n.isArrayEqual(["text_1","text_2","text_3"],r.get("content").nodes)},"Codeblock",function(){var e=t("../data/pandoc/1_12/paragraph_and_codeblock.json"),r=this.importer.import(e),i=r.get("text_1"),o=r.get("codeblock_1");n.isEqual("This is a normal paragraph:",i.content),n.isEqual('function foo() {\n  returb "bar";\n}',o.content),n.isArrayEqual(["text_1","codeblock_1"],r.get("content").nodes)},"Horitontal rulers are ignored.",function(){var e=t("../data/pandoc/1_12/horizontal_ruler.json"),r=this.importer.import(e);n.isArrayEqual(["text_1","text_2"],r.get("content").nodes)},"Links are annotations.",function(){var e=t("../data/pandoc/1_12/inline_link.json"),r=this.importer.import(e),i=s.createIndex(r),o=i.get(),a=r.get("text_1"),c=o.link_1;n.isDefined(a),n.isDefined(c),n.isEqual("link",c.type),n.isEqual("This is an example inline link.",a.content),n.isArrayEqual(["text_1","content"],c.path),n.isArrayEqual([8,18],c.range),n.isArrayEqual(["text_1"],r.get("content").nodes)},"Inline code is an annotation.",function(){var e=t("../data/pandoc/1_12/inline_code.json"),r=this.importer.import(e),i=s.createIndex(r),o=i.get(),a=r.get("text_1"),c=o.code_1;n.isDefined(a),n.isDefined(c),n.isEqual("code",c.type),n.isEqual("Don't call me foo(), fool",a.content),n.isArrayEqual(["text_1","content"],c.path),n.isArrayEqual([14,19],c.range),n.isArrayEqual(["text_1"],r.get("content").nodes)},"Paragraph with Image.",function(){var e=t("../data/pandoc/1_12/paragraph_and_image.json"),r=this.importer.import(e),i=r.get("text_1");r.get("figure_1");var o=r.get("image_1"),s=r.get("text_2"),a=r.get("text_3");n.isDefined(i),n.isDefined(o),n.isDefined(s),n.isDefined(a),n.isEqual("This is paragraph 1.",i.content),n.isEqual("http://backbonejs.org/docs/images/lens.png",o.url),n.isEqual("lens",s.content),n.isEqual("This is paragraph 2.",a.content),n.isArrayEqual(["text_1","figure_1","text_3"],r.get("content").nodes)},"Annotated List",function(){var e=t("../data/pandoc/1_12/annotated_list.json"),r=this.importer.import(e),i=s.createIndex(r),o=r.get("list_1"),a=i.get();n.isDefined(o),n.isDefined(r.get("text_1")),n.isDefined(r.get("text_2")),n.isDefined(r.get("text_3")),n.isDefined(a.emphasis_1),n.isDefined(a.strong_1);var c=r.get("text_1"),p=r.get("text_2"),u=r.get("text_3"),h=a.emphasis_1,l=a.strong_1;n.isEqual("I am a listitem",c.content),n.isEqual("Me too",p.content),n.isEqual("Me three",u.content),n.isArrayEqual(["text_2","content"],h.path),n.isArrayEqual([3,6],h.range),n.isArrayEqual(["text_3","content"],l.path),n.isArrayEqual([3,8],l.range)},"Annotations in Nested Blockquotes",function(){var e=t("../data/pandoc/1_12/nested_block_quotes_with_annotations.json"),r=this.importer.import(e),i=s.createIndex(r),o=r.get("text_1"),a=r.get("text_2"),c=r.get("text_3"),p=r.get("text_4"),u=i.get(),h=u.emphasis_1,l=u.strong_1,d=u.emphasis_2,f=u.emphasis_3;n.isDefined(o),n.isDefined(a),n.isDefined(c),n.isDefined(p),n.isDefined(h),n.isDefined(l),n.isDefined(d),n.isDefined(f),n.isEqual("This is the first level of quoting.",o.content),n.isEqual("This is nested blockquote.",a.content),n.isEqual("And a another level is here.",c.content),n.isEqual("Back to the first level.",p.content),n.isArrayEqual(["text_1","content"],h.path),n.isArrayEqual([18,23],h.range),n.isArrayEqual(["text_2","content"],l.path),n.isArrayEqual([15,25],l.range),n.isArrayEqual(["text_3","content"],d.path),n.isArrayEqual([6,13],d.range),n.isArrayEqual(["text_4","content"],f.path),n.isArrayEqual([12,17],f.range)},"Convert eLife Lens REAMDE",function(){var e=t("../data/pandoc/1_12/lens_readme.json"),r=this.importer.import(e),i=s.createIndex(r),o=i.get(),a=["header_1","codeblock_1","text_1","text_2","header_2","text_3","text_4","header_3","list_1","text_6","list_2","text_8","list_3","text_10","list_4","text_12","header_4","text_13","text_14","text_15","text_16","text_17","text_18","header_5","text_19","text_20","text_21","codeblock_2","text_22","header_6","codeblock_3","header_7","text_23","codeblock_4","text_24","header_8","text_25"],c=r.get("content").nodes,p=o.code_1,u=o.code_2,h=o.code_3,l=o.code_4,d=o.code_5,f=o.code_6,g=o.code_7;n.isArrayEqual(["text_6","content"],p.path),n.isArrayEqual([0,118],p.range),n.isArrayEqual(["text_8","content"],u.path),n.isArrayEqual([0,61],u.range),n.isArrayEqual(["text_10","content"],h.path),n.isArrayEqual([0,41],h.range),n.isArrayEqual(["text_11","content"],l.path),n.isArrayEqual([51,72],l.range),n.isArrayEqual(["text_12","content"],d.path),n.isArrayEqual([0,19],d.range),n.isArrayEqual(["text_21","content"],f.path),n.isArrayEqual([32,44],f.range),n.isArrayEqual(["text_24","content"],g.path),n.isArrayEqual([13,17],g.range),n.isArrayEqual([13,17],g.range),n.isArrayEqual(a,c)},"Document with YAML meta header",function(){var e=t("../data/pandoc/1_12/with_yaml_meta.json"),r=this.importer.import(e),i=r.get(["document","meta"]),o={title:"MyDoc",author:{name:"Mickey Mouse",address:{street:"The Street 111",zip:"123",state:"Phantasia"}},keywords:["yaml","meta"]};n.isObjectEqual(o,i)},"Inline formula",function(){var e=t("../data/pandoc/1_12/inline_math.json"),n=this.importer.import(e);n.get("paragraph_1"),n.get("text_1"),n.get("formula_1"),n.get("text_2"),n.get("formula_1"),n.get("text_2")}]};r(["Substance.Converter","Pandoc Importer"],new a)},{"../data/pandoc/1_12/annotated_list.json":97,"../data/pandoc/1_12/annotated_paragraph.json":98,"../data/pandoc/1_12/block_quote.json":99,"../data/pandoc/1_12/heading_and_paragraph.json":100,"../data/pandoc/1_12/horizontal_ruler.json":101,"../data/pandoc/1_12/inline_code.json":102,"../data/pandoc/1_12/inline_link.json":103,"../data/pandoc/1_12/inline_math.json":104,"../data/pandoc/1_12/lens_readme.json":105,"../data/pandoc/1_12/list.json":106,"../data/pandoc/1_12/nested_block_quotes.json":107,"../data/pandoc/1_12/nested_block_quotes_with_annotations.json":108,"../data/pandoc/1_12/paragraph_and_codeblock.json":109,"../data/pandoc/1_12/paragraph_and_image.json":110,"../data/pandoc/1_12/paragraph_and_list.json":111,"../data/pandoc/1_12/with_yaml_meta.json":112,"../src/pandoc_importer":115,"substance-document":133,"substance-test":210}],119:[function(t,e){"use strict";var n={};n.VERSION="0.8.0",n.Graph=t("./src/graph"),e.exports=n},{"./src/graph":121}],120:[function(t,e){"use strict";var n=t("substance-chronicle"),r=t("substance-operator"),i=function(t){this.graph=t,this.graph.state="ROOT"};i.Prototype=function(){this.apply=function(t){this.graph.__apply__(t),this.graph.updated_at=new Date(t.timestamp)},this.invert=function(t){return r.ObjectOperation.fromJSON(t).invert()},this.transform=function(t,e,n){return r.ObjectOperation.transform(t,e,n)},this.reset=function(){this.graph.reset()},this.getState=function(){return this.graph.state},this.setState=function(t){this.graph.state=t}},i.Prototype.prototype=n.Versioned.prototype,i.prototype=new i.Prototype,e.exports=i},{"substance-chronicle":76,"substance-operator":184}],121:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util"),i=r.errors,o=t("./schema"),s=t("./property"),a=t("substance-chronicle"),c=t("substance-operator"),p=t("./persistence_adapter"),u=t("./chronicle_adapter"),h=t("./graph_index"),l=i.define("GraphError"),d=["object","array","string","number","boolean","date"],f=function(t){return n.isArray(t)&&(t=t[0]),d.indexOf(t)>=0},g=function(t,e){if(e=e||{},this.schema=new o(t),this.schema.id&&e.seed&&e.seed.schema&&!n.isEqual(e.seed.schema,[this.schema.id,this.schema.version]))throw new l(["Graph does not conform to schema. Expected: ",this.schema.id+"@"+this.schema.version," Actual: ",e.seed.schema[0]+"@"+e.seed.schema[1]].join(""));if(this.objectAdapter=new g.ObjectAdapter(this),this.nodes={},this.indexes={},this.__mode__=e.mode||g.DEFAULT_MODE,this.__seed__=e.seed,this.isVersioned=!!e.chronicle,this.isPersistent=!!e.store,this.isVersioned&&(this.chronicle=e.chronicle,this.chronicle.manage(new g.ChronicleAdapter(this))),this.isPersistent){var r=e.store.hash("nodes");this.__store__=e.store,this.__nodes__=r,this.isVersioned&&(this.__version__=e.store.hash("__version__")),this.objectAdapter=new p(this.objectAdapter,r)}e.load?this.load():this.init(),e.graph&&this.merge(e.graph)};g.Prototype=function(){var t=new g.Private;n.extend(this,r.Events),this.create=function(t){var e=c.ObjectOperation.Create([t.id],t);return this.apply(e)},this.delete=function(t){var e=this.get(t);if(void 0===e)throw new l("Could not resolve a node with id "+t);e.toJSON&&(e=e.toJSON());var n=c.ObjectOperation.Delete([t],e);return this.apply(n)},this.update=function(t,e){var r=this.resolve(t);if(!r)throw new l("Could not resolve property with path "+JSON.stringify(t));if(n.isArray(e))if("string"===r.baseType)e=c.TextOperation.fromSequence(r.get(),e);else{if("array"!==r.baseType)throw new l("There is no convenient notation supported for this type: "+r.baseType);e=c.ArrayOperation.create(r.get(),e)}if(e){var i=c.ObjectOperation.Update(t,e,r.baseType);return this.apply(i)}},this.set=function(t,e){var n=this.resolve(t);if(!n)throw new l("Could not resolve property with path "+JSON.stringify(t));var r=n.get(),i=c.ObjectOperation.Set(t,r,e);return this.apply(i)},this.__apply__=function(t){c.Helpers.each(t,function(t){t.apply(this.objectAdapter),this.updated_at=new Date,this._internalUpdates(t),n.each(this.indexes,function(e){e.onGraphChange(t)},this),this.trigger("operation:applied",t,this)},this)},this._internalUpdates=function(t){c.Helpers.each(t,function(t){n.each(this.indexes,function(e){e.onGraphChange(t)},this)},this)},this.apply=function(t){return this.__apply__(t),!this.__is_initializing__&&this.isVersioned&&(t.timestamp=new Date,this.chronicle.record(r.clone(t))),t},this.get=function(t){if(!n.isArray(t)&&!n.isString(t))throw new l("Invalid argument path. Must be String or Array");if(arguments.length>1&&(t=n.toArray(arguments)),n.isString(t))return this.nodes[t];var e=this.resolve(t);return e.get()},this.query=function(e){var n=this.resolve(e),r=n.type,i=n.baseType,o=n.get();return"array"===i?t.queryArray.call(this,o,r):f(i)?o:this.get(o)},this.toJSON=function(){return{id:this.id,schema:[this.schema.id,this.schema.version],nodes:r.deepclone(this.nodes)}},this.contains=function(t){return!!this.nodes[t]},this.resolve=function(t){return new s(this,t)},this.reset=function(){this.isPersistent&&this.__nodes__&&this.__nodes__.clear(),this.init(),this.isVersioned&&(this.state=a.ROOT),this.trigger("graph:reset")},this.init=function(){this.__is_initializing__=!0,this.nodes=this.__seed__?r.clone(this.__seed__.nodes):{},n.each(this.indexes,function(t){t.reset()}),this.isPersistent&&n.each(this.nodes,function(t,e){this.__nodes__.set(e,t)},this),delete this.__is_initializing__},this.merge=function(t){return n.each(t.nodes,function(t){this.create(t)},this),this},this.traverse=function(t){return n.map(this.getView(t),function(t){return this.get(t)},this)},this.load=function(){if(!this.isPersistent)return console.log("Graph is not persistent."),void 0;this.__is_initializing__=!0,this.nodes={},this.indexes={};for(var e=this.__nodes__.keys(),n=0;n<e.length;n++)t.create.call(this,this.__nodes__.get(e[n]));return this.isVersioned&&(this.state=this.__version__.get("state")||"ROOT"),delete this.__is_initializing__,this},this.cotransform=function(t,e){if("create"===e.type)t.create(e.val);else if("delete"===e.type)t.delete(e.val);else{var r,i=this.resolve(e.path),o=i.get();if(void 0===o)return;r="set"===e.type?e.original:e.diff.invert().apply(n.clone(o)),t.update(i.node,i.key,o,r)}},this.addIndex=function(t,e){if(this.indexes[t])throw new l("Index with name "+t+"already exists.");var n=new h(this,e);return this.indexes[t]=n,n},this.removeIndex=function(t){delete this.indexes[t]}},g.STRICT_INDEXING=2,g.DEFAULT_MODE=g.STRICT_INDEXING,g.Private=function(){var t=this;this.createNode=function(t,e){if(!e.id||!e.type)throw new l("Can not create Node: 'id' and 'type' are mandatory.");var i=t.type(e.type);if(!i)throw new l("Type '"+e.type+"' not found in the schema");var o=t.properties(e.type),s={type:e.type,id:e.id};return n.each(o,function(n,i){var o=t.propertyBaseType(e.type,i),a=void 0!==e[i]?e[i]:t.defaultValue(o);s[i]=r.deepclone(a)}),s},this.create=function(e){var n=t.createNode(this.schema,e);if(this.contains(n.id))throw new l("Node already exists: "+n.id);return this.nodes[n.id]=n,this.trigger("node:created",n),this},this.delete=function(t){delete this.nodes[t.id],this.trigger("node:deleted",t.id)},this.set=function(t,e){var n=this.resolve(t),i=r.deepclone(n.get());n.set(e),this.trigger("property:set",t,i,e)};var e=function(t,e){c.Helpers.each(e,function(e){this.trigger("property:updated",t,e,this)},this)};this.update=function(t,n,r){var i=this.resolve(t);i.set(n),e.call(this,t,r)},this.queryArray=function(e,r){if(!n.isArray(r))throw new l("Illegal argument: array types must be specified as ['array'(, 'array')*, <type>]");
var i,o;if("array"===r[1])for(i=[],o=0;o<e.length;o++)i.push(t.queryArray.call(this,e[o],r.slice(1)));else if(f(r[1]))i=e;else for(i=[],o=0;o<e.length;o++)i.push(this.get(e[o]));return i}},g.prototype=new g.Prototype,g.ObjectAdapter=function(t){this.graph=t},g.ObjectAdapter.Prototype=function(){var t=new g.Private;this.get=function(t){var e=this.graph.resolve(t);return e.get()},this.create=function(e,n){t.create.call(this.graph,n)},this.set=function(e,n){t.set.call(this.graph,e,n)},this.update=function(e,n,r){t.update.call(this.graph,e,n,r)},this.delete=function(e,n){t.delete.call(this.graph,n)},this.inplace=function(){return!1}},g.ObjectAdapter.Prototype.prototype=c.ObjectOperation.Object.prototype,g.ObjectAdapter.prototype=new g.ObjectAdapter.Prototype,g.Schema=o,g.Property=s,g.PersistenceAdapter=p,g.ChronicleAdapter=u,g.Index=h,e.exports=g},{"./chronicle_adapter":120,"./graph_index":122,"./persistence_adapter":123,"./property":124,"./schema":125,"substance-chronicle":76,"substance-operator":184,"substance-util":219,underscore:225}],122:[function(t,e){var n=t("underscore"),r=t("substance-util"),i=function(t,e){e=e||{},this.graph=t,this.nodes={},this.scopes={},e.filter?this.filter=e.filter:e.types&&(this.filter=i.typeFilter(t.schema,e.types)),e.property&&(this.property=e.property),this.createIndex()};i.Prototype=function(){var t=function(t){var e=this;if(null!==t)for(var n=0;n<t.length;n++){var r=t[n];e.scopes[r]=e.scopes[r]||{nodes:{},scopes:{}},e=e.scopes[r]}return e},e=function(t){if(!this.property)return null;var e=t[this.property]?t[this.property]:null;return n.isString(e)&&(e=[e]),e},r=function(t){var e=n.extend({},t.nodes);return n.each(t.scopes,function(t,i){"nodes"!==i&&n.extend(e,r(t))}),e},i=function(e,n){var r=t.call(this,e);r.nodes[n.id]=n.id},o=function(e,n){var r=t.call(this,e);delete r.nodes[n.id]};this.onGraphChange=function(t){var r=this,s={create:function(t){if(!r.filter||r.filter(t)){var n=e.call(r,t);i.call(r,n,t)}},"delete":function(t){if(!r.filter||r.filter(t)){var n=e.call(r,t);o.call(r,n,t)}},update:function(t,e,s,a){if(r.property===e&&(!r.filter||r.filter(t))){var c=a;n.isString(c)&&(c=[c]),o.call(r,c,t),c=s,n.isString(c)&&(c=[c]),i.call(r,c,t)}}};this.graph.cotransform(s,t)},this.createIndex=function(){this.reset();var t=this.graph.nodes;n.each(t,function(t){if(!this.filter||this.filter(t)){var n=e.call(this,t);i.call(this,n,t)}},this)},this.get=function(e){0===arguments.length?e=null:n.isString(e)&&(e=[e]);var i,o=t.call(this,e);return i=r(o),n.each(i,function(t){i[t]=this.graph.get(t)},this),i},this.reset=function(){this.nodes={},this.scopes={}},this.dispose=function(){this.stopListening()}},i.prototype=n.extend(new i.Prototype,r.Events.Listener),i.typeFilter=function(t,e){return function(n){for(var r=t.typeChain(n.type),i=0;i<e.length;i++)if(r.indexOf(e[i])>=0)return!0;return!1}},e.exports=i},{"substance-util":219,underscore:225}],123:[function(t,e){"use strict";var n=t("substance-operator"),r=function(t,e){this.delegate=t,this.nodes=e};r.Prototype=function(){this.get=function(t){return this.delegate.get(t)},this.create=function(t,e){this.delegate.create(t,e),this.nodes.set(e.id,e)},this.set=function(t,e){this.delegate.set(t,e);var n=t[0],r=this.delegate.get([n]);this.nodes.set(n,r)},this.delete=function(t,e){this.delegate.delete(t,e),this.nodes.delete(e.id)},this.inplace=function(){return!1}},r.Prototype.prototype=n.ObjectOperation.Object.prototype,r.prototype=new r.Prototype,e.exports=r},{"substance-operator":184}],124:[function(t,e){"use strict";var n=t("underscore"),r=function(t,e){if(!e)throw new Error("Illegal argument: path is null/undefined.");this.graph=t,this.schema=t.schema,n.extend(this,this.resolve(e))};r.Prototype=function(){this.resolve=function(t){for(var e,n,r=this.graph,i=r,o="graph",s=0;s<t.length;s++)if("graph"===o||void 0!==this.schema.types[o]){if(i=this.graph.get(t[s]),void 0===i)return void 0;r=i,o=this.schema.properties(i.type),n=r,e=void 0}else{if(void 0===i)return void 0;e=t[s];var a=t[s];o=o[a],n=i[e],s<t.length-1&&(i=i[a])}return{node:r,parent:i,type:o,key:e,value:n}},this.get=function(){return void 0!==this.key?this.parent[this.key]:this.node},this.set=function(t){if(void 0===this.key)throw new Error("'set' is only supported for node properties.");this.parent[this.key]=this.schema.parseValue(this.baseType,t)}},r.prototype=new r.Prototype,Object.defineProperties(r.prototype,{baseType:{get:function(){return n.isArray(this.type)?this.type[0]:this.type}},path:{get:function(){return[this.node.id,this.key]}}}),e.exports=r},{underscore:225}],125:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util"),i=function(t){n.extend(this,t)};i.Prototype=function(){this.defaultValue=function(t){return"object"===t?{}:"array"===t?[]:"string"===t?"":"number"===t?0:"boolean"===t?!1:"date"===t?new Date:null},this.parseValue=function(t,e){if(null===e)return e;if(n.isString(e)){if("object"===t)return JSON.parse(e);if("array"===t)return JSON.parse(e);if("string"===t)return e;if("number"===t)return parseInt(e,10);if("boolean"===t){if("true"===e)return!0;if("false"===e)return!1;throw new Error("Can not parse boolean value from: "+e)}return"date"===t?new Date(e):e}if("array"===t){if(!n.isArray(e))throw new Error("Illegal value type: expected array.");e=r.deepclone(e)}else if("string"===t){if(!n.isString(e))throw new Error("Illegal value type: expected string.")}else if("object"===t){if(!n.isObject(e))throw new Error("Illegal value type: expected object.");e=r.deepclone(e)}else if("number"===t){if(!n.isNumber(e))throw new Error("Illegal value type: expected number.")}else if("boolean"===t){if(!n.isBoolean(e))throw new Error("Illegal value type: expected boolean.")}else{if("date"!==t)throw new Error("Unsupported value type: "+t);e=new Date(e)}return e},this.type=function(t){return this.types[t]},this.typeChain=function(t){var e=this.types[t];if(!e)throw new Error("Type "+t+" not found in schema");var n=e.parent?this.typeChain(e.parent):[];return n.push(t),n},this.isInstanceOf=function(t,e){var n=this.typeChain(t);return n&&n.indexOf(e)>=0?!0:!1},this.baseType=function(t){return this.typeChain(t)[0]},this.properties=function(t){t=n.isObject(t)?t:this.type(t);var e=t.parent?this.properties(t.parent):{};return n.extend(e,t.properties),e},this.propertyType=function(t,e){var r=this.properties(t),i=r[e];if(!i)throw new Error("Property not found for"+t+"."+e);return n.isArray(i)?i:[i]},this.propertyBaseType=function(t,e){return this.propertyType(t,e)[0]}},i.prototype=new i.Prototype,e.exports=i},{"substance-util":219,underscore:225}],126:[function(t){"use strict";var e=t("underscore"),n=t("substance-test"),r=n.assert,i=n.registerTest,o=t("substance-util"),s=t("substance-operator"),a=t("../index"),c=t("substance-chronicle"),p={},u={views:{content:{}},indexes:{comments:{type:"comment",properties:["node"]},annotations:{type:"annotation",properties:["node"]}},types:{content:{properties:{}},text:{parent:"content",properties:{content:"string"}},document:{properties:{views:"array"}},view:{properties:{nodes:"array"}},code:{parent:"content",properties:{content:"string"}},image:{parent:"content",properties:{large:"string",medium:"string",caption:"string"}},heading:{properties:{content:"string",level:"number"},parent:"content"},annotation:{properties:{node:"node",pos:"object"}},strong:{properties:{node:"string",pos:"object"},parent:"annotation"},emphasis:{properties:{node:"string",pos:"object"},parent:"annotation"},"inline-code":{parent:"annotation",properties:{node:"string",pos:"object"}},link:{parent:"annotation",properties:{node:"string",pos:"object",url:"string"}},idea:{parent:"annotation",properties:{node:"string",pos:"object",url:"string"}},error:{parent:"annotation",properties:{node:"string",pos:"object",url:"string"}},question:{parent:"annotation",properties:{node:"string",pos:"object",url:"string"}},comment:{properties:{content:"string",node:"node"}}}},h=s.ObjectOperation.Create(["document"],{id:"document",type:"document",views:["content","figures"]}),l=s.ObjectOperation.Create(["content"],{id:"content",type:"view",nodes:[]}),d=s.ObjectOperation.Create(["h1"],{id:"h1",type:"heading",content:"Heading 1"}),f=s.ObjectOperation.Update(["content","nodes"],s.ArrayOperation.Insert(0,"h1")),g=s.ObjectOperation.Create(["text1"],{id:"text1",type:"text",content:"This is text1."}),y=s.ObjectOperation.Update(["content","nodes"],s.ArrayOperation.Insert(1,"text1")),m=s.ObjectOperation.Update(["content","nodes"],s.ArrayOperation.Move(1,0)),v=s.ObjectOperation.Create(["text2"],{id:"text2",type:"text",content:"This is text2."}),b=s.ObjectOperation.Update(["content","nodes"],s.ArrayOperation.Insert(1,"text2"));p.setup=function(){this.graph=new a.Graph(u,{chronicle:c.create()}),this.chronicle=this.graph.chronicle,this.index=this.chronicle.index,this.adapter=this.graph.chronicle.versioned,this.ID=["ROOT"],this.M=["ROOT"];var t=this;this.CHECKS={ROOT:function(){r.isTrue(e.isEmpty(t.graph.nodes))}},this.chronicle.uuid=o.uuidGen("")},p.actions=["Creation",function(){var t,n=this;this.CHECKS.ROOT(),this.graph.apply(h),this.ID.push(this.chronicle.getState()),this.CHECKS[e.last(this.ID)]=t=function(){r.isArrayEqual(["content","figures"],n.graph.get("document").views)},t(),this.graph.apply(l),this.ID.push(this.chronicle.getState()),this.CHECKS[e.last(this.ID)]=t=function(){r.isArrayEqual([],n.graph.get("content").nodes)},t(),this.graph.apply(d),this.ID.push(this.chronicle.getState()),this.CHECKS[e.last(this.ID)]=t=function(){r.isEqual("Heading 1",n.graph.get("h1").content)},t(),this.graph.apply(f),this.ID.push(this.chronicle.getState()),this.CHECKS[e.last(this.ID)]=t=function(){r.isArrayEqual(["h1"],n.graph.get("content").nodes)},t(),this.graph.apply(g),this.ID.push(this.chronicle.getState()),this.CHECKS[e.last(this.ID)]=t=function(){r.isEqual("This is text1.",n.graph.get("text1").content)},t(),this.graph.apply(y),this.ID.push(this.chronicle.getState()),this.CHECKS[e.last(this.ID)]=t=function(){r.isArrayEqual(["h1","text1"],n.graph.get("content").nodes)},t(),this.graph.apply(m),this.ID.push(this.chronicle.getState()),this.CHECKS[e.last(this.ID)]=t=function(){r.isArrayEqual(["text1","h1"],n.graph.get("content").nodes)},t()},"Random checkout",function(){this.graph.reset();var t=["1","7","5","4","3","2","6"];e.each(t,function(t){this.chronicle.open(t),this.CHECKS[t].call(this)},this)},"Merge",function(){this.chronicle.open(this.ID[4]),this.graph.apply(v),this.ID.push(this.chronicle.getState()),this.graph.apply(b),this.ID.push(this.chronicle.getState()),this.chronicle.open(this.ID[7]);var t={sequence:[this.ID[5],this.ID[6],this.ID[8],this.ID[9],this.ID[7]],force:!0};this.chronicle.merge(this.ID[9],"manual",t),this.M.push(this.chronicle.getState()),r.isArrayEqual(["text1","h1","text2"],this.graph.get("content").nodes)}],i(["Substance.Data","Versioned Graph"],p)},{"../index":119,"substance-chronicle":76,"substance-operator":184,"substance-test":210,"substance-util":219,underscore:225}],127:[function(t){"use strict";var e=t("substance-test"),n=e.assert,r=e.registerTest,i=t("substance-operator"),o=t("../index"),s=t("substance-store").MemoryStore,a={},c={indexes:{all:{type:"node"},foos:{type:"foo"},bars:{type:"bar"},by_category:{type:"node",properties:["category"]}},types:{node:{properties:{category:"string"}},foo:{parent:"node"},bar:{parent:"node"}}};a.setup=function(){this.store=new s,this.graph=new o.Graph(c,{store:this.store}),this.nodes=this.graph.__nodes__};var p={id:"the_foo",type:"foo",category:"bla"},u={id:"the_bar",type:"bar",category:"blupp"};a.actions=["Created node should be persisted",function(){this.graph.create(p),this.graph.create(u);var t=this.nodes.get(p.id);n.isDeepEqual(p,t),t=this.nodes.get(u.id),n.isDeepEqual(u,t)},"Deleted node should be removed from store",function(){this.graph.delete(p.id);var t=this.nodes.get(p.id);n.isUndefined(t)},"Update: property updates should be persisted",function(){this.graph.update([u.id,"category"],i.TextOperation.fromOT("blupp",[2,-3,"a"]));var t=this.nodes.get(u.id);n.isEqual("bla",t.category)},"Set: property updates should be persisted",function(){this.graph.set([u.id,"category"],"blupp");var t=this.nodes.get(u.id);n.isEqual("blupp",t.category)},"Import: persisted graph should be restored",function(){var t=new o.Graph(c,{store:this.store}).load(),e=t.get(u.id);n.isDeepEqual(u,e)}],r(["Substance.Data","Persistent Graph"],a)},{"../index":119,"substance-operator":184,"substance-store":197,"substance-test":210}],128:[function(t){"use strict";var e=t("underscore"),n=t("substance-util"),r=t("substance-test"),i=r.assert,o=r.registerTest,s=t("../index"),a=t("substance-operator"),c={types:{node:{properties:{val:["string"],arr:["array","string"]}}}},p=function(){function t(){var t=function(){t.called++,t.args=arguments};return t.called=0,t.args=void 0,t}this.setup=function(){this.graph=new s.Graph(c),this.schema=this.graph.schema,this.graph.create({id:"foo",type:"node",val:"foo",arr:["bla","blupp"]})},this.actions=["Notification on Node Creation",function(){this.setup();var e=t();this.listenTo(this.graph,"node:created",e);var n={id:"001",type:"node",val:"0",arr:["1","2"]};this.graph.create(n),i.isEqual(1,e.called),i.isObjectEqual(n,e.args[0]),this.stopListening()},"Notification on Node Deletion",function(){this.setup();var e=t();this.listenTo(this.graph,"node:deleted",e),this.graph.delete("foo"),i.isEqual(1,e.called),i.isEqual("foo",e.args[0]),this.stopListening()},"Notification on Property Set",function(){this.setup();var n=t();this.listenTo(this.graph,"property:set",n),this.graph.set(["foo","val"],"bar"),i.isEqual(1,n.called),i.isDeepEqual([["foo","val"],"foo","bar"],e.toArray(n.args)),this.stopListening()},"Notification on Property Update",function(){this.setup();var e=t();this.listenTo(this.graph,"property:updated",e),this.graph.update(["foo","val"],[-3,"bla"]),i.isEqual(2,e.called),i.isArrayEqual(["foo","val"],e.args[0]),i.isTrue(e.args[1]instanceof a.Operation),this.stopListening()},"Notification with Compounds",function(){this.setup();var e=t(),n=t();this.listenTo(this.graph,"property:set",e),this.listenTo(this.graph,"property:updated",n);var r=[a.ObjectOperation.Set(["foo","val"],"foo","bar"),a.ObjectOperation.Update(["foo","val"],a.TextOperation.Insert(0,"bla"))],o=a.ObjectOperation.Compound(r);this.graph.apply(o),i.isEqual(1,e.called),i.isEqual(1,n.called),this.stopListening()},"Generic Operation Notification",function(){this.setup();var e=t();this.listenTo(this.graph,"operation:applied",e),this.graph.set(["foo","val"],"bar"),i.isEqual(1,e.called),i.isTrue(e.args[0]instanceof a.Operation),this.stopListening()},"Generic Operation Notification with Compounds",function(){this.setup();var e=t();this.listenTo(this.graph,"operation:applied",e);var n=[a.ObjectOperation.Set(["foo","val"],"foo","bar"),a.ObjectOperation.Update(["foo","val"],a.TextOperation.Insert(0,"bla"))],r=a.ObjectOperation.Compound(n);this.graph.apply(r),i.isEqual(2,e.called),this.stopListening()}]};e.extend(p.prototype,n.Events.Listener),o(["Substance.Data","Graph Events"],new p)},{"../index":119,"substance-operator":184,"substance-test":210,"substance-util":219,underscore:225}],129:[function(t){"use strict";var e=t("underscore"),n=t("substance-test"),r=n.assert,i=n.registerTest,o=t("../index"),s=t("substance-chronicle"),a={id:"test_schema",version:"1.0.0",types:{node:{properties:{category:"string"}},foo:{parent:"node"},bar:{parent:"node"}}},c=function(){function t(t){return e.map(t,function(t){return t.id}).sort()}this.setup=function(){this.graph=new o.Graph(a,{chronicle:s.create({mode:s.HYSTERICAL})}),this.schema=this.graph.schema,this.all=this.graph.addIndex("all",{types:["foo","bar"]}),this.foos=this.graph.addIndex("foos",{types:["foo"]}),this.bars=this.graph.addIndex("bars",{types:["bar"]}),this.byCategory=this.graph.addIndex("by_category",{types:["foo","bar"],property:"category"})},this.actions=["Created nodes should be added to indexes",function(){var e={id:"foo1",type:"foo",category:"bla"};this.graph.create(e),e={id:"bar1",type:"bar",category:"blupp"},this.graph.create(e);var n=t(this.all.get());r.isArrayEqual(["bar1","foo1"],n);var i=t(this.foos.get());r.isArrayEqual(["foo1"],i);var o=t(this.bars.get());r.isArrayEqual(["bar1"],o);var s=t(this.byCategory.get("bla"));r.isArrayEqual(["foo1"],s);var a=t(this.byCategory.get("blupp"));r.isArrayEqual(["bar1"],a)},"Deleted nodes should be removed from indexes",function(){this.graph.delete("foo1");var e=t(this.all.get());r.isArrayEqual(["bar1"],e);var n=t(this.foos.get());r.isArrayEqual([],n);var i=t(this.bars.get());r.isArrayEqual(["bar1"],i);var o=t(this.byCategory.get("bla"));r.isArrayEqual([],o);var s=t(this.byCategory.get("blupp"));r.isArrayEqual(["bar1"],s)},"Updates of indexed properties should update indexes",function(){this.graph.set(["bar1","category"],"bla");var e=t(this.all.get());r.isArrayEqual(["bar1"],e);var n=t(this.foos.get());r.isArrayEqual([],n);var i=t(this.bars.get());r.isArrayEqual(["bar1"],i);var o=t(this.byCategory.get("bla"));r.isArrayEqual(["bar1"],o);var s=t(this.byCategory.get("blupp"));r.isArrayEqual([],s)},"Be smart about missing properties on nodes",function(){var e={id:"foo2",type:"foo"};this.graph.create(e);var n=t(this.byCategory.get("bla"));r.isArrayEqual(["bar1"],n);var i=t(this.byCategory.get("blupp"));r.isArrayEqual([],i)}]};i(["Substance.Data","Graph Indexes"],new c)},{"../index":119,"substance-chronicle":76,"substance-test":210,underscore:225}],130:[function(t){"use strict";function e(t){return n.map(t,function(t){return t.id})}var n=t("underscore"),r=t("substance-test"),i=r.assert,o=r.registerTest,s=t("substance-operator"),a=t("../index"),c={id:"test_schema",version:"1.0.0",types:{node:{properties:{name:"string"}},strings:{parent:"node",properties:{val:["string"],arr:["array","string"]}},numbers:{parent:"node",properties:{val:["number"],arr:["array","number"]}},booleans:{parent:"node",properties:{val:["boolean"],arr:["array","boolean"]}},dates:{parent:"node",properties:{val:["date"],arr:["array","date"]}},custom:{parent:"node",properties:{val:["object"]}},item:{},linked_item:{parent:"item",properties:{next:"item"}},collection:{properties:{items:["array","item"]}},table:{properties:{items:["array","array","item"]}}}},p=function(){this.setup=function(){this.graph=new a.Graph(c),this.schema=this.graph.schema,this.graph.create({id:"the_strings",type:"strings",name:"Strings",val:"foo",arr:["bla","blupp"]}),this.graph.create({id:"the_numbers",type:"numbers",name:"Numbers",val:11,arr:[1,2,3]}),this.graph.create({id:"the_booleans",type:"booleans",name:"Booleans",val:!0,arr:[!1,!0]}),this.graph.create({id:"the_dates",type:"dates",name:"Dates",val:new Date(1e3),arr:[new Date(1e3),new Date(2e3)]}),this.graph.create({id:"the_custom",type:"custom",name:"Custom",val:{a:{foo:"bar"},bla:"blupp"}}),this.graph.create({id:"i1",type:"linked_item",next:null}),this.graph.create({id:"i2",type:"linked_item",next:"i1"}),this.graph.create({id:"i3",type:"linked_item",next:"i2"}),this.graph.create({id:"c1",type:"collection",items:["i1","i3"]}),this.graph.create({id:"t1",type:"table",items:[["i1","i3"],["i2","i3"]]})},this.actions=["Node creation.",function(){var t={id:"n1",type:"numbers",name:"Numbers 1",foo:"bar",val:11,arr:[1,2,3]};this.graph.create(t);var e=this.graph.get(t.id);i.isDefined(e),i.isEqual(t.name,e.name),i.isEqual(t.val,e.val),i.isArrayEqual(t.arr,e.arr),t.bla="blupp",i.isUndefined(e.bla),t.arr.push(4),i.isFalse(n.isEqual(t.arr,e.arr)),i.isUndefined(e.foo)},"Node creation: 'id' and 'type' are mandatory",function(){i.exception(function(){this.graph.create({})},this)},"Node creation: 'type' must be defined in schema",function(){var t={id:"aaa",type:"unknown_type"};i.exception(function(){this.graph.create(t)},this)},"Node creation: should use default values for incomplete data",function(){var t={id:"n2",type:"numbers"};this.graph.create(t);var e=this.graph.get(t.id);i.isEqual("",e.name),i.isEqual(0,e.val),i.isArrayEqual([],e.arr)},"Node deletion",function(){var t="n1";this.graph.delete(t),i.isUndefined(this.graph.get(t))},"Node creation: should reject duplicate creations",function(){var t={id:"n2",type:"numbers"};i.exception(function(){this.graph.create(t),this.graph.create(t)},this)},"Reset fixture",function(){this.setup()},"Update 'object'",function(){var t=s.TextOperation.fromOT("bar",[1,-1,"e",1,"ry"]),e=s.ObjectOperation.Update(["a","foo"],t);this.graph.update(["the_custom","val"],e);var n=this.graph.get("the_custom");i.isEqual("berry",n.val.a.foo)},"Update 'array'",function(){this.graph.update(["the_numbers","arr"],["+",3,4]);var t=this.graph.get("the_numbers");i.isArrayEqual([1,2,3,4],t.arr)},"Update 'string'",function(){this.graph.update(["the_strings","val"],[3,"tball"]);var t=this.graph.get("the_strings");i.isEqual("football",t.val)},"Update 'number'",function(){this.graph.set(["the_numbers","val"],42);var t=this.graph.get("the_numbers");i.isEqual(42,t.val)},"Update 'boolean'",function(){this.graph.set(["the_booleans","val"],!1);var t=this.graph.get("the_booleans");i.isEqual(!1,t.val)},"Update 'date'",function(){var t=new Date(1111);this.graph.set(["the_dates","val"],t);var e=this.graph.get("the_dates");i.isEqual(t.getTime(),e.val.getTime())},"Query: resolve referenced nodes",function(){var t=["i2","next"],e=this.graph.get(t);i.isEqual("i1",e);var n=this.graph.query(t);i.isEqual("i1",n.id)},"Query: resolve arrays of references",function(){var t=["c1","items"],n=this.graph.get(t);i.isArrayEqual(["i1","i3"],n);var r=this.graph.query(t),o=e(r);i.isArrayEqual(["i1","i3"],o),t=["t1","items"],r=this.graph.query(t),o=[e(r[0]),e(r[1])],i.isDeepEqual([["i1","i3"],["i2","i3"]],o)}]};o(["Substance.Data","Graph Manipulation"],new p)},{"../index":119,"substance-operator":184,"substance-test":210,underscore:225}],131:[function(t){t("./schema_test"),t("./graph_manipulation_test"),t("./graph_index_test"),t("./002-versioned-graph"),t("./003-persistent-graph"),t("./004-graph-events")},{"./002-versioned-graph":126,"./003-persistent-graph":127,"./004-graph-events":128,"./graph_index_test":129,"./graph_manipulation_test":130,"./schema_test":132}],132:[function(t){"use strict";var e=t("underscore"),n=t("substance-test"),r=n.assert,i=n.registerTest,o=t("../index"),s={id:"schema-1",version:"1.0.0",types:{elem:{properties:{obj:"object",arr:"array",str:"string",num:"number",flag:"boolean",time:"date"}},node:{properties:{name:"string"}},numbers:{parent:"node",properties:{val:["number"],arr:["array","number"]}}}},a=function(){this.setup=function(){this.graph=new o.Graph(s),this.schema=this.graph.schema},this.actions=["Schema.defaultValue()",function(){r.isDeepEqual({},this.schema.defaultValue("object")),r.isArrayEqual([],this.schema.defaultValue("array")),r.isEqual("",this.schema.defaultValue("string")),r.isEqual(0,this.schema.defaultValue("number")),r.isEqual(!1,this.schema.defaultValue("boolean")),r.isDefined(this.schema.defaultValue("date"))},"Schema.parseValue()",function(){r.isDeepEqual({a:"bla"},this.schema.parseValue("object",'{"a": "bla"}')),r.isArrayEqual([1,2,3],this.schema.parseValue("array","[1,2,3]")),r.isEqual("bla",this.schema.parseValue("string","bla")),r.isEqual(42,this.schema.parseValue("number","42")),r.isEqual(!0,this.schema.parseValue("boolean","true"));var t=new Date(Date.now()),e=this.schema.parseValue("date",t.toISOString());r.isEqual(t.getTime(),e.getTime())},"Schema.properties()",function(){var t=this.schema.properties("elem");r.isDeepEqual(s.types.elem.properties,t),t.ooooh="aaaaahh",r.isFalse(e.isEqual(s.types.elem.properties,t))},"Inheritance - type chain",function(){var t=this.schema.typeChain("numbers");r.isArrayEqual(["node","numbers"],t)},"Inheritance - properties",function(){var t=e.extend({},s.types.node.properties,s.types.numbers.properties),n=this.schema.properties("numbers");r.isDeepEqual(t,n)},"Composite types",function(){var t=["array","number"],e=this.schema.propertyType("numbers","arr");r.isArrayEqual(t,e)}]};i(["Substance.Data","Schema"],new a)},{"../index":119,"substance-test":210,underscore:225}],133:[function(t,e){"use strict";t("underscore");var n=t("./src/document");n.Annotator=t("./src/annotator"),n.Container=t("./src/container"),n.Cursor=t("./src/cursor"),n.Selection=t("./src/selection"),n.Controller=t("./src/controller"),n.Node=t("./src/node"),n.Composite=t("./src/composite"),n.TextNode=t("./src/text_node"),n.Writer=t("./src/controller"),e.exports=n},{"./src/annotator":134,"./src/composite":136,"./src/container":137,"./src/controller":138,"./src/cursor":139,"./src/document":140,"./src/node":141,"./src/selection":142,"./src/text_node":143,underscore:225}],134:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util");t("substance-data");var i=t("./document");t("./selection");var o=i.DocumentError,s=t("substance-operator"),a=function(t,e){e=e||{},this.document=t,this.document.on("operation:applied",this.handleOperation,this),this.group={emphasis:"style",strong:"style",link:"style",question:"marker",idea:"marker",error:"marker"},this.expansion={emphasis:{left:a.isOnNodeStart},strong:{left:a.isOnNodeStart}},this.splittable=["emphasis","strong"],this._index=a.createIndex(t),this.withTransformation=e.withTransformation};a.Prototype=function(){var t=function(t,e){for(var n=e.getNodes(),r={},i=0;i<n.length;i++){var o=n[i],s=[0,null];0===i&&(s[0]=e.startChar()),i===n.length-1&&(s[1]=e.endChar()),r[o.id]=s}return r},e=function(t,e,i,o,s){var a={id:r.uuid(),type:i,path:e,range:o};return s&&n.extend(a,s),t.create(a)},i=function(t,e){t.document.delete(e.id)},a=function(t,e,n){t.document.apply(s.ObjectOperation.Set([e.id,"range"],e.range,n))},c=function(t,e,r){var i=this._index.get(e);if(r){var o=r[0],s=r[1],a={};n.each(i,function(t){var e=t.range[0],n=t.range[1],r=n>=o;s&&(r&=s>=e),r&&(a[t.id]=t)}),i=a}return i},p=function(t,n,r){var o,s=n.range[0],c=r[0],p=n.range[1],u=r[1];if(s>=c&&u>=p)i(t,n);else if(s>=c&&p>u)o=[u,p],a(t,n,o);else if(c>s&&u>=p)o=[s,c],a(t,n,o);else if(t.isSplittable(n.type)){o=[s,c],a(t,n,o);var h=[u,p];e(t,n.path,n.type,h)}else i(t,n)};this.handleOperation=function(t){var e,r,o;if("delete"===t.type||"create"===t.type)e=this.document.schema.typeChain(t.val.type),e.indexOf("annotation")>=0?(o=t.val,this.triggerLater("annotation:changed",t.type,o)):"delete"===t.type&&(r=this._index.get(t.path),n.each(r,function(t){i(this,t)},this));else if("update"===t.type||"set"===t.type){var s=this.document.get(t.path[0]);if(void 0===s)return;if(e=this.document.schema.typeChain(s.type),e.indexOf("annotation")>=0){if("range"!==t.path[1])return;this.triggerLater("annotation:changed","update",s)}else this.withTransformation&&this.transform(t)}},this.create=function(t){return this.document.create(t),t};var u=function(t,e){if(n.isEqual(e.path,t.path))if("update"===t.type){var o=!1,a=!1,c=this.expansion[e.type];c&&(c.left&&(o=c.left(e)),c.right&&(a=c.right(e)));var p=r.clone(e.range),u=s.TextOperation.Range.transform(p,t.diff,o,a);u&&(p[0]===p[1]?i(this,e):this.document.set([e.id,"range"],p))}else("delete"===t.type||"set"===t.type)&&i(this,e)};this.transform=function(t){var e=this._index.get(t.path);n.each(e,function(e){u.call(this,t,e)},this)},this.paste=function(t,e,r){for(var i=0;i<t.length;i++){var o=t[i];void 0!==e&&(o.path=n.clone(o.path),o.path[0]=e),void 0!==r&&(o.range[0]+=r,o.range[1]+=r),this.create(o)}},this.copy=function(e){var i=t(this,e),o=this.getAnnotations({selection:e}),s=[];return n.each(o,function(t){var e,n=i[t.path[0]],o=n[0]>t.range[0]||n[1]<t.range[1];o?this.isSplittable(t.type)&&(e=r.clone(t),e.id=r.uuid(),e.range=[Math.max(0,t.range[0]-n[0]),t.range[1]-n[0]],s.push(e)):(e=r.clone(t),e.id=r.uuid(),e.range=[e.range[0]-n[0],e.range[1]-n[0]],s.push(e))},this),s},this.getAnnotations=function(t){t=t||{},t.view||(t.view="content");var e=this.document,r={};if(t.node)r=c.call(this,t.view,t.node,t.range);else if(t.selection)for(var i=t.selection,o=i.getRanges(),s=0;s<o.length;s++){var a=o[s];n.extend(r,c.call(this,t.view,a.node.id,[a.start,a.end]))}else n.each(e.nodes,function(t){var n=e.schema.baseType(t.type);"annotation"===n&&(r[t.id]=t)});if(t.filter){var p={};n.each(r,function(e){t.filter(e)&&(p[e.id]=e)}),r=p}return r},this.isExclusive=function(t,e){return this.group[t]===this.group[e]},this.isSplittable=function(t){return this.splittable.indexOf(t)>=0},this.annotate=function(t,r,s){var a=t.range(),c=t.cursor.node;if(a.start[0]!==a.end[0])throw new o("Multi-node annotations are not supported.");var u=[a.start[1],a.end[1]],h=this.getAnnotations({node:c.id,range:u});if(t.isCollapsed())n.each(h,function(t){t.type===r&&i(this,t)},this);else{var l=!1;if(n.each(h,function(t){this.isExclusive(r,t.type)&&(p(this,t,u),r===t.type&&(l=!0))},this),!l)return e(this,[c.id,"content"],r,u,s)}}},a.Prototype.prototype=r.Events,a.prototype=new a.Prototype,a.isOnNodeStart=function(t){return 0===t.range[0]},a.isTrue=function(){return!0},a.createIndex=function(t){if(void 0===t.indexes.annotations){var e={types:["annotation"],property:"path"},n=t.addIndex("annotations",e);n.ENABLE_LOGGING=!0,t.indexes.annotations=n}return t.indexes.annotations};var c={idea:1,question:1,error:1,link:1,strong:2,emphasis:2,code:2,subscript:2,superscript:2,underline:2,cross_reference:1,figure_reference:1,person_reference:1,citation_reference:1},p=1,u=-1,h=function(t){this.levels=t.levels||c};h.Prototype=function(){var t=function(t,e){if(t.pos<e.pos)return-1;if(t.pos>e.pos)return 1;if(t.mode<e.mode)return-1;if(t.mode>e.mode)return 1;if(t.mode===p){if(t.level<e.level)return-1;if(t.level>e.level)return 1}if(t.mode===u){if(t.level>e.level)return-1;if(t.level<e.level)return 1}return 0},e=function(t){var e=[];return n.each(t,function(t){var n=this.levels[t.type];void 0!==n&&(e.push({pos:t.range[0],mode:p,level:n,id:t.id,type:t.type}),e.push({pos:t.range[1],mode:u,level:n,id:t.id,type:t.type}))},this),e};this.onText=function(){},this.onEnter=function(){return null},this.enter=function(t,e){return this.onEnter(t,e)},this.createText=function(t,e){this.onText(t,e)},this.start=function(n,r,i){var o=e.call(this,i);o.sort(t.bind(this));for(var s=[{context:n,entry:null}],a=0,c=0;c<o.length;c++){var h=o[c];this.createText(s[s.length-1].context,r.substring(a,h.pos)),a=h.pos;var l,d=1;if(h.mode===p){for(;d<s.length&&!(h.level<s[d].entry.level);d++);s.splice(d,0,{entry:h})}else if(h.mode===u){for(;d<s.length&&s[d].entry.id!==h.id;d++);s.splice(d,1)}for(l=d;l<s.length;l++)s[l].context=this.enter(s[l].entry,s[l-1].context)}this.createText(n,r.substring(a))}},h.prototype=new h.Prototype,a.Fragmenter=h,e.exports=a},{"./document":140,"./selection":142,"substance-data":119,"substance-operator":184,"substance-util":219,underscore:225}],135:[function(t,e){"use strict";t("underscore");var n=t("substance-util"),r=function(){};r.Prototype=function(){this.setContent=function(t){this.content=t},this.getContent=function(){return this.content}},r.Prototype.prototype=n.Events,r.prototype=new r.Prototype,e.exports=r},{"substance-util":219,underscore:225}],136:[function(t,e){var n=t("./node"),r=function(t,e){n.call(this,t,e)};r.type={id:"composite",parent:"content",properties:{}},r.description={name:"Composite",remarks:["A file reference to an external resource."],properties:{}},r.example={no_example:"yet"},r.Prototype=function(){this.getLength=function(){throw new Error("Composite.getLength() is abstract.")},this.getNodes=function(){throw new Error("Composite.getNodes() is abstract.")},this.isMutable=function(){return!1},this.insertOperation=function(){return null},this.deleteOperation=function(){return null},this.insertChild=function(){throw new Error("This composite is immutable.")},this.deleteChild=function(){throw new Error("This composite is immutable.")},this.getChangePosition=function(){return 0}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"./node":141}],137:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util"),i=t("./composite"),o=function(t,e){this.document=t,this.view=e,this.treeView=[],this.listView=[],this.__parents={},this.__composites={},this.rebuild()
};o.Prototype=function(){var t=function(t,e){var n,r=[];for(n=this.treeView.length-1;n>=0;n--)r.unshift({id:this.treeView[n],parent:null});for(var o,s;r.length>0;){if(o=r.shift(),s=this.document.get(o.id),s instanceof i){var a=s.getNodes();for(n=a.length-1;n>=0;n--)r.unshift({id:a[n],parent:s.id})}t.call(e,s,o.parent)}};this.rebuild=function(){this.treeView.splice(0,this.treeView.length),this.listView.splice(0,this.listView.length),this.treeView=n.clone(this.view.nodes);for(var e=0;e<this.view.length;e++)this.treeView.push(this.view[e]);this.__parents={},this.__composites={},t.call(this,function(t,e){if(t instanceof i)this.__parents[t.id]=e,this.__composites[e]=e;else{if(this.listView.push(t.id),this.__parents[t.id])throw new Error("Nodes must be unique in one view.");this.__parents[t.id]=e,this.__composites[e]=e}},this)},this.getTopLevelNodes=function(){return n.map(this.treeView,function(t){return this.document.get(t)},this)},this.getNodes=function(t){var e=this.listView;if(t)return n.clone(e);for(var r=[],i=0;i<e.length;i++)r.push(this.document.get(e[i]));return r},this.getPosition=function(t){var e=this.listView;return e.indexOf(t)},this.getNodeFromPosition=function(t){var e=this.listView,n=e[t];return void 0!==n?this.document.get(n):null},this.getParent=function(t){return this.__parents[t]},this.getRoot=function(t){for(var e=t;e;)t=e,e=this.getParent(t);return t},this.update=function(t){var e=t.path,n=e[0]===this.view.id||void 0!==this.__composites[e[0]];n&&this.rebuild()},this.getLength=function(){return this.listView.length},this.hasSuccessor=function(t){var e=this.getLength();return e-1>t},this.hasPredecessor=function(t){return t>0},this.getPredecessor=function(t){var e=this.getPosition(t);return 0>=e?null:this.getNodeFromPosition(e-1)},this.getSuccessor=function(t){var e=this.getPosition(t);return e>=this.getLength()-1?null:this.getNodeFromPosition(e+1)},this.firstChild=function(t){if(t instanceof i){var e=this.document.get(t.getNodes()[0]);return this.firstChild(e)}return t},this.lastChild=function(t){if(t instanceof i){var e=this.document.get(n.last(t.getNodes()));return this.lastChild(e)}return t},this.before=function(t){var e=this.firstChild(t),n=this.getPosition(e.id);return[n,0]},this.after=function(t){var e=this.lastChild(t),n=this.getPosition(e.id),r=e.getLength();return[n,r]}},o.prototype=n.extend(new o.Prototype,r.Events.Listener),Object.defineProperties(o.prototype,{id:{get:function(){return this.view.id}},type:{get:function(){return this.view.type}},nodes:{get:function(){return this.view.nodes},set:function(t){this.view.nodes=t}}}),e.exports=o},{"./composite":136,"substance-util":219,underscore:225}],138:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util"),i=t("substance-operator"),o=t("./selection"),s=t("./annotator"),a=t("./clipboard"),c=t("./composite"),p=function(t,e){e=e||{},this.view=e.view||"content",this.__document=t,this.chronicle=t.chronicle,this.annotator=new s(t),this.container=t.get(this.view),this.selection=new o(this.container),this.clipboard=new a};p.Prototype=function(){this.getNodes=function(t){return this.container.getNodes(t)},this.getContainer=function(){return this.container},this.getPosition=function(t,e){return this.container.getPosition(t,e)},this.getNodeFromPosition=function(t){return this.container.getNodeFromPosition(t)},this.getAnnotations=function(t){return t=t||{},t.view=this.view,this.annotator.getAnnotations(t)},this.delete=function(t){var e=this.startManipulation(),n=e.sel,r=n.container;if(!n.isNull())if(n.isCollapsed()&&n.expand(t,"char"),e.deleteSelection(),e.save(),0===r.getLength())this.selection.clear();else{var i=r.listView.length;if(n.cursor.nodePos>=i){var o=r.getNodeFromPosition(i-1).getLength();this.selection.set([i-1,o])}else n.collapse("left"),this.selection.set(n)}},this.copy=function(){console.log("I am sorry. Currently disabled.")},this.cut=function(){this.copy(),this.delete()},this.paste=function(){console.log("I am sorry. Currently disabled.")},this.modifyNode=function(){this.breakNode()},this.breakNode=function(){if(this.selection.isNull())return console.log("Can not write, as no position has been selected."),void 0;var t=this.startManipulation(),e=t.doc,n=t.sel,r=n.container;n.isCollapsed()||t.deleteSelection();var i=n.getNodes()[0];n.start[0];var o=n.start[1];if(i.isBreakable()){var s,a=r.getParent(i.id);if(a){var c=e.get(a);c.isBreakable()?(c.getNodes(),s=c.break(e,i.id,o)):console.log("Node type '"+c.type+"' is not splittable.")}else{s=i.break(e,o);var p=r.treeView.indexOf(i.id)+1;e.show(this.view,s.id,p)}}if(s){var u=r.before(s);n.set(u)}t.save(),this.selection.set(n)},this.insertNode=function(t,e){console.log("I am sorry. Currently disabled.",t,e)},this.annotate=function(t,e){return this.annotator.annotate(this.selection,t,e)},this.startManipulation=function(){var t=this.__document.startSimulation();new s(t,{withTransformation:!0});var e=new o(t.get(this.view),this.selection);return new p.ManipulationSession(t,e)},this.write=function(t){if(this.selection.isNull())return console.log("Can not write, as no position has been selected."),void 0;var e=this.startManipulation(),n=e.doc,r=e.sel;r.isCollapsed()||e.deleteSelection();var i=r.getNodes()[0],o=r.start[0],s=r.start[1],a=i.insertOperation(s,t);a&&n.apply(a),e.save(),this.selection.set([o,s+t.length])},this.get=function(){return this.__document.get.apply(this.__document,arguments)},this.on=function(){return this.__document.on.apply(this.__document,arguments)},this.off=function(){return this.__document.off.apply(this.__document,arguments)};var t=function(t){function e(t){if("update"===t.type||"set"===t.type){var e=n.get(t.path[0]);if(!e)return console.log("Hmmm... this.should not happen, though."),void 0;var i=-1,o=-1;return e instanceof c||e.getChangePosition&&(i=r.getPosition(e.id),o=e.getChangePosition(t)),i>=0&&o>=0?[i,o]:void 0}}if(t){this.view;var n=this.__document,r=this.container;i.Helpers.each(t,function(t){var n=e(t);return n?(this.selection.set(n),!1):void 0},this,"reverse")}};this.undo=function(){var e=this.chronicle.rewind();t.call(this,e)},this.redo=function(){var e=this.chronicle.forward();t.call(this,e)}},p.prototype=n.extend(new p.Prototype,r.Events.Listener),Object.defineProperties(p.prototype,{id:{get:function(){return this.__document.id},set:function(){throw"immutable property"}},nodeTypes:{get:function(){return this.__document.nodeTypes},set:function(){throw"immutable property"}},title:{get:function(){return this.__document.get("document").title},set:function(){throw"immutable property"}},updated_at:{get:function(){return this.__document.get("document").updated_at},set:function(){throw"immutable property"}},creator:{get:function(){return this.__document.get("document").creator},set:function(){throw"immutable property"}}});var u=function(t,e){this.doc=t,this.sel=e,this.container=e.container,this.viewId=this.container.view.id};u.Prototype=function(){this.save=function(){this.doc.save()},this.join=function(t,e){var n=this.doc,r=this.container,i=n.get(t),o=n.get(e),s=r.getParent(t),a=r.getParent(e),c=s?n.get(s):null;if(!i.canJoin(o)||c&&!c.isMutable())return!1;i.join(n,o),this.deleteNode(o.id);var p=a?n.get(a):null;if(c&&p&&c.id!==p.id&&c.canJoin(p)&&r.getParent(s)!==a){var u=c.getNodes(),h=p.getNodes(),l=u.indexOf(t)+1;if(l===u.length){this.deleteNode(p.id);for(var d=0;d<h.length;d++)c.insertChild(n,l+d,h[d])}}return!0},this.deleteNode=function(t){var e=this.doc,n=this.container.getParent(t),r=n?e.get(n):null;n?(r.deleteChild(e,t),0===r.getLength()&&this.deleteNode(r.id)):(e.hide(this.viewId,t),e.delete(t))},this.deleteSelection=function(){function t(t){var e=n.clone(t.getNodes());for(r.deleteNode(t.id);e.length>0;){var o=e.shift();i.delete(o),h[o]=!0}h[t.id]=!0}function e(n){if(void 0===h[n.id]){var r=s.firstChild(n),o=u[r.id],a=s.lastChild(n),c=u[a.id];if(o&&c&&o.isFull()&&c.isFull()){var p=s.getParent(n.id);p&&e(i.get(p)),h[p]||t(n)}else h[n.id]=!1}return h[n.id]}var r=this,i=this.doc,o=this.sel,s=o.container,a=o.getRanges(),c=a.length>1&&!a[0].isFull()&&!n.last(a).isFull(),p=0,u={};for(p=0;p<a.length;p++)u[a[p].node.id]=a[p];var h={};for(p=0;p<a.length;p++){var l=a[p],d=l.node;if(!h[d.id])if(l.isFull()){var f=s.getParent(d.id);if(f&&e(i.get(f)),!h[f])if(0===l.node.getLength())this.deleteNode(d.id);else{var g=l.node.deleteOperation(l.start,l.end);g&&!g.isNOP()&&i.apply(g),p>0&&this.deleteNode(d.id)}}else{var g=l.node.deleteOperation(l.start,l.end);g&&!g.isNOP()&&i.apply(g)}}c&&this.join(a[0].node.id,a[a.length-1].node.id)}},u.prototype=new u.Prototype,p.ManipulationSession=u,e.exports=p},{"./annotator":134,"./clipboard":135,"./composite":136,"./selection":142,"substance-operator":184,"substance-util":219,underscore:225}],139:[function(t,e){var n=t("underscore");t("substance-regexp");var r=t("substance-util"),i=r.errors,o=i.define("CursorError"),s=function(t,e,r,i){if(this.container=t,this.view=i||"content",this.nodePos=e,this.charPos=r,null!==e&&!n.isNumber(e))throw new o("Illegal argument: expected nodePos as number");if(null!==r&&!n.isNumber(r))throw new o("Illegal argument: expected charPos as number")};s.Prototype=function(){this.copy=function(){return new s(this.container,this.nodePos,this.charPos,this.view)},this.isValid=function(){if(null===this.nodePos||null===this.charPos)return!1;if(this.nodePos<0||this.charPos<0)return!1;var t=this.container.getNodeFromPosition(this.nodePos);return t?this.charPos>=t.getLength()?!1:!0:!1},this.isRightBound=function(){return this.charPos===this.node.getLength()},this.isLeftBound=function(){return 0===this.charPos},this.isEndOfDocument=function(){return this.isRightBound()&&this.nodePos===this.container.getLength()-1},this.isBeginOfDocument=function(){return this.isLeftBound()&&0===this.nodePos},this.prevNode=function(){this.isLeftBound()?this.nodePos>0&&(this.nodePos-=1,this.charPos=this.node.length):this.charPos=0},this.nextNode=function(){this.isRightBound()?this.nodePos<this.container.getLength()-1&&(this.nodePos+=1,this.charPos=0):this.charPos=this.node.length},this.prevWord=function(){if(!this.node)throw new o("Invalid node position");if(this.isLeftBound())this.prevChar();else{if(!this.node.prevWord)return this.prevChar();this.charPos=this.node.prevWord(this.charPos)}},this.nextWord=function(){if(!this.node)throw new o("Invalid node position");this.isRightBound()?this.nextChar():this.node.nextWord?this.charPos=this.node.nextWord(this.charPos):this.nextChar()},this.nextChar=function(){if(!this.node)throw new o("Invalid node position");this.isRightBound()?this.nodePos<this.container.getLength()-1&&(this.nodePos+=1,this.charPos=0):this.charPos+=1},this.prevChar=function(){if(!this.node)throw new o("Invalid node position");if(this.charPos<0)throw new o("Invalid char position");this.isLeftBound()?this.nodePos>0&&(this.nodePos-=1,this.charPos=this.node.getLength()):this.charPos-=1},this.move=function(t,e){"left"===t?"word"===e?this.prevWord():"char"===e?this.prevChar():"node"===e&&this.prevNode():"word"===e?this.nextWord():"char"===e?this.nextChar():"node"===e&&this.nextNode()},this.set=function(t,e){if(this.nodePos=t,this.charPos=e,null!==t&&!n.isNumber(t))throw new o("Illegal argument: expected nodePos as number");if(null!==e&&!n.isNumber(e))throw new o("Illegal argument: expected charPos as number");if(null!==t){if(!n.isNumber(t))throw new o("Illegal argument: expected nodePos as number");var r=this.container.getLength();if(0>t||t>=r)throw new o("Invalid node position: "+t);var i=this.container.getNodeFromPosition(t),s=i.getLength();if(0>e||e>s)throw new o("Invalid char position: "+e)}},this.position=function(){return[this.nodePos,this.charPos]}},s.prototype=new s.Prototype,Object.defineProperties(s.prototype,{node:{get:function(){return this.container.getNodeFromPosition(this.nodePos)}}}),e.exports=s},{"substance-regexp":195,"substance-util":219,underscore:225}],140:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util"),i=r.errors,o=t("substance-data"),s=t("substance-operator");t("substance-chronicle");var a=t("./container"),c=i.define("DocumentError"),p=function(t){o.Graph.call(this,t.schema,t),this.containers={}};p.schema={indexes:{},types:{content:{properties:{}},view:{properties:{nodes:["array","content"]}}}},p.Prototype=function(){var t=r.prototype(this);this.__apply__=function(e){var r=t.__apply__.call(this,e,"silent");return s.Helpers.each(e,function(t){("set"===t.type||"update"===t.type)&&n.each(this.containers,function(e){e.update(t)},this)},this),r},this.getIndex=function(t){return this.indexes[t]},this.getSchema=function(){return this.schema},this.create=function(e){return t.create.call(this,e),this.get(e.id)},this.get=function(e){var n=t.get.call(this,e);if(!n)return n;if("view"===n.type)return this.containers[n.id]||(this.containers[n.id]=new a(this,n)),this.containers[n.id];var r=this.nodeTypes[n.type],i=void 0!==r?r.Model:null;return!i||n instanceof i||(n=new i(n,this),this.nodes[n.id]=n),n},this.toJSON=function(){var e=t.toJSON.call(this);return e.id=this.id,e},this.hide=function(t,e){var r=this.get(t);if(!r)throw new c("Invalid view id: "+t);n.isString(e)&&(e=[e]);var i=[];if(n.each(e,function(t){var e=r.nodes.indexOf(t);e>=0&&i.push(e)},this),0!==i.length){i=i.sort().reverse(),i=n.uniq(i);var o=n.map(i,function(t){return s.ArrayOperation.Delete(t,r.nodes[t])}),a=s.ObjectOperation.Update([t,"nodes"],s.ArrayOperation.Compound(o));return this.apply(a)}},this.show=function(t,e,r){void 0===r&&(r=-1);var i=this.get(t);if(!i)throw new c("Invalid view id: "+t);n.isString(e)&&(e=[e]);var o=i.nodes.length;r=Math.min(r,o),0>r&&(r=Math.max(0,o+r+1));for(var a=[],p=0;p<e.length;p++){var u=e[p];if(void 0===this.nodes[u])throw new c("Invalid node id: "+u);a.push(s.ArrayOperation.Insert(r+p,u))}if(a.length>0){var h=s.ObjectOperation.Update([t,"nodes"],s.ArrayOperation.Compound(a));return this.apply(h)}},this.startSimulation=function(){var t=this,e=this.fromSnapshot(this.toJSON()),n=[];e.ops=n;var r=e.apply;return e.apply=function(t){return n.push(t),t=r.call(e,t)},e.save=function(){for(var e=[],r=0;r<n.length;r++)"compound"!==n[r].type?e.push(n[r]):e=e.concat(n[r].ops);if(0!==e.length){var i=s.ObjectOperation.Compound(e);t.apply(i)}},e},this.fromSnapshot=function(t,e){return p.fromSnapshot(t,e)},this.uuid=function(t){return t+"_"+r.uuid()}},p.Prototype.prototype=o.Graph.prototype,p.prototype=new p.Prototype,p.fromSnapshot=function(t,e){return e=e||{},e.seed=t,new p(e)},p.DocumentError=c,e.exports=p},{"./container":137,"substance-chronicle":76,"substance-data":119,"substance-operator":184,"substance-util":219,underscore:225}],141:[function(t,e){"use strict";var n=t("underscore"),r=function(t,e){this.document=e,this.properties=t};r.type={parent:"content",properties:{}},r.properties={"abstract":!0,immutable:!0,mergeableWith:[],preventEmpty:!0,allowedAnnotations:[]},r.Prototype=function(){this.toJSON=function(){return n.clone(this.properties)},this.getLength=function(){throw new Error("Node.getLength() is abstract.")},this.getChangePosition=function(){throw new Error("Node.getCharPosition() is abstract.")},this.insertOperation=function(){throw new Error("Node.insertOperation() is abstract.")},this.deleteOperation=function(){throw new Error("Node.deleteOperation() is abstract.")},this.canJoin=function(){return!1},this.join=function(){throw new Error("Node.join() is abstract.")},this.isBreakable=function(){return!1},this.break=function(){throw new Error("Node.split() is abstract.")},this.getAnnotations=function(){return this.document.getIndex("annotations").get(this.properties.id)}},r.prototype=new r.Prototype,r.prototype.constructor=r,r.defineProperties=function(t,e,r){n.each(e,function(e){var n={get:function(){return this.properties[e]}};r||(n.set=function(t){return this.properties[e]=t,this}),Object.defineProperty(t,e,n)})},r.defineProperties(r.prototype,["id","type"]),e.exports=r},{underscore:225}],142:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util"),i=r.errors,o=t("./cursor"),s=i.define("SelectionError"),a=function(t,e){this.container=t,this.start=null,this.__cursor=new o(t,null,null),e&&this.set(e)};a.Prototype=function(){this.__node=function(t){return this.container.getNodeFromPosition(t)},this.copy=function(){var t=new a(this.container);return this.isNull()||t.set(this),t},this.set=function(t){var e=this.__cursor;t instanceof a?(this.start=n.clone(t.start),e.set(t.__cursor.nodePos,t.__cursor.charPos)):n.isArray(t)?(this.start=n.clone(t),e.set(t[0],t[1])):(this.start=n.clone(t.start),e.set(t.end[0],t.end[1]));var r=this.start,i=this.container.getLength();if(r[0]<0||r[0]>=i)throw new s("Invalid node position: "+r[0]);var o=this.__node(r[0]).getLength();if(r[1]<0||r[1]>o)throw new s("Invalid char position: "+r[1]);return this.trigger("selection:changed",this.range()),this},this.clear=function(){this.start=null,this.__cursor.set(null,null),this.trigger("selection:changed",null)},this.range=function(){if(this.isNull())return null;var t=this.start,e=this.__cursor.position();return this.isReverse()?{start:e,end:t}:{start:t,end:e}},this.isReverse=function(){var t=this.__cursor;return t.nodePos<this.start[0]||t.nodePos===this.start[0]&&t.charPos<this.start[1]},this.setCursor=function(t){return this.__cursor.set(t[0],t[1]),this.start=t,this},this.getCursor=function(){return this.__cursor.copy()},this.getCursorPosition=function(){return[this.__cursor.nodePos,this.__cursor.charPos]},this.selectNode=function(t){var e=this.container.getPosition(t);if(0>e)throw new s("Node is not visible: "+t);var n=this.container.getNodeFromPosition(e);this.set({start:[e,0],end:[e,n.getLength()]})},this.getPredecessor=function(){var t=this.isReverse()?this.__cursor.nodePos:this.start[0];return 0===t?null:this.__node(t-1)},this.getSuccessor=function(){var t=this.isReverse()?this.start[0]:this.__cursor.nodePos;return this.__node(t+1)},this.hasPredecessor=function(t){return t>0},this.hasSuccessor=function(t){var e=this.container.getLength();return e-1>t},this.collapse=function(t){if("right"!==t&&"left"!==t&&"start"!==t&&"cursor"!==t)throw new s("Invalid direction: "+t);if(!this.isCollapsed()&&!this.isNull()){if("start"===t)this.__cursor.set(this.start[0],this.start[1]);else if("cursor"===t)this.start[0]=this.__cursor.nodePos,this.start[1]=this.__cursor.charPos;else{var e=this.range();this.isReverse()?"left"===t?this.start=e.start:this.__cursor.set(e.end[0],e.end[1]):"left"===t?this.__cursor.set(e.start[0],e.start[1]):this.start=e.end}this.trigger("selection:changed",this.range())}},this.move=function(t,e){this.isCollapsed()||"char"!==e?(this.__cursor.move(t,e),this.start=this.__cursor.position()):this.collapse(t),this.trigger("selection:changed",this.range())},this.expand=function(t,e){this.__cursor.move(t,e),this.trigger("selection:changed",this.range())},this.toJSON=function(){return this.range()},this.getNodes=function(){var t=this.container.getNodes();if(this.isNull())return[];var e=this.range();return t.slice(e.start[0],e.end[0]+1)},this.getRanges=function(){for(var t=[],e=this.range(),r=e.start[0];r<=e.end[0];r++){var i=0,o=null;if(r===e.start[0]&&(i=e.start[1]),r===e.end[0]&&(o=e.end[1]),!n.isNumber(o)){var s=this.__node(r);o=s.getLength()}t.push(new a.Range(this,r,i,o))}return t},this.startNode=function(){return this.isReverse()?this.__cursor.nodePos:this.start[0]},this.endNode=function(){return this.isReverse()?this.start[0]:this.__cursor.nodePos},this.startChar=function(){return this.isReverse()?this.__cursor.charPos:this.start[1]},this.endChar=function(){return this.isReverse()?this.start[1]:this.__cursor.charPos},this.isNull=function(){return null===this.start},this.isCollapsed=function(){return this.start[0]===this.__cursor.nodePos&&this.start[1]===this.__cursor.charPos},this.hasMultipleNodes=function(){return!this.isNull()&&this.startNode()!==this.endNode()}},a.Prototype.prototype=r.Events,a.prototype=new a.Prototype,Object.defineProperties(a.prototype,{cursor:{get:function(){return this.__cursor.copy()},set:function(){throw"immutable property"}}});var c=function(t,e,n,r){this.selection=t,this.nodePos=e,this.node=t.__node(e),this.start=n,this.end=r};c.Prototype=function(){this.isFirst=function(){return this.nodePos===this.selection.startNode()},this.isLast=function(){return this.nodePos===this.selection.endNode()},this.hasPredecessor=function(){return!this.isFirst()},this.hasSuccessor=function(){return!this.isLast()},this.isEnclosed=function(){return this.hasPredecessor()&&this.hasSuccessor()},this.isRightBound=function(){return this.end===this.node.getLength()},this.isLeftBound=function(){return 0===this.start},this.length=function(){return this.end-this.start},this.content=function(){return this.node.content.slice(this.start,this.end)},this.isFull=function(){return this.isLeftBound()&&this.isRightBound()},this.isPartial=function(){return!this.isFull()}},c.prototype=new c.Prototype,a.Range=c,a.SelectionError=s,e.exports=a},{"./cursor":139,"substance-util":219,underscore:225}],143:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-operator"),i=t("substance-regexp"),o=r.ObjectOperation,s=r.TextOperation,a=t("./node"),c=function(t,e){a.call(this,t,e)};c.type={id:"text",parent:"content",properties:{source_id:"Text element source id",content:"string"}},c.description={name:"Text",remarks:["A simple text fragement that can be annotated. Usually text nodes are combined in a paragraph."],properties:{content:"Content"}},c.example={type:"paragraph",id:"paragraph_1",content:"Lorem ipsum dolor sit amet, adipiscing elit."},c.Prototype=function(){this.getChangePosition=function(t){if("content"===t.path[1]){var e=r.Helpers.last(t.diff);if(e.isInsert())return e.pos+e.length();if(e.isDelete())return e.pos}return-1},this.getLength=function(){return this.properties.content.length},this.insertOperation=function(t,e){return o.Update([this.properties.id,"content"],s.Insert(t,e))},this.deleteOperation=function(t,e){var n=this.properties.content;return o.Update([this.properties.id,"content"],s.Delete(t,n.substring(t,e)),"string")},this.prevWord=function(t){var e=this.properties.content,r=new i(/\b\w/g).match(e),o=n.select(r,function(e){return e.index<t},this);return 0===o.length?0:n.last(o).index},this.nextWord=function(t){var e=this.properties.content,n=new i(/\w\b/g).match(e.substring(t));if(0===n.length)return e.length;var r=n[0];return t+r.index+1},this.canJoin=function(t){return t instanceof c},this.join=function(t,e){var r=this.properties.content.length,i=e.content;t.update([this.id,"content"],[r,i]);var o=t.indexes.annotations.get(e.id);n.each(o,function(e){t.set([e.id,"path"],[this.properties.id,"content"]),t.set([e.id,"range"],[e.range[0]+r,e.range[1]+r])},this)},this.isBreakable=function(){return!0},this.break=function(t,e){var r=this.properties.content.substring(e),i=this.toJSON();i.type=this.splitInto?this.splitInto:this.properties.type,i.id=t.uuid(this.properties.type),i.content=r,t.create(i);var o=t.indexes.annotations.get(this.properties.id);return n.each(o,function(n){n.range[0]>=e&&(t.set([n.id,"path"],[i.id,"content"]),t.set([n.id,"range"],[n.range[0]-e,n.range[1]-e]))}),t.update([this.properties.id,"content"],s.Delete(e,r)),i}},c.Prototype.prototype=a.prototype,c.prototype=new c.Prototype,c.prototype.constructor=c,a.defineProperties(c.prototype,["content"]),e.exports=c},{"./node":141,"substance-operator":184,"substance-regexp":195,underscore:225}],144:[function(t){var e=t("substance-test"),n=e.assert,r=e.registerTest,i=t("./test_document");t("../index"),t("../src/container");var o=t("substance-chronicle"),s={nodes:{h1:{id:"h1",type:"heading",content:"Part 1",level:1},p1:{id:"p1",type:"paragraph",content:"The quick brown fox jumps over the lazy dog."},l1:{id:"l1",type:"list",items:["p10","p11","p12"]},p10:{id:"p10",type:"paragraph",content:"List item 1."},p11:{id:"p11",type:"paragraph",content:"List item 2."},p12:{id:"p12",type:"paragraph",content:"List item 3."},p2:{id:"p2",type:"paragraph",content:"  Pack my box with five dozen liquor jugs."},h2:{id:"h2",type:"heading",content:"Part 2",level:1},p3:{id:"p3",type:"paragraph",content:"Fix problem quickly with galvanized jets."},f1:{id:"f1",type:"figure",image:"i1",caption:"p13"},i1:{id:"i1",type:"image",url:"https://github-camo.global.ssl.fastly.net/e0a00dc1e48a3c136441721dfe70a8bf67719e2b/687474703a2f2f662e636c2e6c792f6974656d732f334d326a306a326e31733042304f3259337032682f696c2d6c656f6e652d69636f6e2e706e67"},p13:{id:"p13",type:"paragraph",content:"The Substance Icon."},p4:{id:"p4",type:"paragraph",content:"Heavy boxes perform quick waltzes and jigs."},content:{id:"content",type:"view",nodes:["h1","p1","l1","p2","h2","p3","f1","p4"]},p20:{id:"p20",type:"paragraph",content:"Some other content."}}},a=function(){this.setup=function(){this.doc=new i({seed:s,chronicle:o.create({mode:o.HYSTERICAL})}),this.container=this.doc.get("content")},this.actions=["Access nodes in the flattened view",function(){var t=this.container.getNodes("idsOnly");n.isArrayEqual(["h1","p1","p10","p11","p12","p2","h2","p3","i1","p13","p4"],t)},"Get parent of nested node",function(){var t=this.container.getParent("p10");n.isEqual("l1",t)},"Parent of top-level nodes is null",function(){var t=this.container.getParent("p1");n.isEqual(null,t)},"Update the view when adding a node to a composite",function(){this.setup(),this.doc.update(["l1","items"],["+",3,"p20"]);var t=this.container.getNodes("idsOnly");n.isArrayEqual(["h1","p1","p10","p11","p12","p20","p2","h2","p3","i1","p13","p4"],t)},"Update the view when removing a node from a composite",function(){this.setup(),this.doc.update(["l1","items"],["-",2,"p12"]);var t=this.container.getNodes("idsOnly");n.isArrayEqual(["h1","p1","p10","p11","p2","h2","p3","i1","p13","p4"],t)},"Update the view when changing a reference in a composite",function(){this.setup(),this.doc.set(["f1","caption"],"p20");var t=this.container.getNodes("idsOnly");n.isArrayEqual(["h1","p1","p10","p11","p12","p2","h2","p3","i1","p20","p4"],t)},"Update the view when changing a top-level composite",function(){this.setup(),this.doc.update(["content","nodes"],["-",2,"l1"]);var t=this.container.getNodes("idsOnly");n.isArrayEqual(["h1","p1","p2","h2","p3","i1","p13","p4"],t)},"Child nodes can only be referenced once",function(){this.setup(),n.exception(function(){this.doc.update(["l1","items"],["+",3,"p13"])},this)}]};r(["Substance.Document","Container"],new a)},{"../index":133,"../src/container":137,"./test_document":149,"substance-chronicle":76,"substance-test":210}],145:[function(t){"use strict";var e=t("underscore"),n=t("substance-util"),r=t("substance-test"),i=r.assert,o=r.registerTest,s=t("./test_document"),a=t("../src/controller"),c=t("substance-chronicle"),p={},u=function(){this.setup=function(){},this.fixture=function(t){var e=p[t];return this.doc=new s({seed:e,chronicle:c.create({mode:c.HYSTERICAL})}),this.controller=new a(this.doc),this.container=this.controller.container,this.manipulator=new a.ManipulationSession(this.doc,this.controller.selection),e},this.actions=["Break a paragraph",function(){this.fixture("two_paragraphs"),this.controller.selection.set([0,3]),this.controller.breakNode();var t=this.container.getNodes();i.isEqual("Hel",t[0].content),i.isEqual("lo",t[1].content),i.isEqual("World",t[2].content)},"Figures are not breakable",function(){this.fixture("figure"),this.controller.selection.set([1,3]),this.controller.breakNode();var t=this.container.getNodes("idsOnly");i.isArrayEqual(["i1","p1"],t)},"Breaking a list creates a new list item",function(){this.fixture("list"),this.controller.selection.set([1,1]),this.controller.breakNode();var t=this.container.getNodes();i.isEqual("Tic",t[0].content),i.isEqual("T",t[1].content),i.isEqual("ac",t[2].content),i.isEqual("Toe",t[3].content)}]},h="https://github-camo.global.ssl.fastly.net/e0a00dc1e48a3c136441721dfe70a8bf67719e2b/687474703a2f2f662e636c2e6c792f6974656d732f334d326a306a326e31733042304f3259337032682f696c2d6c656f6e652d69636f6e2e706e67";p.single_paragraph={nodes:{p1:{id:"p1",type:"paragraph",content:"Hello"},content:{id:"content",type:"view",nodes:["p1"]}}},p.two_paragraphs={nodes:{p1:{id:"p1",type:"paragraph",content:"Hello"},p2:{id:"p2",type:"paragraph",content:"World"},content:{id:"content",type:"view",nodes:["p1","p2"]}}},p.paragraph_and_image={nodes:{p1:{id:"p1",type:"paragraph",content:"Hello"},i1:{id:"i1",type:"image",url:h},content:{id:"content",type:"view",nodes:["p1","i1"]}}},p.list={nodes:{p1:{id:"p1",type:"paragraph",content:"Tic"},p2:{id:"p2",type:"paragraph",content:"Tac"},p3:{id:"p3",type:"paragraph",content:"Toe"},l1:{id:"l1",type:"list",items:["p1","p2","p3"]},content:{id:"content",type:"view",nodes:["l1"]}}},p.figure={nodes:{i1:{id:"i1",type:"image",url:h},p1:{id:"p1",type:"paragraph",content:"Caption"},f1:{id:"f1",type:"figure",image:"i1",caption:"p1"},content:{id:"content",type:"view",nodes:["f1"]}}},p.embedded_list={nodes:{p1:{id:"p1",type:"paragraph",content:"Hello"},p2:{id:"p2",type:"paragraph",content:"Tic"},p3:{id:"p3",type:"paragraph",content:"Tac"},p4:{id:"p4",type:"paragraph",content:"Toe"},l1:{id:"l1",type:"list",items:["p2","p3","p4"]},p5:{id:"p5",type:"paragraph",content:"World"},content:{id:"content",type:"view",nodes:["p1","l1","p5"]}}},p.embedded_figure={nodes:{p1:{id:"p1",type:"paragraph",content:"Hello"},i1:{id:"i1",type:"image",url:h},p2:{id:"p2",type:"paragraph",content:"Caption"},f1:{id:"f1",type:"figure",image:"i1",caption:"p2"},p3:{id:"p3",type:"paragraph",content:"World"},content:{id:"content",type:"view",nodes:["p1","f1","p3"]}}},p.two_lists={nodes:{p1:{id:"p1",type:"paragraph",content:"Item 1"},p2:{id:"p2",type:"paragraph",content:"Item 2"},p3:{id:"p3",type:"paragraph",content:"Item 3"},p4:{id:"p4",type:"paragraph",content:"Item 4"},l1:{id:"l1",type:"list",items:["p1","p2"]},l2:{id:"l2",type:"list",items:["p3","p4"]},content:{id:"content",type:"view",nodes:["l1","l2"]}}},p.nested_lists={nodes:{p1:{id:"p1",type:"paragraph",content:"Item 1"},p2:{id:"p2",type:"paragraph",content:"Item 2"},p3:{id:"p3",type:"paragraph",content:"Item 3"},p4:{id:"p4",type:"paragraph",content:"Item 4"},l2:{id:"l2",type:"list",items:["p2","p3"]},l1:{id:"l1",type:"list",items:["p1","l2","p4"]},content:{id:"content",type:"view",nodes:["l1"]}}},p.nested_lists_2={nodes:{p1:{id:"p1",type:"paragraph",content:"Item 1"},p2:{id:"p2",type:"paragraph",content:"Item 2"},l2:{id:"l2",type:"list",items:["p2"]},l1:{id:"l1",type:"list",items:["p1","l2"]},content:{id:"content",type:"view",nodes:["l1"]}}},e.each(p,function(t){n.freeze(t)}),o(["Substance.Document","Manipulation"],new u)},{"../src/controller":138,"./test_document":149,"substance-chronicle":76,"substance-test":210,"substance-util":219,underscore:225}],146:[function(t,e){e.exports={nodes:{h1:{id:"h1",type:"heading",content:"Part 1",level:1},p1:{id:"p1",type:"paragraph",content:"The quick brown fox jumps over the lazy dog."},p2:{id:"p2",type:"paragraph",content:"  Pack my box with five dozen liquor jugs."},h2:{id:"h2",type:"heading",content:"Part 2",level:1},p3:{id:"p3",type:"paragraph",content:"Fix problem quickly with galvanized jets."},p4:{id:"p4",type:"paragraph",content:"Heavy boxes perform quick waltzes and jigs."},content:{id:"content",type:"view",nodes:["h1","p1","p2","h2","p3","p4"]}}}},{}],147:[function(t){"use strict";t("./document_manipulation_test"),t("./container_test"),t("./selection_test")},{"./container_test":144,"./document_manipulation_test":145,"./selection_test":148}],148:[function(t){"use strict";var e=t("substance-test"),n=e.assert,r=e.registerTest,i=t("./test_document"),o=t("../index");o.Container;var s=o.Selection,a=function(){this.setup=function(){this.fixture()},this.fixture=function(){var e=t("./fixture.json");this.doc=new i({seed:e}),this.container=this.doc.get("content"),this.sel=new s(this.container)},this.actions=["Empty Selection 'isNull' and has no valid Cursor",function(){n.isTrue(this.sel.isNull());var t=this.sel.getCursor();n.isFalse(t.isValid())},"Setting a range in the first node",function(){this.sel.set({start:[0,0],end:[0,3]}),n.isFalse(this.sel.isCollapsed()),n.isEqual(0,this.sel.startNode()),n.isEqual(0,this.sel.startChar()),n.isEqual(0,this.sel.endNode()),n.isEqual(3,this.sel.endChar()),n.isFalse(this.sel.isCollapsed())
},"set() should reject invalid positions",function(){n.exception(s.SelectionError,function(){this.sel.set({start:[-1,0],end:[0,3]})},this),n.exception(s.SelectionError,function(){this.sel.set({start:[2e3,0],end:[0,3]})},this),n.exception(s.SelectionError,function(){this.sel.set({start:[0,0],end:[-1,3]})},this),n.exception(s.SelectionError,function(){this.sel.set({start:[0,0],end:[2e3,3]})},this)},"setCursor() should collapse the selection",function(){this.sel.setCursor([0,1]),n.isTrue(this.sel.isCollapsed())},"Setting a reversed range",function(){this.sel.set({start:[0,3],end:[0,0]}),n.isTrue(this.sel.isReverse())},"range() always provides a selection in ascending order",function(){var t={start:[0,0],end:[0,3]};this.sel.set({start:[0,0],end:[0,3]}),n.isObjectEqual(t,this.sel.range()),this.sel.set({start:[0,3],end:[0,0]}),n.isObjectEqual(t,this.sel.range())},"range() should return null for invalid selections",function(){var t=new s(this.container);n.isNull(t.range())},"clear() should invalidate the selection",function(){var t=this.sel;t.set({start:[0,0],end:[0,3]}),t.clear(),n.isTrue(t.isNull())},"selectNode() should span a range over the whole content of a node",function(){this.sel.selectNode("h1");var t=this.doc.get("h1").content.length;n.isObjectEqual({start:[0,0],end:[0,t]},this.sel.range())},"selectNode() should reject invalid node ids",function(){n.exception(s.SelectionError,function(){this.sel.selectNode("bla")},this)},"selectNode() should reject selecting invisible nodes",function(){this.doc.hide("content","p1"),n.exception(s.SelectionError,function(){this.sel.selectNode("p1")},this)},"collapse(): [0->3], right -> 3",function(){var t=this.sel;t.set({start:[0,0],end:[0,3]}),t.collapse("right"),n.isTrue(t.isCollapsed()),n.isObjectEqual({start:[0,3],end:[0,3]},t.range())},"collapse(): [0->3], left -> 0",function(){var t=this.sel;t.set({start:[0,0],end:[0,3]}),t.collapse("left"),n.isTrue(t.isCollapsed()),n.isObjectEqual({start:[0,0],end:[0,0]},t.range())},"collapse(): [0<-3], right -> 3",function(){var t=this.sel;t.set({start:[0,0],end:[0,3]}),t.collapse("right"),n.isTrue(t.isCollapsed()),n.isObjectEqual({start:[0,3],end:[0,3]},t.range())},"collapse(): [0<-3], left -> 0",function(){var t=this.sel;t.set({start:[0,0],end:[0,3]}),t.collapse("left"),n.isTrue(t.isCollapsed()),n.isObjectEqual({start:[0,0],end:[0,0]},t.range())},"collapse() should reject invalid direction name",function(){n.exception(s.SelectionError,function(){this.sel.collapse("blupp")},this)},"hasMultipleNodes()",function(){var t=new s(this.container);n.isFalse(t.hasMultipleNodes()),t.set({start:[0,0],end:[0,3]}),n.isFalse(t.hasMultipleNodes()),t.set({start:[0,0],end:[1,3]}),n.isTrue(t.hasMultipleNodes())},"move('right', 'char')",function(){this.fixture();var t=this.sel;t.setCursor([0,0]),t.move("right","char"),n.isObjectEqual({start:[0,1],end:[0,1]},t.range())},"move('right', 'char') at end of node should move to next",function(){var t=this.sel,e=this.container.getNodeFromPosition(0),r=e.content.length;t.setCursor([0,r]),t.move("right","char"),n.isObjectEqual({start:[1,0],end:[1,0]},t.range())},"move('right', 'char') at end of document should do nothing",function(){var t=this.sel,e=5,r=this.container.getNodeFromPosition(e),i=r.content.length,o=[e,i];t.setCursor(o),t.move("right","char"),n.isObjectEqual({start:o,end:o},t.range())},"move('left', 'char')",function(){this.fixture();var t=this.sel;t.setCursor([0,3]),t.move("left","char"),n.isObjectEqual({start:[0,2],end:[0,2]},t.range())},"move('left', 'char') at begin of node should move to previous",function(){var t=this.sel,e=this.container.getNodeFromPosition(0),r=e.content.length;t.setCursor([1,0]),t.move("left","char"),n.isObjectEqual({start:[0,r],end:[0,r]},t.range())},"move('left', 'char') at begin of document should do nothing",function(){var t=this.sel,e=[0,0];t.setCursor(e),t.move("left","char"),n.isObjectEqual({start:e,end:e},t.range())},"move('right', 'char') with selected range should collapse to the right boundary",function(){var t=this.sel;t.set({start:[0,0],end:[0,3]}),t.move("right","char"),n.isObjectEqual({start:[0,3],end:[0,3]},t.range())},"move('left', 'char') with selected range should collapse to the left boundary",function(){var t=this.sel;t.set({start:[0,0],end:[0,3]}),t.move("left","char"),n.isObjectEqual({start:[0,0],end:[0,0]},t.range())},"move('right', 'word')",function(){var t=this.sel;t.setCursor([1,1]);var e=[1,3];t.move("right","word"),n.isObjectEqual({start:e,end:e},t.range())},"move('right', 'word') should step to node boundary (e.g, '.' at the end)",function(){var t=this.sel;t.setCursor([1,42]);var e=[1,43];t.move("right","word"),n.isObjectEqual({start:e,end:e},t.range())},"move('left', 'word')",function(){var t=this.sel;t.setCursor([1,7]);var e=[1,4];t.move("left","word"),n.isObjectEqual({start:e,end:e},t.range())},"move('left', 'word') should skip leading non-word characters (e.g., whitespaces)",function(){var t=this.sel;t.setCursor([2,2]);var e=[2,0];t.move("left","word"),n.isObjectEqual({start:e,end:e},t.range())},"expand('right', 'word')",function(){var t=this.sel;t.setCursor([1,1]);var e=[1,3];t.expand("right","word"),n.isObjectEqual({start:[1,1],end:e},t.range())},"expand('left', 'word') with change of direction",function(){var t=this.sel;t.set({start:[1,6],end:[1,9]}),t.expand("left","word"),n.isObjectEqual({start:[1,4],end:[1,6]},t.range()),n.isTrue(t.isReverse())},"getNodes()",function(){var t=this.sel;t.set({start:[1,0],end:[3,6]});var e=[this.doc.get("p1"),this.doc.get("p2"),this.doc.get("h2")],r=t.getNodes();n.isArrayEqual(e,r)},"getRanges()",function(){var t=this.sel;t.set({start:[1,1],end:[3,6]});var e=t.getRanges();n.isObjectEqual(this.doc.get("p1"),e[0].node),n.isObjectEqual(this.doc.get("p2"),e[1].node),n.isObjectEqual(this.doc.get("h2"),e[2].node)},"Range.isPartial()/isFull()",function(){var t=this.sel;t.set({start:[1,1],end:[3,2]});var e=t.getRanges();n.isTrue(e[0].isPartial()),n.isTrue(e[1].isFull()),n.isTrue(e[2].isPartial())}]};a.Prototype=function(){},a.prototype=new a.Prototype,r(["Substance.Document","Selection"],new a)},{"../index":133,"./fixture.json":146,"./test_document":149,"substance-test":210}],149:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util"),i=t("../index"),o=i.TextNode,s=function(t,e){o.call(this,t,e)};s.Prototype=function(){},s.Prototype.prototype=o.prototype,s.prototype=new s.Prototype;var a=function(t,e){o.call(this,t,e)};a.Prototype=function(){this.splitInto="paragraph"},a.Prototype.prototype=o.prototype,a.prototype=new a.Prototype;var c=function(t,e){i.Node.call(this,t,e)};c.Prototype=function(){this.getLength=function(){return 1},this.deleteOperation=function(){return null}},c.Prototype.prototype=i.Node.prototype,c.prototype=new c.Prototype,i.Node.defineProperties(c.prototype,["url"]);var p=function(t,e){i.Composite.call(this,t,e)};p.Prototype=function(){this.getLength=function(){return this.properties.items.length},this.getNodes=function(){return n.clone(this.properties.items)},this.isMutable=function(){return!0},this.insertChild=function(t,e,n){t.update([this.id,"items"],["+",e,n])},this.deleteChild=function(t,e){var n=this.items.indexOf(e);t.update([this.id,"items"],["-",n,e]),t.delete(e)},this.canJoin=function(t){return"list"===t.type},this.isBreakable=function(){return!0},this.break=function(t,e,n){var r=this.properties.items.indexOf(e);if(0>r)throw new Error("Unknown child "+e);var i=t.get(e),o=i.break(t,n);return t.update([this.id,"items"],["+",r+1,o.id]),o}},p.Prototype.prototype=i.Composite.prototype,p.prototype=new p.Prototype,i.Node.defineProperties(p.prototype,["items"]);var u=function(t,e){i.Composite.call(this,t,e)};u.Prototype=function(){this.getLength=function(){return 2},this.getNodes=function(){var t=[];return this.properties.image&&t.push(this.properties.image),this.properties.caption&&t.push(this.properties.caption),t},this.deleteChild=function(t,e){e===this.image?(t.set([this.id,"image"],null),t.delete(e)):e===this.caption&&t.set([this.caption,"content"],"")}},u.Prototype.prototype=i.Composite.prototype,u.prototype=new u.Prototype,i.Node.defineProperties(u.prototype,["image","caption"]);var h=r.clone(i.schema);n.extend(h.types,{document:{properties:{views:["array","view"],guid:"string",creator:"string",title:"string","abstract":"string"}},node:{parent:"content",properties:{}},composite:{parent:"node",properties:{nodes:["array","node"]}},paragraph:{parent:"node",properties:{content:"string"}},heading:{parent:"node",properties:{content:"string",level:"number"}},image:{parent:"node",properties:{url:"string"}},list:{parent:"composite",properties:{items:["array","paragraph"]}},figure:{parent:"composite",properties:{image:"image",caption:"paragraph"}},annotation:{properties:{path:["array","string"],range:"object"}},strong:{parent:"annotation",properties:{}},idea:{parent:"annotation",properties:{}}});var l={paragraph:{Model:s},heading:{Model:a},image:{Model:c},list:{Model:p},figure:{Model:u}},d=function(t){t=t||{},t.schema=r.deepclone(h),void 0===t.seed&&(t.seed=d.Seed),i.call(this,t),this.nodeTypes=l};d.Prototype=function(){this.fromSnapshot=function(t,e){return e=e||{},e.seed=t,new d(e)}},d.Prototype.prototype=i.prototype,d.prototype=new d.Prototype,d.Schema=h,d.Seed={nodes:{document:{id:"document",type:"document",views:["content"]},content:{id:"content",type:"view",nodes:[]}}},d.Paragraph=s,d.Heading=a,e.exports=d},{"../index":133,"substance-util":219,underscore:225}],150:[function(t,e){"use strict";var n=t("./src/library");n.Controller=t("./src/library_controller"),n.View=t("./src/library_controller"),n.Collection={},n.Collection.View=t("./src/collection_view"),e.exports=n},{"./src/collection_view":152,"./src/library":153,"./src/library_controller":154}],151:[function(t,e){"use strict";var n=t("underscore"),r=function(t,e){this.library=e,this.properties=t};r.Prototype=function(){},r.prototype=new r.Prototype,r.prototype.constructor=r,Object.defineProperties(r.prototype,{id:{get:function(){return this.properties.id}},name:{get:function(){return this.properties.name},set:function(){throw"collection.name is immutable"}},records:{get:function(){return n.map(this.properties.records,function(t){return this.library.get(t)},this)},set:function(){throw"collection.records is immutable"}}}),e.exports=r},{underscore:225}],152:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util");r.html;var i=t("substance-application").View,o=t("substance-application").$$,s=function(t){i.call(this),this.$el.addClass("collection"),this.libraryCtrl=t};s.Prototype=function(){this.render=function(){var t=this.libraryCtrl.collection,e=t.records;return n.each(e,function(e){this.el.appendChild(o("a.document",{href:"#"+t.id+"/"+e.id,children:[o(".title",{text:e.title}),o(".authors",{text:e.authors.join(", ")})]}))},this),this},this.dispose=function(){this.stopListening()}},s.Prototype.prototype=i.prototype,s.prototype=new s.Prototype,e.exports=s},{"substance-application":63,"substance-util":219,underscore:225}],153:[function(t,e){"use strict";var n=t("underscore");t("substance-util");var r=t("substance-data"),i=t("./collection");t("substance-chronicle");var o={id:"substance-library",version:"0.1.0",types:{library:{properties:{name:"string",collections:["array","collection"]}},collection:{properties:{name:"string",documents:["array","record"]}},record:{properties:{title:"string",authors:["array","string"],published_on:"date",url:"string"}}}},s=function(t){r.Graph.call(this,o,t),void 0===t.seed&&this.create({id:"library",type:"library",guid:t.id,creator:t.creator,created_at:t.created_at})};s.Prototype=function(){this.getCollection=function(t){var e=this.get(t);return new i(e,this)},this.loadDocument=function(e,n){var r,i=this.get(e);console.log("LOADING DOC from: ",i.url),$.getJSON(i.url,function(e){if(e.schema&&"lens-article"===e.schema[0]){console.log("lens article");var i=t("lens-article");r=i.fromSnapshot(e)}else{console.log("substance article");var i=t("substance-article");r=i.fromSnapshot(e)}n(null,r)})}},s.Prototype.prototype=r.Graph.prototype,s.prototype=new s.Prototype,s.prototype.constructor=s,Object.defineProperties(s.prototype,{id:{get:function(){return this.get("library").guid},set:function(){throw"library.id is immutable"}},name:{get:function(){return this.get("library").name}},collections:{get:function(){return n.map(this.get("library").collections,function(t){return new i(this.get(t),this)},this)}}}),e.exports=s},{"./collection":151,"lens-article":5,"substance-article":71,"substance-chronicle":76,"substance-data":119,"substance-util":219,underscore:225}],154:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-application").Controller,i=t("./library_view"),o=t("substance-util"),s=function(t,e){this.library=t,this.state=e,this.collection=this.library.getCollection(e.collection),r.call(this),this.view=new i(this)};s.Prototype=function(){this.createView=function(){var t=new i(this);return t},this.getActiveControllers=function(){var t=[["sandbox",this]],e=this.state;return"editor"===e?t=t.concat(this.editor.getActiveControllers()):"test_center"===e&&t.push(["test_center",this.testRunner]),t}},s.Prototype.prototype=r.prototype,s.prototype=new s.Prototype,n.extend(s.prototype,o.Events),e.exports=s},{"./library_view":155,"substance-application":63,"substance-util":219,underscore:225}],155:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util");r.html;var i=t("substance-application").View,o=t("./collection_view"),s=t("substance-application").$$,a=function(t){i.call(this),this.$el.addClass("library"),this.libraryCtrl=t,this.collectionView=new o(t)};a.Prototype=function(){this.render=function(){var t=this.libraryCtrl.library.collections,e=this.libraryCtrl.collection,r=s(".collection-toggles",{children:n.map(t,function(t){function n(){return t.id===e.id}return s("a",{id:"collection_toggle_"+t.id,"class":"toggle-collection"+(n()?" active":""),href:"#"+t.id,text:t.name})})});return this.el.appendChild(r),this.el.appendChild(s(".collection")),this.$(".collection").replaceWith(this.collectionView.render().el),this},this.dispose=function(){this.stopListening()}},a.Prototype.prototype=i.prototype,a.prototype=new a.Prototype,e.exports=a},{"./collection_view":152,"substance-application":63,"substance-util":219,underscore:225}],156:[function(t,e){"use strict";e.exports={node:t("./src/node"),composite:t("./src/composite"),text:t("./src/text"),paragraph:t("./src/paragraph"),heading:t("./src/heading"),list:t("./src/list"),codeblock:t("./src/codeblock"),webresource:t("./src/web_resource"),image:t("./src/image")}},{"./src/codeblock":159,"./src/composite":162,"./src/heading":165,"./src/image":168,"./src/list":169,"./src/node":172,"./src/paragraph":175,"./src/text":178,"./src/web_resource":181}],157:[function(t,e){"use strict";var n=t("../text/text_node"),r=function(t,e){n.call(this,t,e)};r.type={id:"codeblock",parent:"content",properties:{source_id:"string",content:"string"}},r.config={zoomable:!0},r.description={name:"Codeblock",remarks:["Text in a codeblock is displayed in a fixed-width font, and it preserves both spaces and line breaks"],properties:{content:"Content"}},r.example={type:"codeblock",id:"codeblock_1",content:'var text = "Sun";\nvar op1 = Operator.TextOperation.Delete(2, "n");\ntext = op2.apply(op1.apply(text));\nconsole.log(text);'},r.Prototype=function(){},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,r.prototype.constructor=r,e.exports=r},{"../text/text_node":179}],158:[function(t,e){"use strict";var n=t("../text/text_view"),r=function(t){n.call(this,t),this.$el.addClass("content-node codeblock")};r.Prototype=function(){},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"../text/text_view":180}],159:[function(t,e){"use strict";e.exports={Model:t("./codeblock"),View:t("./codeblock_view")}},{"./codeblock":157,"./codeblock_view":158}],160:[function(t,e){"use strict";var n=t("substance-document");e.exports=n.Composite},{"substance-document":133}],161:[function(t,e){"use strict";var n=t("../node").View,r=function(t,e){n.call(this,t,e),this.$el.addClass(t.type),this.$el.attr("id",this.node.id),this.childrenViews=[]};r.Prototype=function(){this.render=function(){this.content=document.createElement("DIV"),this.content.classList.add("content");var t;for(t=0;t<this.childrenViews.length;t++)this.childrenViews[t].dispose();var e=this.node.getNodes();for(t=0;t<e.length;t++){var n=this.node.document.get(e[t]),r=this.viewFactory.createView(n);this.content.appendChild(r.render().el),this.childrenViews.push(r)}return this.el.appendChild(this.content),this},this.dispose=function(){n.prototype.dispose.call(this);for(var t=0;t<this.childrenViews.length;t++)this.childrenViews[t].dispose()},this.delete=function(){},this.getCharPosition=function(){return 0},this.getDOMPosition=function(){var t=this.$(".content")[0],e=document.createRange();return e.setStartBefore(t.childNodes[0]),e}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"../node":172}],162:[function(t,e){"use strict";e.exports={Model:t("./composite"),View:t("./composite_view")}},{"./composite":160,"./composite_view":161}],163:[function(t,e){"use strict";var n=t("substance-document").Node,r=t("../text/text_node"),i=function(t,e){r.call(this,t,e)};i.type={id:"heading",parent:"content",properties:{source_id:"string",content:"string",level:"number"}},i.example={type:"heading",id:"heading_1",content:"Introduction",level:1},i.description={name:"Heading",remarks:["Denotes a section or sub section in your article."],properties:{content:"Heading content",level:"Heading level. Ranges from 1..4"}},i.Prototype=function(){this.splitInto="paragraph"},i.Prototype.prototype=r.prototype,i.prototype=new i.Prototype,i.prototype.constructor=i,n.defineProperties(i.prototype,["level"]),e.exports=i},{"../text/text_node":179,"substance-document":133}],164:[function(t,e){"use strict";var n=t("../text/text_view"),r=function(t){n.call(this,t),this.$el.addClass("heading"),this.$el.addClass("level-"+this.node.level)};r.Prototype=function(){},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"../text/text_view":180}],165:[function(t,e){"use strict";e.exports={Model:t("./heading"),View:t("./heading_view")}},{"./heading":163,"./heading_view":164}],166:[function(t,e){"use strict";t("substance-document").Node;var n=t("../web_resource/web_resource"),r=function(t,e){n.call(this,t,e)};r.type={id:"image",parent:"webresource",properties:{source_id:"string"}},r.example={type:"image",id:"image_1",url:"http://elife.elifesciences.org/content/elife/1/e00311/F3.medium.gif"},r.description={name:"Image",remarks:["Represents a web-resource for an image."],properties:{}},r.Prototype=function(){},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,r.prototype.constructor=r,e.exports=r},{"../web_resource/web_resource":182,"substance-document":133}],167:[function(t,e){"use strict";var n=t("../node").View,r=function(t,e){n.call(this,t,e),this.$el.addClass("image"),this.$el.attr("id",this.node.id)};r.Prototype=function(){var t=Array.prototype.indexOf;this.render=function(){var e=document.createElement("div");e.className="content";var n=document.createElement("div");n.className="image-char",this._imgChar=n;var r=document.createElement("img");return r.src=this.node.url,r.alt="alt text",r.title="alt text",n.appendChild(r),e.appendChild(n),this.el.appendChild(e),this._imgPos=t.call(n.childNodes,r),this},this.delete=function(t,e){for(var n=this.$(".content")[0],r=n.childNodes,i=e-1;i>=0;i--)n.removeChild(r[t+i])},this.getCharPosition=function(t,e){return t===this._imgChar?e>this._imgPos?1:0:(console.log("Errhhh.."),void 0)},this.getDOMPosition=function(t){var e=this.$(".content")[0],n=document.createRange();return 0===t?n.setStartBefore(e.childNodes[0]):n.setStartAfter(e.childNodes[0]),n}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"../node":172}],168:[function(t,e){"use strict";e.exports={Model:t("./image"),View:t("./image_view")}},{"./image":166,"./image_view":167}],169:[function(t,e){"use strict";e.exports={Model:t("./list"),View:t("./list_view")}},{"./list":170,"./list_view":171}],170:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-document"),i=r.Node,o=r.Composite,s=function(t,e){o.call(this,t,e)};s.type={id:"list",parent:"content",properties:{source_id:"string",items:["array","paragraph"],ordered:"boolean"}},s.description={name:"List",remarks:["Lists can either be numbered or bullet lists"],properties:{ordered:"Specifies wheter the list is ordered or not",items:"An array of paragraph references"}},s.example={type:"list",id:"list_1","items ":["paragraph_listitem_1","paragraph_listitem_2"]},s.Prototype=function(){this.getLength=function(){return this.properties.items.length},this.getNodes=function(){return n.clone(this.items)},this.getItems=function(){return n.map(this.properties.items,function(t){return this.document.get(t)},this)},this.getChangePosition=function(t){if("items"===t.path[1])if("update"===t.type){var e=t.diff;if(e.isInsert())return t.diff.pos+1;if(e.isDelete())return t.diff.pos;if(e.isMove())return t.diff.target}else if("set"===t.type)return this.properties.items.length-1;return-1},this.isMutable=function(){return!0},this.insertChild=function(t,e,n){t.update([this.id,"items"],["+",e,n])},this.deleteChild=function(t,e){var n=this.items.indexOf(e);t.update([this.id,"items"],["-",n,e]),t.delete(e)},this.canJoin=function(t){return"list"===t.type},this.isBreakable=function(){return!0},this.break=function(t,e,n){var r=this.properties.items.indexOf(e);if(0>r)throw new Error("Unknown child "+e);var i=t.get(e),o=i.break(t,n);return t.update([this.id,"items"],["+",r+1,o.id]),o}},s.Prototype.prototype=o.prototype,s.prototype=new s.Prototype,s.prototype.constructor=s,i.defineProperties(s.prototype,["items","ordered"]),e.exports=s},{"substance-document":133,underscore:225}],171:[function(t,e){"use strict";var n=t("../composite/composite_view"),r=t("./list"),i=function(t,e){n.call(this,t,e)};i.whoami="SubstanceListView",i.Prototype=function(){this.render=function(){this.el.innerHTML="";var t=this.node.ordered?"OL":"UL";this.content=document.createElement(t),this.content.classList.add("content");var e;for(e=0;e<this.childrenViews.length;e++)this.childrenViews[e].dispose();var n=this.node.getNodes();for(e=0;e<n.length;e++){var i,o=this.node.document.get(n[e]),s=this.viewFactory.createView(o);o instanceof r?i=s.render().el:(i=document.createElement("LI"),i.appendChild(s.render().el)),this.content.appendChild(i),this.childrenViews.push(s)}return this.el.appendChild(this.content),this},this.onNodeUpdate=function(t){t.path[0]===this.node.id&&"items"===t.path[1]&&this.render()}},i.Prototype.prototype=n.prototype,i.prototype=new i.Prototype,e.exports=i},{"../composite/composite_view":161,"./list":170}],172:[function(t,e){"use strict";e.exports={Model:t("./node"),View:t("./node_view")}},{"./node":173,"./node_view":174}],173:[function(t,e){"use strict";var n=t("substance-document");e.exports=n.Node},{"substance-document":133}],174:[function(t,e){var n=t("substance-application").View,r=function(t,e){n.call(this),this.node=t,this.viewFactory=e,this.$el.addClass("content-node"),this.$el.attr("id",this.node.id)};r.Prototype=function(){this.render=function(){return this.content=document.createElement("DIV"),this.content.classList.add("content"),this.el.appendChild(this.content),this},this.dispose=function(){this.stopListening()},this.getCharPosition=function(){throw new Error("NodeView.getCharPosition() is abstract.")},this.getDOMPosition=function(){throw new Error("NodeView.getDOMPosition() is abstract.")},this.onGraphUpdate=function(t){t.path[0]!==this.node.id||"update"!==t.type&&"set"!==t.type||this.onNodeUpdate(t)},this.onNodeUpdate=function(){}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"substance-application":63}],175:[function(t,e){"use strict";e.exports={Model:t("./paragraph"),View:t("./paragraph_view")}},{"./paragraph":176,"./paragraph_view":177}],176:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-document"),i=r.Node,o=r.Composite,s=function(t,e){o.call(this,t,e)};s.type={id:"paragraph",parent:"content",properties:{children:["array","content"]}},s.description={name:"Paragraph",remarks:["A Paragraph can have inline elements such as images."],properties:{children:"An array of content node references"}},s.example={type:"paragraph",id:"paragraph_1","children ":["text_1","image_1","text_2"]},s.Prototype=function(){this.getLength=function(){return this.properties.children.length},this.getNodes=function(){return n.clone(this.properties.children)},this.getChildren=function(){return n.map(this.properties.children,function(t){return this.document.get(t)},this)},this.getChangePosition=function(t){if("children"===t.path[1])if("update"===t.type){var e=t.diff;if(e.isInsert())return t.diff.pos+1;if(e.isDelete())return t.diff.pos;if(e.isMove())return t.diff.target}else if("set"===t.type)return this.properties.children.length-1;return-1},this.isMutable=function(){return!0},this.insertChild=function(t,e,n){t.update([this.id,"children"],["+",e,n])},this.deleteChild=function(t,e){var n=this.children.indexOf(e);t.update([this.id,"children"],["-",n,e]),t.delete(e)},this.canJoin=function(t){return"paragraph"===t.type},this.isBreakable=function(){return!0},this.break=function(t,e,n){var r=this.properties.children.indexOf(e);if(0>r)throw new Error("Unknown child "+e);var i=t.get(e),o=i.break(t,n);return t.update([this.id,"children"],["+",r+1,o.id]),o}},s.Prototype.prototype=o.prototype,s.prototype=new s.Prototype,s.prototype.constructor=s,i.defineProperties(s.prototype,["children"]),e.exports=s},{"substance-document":133,underscore:225}],177:[function(t,e){"use strict";var n=t("../composite/composite_view"),r=function(t,e){n.call(this,t,e)};r.Prototype=function(){this.onNodeUpdate=function(t){t.path[0]===this.node.id&&"children"===t.path[1]&&this.render()}},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,e.exports=r},{"../composite/composite_view":161}],178:[function(t,e){"use strict";e.exports={Model:t("./text_node"),View:t("./text_view")}},{"./text_node":179,"./text_view":180}],179:[function(t,e){"use strict";var n=t("substance-document");e.exports=n.TextNode},{"substance-document":133}],180:[function(t,e){var n=t("../node/node_view"),r=t("substance-document"),i=r.Annotator,o=t("substance-application").$$,s=!1,a=function(t){n.call(this,t),this.$el.addClass("content-node text"),this.$el.attr("id",this.node.id),this._annotations={}};a.Prototype=function(){this.render=function(t){return n.prototype.render.call(this,t),this.renderContent(),this},this.dispose=function(){n.prototype.dispose.call(this),console.log("disposing paragraph view")},this.renderContent=function(){this.content.innerHTML="",this._annotations=this.node.getAnnotations(),this.renderWithAnnotations(this._annotations)},this.insert=function(t,e){var n=this.getDOMPosition(t),r=n.startContainer,i=n.startOffset,o=r.textContent;o=o.substring(0,i)+e+o.substring(i),r.textContent=o},this.delete=function(t,e){var n=this.getDOMPosition(t),r=n.startContainer,i=n.startOffset,o=r.textContent;o=o.substring(0,i)+o.substring(i+e),r.textContent=o},this.onNodeUpdate=function(t){if("content"===t.path[1])if(console.log("Updating text view: ",t),"update"===t.type){var e=t.diff;e.isInsert()?this.insert(e.pos,e.str):e.isDelete()&&this.delete(e.pos,e.str.length)}else"set"===t.type&&this.renderContent()},this.onGraphUpdate=function(t){n.prototype.onGraphUpdate.call(this,t);var e,r=this.node.document,i=r.getSchema();if(e="delete"!==t.type?r.get(t.path[0]):t.val,i.isInstanceOf(e.type,"annotation")){var o=!1;e.path[0]===this.node.id?o=!0:"set"===t.type&&"path"===t.path[1]&&t.original[0]===this.node.id&&(o=!0),o&&(console.log("Rerendering TextView due to annotation update",t),this.renderContent())}},this.getCharPosition=function(t,e){var n=document.createRange();n.setStart(this.content.childNodes[0],0),n.setEnd(t,e);var r=n.toString(),i=Math.min(this.node.content.length,r.length);return i},this.getDOMPosition=function(t){if(void 0===this.content)throw new Error("Not rendered yet.");var e=document.createRange();if(0===this.node.content.length)return e.setStart(this.content.childNodes[0],0),e;for(var n=[this.content];n.length>0;){var r=n.pop();if(r.nodeType===Node.TEXT_NODE){var i=r;if(i.length>=t)return e.setStart(r,t),e;t-=i.length}else if(r.childNodes.length>0)for(var o=r.childNodes.length-1;o>=0;o--)n.push(r.childNodes[o])}console.log("Bug-Alarm: the model and the view are out of sync."),console.log("The model as "+t+" more characters"),console.log("Returning the last available position... but please fix me. Anyone?");var s=this.content.childNodes,a=s[s.length-1];return e.setStart(a,a.length),e},this.createAnnotationElement=function(t){var e;return e="link"===t.type?o("a.annotation."+t.type,{id:t.id,href:this.node.document.get(t.id).url}):o("span.annotation."+t.type,{id:t.id})},this.renderWithAnnotations=function(t){var e=this,n=this.node.content,r=document.createDocumentFragment(),o=new i.Fragmenter(r,n,t);o.onText=function(t,e){t.appendChild(document.createTextNode(e))},o.onEnter=function(t,n){var r=e.createAnnotationElement(t);return n.appendChild(r),r},o.start(r,n,t),s&&r.appendChild(document.createTextNode(" ")),this.content.innerHTML="",this.content.appendChild(r)},this.dispose=function(){this.stopListening()}},a.Prototype.prototype=n.prototype,a.prototype=new a.Prototype,e.exports=a},{"../node/node_view":174,"substance-application":63,"substance-document":133}],181:[function(t,e){"use strict";e.exports={Model:t("./web_resource"),View:t("./web_resource_view")}},{"./web_resource":182,"./web_resource_view":183}],182:[function(t,e){"use strict";var n=t("substance-document").Node,r=function(t,e){n.call(this,t,e)};r.type={id:"webresource",parent:"content",properties:{source_id:"string",url:"string"}},r.description={name:"WebResource",description:"A resource which can be accessed via URL",remarks:["This element is a parent for several other nodes such as Image."],properties:{url:"URL to a resource"}},r.example={type:"webresource",id:"webresource_3",url:"http://elife.elifesciences.org/content/elife/1/e00311/F3.medium.gif"},r.Prototype=function(){},r.Prototype.prototype=n.prototype,r.prototype=new r.Prototype,r.prototype.constructor=r,n.defineProperties(r.prototype,["url"]),e.exports=r},{"substance-document":133}],183:[function(t,e){"use strict";e.exports=t("../node").View},{"../node":172}],184:[function(t,e){"use strict";e.exports={Operation:t("./src/operation"),Compound:t("./src/compound"),ArrayOperation:t("./src/array_operation"),TextOperation:t("./src/text_operation"),ObjectOperation:t("./src/object_operation"),Helpers:t("./src/operation_helpers")}},{"./src/array_operation":185,"./src/compound":186,"./src/object_operation":187,"./src/operation":188,"./src/operation_helpers":189,"./src/text_operation":190}],185:[function(t,e){"use strict";function n(t,e,n){t.pos===e.pos?n?e.pos+=1:t.pos+=1:t.pos<e.pos?e.pos+=1:t.pos+=1}function r(t,e){return t.pos===e.pos?(e.type=l,t.type=l,void 0):(t.pos<e.pos?e.pos-=1:t.pos-=1,void 0)}function i(t,e){if(t.type===d){var n=t;t=e,e=n}t.pos<=e.pos?e.pos+=1:t.pos-=1}function o(t,e,n,r){if(t.type!==g)return o(e,t,n,!r);var i={type:d,pos:t.pos},s={type:f,pos:t.target},a={inplace:!0,check:n};e.type===d&&t.pos===e.pos?(t.type=l,e.pos=t.target):e.type===g&&t.pos===e.pos?r?(e.pos=t.target,t.type=l):(t.pos=e.target,e.type=l):(r?(x(i,e,a),x(s,e,a)):(x(e,i,a),x(e,s,a)),t.pos=i.pos,t.target=s.pos)}var s,a=t("underscore"),c=t("substance-util"),p=c.errors,u=t("./operation"),h=t("./compound"),l="NOP",d="delete",f="insert",g="move",y=function(t){if(void 0===t.type)throw new p.OperationError("Illegal argument: insufficient data.");if(this.type=t.type,this.type!==l){if(this.pos=t.pos,this.val=t.val,this.target=t.target,this.type!==l&&this.type!==f&&this.type!==d&&this.type!==g)throw new p.OperationError("Illegal type.");
if(this.type===f||this.type===d){if(void 0===this.pos||void 0===this.val)throw new p.OperationError("Illegal argument: insufficient data.");if(!a.isNumber(this.pos)&&this.pos<0)throw new p.OperationError("Illegal argument: expecting positive number as pos.")}else if(this.type===g){if(void 0===this.pos||void 0===this.target)throw new p.OperationError("Illegal argument: insufficient data.");if(!a.isNumber(this.pos)&&this.pos<0)throw new p.OperationError("Illegal argument: expecting positive number as pos.");if(!a.isNumber(this.target)&&this.target<0)throw new p.OperationError("Illegal argument: expecting positive number as target.")}}};y.fromJSON=function(t){if(a.isArray(t))return t[0]===g?new s(t[1],t[2]):new y(t);if(t.type===g)return s.fromJSON(t);if(t.type===h.TYPE){for(var e=[],n=0;n<t.ops.length;n++)e.push(y.fromJSON(t.ops[n]));return y.Compound(e)}return new y(t)},y.Prototype=function(){this.clone=function(){return new y(this)},this.apply=function(t){if(this.type===l)return t;var e=t instanceof y.ArrayAdapter?t:new y.ArrayAdapter(t);if(this.type===f)e.insert(this.pos,this.val);else{if(this.type!==d)throw new p.OperationError("Illegal state.");e.delete(this.pos,this.val)}return t},this.invert=function(){var t=this.toJSON();if(this.type===f)t.type=d;else if(this.type===d)t.type=f;else{if(this.type!==l)throw new p.OperationError("Illegal state.");t.type=l}return new y(t)},this.hasConflict=function(t){return y.hasConflict(this,t)},this.toJSON=function(){var t={type:this.type};return this.type===l?t:(t.pos=this.pos,t.val=this.val,t)},this.isInsert=function(){return this.type===f},this.isDelete=function(){return this.type===d},this.isNOP=function(){return this.type===l},this.isMove=function(){return this.type===g}},y.Prototype.prototype=u.prototype,y.prototype=new y.Prototype;var m=0,v=1,b=2,S=4,w={};w[l]=m,w[d]=v,w[f]=b,w[g]=S;var _=[];_[v|v]=function(t,e){return t.pos===e.pos},_[v|b]=function(){return!1},_[b|b]=function(t,e){return t.pos===e.pos};var x,E=function(t,e){if(t.type===l||e.type===l)return!1;var n=w[t.type]|w[e.type];return _[n]?_[n](t,e):!1};x=function(t,e,s){if(s=s||{},s.check&&E(t,e))throw u.conflict(t,e);return s.inplace||(t=c.clone(t),e=c.clone(e)),t.type===l||e.type===l||(t.type===f&&e.type===f?n(t,e,!0):t.type===d&&e.type===d?r(t,e,!0):t.type===g||e.type===g?o(t,e,s.check,!0):i(t,e,!0)),[t,e]};var C=function(t,e){return a.isArray(t)?t=t[0]===g?new s(t[1],t[2]):new y(t):t instanceof y||(t=y.fromJSON(t)),t.apply(e)};y.transform=h.createTransform(x),y.hasConflict=E,y.perform=C,y.apply=C;var s=function(t,e){if(this.type=g,this.pos=t,this.target=e,!a.isNumber(this.pos)||!a.isNumber(this.target)||this.pos<0||this.target<0)throw new p.OperationError("Illegal argument")};s.Prototype=function(){this.clone=function(){return new s(this.pos,this.target)},this.apply=function(t){if(this.type===l)return t;var e=t instanceof y.ArrayAdapter?t:new y.ArrayAdapter(t),n=t[this.pos];return e.move(n,this.pos,this.target),t},this.invert=function(){return new s(this.target,this.pos)},this.toJSON=function(){return{type:g,pos:this.pos,target:this.target}}},s.Prototype.prototype=y.prototype,s.prototype=new s.Prototype,s.fromJSON=function(t){return new s(t.pos,t.target)};var P=function(t,e){var n,r,i=[0];for(n=0;n<t.length;n++)for(r=0;r<e.length;r++)i[r+1]=i[r+1]||0,i[r+1]=a.isEqual(t[n],e[r])?Math.max(i[r+1],i[r]+1):Math.max(i[r+1],i[r]);var o=[];for(r=e.length;r>=0;r--)i[r]>i[r-1]&&o.unshift(e[r-1]);return o};y.Insert=function(t,e){return new y({type:f,pos:t,val:e})},y.Delete=function(t,e){return a.isArray(t)&&(t=t.indexOf(e)),0>t?new y({type:l}):new y({type:d,pos:t,val:e})},y.Move=function(t,e){return new s(t,e)},y.Push=function(t,e){var n=t.length;return y.Insert(n,e)},y.Pop=function(t){var e=t.length-1;return y.Delete(e,t[e])},y.Update=function(t,e){var n,r,i,o=P(t,e),s=o,a=t,c=e;for(n=0,r=0,i=0,o=[];r<a.length||i<c.length;)s[n]===a[r]&&a[r]===c[i]?(n++,r++,i++,o.push(1)):s[n]===a[r]?o.push(["+",c[i++]]):o.push(["-",a[r++]]);return y.Sequence(o)},y.Compound=function(t){return 1===t.length?t[0]:new h(t)},y.Clear=function(t){for(var e=[],n=0;n<t.length;n++)e.push(y.Delete(0,t[n]));return y.Compound(e)},y.Sequence=function(t){for(var e=0,n=[],r=0;r<t.length;r++){var i=t[r];if(a.isNumber(i)&&i>0)e+=i;else if("+"===i[0])n.push(y.Insert(e,i[1])),e+=1;else{if("-"!==i[0])throw new p.OperationError("Illegal operation.");n.push(y.Delete(e,i[1]))}}return new h(n)},y.create=function(t,e){var n,r,i=e[0];if(i===f||"+"===i)return r=e[1],n=e[2],y.Insert(r,n);if(i===d||"-"===i)return r=e[1],n=t[r],y.Delete(r,n);if(i===g||">>"===i){r=e[1];var o=e[2];return y.Move(r,o)}throw new p.OperationError("Illegal specification.")};var k=function(t){this.array=t};k.prototype={insert:function(t,e){if(this.array.length<t)throw new p.OperationError("Provided array is too small.");this.array.splice(t,0,e)},"delete":function(t,e){if(this.array.length<t)throw new p.OperationError("Provided array is too small.");if(this.array[t]!==e)throw new p.OperationError("Unexpected value at position "+t+". Expected "+e+", found "+this.array[t]);this.array.splice(t,1)},move:function(t,e,n){if(this.array.length<e)throw new p.OperationError("Provided array is too small.");if(this.array.splice(e,1),this.array.length<n)throw new p.OperationError("Provided array is too small.");this.array.splice(n,0,t)}},y.ArrayAdapter=k,y.NOP=l,y.DELETE=d,y.INSERT=f,y.MOVE=g,e.exports=y},{"./compound":186,"./operation":188,"substance-util":219,underscore:225}],186:[function(t,e){"use strict";t("underscore");var n=t("substance-util"),r=t("./operation"),i="compound",o=function(t){if(this.type=i,this.ops=t,this.alias=void 0,!t||0===t.length)throw new r.OperationError("No operations given.")};o.Prototype=function(){this.clone=function(){for(var t=[],e=0;e<this.ops.length;e++)t.push(n.clone(this.ops[e]));return new o(t)},this.apply=function(t){for(var e=0;e<this.ops.length;e++)t=this.ops[e].apply(t);return t},this.invert=function(){for(var t=[],e=0;e<this.ops.length;e++)t.unshift(this.ops[e].invert());return new o(t)},this.toJSON=function(){var t={type:i,ops:this.ops};return this.alias&&(t.alias=this.alias),t}},o.Prototype.prototype=r.prototype,o.prototype=new o.Prototype,o.TYPE=i;var s=function(t,e,n,r,o){var a;if(e.type===i)for(a=0;a<e.ops.length;a++)s(t,e.ops[a],n,r,o);else for(a=0;a<t.ops.length;a++){var c,p;n?(c=t.ops[a],p=e):(c=e,p=t.ops[a]),o(c,p,{inplace:!0,check:r})}};o.createTransform=function(t){return function(e,r,o){return o=o||{},e.type===i||r.type===i?(o.inplace||(e=n.clone(e),r=n.clone(r)),e.type===i?s(e,r,!0,o.check,t):r.type===i&&s(r,e,!1,o.check,t),[e,r]):t(e,r,o)}},e.exports=o},{"./operation":188,"substance-util":219,underscore:225}],187:[function(t,e){"use strict";function n(t){return t instanceof a?n(t.ops[0]):t instanceof c?"string":t instanceof p?"array":"other"}var r=t("underscore"),i=t("substance-util"),o=i.errors,s=t("./operation"),a=t("./compound"),c=t("./text_operation"),p=t("./array_operation"),u="NOP",h="create",l="delete",d="update",f="set",g=function(t){if(this.type=t.type,this.path=t.path,this.type===h||this.type===l)this.val=t.val;else if(this.type===d){if(void 0===t.diff)throw new o.OperationError("Illegal argument: update by value or by diff must be provided");this.diff=t.diff,this.propertyType=t.propertyType}else this.type===f&&(this.val=t.val,this.original=t.original)};g.fromJSON=function(t){if(t.type===a.TYPE){for(var e=[],n=0;n<t.ops.length;n++)e.push(g.fromJSON(t.ops[n]));return g.Compound(e)}return new g(t)},g.Prototype=function(){this.clone=function(){return new g(this)},this.isNOP=function(){return this.type===u?!0:this.type===d?this.diff.isNOP():void 0},this.apply=function(t){if(this.type===u)return t;var e=t instanceof g.Object?t:new g.Object(t);if(this.type===h)return e.create(this.path,i.clone(this.val)),t;var n=e.get(this.path);if(this.type===l){if(void 0===n)throw new o.OperationError("Property "+JSON.stringify(this.path)+" not found.");e.delete(this.path,n)}else if(this.type===d)if("object"===this.propertyType)n=g.apply(this.diff,n),e.inplace()||e.update(this.path,n,this.diff);else if("array"===this.propertyType)n=p.apply(this.diff,n),e.inplace()||e.update(this.path,n,this.diff);else{if("string"!==this.propertyType)throw new o.OperationError("Unsupported type for operational update.");n=c.apply(this.diff,n),e.update(this.path,n,this.diff)}else{if(this.type!==f)throw new o.OperationError("Illegal state.");e.set(this.path,i.clone(this.val))}return t},this.invert=function(){if(this.type===u)return{type:u};var t=new g(this);if(this.type===h)t.type=l;else if(this.type===l)t.type=h;else if(this.type===d){var e;"string"===this.propertyType?e=c.fromJSON(this.diff).invert():"array"===this.propertyType&&(e=p.fromJSON(this.diff).invert()),t.diff=e,t.propertyType=this.propertyType}else{if(this.type!==f)throw new o.OperationError("Illegal state.");t.val=this.original,t.original=this.val}return t},this.hasConflict=function(t){return g.hasConflict(this,t)},this.toJSON=function(){if(this.type===u)return{type:u};var t={type:this.type,path:this.path};return this.type===h||this.type===l?t.val=this.val:this.type===d?(t.diff=this.diff,t.propertyType=this.propertyType):this.type===f&&(t.val=this.val,t.original=this.original),t}},g.Prototype.prototype=s.prototype,g.prototype=new g.Prototype,g.Object=function(t){this.obj=t},g.Object.Prototype=function(){function t(t,e,n,r){for(var i=e,o=0;o<n.length-1;o++){if(void 0===i)throw new Error("Key error: could not find element for path "+JSON.stringify(t.path));void 0===i[n[o]]&&r&&(i[n[o]]={}),i=i[n[o]]}return{parent:i,key:n[o]}}this.get=function(e){var n=t(this,this.obj,e);return n.parent[n.key]},this.create=function(e,n){var r=t(this,this.obj,e,!0);if(void 0!==r.parent[r.key])throw new o.OperationError("Value already exists. path ="+JSON.stringify(e));r.parent[r.key]=n},this.update=function(t,e){this.set(t,e)},this.set=function(e,n){var r=t(this,this.obj,e);r.parent[r.key]=n},this.delete=function(e){var n=t(this,this.obj,e);delete n.parent[n.key]},this.inplace=function(){return!0}},g.Object.prototype=new g.Object.Prototype;var y=function(t,e){return t.type===u||e.type===u?!1:r.isEqual(t.path,e.path)},m=function(t,e){t.type=u,e.type=u},v=function(){throw new o.OperationError("Can not transform two concurring creates of the same property")},b=function(t,e,n){return t.type!==l?b(e,t,!0):(n?(t.val=e.val,e.type=u):t.type=u,void 0)},S=function(t,e,n){if(t.type!==l)return S(e,t,!0);var r;"string"===e.propertyType?r=c.fromJSON(e.diff):"array"===e.propertyType&&(r=p.fromJSON(e.diff)),n?(t.val=r.apply(t.val),e.type=u):(t.type=u,e.type=h,e.val=r.apply(t.val))},w=function(){throw new o.OperationError("Can not transform a concurring create and update of the same property")},_=function(t,e){var n,r,i;"string"===e.propertyType?(n=c.fromJSON(t.diff),r=c.fromJSON(e.diff),i=c.transform(n,r,{inplace:!0})):"array"===e.propertyType?(n=p.fromJSON(t.diff),r=p.fromJSON(e.diff),i=p.transform(n,r,{inplace:!0})):"object"===e.propertyType&&(n=g.fromJSON(t.diff),r=g.fromJSON(e.diff),i=g.transform(n,r,{inplace:!0})),t.diff=i[0],e.diff=i[1]},x=function(t,e,n){return t.type!==h?x(e,t,!0):(n?(t.type=f,t.original=e.val,e.type=u):(t.type=u,e.original=t.val),void 0)},E=function(t,e,n){return t.type!==l?E(e,t,!0):(n?(t.val=e.val,e.type=u):(t.type=u,e.type=h,e.original=void 0),void 0)},C=function(){throw new o.OperationError("Can not transform update/set of the same property.")},P=function(t,e){t.type=u,e.original=t.val},k=0,O=1,T=2,q=4,I=8,N={};N[u]=k,N[h]=O,N[l]=T,N[d]=q,N[f]=I;var A=[];A[T|T]=m,A[T|O]=b,A[T|q]=S,A[O|O]=v,A[O|q]=w,A[q|q]=_,A[O|I]=x,A[T|I]=E,A[q|I]=C,A[I|I]=P;var D=function(t,e,n){n=n||{};var r=y(t,e);if(n.check&&r)throw s.conflict(t,e);return n.inplace||(t=i.clone(t),e=i.clone(e)),r?(A[N[t.type]|N[e.type]](t,e),[t,e]):[t,e]};g.transform=a.createTransform(D),g.hasConflict=y;var j=function(t,e){return t instanceof g||(t=g.fromJSON(t)),t.apply(e)};g.apply=j,g.Create=function(t,e){return new g({type:h,path:t,val:e})},g.Delete=function(t,e){return new g({type:l,path:t,val:e})},g.Update=function(t,e,r){return r=r||n(e),new g({type:d,path:t,diff:e,propertyType:r})},g.Set=function(t,e,n){return new g({type:f,path:t,val:n,original:e})},g.Compound=function(t){return 0===t.length?null:new a(t)};var M=function(t,e,n,i,s,a){for(var c=Object.getOwnPropertyNames(e),p=0;p<c.length;p++){var u=c[p],h=n.concat(u);if(void 0===e[u]&&void 0!==t[u])i.push(g.Delete(h,t[u]));else if(r.isObject(e[u])){if(!r.isObject(t[u]))throw new o.OperationError("Incompatible arguments: newVals must have same structure as obj.");M(t[u],e[u],h,i,s,a)}else if(void 0===t[u])s.push(g.Create(h,e[u]));else{var l=t[u],d=e[u];r.isEqual(l,d)||a.push(g.Set(h,l,d))}}};g.Extend=function(t,e){var n=[],r=[],i=[];return M(t,e,[],n,r,i),g.Compound(n.concat(r).concat(i))},g.NOP=u,g.CREATE=h,g.DELETE=l,g.UPDATE=d,g.SET=f,e.exports=g},{"./array_operation":185,"./compound":186,"./operation":188,"./text_operation":190,"substance-util":219,underscore:225}],188:[function(t,e){"use strict";var n=t("substance-util"),r=n.errors,i=r.define("OperationError",-1),o=r.define("Conflict",-1),s=function(){};s.Prototype=function(){this.clone=function(){throw new Error("Not implemented.")},this.apply=function(){throw new Error("Not implemented.")},this.invert=function(){throw new Error("Not implemented.")},this.hasConflict=function(){throw new Error("Not implemented.")}},s.prototype=new s.Prototype,s.conflict=function(t,e){var n=new r.Conflict("Conflict: "+JSON.stringify(t)+" vs "+JSON.stringify(e));return n.a=t,n.b=e,n},s.OperationError=i,s.Conflict=o,e.exports=s},{"substance-util":219}],189:[function(t,e){var n={};n.last=function(t){return"compound"===t.type?t.ops[t.ops.length-1]:t},n.each=function(t,e,r,i){if("compound"===t.type){for(var o=t.ops.length,s=0;o>s;s++){var a=t.ops[s];if(i&&(a=t.ops[o-s-1]),"compound"===a.type){if(n.each(a,e,r,i)===!1)return!1}else if(e.call(r,a)===!1)return!1}return!0}return e.call(r,t)},e.exports=n},{}],190:[function(t,e){"use strict";function n(t,e,n){t.pos===e.pos?n?e.pos+=t.str.length:t.pos+=e.str.length:t.pos<e.pos?e.pos+=t.str.length:t.pos+=e.str.length}function r(t,e,n){if(t.pos>e.pos)return r(e,t,!n);if(t.pos===e.pos&&t.str.length>e.str.length)return r(e,t,!n);if(e.pos<t.pos+t.str.length){var i=e.pos-t.pos,o=t.str.length-i,s=i+e.str.length;t.str=t.str.slice(0,i)+t.str.slice(s),e.str=e.str.slice(o),e.pos-=i}else e.pos-=t.str.length}function i(t,e){if(t.type===h)return i(e,t);if(t.pos<=e.pos)e.pos+=t.str.length;else if(t.pos>=e.pos+e.str.length)t.pos-=e.str.length;else{var n=t.pos-e.pos;e.str=e.str.slice(0,n)+t.str+e.str.slice(n),t.str=""}}var o=t("underscore"),s=t("substance-util"),a=s.errors,c=t("./operation"),p=t("./compound"),u="+",h="-",l=function(t){if(o.isArray(t)&&(t={type:t[0],pos:t[1],str:t[2]}),void 0===t.type||void 0===t.pos||void 0===t.str)throw new a.OperationError("Illegal argument: insufficient data.");if(this.type=t.type,this.pos=t.pos,this.str=t.str,!this.isInsert()&&!this.isDelete())throw new a.OperationError("Illegal type.");if(!o.isString(this.str))throw new a.OperationError("Illegal argument: expecting string.");if(!o.isNumber(this.pos)&&this.pos<0)throw new a.OperationError("Illegal argument: expecting positive number as pos.")};l.fromJSON=function(t){if(t.type===p.TYPE){for(var e=[],n=0;n<t.ops.length;n++)e.push(l.fromJSON(t.ops[n]));return l.Compound(e)}return new l(t)},l.Prototype=function(){this.clone=function(){return new l(this)},this.isNOP=function(){return"NOP"===this.type||0===this.str.length},this.isInsert=function(){return this.type===u},this.isDelete=function(){return this.type===h},this.length=function(){return this.str.length},this.apply=function(t){if(this.isEmpty())return t;var e=t instanceof l.StringAdapter?t:new l.StringAdapter(t);if(this.type===u)e.insert(this.pos,this.str);else{if(this.type!==h)throw new a.OperationError("Illegal operation type: "+this.type);e.delete(this.pos,this.str.length)}return e.get()},this.invert=function(){var t={type:this.isInsert()?"-":"+",pos:this.pos,str:this.str};return new l(t)},this.hasConflict=function(t){return l.hasConflict(this,t)},this.isEmpty=function(){return 0===this.str.length},this.toJSON=function(){return{type:this.type,pos:this.pos,str:this.str}}},l.Prototype.prototype=c.prototype,l.prototype=new l.Prototype;var d=function(t,e){if(t.type===u&&e.type===u)return t.pos===e.pos;if(t.type===h&&e.type===h)return!(t.pos>=e.pos+e.str.length||e.pos>=t.pos+t.str.length);var n,r;return t.type===h?(n=t,r=e):(n=e,r=t),r.pos>=n.pos&&r.pos<n.pos+n.str.length},f=function(t,e,o){if(o=o||{},o.check&&d(t,e))throw c.conflict(t,e);return o.inplace||(t=s.clone(t),e=s.clone(e)),t.type===u&&e.type===u?n(t,e,!0):t.type===h&&e.type===h?r(t,e,!0):i(t,e),[t,e]},g=function(t,e){return o.isArray(t)?t=new l(t):t instanceof l||(t=l.fromJSON(t)),t.apply(e)};l.transform=p.createTransform(f),l.apply=g;var y=function(t){this.str=t};y.prototype={insert:function(t,e){if(this.str.length<t)throw new a.OperationError("Provided string is too short.");this.str=this.str.slice(0,t)+e+this.str.slice(t)},"delete":function(t,e){if(this.str.length<t+e)throw new a.OperationError("Provided string is too short.");this.str=this.str.slice(0,t)+this.str.slice(t+e)},get:function(){return this.str}},l.Insert=function(t,e){return new l(["+",t,e])},l.Delete=function(t,e){return new l(["-",t,e])},l.Compound=function(t){return 1===t.length?t[0]:new p(t)},l.fromOT=function(t,e){var n=[],r=0,i=0;return o.isArray(e)||(e=o.toArray(arguments).slice(1)),o.each(e,function(e){if(o.isString(e))n.push(l.Insert(i,e)),i+=e.length;else if(0>e){var s=-e;n.push(l.Delete(i,t.slice(r,r+s))),r+=s}else r+=e,i+=e}),0===n.length?null:l.Compound(n)},l.fromSequence=l.fromOT;var m=function(t){o.isArray(t)?(this.start=t[0],this.length=t[1]):(this.start=t.start,this.length=t.length)},v=function(t,e,n,r){var i=!1;{if(e.type!==p.TYPE){var s,a;if(o.isArray(t)?(s=t[0],a=t[1]):(s=t.start,a=s+t.length),e.type===h){var c=e.pos,l=e.pos+e.str.length;s>=c&&(s-=Math.min(l-c,s-c),i=!0),a>=c&&(a-=Math.min(l-c,a-c),i=!0)}else if(e.type===u){var d=e.pos,f=e.str.length;(s>d||d===s&&!n)&&(s+=f,i=!0),(a>d||d===a&&r)&&(a+=f,i=!0)}return i&&(o.isArray(t)?(t[0]=s,t[1]=a):(t.start=s,t.length=a-s)),i}for(var g=0;g<e.ops.length;g++){var y=e.ops[g];v(t,y)}}};m.Prototype=function(){this.clone=function(){return new m(this)},this.toJSON=function(){var t={start:this.start,length:this.length};return t},this.transform=function(t,e){return v(this.range,t,e)}},m.prototype=new m.Prototype,m.transform=function(t,e,n,r){return v(t,e,n,r)},m.fromJSON=function(t){return new m(t)},l.StringAdapter=y,l.Range=m,l.INSERT=u,l.DELETE=h,e.exports=l},{"./compound":186,"./operation":188,"substance-util":219,underscore:225}],191:[function(t){"use strict";function e(t,e,n,i){var s=o.transform(t,e),a=s[1].apply(t.apply(n));r.isEqual(i,a),a=s[0].apply(e.apply(n)),r.isEqual(i,a)}var n=t("substance-test"),r=n.assert,i=n.registerTest,o=t("../index").TextOperation,s=function(){this.actions=["Apply: Insert char at the string end",function(){var t="Lorem ipsum",e="Lorem ipsum.",n=o.Insert(11,".");r.isEqual(e,n.apply(t))},"Transformation: a=Insert, b=Insert, a before b",function(){var t="Lorem ipsum",n="Lorem bla ipsum blupp",r=o.Insert(6,"bla "),i=o.Insert(11," blupp");e(r,i,t,n),e(i,r,t,n)},"Transformation: a=Insert, b=Insert, same position",function(){var t="Lorem ipsum",n="Lorem bla blupp ipsum",r="Lorem blupp bla ipsum",i=o.Insert(6,"bla "),s=o.Insert(6,"blupp ");e(i,s,t,n),e(s,i,t,r)},"Transformation: a=Delete, b=Delete, a before b, no overlap",function(){var t="Lorem ipsum dolor sit amet",n="Lorem dolor amet",r=o.Delete(6,"ipsum "),i=o.Delete(18,"sit ");e(r,i,t,n),e(i,r,t,n)},"Transformation: a=Delete, b=Delete, with overlap",function(){var t="Lorem ipsum dolor sit amet",n="Lorem amet",r=o.Delete(6,"ipsum dolor sit "),i=o.Delete(12,"dolor ");e(r,i,t,n),e(i,r,t,n)},"Transformation: a=Delete, b=Delete, same position",function(){var t="Lorem ipsum dolor sit amet",n="Lorem amet",r=o.Delete(6,"ipsum dolor "),i=o.Delete(6,"ipsum dolor sit ");e(r,i,t,n),e(i,r,t,n)},"Transformation: a=Insert, b=Delete, a before b",function(){var t="Lorem dolor sit amet",n="Lorem ipsum dolor amet",r=o.Insert(6,"ipsum "),i=o.Delete(12,"sit ");e(r,i,t,n),e(i,r,t,n)},"Transformation: a=Insert, b=Delete, overlap",function(){var t="Lorem dolor sit amet",n="Lorem amet",r=o.Insert(12,"ipsum "),i=o.Delete(6,"dolor sit ");e(r,i,t,n),e(i,r,t,n)},"Compound: 'bla' - 'blapp' | 'blupp'",function(){var t="bla",n="blappupp",r="bluppapp",i=o.fromOT("bla",[2,-1,"app"]),s=o.fromOT("bla",[2,-1,"upp"]);e(i,s,t,n),e(s,i,t,r)}]};i(["Substance.Operator","Text Operation"],new s)},{"../index":184,"substance-test":210}],192:[function(t){"use strict";function e(t,e,n,i){var o=s.transform(t,e),a=s.perform(o[1],s.perform(t,n.slice(0)));r.isArrayEqual(i,a),a=s.perform(o[0],s.perform(e,n.slice(0))),r.isArrayEqual(i,a)}var n=t("substance-test"),r=n.assert,i=t("../index"),o=n.registerTest,s=i.ArrayOperation,a=function(){this.actions=["Transformation: a=Insert, b=Insert (1,2), a < b and b < a",function(){var t=[1,3,5],n=[1,2,3,4,5],r=s.Insert(1,2),i=s.Insert(2,4);e(r,i,t,n),e(i,r,t,n)},"Transformation: a=Insert, b=Insert (3), a == b",function(){var t=[1,4],n=[1,2,3,4],r=[1,3,2,4],i=s.Insert(1,2),o=s.Insert(1,3);e(i,o,t,n),e(o,i,t,r)},"Transformation: a=Delete, b=Delete (1,2), a < b and b < a",function(){var t=[1,2,3,4,5],n=[1,3,5],r=s.Delete(1,2),i=s.Delete(3,4);e(r,i,t,n),e(i,r,t,n)},"Transformation: a=Delete, b=Delete (3), a == b",function(){var t=[1,2,3],n=[1,3],r=s.Delete(1,2),i=s.Delete(1,2);e(r,i,t,n),e(i,r,t,n)},"Transformation: a=Insert, b=Delete (1), a < b",function(){var t=[1,3,4,5],n=[1,2,3,5],r=s.Insert(1,2),i=s.Delete(2,4);e(r,i,t,n),e(i,r,t,n)},"Transformation: a=Insert, b=Delete (2), b < a",function(){var t=[1,2,3,5],n=[1,3,4,5],r=s.Insert(3,4),i=s.Delete(1,2);e(r,i,t,n),e(i,r,t,n)},"Transformation: a=Insert, b=Delete (3), a == b",function(){var t=[1,2,3],n=[1,4,3],r=s.Insert(1,4),i=s.Delete(1,2);e(r,i,t,n),e(i,r,t,n)},"Transformation (conflict): a=Move, b=Insert, m.s > i && m.t == i",function(){var t=[1,3,4,5],n=[1,5,2,3,4],r=[1,2,5,3,4],i=s.Move(3,1),o=s.Insert(1,2);e(i,o,t,n),e(o,i,t,r)},"Transformation (conflict): a=Move, b=Insert, m.s < i && m.t == i-1",function(){var t=[1,2,3,5],n=[1,3,2,4,5],r=[1,3,4,2,5],i=s.Move(1,2),o=s.Insert(3,4);e(i,o,t,n),e(o,i,t,r)},"Transformation (conflict): a=Move, b=Delete, m.s == d",function(){var t=[1,2,3,4],n=[1,2,4],r=s.Move(2,0),i=s.Delete(2,3);e(r,i,t,n),e(i,r,t,n)},"Transformation (conflict): a=Move, b=Move, a.s == b.s",function(){var t=[1,2,3,4],n=[1,3,2,4],r=[2,1,3,4],i=s.Move(1,0),o=s.Move(1,2);e(i,o,t,n),e(o,i,t,r)},"Transformation (conflict): a=Move, b=Move, a.s < b.t && a.t == b.t-1",function(){var t=[1,2,3,4],n=[2,1,4,3],r=[2,4,1,3],i=s.Move(0,1),o=s.Move(3,2);e(i,o,t,n),e(o,i,t,r)},"Transformation (conflict): a=Move, b=Move, a.t == b.t",function(){var t=[1,2,3,4],n=[1,3,4,2],r=[1,4,3,2],i=s.Move(2,1),o=s.Move(3,1);e(i,o,t,n),e(o,i,t,r)},"Update: [1,2,3,4,5] -> [2,1,3,4]",function(){var t=[1,2,3,4,5],e=[2,1,3,4],n=s.Update(t,e),i=n.apply(t);r.isArrayEqual(e,i)},"Update: [1,2,3,4,5] -> []",function(){var t=[1,2,3,4,5],e=[],n=s.Update(t,e),i=n.apply(t);r.isArrayEqual(e,i)},"Update: [1,2,3,4,5] -> [5,4,3,2,1]",function(){var t=[1,2,3,4,5],e=[5,4,3,2,1],n=s.Update(t,e),i=n.apply(t);r.isArrayEqual(e,i)},"Delete 3: [1,2,3,4,5] -> [1,2,4,5]",function(){var t=[1,2,3,4,5],e=[1,2,4,5],n=s.Delete(t,3),i=n.apply(t);r.isArrayEqual(e,i)},"Pop: [1,2,3,4,5] -> [1,2,3,4]",function(){var t=[1,2,3,4,5],e=[1,2,3,4],n=s.Pop(t),i=n.apply(t);r.isArrayEqual(e,i)},"Push: [1,2,3,4] -> [1,2,3,4,6]",function(){var t=[1,2,3,4],e=[1,2,3,4,6],n=s.Push(t,6),i=n.apply(t);r.isArrayEqual(e,i)}]};o(["Substance.Operator","Array Operation"],new a)},{"../index":184,"substance-test":210}],193:[function(t){"use strict";function e(t,e,n,o){var s=c.transform(t,e),a=c.apply(s[1],c.apply(t,i.clone(n)));r.isDeepEqual(o,a),a=c.apply(s[0],c.apply(e,i.clone(n))),r.isDeepEqual(o,a)}var n=t("substance-test"),r=n.assert,i=t("substance-util"),o=i.errors,s=t("../index"),a=n.registerTest,c=s.ObjectOperation,p=s.TextOperation,u=s.ArrayOperation,h=function(){this.actions=["Apply: create",function(){var t=["a"],e="bla",n={a:"bla"},i=c.Create(t,e),o={};i.apply(o),r.isDeepEqual(n,o)},"Apply: create (nested)",function(){var t=["a","b"],e="bla",n={a:{b:"bla"}},i=c.Create(t,e),o={a:{}};i.apply(o),r.isDeepEqual(n,o)},"Apply: delete",function(){var t=["a"],e="bla",n=c.Delete(t,e),i={},o={a:"bla"};n.apply(o),r.isDeepEqual(i,o)},"Apply: delete (nested)",function(){var t=["a","b"],e="bla",n=c.Delete(t,e),i={a:{}},o={a:{b:"bla"}};n.apply(o),r.isDeepEqual(i,o)},"Apply: delete (key error)",function(){var t=["a","b"],e="bla",n=c.Delete(t,e),i={a:{c:"bla"}};r.exception(o.ChronicleError,function(){n.apply(i)})},"Apply: update (text)",function(){var t=["a"],e=c.Update(t,p.fromOT("bla",[2,-1,"upp"])),n={a:"blupp"},i={a:"bla"};e.apply(i),r.isDeepEqual(n,i)},"Apply: update (array)",function(){var t=["a"],e=[1,2,3,4,5],n=c.Update(t,u.Sequence([2,["-",3],2,["+",6]])),i={a:[1,2,4,5,6]},o={a:e.slice(0)};n.apply(o),r.isDeepEqual(i,o)},"Transformation: create/create (conflict)",function(){var t=["a"],e="bla",n="blupp",i=c.Create(t,e),s=c.Create(t,n);r.isTrue(c.hasConflict(i,s)),r.exception(o.ChronicleError,function(){c.transform(i,s)})},"Transformation: delete/delete (conflict)",function(){var t=["a"],n="bla",i={a:n},o={},s=c.Delete(t,n),a=c.Delete(t,n);r.isTrue(c.hasConflict(s,a)),e(s,a,i,o),e(a,s,i,o)},"Transformation: delete/create (conflict)",function(){var t,e,n=["a"],i=c.Delete(n,"bla"),o=c.Create(n,"blupp"),s={a:"blupp"},a={};r.isTrue(c.hasConflict(i,o)),e=c.transform(i,o),t=e[1].apply(i.apply({a:"bla"})),r.isDeepEqual(s,t),t=e[0].apply(o.apply({})),r.isDeepEqual(s,t),e=c.transform(o,i),t=e[1].apply(o.apply({})),r.isDeepEqual(a,t),t=e[0].apply(i.apply({a:"bla"})),r.isDeepEqual(a,t)},"Transformation: delete/update (conflict)",function(){var t=["a"],n=c.Delete(t,"bla"),i=c.Update(t,p.fromOT("bla",[2,-1,"upp"])),o={a:"bla"},s={a:"blupp"},a={};r.isTrue(c.hasConflict(n,i)),e(n,i,o,s),e(i,n,o,a)},"Transformation: create/update (conflict)",function(){var t=["a"],e=c.Create(t,"bla"),n=c.Update(t,p.fromOT("foo",[-3,"bar"]));r.isTrue(c.hasConflict(e,n)),r.exception(o.ChronicleError,function(){c.transform(e,n)})},"Transformation: update/update (conflict)",function(){var t=["a"],n=c.Update(t,p.fromOT("bla",[2,-1,"app"])),i=c.Update(t,p.fromOT("bla",[2,-1,"upp"])),o={a:"bla"},s={a:"blappupp"},a={a:"bluppapp"};r.isTrue(c.hasConflict(n,i)),e(n,i,o,s),e(i,n,o,a)},"Transformation: delete/set (conflict)",function(){var t=["a"],n=c.Delete(t,"bla"),i=c.Set(t,"bla","blupp"),o={a:"bla"},s={a:"blupp"},a={};r.isTrue(c.hasConflict(n,i)),e(n,i,o,s),e(i,n,o,a)},"Transformation: create/set (conflict)",function(){var t=["a"],e=c.Create(t,"foo"),n=c.Set(t,"bla","blupp"),i={a:"blupp"},o={a:"foo"};r.isTrue(c.hasConflict(e,n));var s=c.transform(e,n),a=s[1].apply(e.apply({}));r.isDeepEqual(i,a),a=s[0].apply(n.apply({a:"bla"})),r.isDeepEqual(i,a),s=c.transform(n,e),a=s[1].apply(n.apply({a:"bla"})),r.isDeepEqual(o,a),a=s[0].apply(e.apply({})),r.isDeepEqual(o,a)},"Transformation: update/set (conflict)",function(){var t=["a"],e=c.Update(t,p.fromOT("bla",[2,-1,"upp"])),n=c.Set(t,"bla","blupp");r.isTrue(c.hasConflict(e,n)),r.exception(o.ChronicleError,function(){c.transform(e,n)})},"Transformation: set/set (conflict)",function(){var t=["a"],n=c.Set(t,"bla","blapp"),i=c.Set(t,"bla","blupp"),o={a:"bla"},s={a:"blupp"},a={a:"blapp"};r.isTrue(c.hasConflict(n,i)),e(n,i,o,s),e(i,n,o,a)}]};a(["Substance.Operator","Object Operation"],new h)},{"../index":184,"substance-test":210,"substance-util":219}],194:[function(t){"use strict";t("./001-text-operation"),t("./002-array-operation"),t("./003-object-operation")},{"./001-text-operation":191,"./002-array-operation":192,"./003-object-operation":193}],195:[function(t,e){"use strict";e.exports=t("./src/regexp")},{"./src/regexp":196}],196:[function(t,e){"use strict";var n=function(t){this.index=t.index,this.match=[];for(var e=0;e<t.length;e++)this.match.push(t[e])};n.Prototype=function(){this.captures=function(){return this.match.slice(1)},this.toString=function(){return this.match[0]}},n.prototype=new n.Prototype;var r=function(t){this.exp=t};r.Prototype=function(){this.match=function(t){if(void 0===t)throw new Error("No string given");if(this.exp.global){var e,r=[];for(this.exp.compile(this.exp);null!==(e=this.exp.exec(t));)r.push(new n(e));return r}return this.exp.exec(t)}},r.prototype=new r.Prototype,r.Match=n,e.exports=r},{}],197:[function(t,e){"use strict";var n=t("./src/store");n.LocalStore=t("./src/local_store"),n.MemoryStore=t("./src/memory_store"),e.exports=n},{"./src/local_store":198,"./src/memory_store":199,"./src/store":200}],198:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util");r.errors;var i=t("./store"),o=function(t){i.call(this),this.scope=t||""};o.Prototype=function(){function t(t){for(var e,r=[],i=0;;){if(e=localStorage.key(i++),!e)break;0===e.indexOf(t)&&r.push(e)}n.each(r,function(t){localStorage.removeItem(t)})}this.hash=function(){return this.sortedhash.apply(this,arguments)},this.sortedhash=function(){var t=i.defaultHashKey(arguments,this.scope);return new o.Hash(t)},this.clear=function(){t(this.scope)},this.subStore=function(t){return new o(this.scope+":"+t.join(":"))}},o.Prototype.prototype=i.prototype,o.prototype=new o.Prototype,o.Hash=function(t){this.scope=t},o.Hash.prototype=n.extend(new i.AbstractHash,{scoped:function(t){return this.scope+":"+t},contains:function(t){return t=this.scoped(t),localStorage.hasOwnProperty(t)},__get__:function(t){return t=this.scoped(t),JSON.parse(localStorage.getItem(t))},__set__:function(t,e){t=this.scoped(t),localStorage.setItem(t,JSON.stringify(e))},__delete__:function(t){t=this.scoped(t),localStorage.removeItem(t)}}),e.exports=o},{"./store":200,"substance-util":219,underscore:225}],199:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util");r.errors;var i=t("./store"),o=function(t){i.call(this),this.content=t||{}};o.Prototype=function(){function t(t,e){return n.each(e,function(e){t[e]=t[e]||{},t=t[e]}),t}this.hash=function(){return this.sortedhash.apply(this,arguments)},this.sortedhash=function(){var e=t(this.content,arguments);return new o.Hash(e)},this.clear=function(){this.content={}},this.subStore=function(e){var n=t(this.content,e);return new o(n)}},o.Prototype.prototype=i.prototype,o.prototype=new o.Prototype,o.Hash=function(t){if(!t)throw new Error("Illegal argument.");this.obj=t},o.Hash.prototype=n.extend(new i.AbstractHash,{contains:function(t){return!!this.obj[t]},__get__:function(t){return this.obj[t]},__set__:function(t,e){this.obj[t]=r.deepclone(e)},__delete__:function(t){delete this.obj[t]}}),e.exports=o},{"./store":200,"substance-util":219,underscore:225}],200:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util"),i=r.errors,o=i.define("StoreError",-1),s=function(){};s.Prototype=function(){this.hash=function(t){return this.sortedhash(t)},this.sortedhash=function(){throw"Called abstract method."},this.clear=function(){throw"Called abstract method."},this.subStore=function(){throw"Called abstract method."}},s.prototype=new s.Prototype,s.AbstractHash=function(){this.contains=function(t){var e=this.keys();return e?e.indexOf(t)>=0:!1},this.keys=function(){var t=this.__get__("__keys__");return t||(this.__set__("__keys__",[]),t=[]),t},this.get=function(t){return this.contains(t)?this.__get__(t):void 0},this.set=function(t,e){if(!t)throw new o("Illegal key:"+t);var r=n.without(this.keys(),t);r.push(t),this.__set__("__keys__",r),this.__set__(t,e)},this.delete=function(t){var e=n.without(this.keys(),t);this.__set__("__keys__",e),this.__delete__(t)},this.clear=function(){var t=this.keys();n.each(t,function(t){this.__delete__(t)},this),this.__set__("__keys__",[])
},this.dump=function(){var t=this.keys(),e={};return n.each(t,function(t){e[t]=this.__get__(t)},this),e},this.__get__=function(){throw new Error("Not implemented")},this.__set__=function(){throw new Error("Not implemented")},this.__delete__=function(){throw new Error("Not implemented")}},s.defaultHashKey=function(t,e){var n=[];e&&n.push(e);for(var r=0;r<t.length;r++)n.push(t[r]);return n.join(":")},e.exports=s},{"substance-util":219,underscore:225}],201:[function(t){"use strict";t("./memory_store_test"),t("./local_store_test")},{"./local_store_test":202,"./memory_store_test":203}],202:[function(t){var e=self,n=t("../index").LocalStore,r=t("substance-test"),i=r.registerTest,o=t("./store_test"),s={setup:function(){this.store=new n("test:localstore"),this.store.clear()},actions:[]};e.localStorage&&i(["Substance.Store","LocalStore"],new o(s))},{"../index":197,"./store_test":204,"substance-test":210}],203:[function(t){"use strict";var e=t("../index"),n=t("substance-test"),r=n.registerTest,i=t("./store_test"),o={setup:function(){this.store=new e.MemoryStore}};r(["Substance.Store","MemoryStore"],new i(o))},{"../index":197,"./store_test":204,"substance-test":210}],204:[function(t,e){"use strict";function n(t){r.extend(this,t),this.actions=["Create Hash",function(){this.hash=this.store.hash("hash1"),o.isArrayEqual([],this.hash.keys())},"Set",function(){this.hash.set("foo","bar"),o.isEqual("bar",this.hash.get("foo")),o.isTrue(this.hash.contains("foo")),o.isArrayEqual(["foo"],this.hash.keys())},"Delete",function(){this.hash.delete("foo"),o.isFalse(this.hash.contains("foo")),o.isArrayEqual([],this.hash.keys()),o.isUndefined(this.hash.get("foo"))},"Clear",function(){this.hash.set("a",1),this.hash.set("b",2),this.hash.set("c",3),this.hash.clear(),o.isArrayEqual([],this.hash.keys()),o.isUndefined(this.hash.get("a")),o.isUndefined(this.hash.get("b")),o.isUndefined(this.hash.get("c"))}]}var r=t("underscore"),i=t("substance-test"),o=i.assert;e.exports=n},{"substance-test":210,underscore:225}],205:[function(t,e){"use strict";var n=t("./src/surface");e.exports=n},{"./src/surface":206}],206:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-application").View,i=t("substance-util"),o=t("substance-commander"),s=function(t,e){e=n.extend({editable:!0},e),r.call(this);var i=this;if(this.options=e,this.renderer=this.options.renderer?this.options.renderer:new this.doc.__document.constructor.Renderer(t),this.doc=t,this.nodeTypes=t.__document.nodeTypes,this.listenTo(this.doc.selection,"selection:changed",this.renderSelection),this.listenTo(this.doc.__document,"property:updated",this.onUpdateView),this.listenTo(this.doc.__document,"graph:reset",this.reset),this.build(),this.$el.addClass("surface"),this.$el.addClass(this.doc.view),e.editable){this.el.setAttribute("contenteditable","true"),this.el.spellcheck=!1,this.$el.mouseup(function(t){this.ignoreNextSelection=!0,this.updateSelection(t)}.bind(this)),this.$el.delegate("img","click",function(t){var e=$(t.currentTarget).parent().parent().parent(),n=e.attr("id");return i.doc.selection.selectNode(n),!1}),this._dirt=[],this._onKeyDown=function(){this._dirtPossible=!0}.bind(this),this._onTextInput=function(t){for(this._dirtPossible=!1;this._dirt.length>0;){var e=this._dirt.shift();e[0].textContent=e[1]}this.doc.write(t.data),t.preventDefault()}.bind(this);var s=function(t,e){return function(n){i._dirtPossible=!1,setTimeout(t,0),e!==!0&&n.preventDefault()}};this.keyboard=new o.Mousetrap,this.keyboard.bind(["up","down","left","right","shift+up","shift+down","shift+left","shift+right","ctrl+up","ctrl+down","ctrl+left","ctrl+right","ctrl+shift+up","ctrl+shift+down","ctrl+shift+left","ctrl+shift+right","alt+up","alt+down","alt+left","alt+right"],function(){setTimeout(function(){i.ignoreNextSelection=!0,i.updateSelection()},0)},"keydown"),this.keyboard.bind(["backspace"],s(function(){i.doc.delete("left")}),"keydown"),this.keyboard.bind(["del"],s(function(){i.doc.delete("right")}),"keydown"),this.keyboard.bind(["enter"],s(function(){i.doc.modifyNode()}),"keydown"),this.keyboard.bind(["shift+enter"],s(function(){i.doc.write("\n")}),"keydown"),this.keyboard.bind(["space"],s(function(){i.doc.write(" ")}),"keydown"),this.keyboard.bind(["tab"],s(function(){i.doc.write("  ")}),"keydown"),this.keyboard.bind(["ctrl+z"],s(function(){i.doc.undo()}),"keydown"),this.keyboard.bind(["ctrl+shift+z"],s(function(){i.doc.redo()}),"keydown"),this.makeEditable(this.el)}};s.Prototype=function(){function t(t,e,n){var r=t.childNodes;if(e<r.length){var i=r[e];t.insertBefore(n,i)}else t.appendChild(n)}var e=function(t){for(var e=t;void 0!==e;){if($(e).is(".content-node"))return e;e=e.parentElement}return null};this.makeEditable=function(t){var e=this;t.addEventListener("keydown",this._onKeyDown),t.addEventListener("textInput",this._onTextInput,!0),t.addEventListener("input",this._onTextInput,!0),this._dirt=[],this._observer=new MutationObserver(function(t){t.forEach(function(t){e._dirtPossible&&e._dirt.push([t.target,t.oldValue])})});var n={subtree:!0,characterData:!0,characterDataOldValue:!0};this._observer.observe(t,n),this.keyboard.connect(t)},this.updateSelection=function(){var t=window.getSelection();if(null!==t.anchorNode){if($(t.anchorNode.parentElement).is(".cursor"))return this.doc.selection.collapse("cursor"),void 0;var n,r,i=t.getRangeAt(0);if(n=[i.startContainer,i.startOffset],r=[i.endContainer,i.endOffset],i.endContainer===t.anchorNode&&i.endOffset===t.anchorOffset){var o=n;n=r,r=o}var s=e.call(this,n[0]),a=e.call(this,r[0]),c=s.getAttribute("id"),p=this.doc.getPosition(c),u=this.nodes[c].getCharPosition(n[0],n[1]),h=a.getAttribute("id"),l=this.doc.getPosition(h),d=this.nodes[h].getCharPosition(r[0],r[1]),f=[p,u],g=[l,d];this.doc.selection.set({start:f,end:g})}},this.renderSelection=function(){if(this.ignoreNextSelection===!0)return this.ignoreNextSelection=!1,void 0;if(this.doc.selection.isNull())return this.$cursor.hide(),void 0;var t=window.getSelection(),e=this.doc.selection.range(),n=this.doc.getNodeFromPosition(e.start[0]),r=this.renderer.nodes[n.id],i=r.getDOMPosition(e.start[1]),o=this.doc.getNodeFromPosition(e.end[0]),s=this.renderer.nodes[o.id],a=s.getDOMPosition(e.end[1]),c=document.createRange();c.setStart(i.startContainer,i.startOffset),c.setEnd(a.endContainer,a.endOffset),t.removeAllRanges(),t.addRange(c)},this.build=function(){this.nodes=this.renderer.nodes},this.render=function(){var t=document.createElement("input");t.className="image-files",t.setAttribute("type","file"),t.setAttribute("name","files[]");var e=document.createElement("div");e.className="controls";var n=document.createElement("div");n.className="nodes";var r=document.createElement("div");return r.className="cursor",this.el.appendChild(t),this.el.appendChild(e),this.el.appendChild(n),this.el.appendChild(r),n.appendChild(this.renderer.render()),this.$("input.image-files").hide(),this.$cursor=this.$(".cursor"),this.$cursor.hide(),this._nodesEl=n,this},this.reset=function(){n.each(this.nodes,function(t){t.dispose()}),this.build(),this.render()},this.dispose=function(){this.stopListening(),n.each(this.nodes,function(t){t.dispose()},this)},this.onUpdateView=function(e,n){if(2===e.length&&"content"===e[0]&&"nodes"===e[1]){var r,i,o,s,a=this._nodesEl;if(n.isInsert()){if(r=n.val,i=this.doc.get(r),this.nodeTypes[i.type]){var c=this.renderer.createView(i);this.nodes[r]=c,s=c.render().el,t(a,n.pos,s)}}else if(n.isDelete())r=n.val,this.nodes[r]&&this.nodes[r].dispose(),delete this.nodes[r],o=a.children,a.removeChild(o[n.pos]);else if(n.isMove())o=a.children,s=o[n.pos],a.removeChild(s),t(a,n.target,s);else if("NOP"!==n.type)throw new Error("Illegal state.")}}},n.extend(s.Prototype,i.Events.Listener),s.Prototype.prototype=r.prototype,s.prototype=new s.Prototype,e.exports=s},{"substance-application":63,"substance-commander":93,"substance-util":219,underscore:225}],207:[function(t){"use strict";var e=t("substance-test"),n=e.assert,r=e.registerTest,i=t("./surface_test"),o="The quick brown fox jumps over the lazy dog.",s="Pack my box with five dozen liquor jugs",a="Fix problem quickly with galvanized jets",c="Heavy boxes perform quick waltzes and jigs",p=function(){i.call(this),this.fixture=function(){},this.actions=["Insert some text",function(){this.insertContent(o)},"Insert some more text",function(){this.insertContent(s),this.insertContent(a),this.insertContent(c)},"Set single cursor",function(){this.doc.selection.set({start:[1,2],end:[1,2]})},"Edge case: Select last char of text node",function(){this.doc.selection.set({start:[1,39],end:[1,39]})},"Insert period after last char",function(){this.doc.write(".");var t=this.doc.get("content").nodes[1],e=this.doc.get(t);n.isEqual(s+".",e.content)},"Make a selection",function(){this.doc.selection.set({start:[0,5],end:[1,10]})},"Delete selection",function(){this.doc.selection.set({start:[0,5],end:[1,10]}),this.doc.delete()},"Delete previous character for collapsed (single cursor) selection",function(){this.doc.selection.set([0,4]),this.doc.delete()},"Select last three chars of a textnode",function(){this.doc.selection.set({start:[0,31],end:[0,34]});var t=this.doc.get("text_1").content.substring(31,34),e=window.getSelection().toString();n.isEqual(t,e)},"Select last char in text node",function(){this.doc.selection.set({start:[0,33],end:[0,34]});var t=this.doc.get("text_1").content.substring(33,34),e=window.getSelection().toString();n.isEqual(t,e)},"Position cursor after last char and hit backspace",function(){this.doc.selection.set([0,34]),n.isTrue(window.getSelection().isCollapsed),this.doc.delete("left"),this.verifyTextNodeContent("text_1")}]};p.prototype=i.prototype,r(["Substance.Surface","Basic Editing"],new p)},{"./surface_test":209,"substance-test":210}],208:[function(t){"use strict";t("./basic_editing")},{"./basic_editing":207}],209:[function(t,e){"use strict";var n=t("../index"),r=t("substance-article"),i=t("substance-document").Controller,o=t("substance-test"),s=o.assert,a=1,c=function(){this.uuid=function(t){return t=t||"node_",t+a++},this.next_uuid=function(){return a},this.setup=function(){a=1,this.__document=new r({id:"surface_test"}),this.doc=new i(this.__document),this.surface=new n(this.doc),$(".test-center .test-output").show(),$(".test-center .test-output").html(this.surface.render().el)},this.insertContent=function(t){var e=this.uuid("text_");this.__document.create({id:e,type:"paragraph",content:t}),this.__document.show("content",[e],-1)},this.insertImage=function(t){var e=this.uuid("image_");this.__document.create({id:e,type:"image",content:" ",url:t}),this.__document.show("content",[e],-1)},this.verify=function(){console.log("verifying..")},this.verifySelection=function(){console.log("verifying selection..")},this.verifyTextNodeContent=function(t){var e=this.surface.el.querySelector("div#"+t),n=document.createRange();n.selectNode(e);var r=this.doc.get(t).content,i=n.toString();s.isEqual(r,i)}};e.exports=c},{"../index":205,"substance-article":71,"substance-document":133,"substance-test":210}],210:[function(t,e){"use strict";var n=t("./src/test");n.assert=t("./src/assert"),n.Runner=t("./src/controllers/test_runner"),n.MochaRunner=t("./src/controllers/mocha_test_runner"),n.TestCenter=t("./src/views/test_center"),n.TestReport=t("./src/views/test_report"),e.exports=n},{"./src/assert":211,"./src/controllers/mocha_test_runner":212,"./src/controllers/test_runner":213,"./src/test":214,"./src/views/test_center":215,"./src/views/test_report":216}],211:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util").errors,i={};i.AssertionError=r.define("AssertionError",-1);var o=function(t,e,n){if(!t){var r=new i.AssertionError(e);throw n&&n(e),r}};i.fail=function(t,e){var n=new i.AssertionError(t);throw e&&e(t),n},i.exception=function(t,e,r){1==arguments.length?(e=t,t=void 0,r=void 0):2==arguments.length&&(n.isFunction(arguments[1])||(r=e,e=t,t=void 0));var o,s=!1,a=t?!1:!0;try{e.call(r)}catch(c){o=c,s=!0,t&&o instanceof t&&(a=!0)}s&&a||(s&&(console.log(o.toString()),i.fail("Assertion failed. Caught exception of wrong type in "+e.toString())),i.fail("Assertion failed. Expected an exception in "+e.toString()))},i.equal=function(t,e,n){var r="Assertion failed. Expected="+t+", actual="+e;o(t===e,r,n)},i.isEqual=i.equal,i.isTrue=function(t,e){i.equal(!0,t,e)},i.isFalse=function(t,e){i.equal(!1,t,e)},i.isNull=function(t,e){i.equal(null,t,e)},i.notNull=function(t,e){o(null!==t,"Assertion failed. Actual value is null.",e)},i.isDefined=function(t,e){o(void 0!==t,"Assertion failed. Actual value is undefined.",e)},i.isUndefined=function(t,e){i.equal(void 0,t,e)},i.isArrayEqual=function(t,e){var n="Assertion failed. Expected="+JSON.stringify(t)+", actual="+JSON.stringify(e);if(t!==e){t&&e&&t.length===e.length||i.fail(n);for(var r=0;r<t.length;r++)t[r]!==e[r]&&i.fail(n)}},i.isDeepEqual=function(t,e){var r="Assertion failed. Expected="+JSON.stringify(t,null,2)+"\n, actual="+JSON.stringify(e,null,2);n.isEqual(t,e)||i.fail(r)},i.isObjectEqual=i.isDeepEqual,e.exports=i},{"substance-util":219,underscore:225}],212:[function(t,e){"use strict";var n=t("underscore");t("substance-util");var r=t("./test_runner"),i=function(){r.call(this);var t=function(t){describe(t.path.join("/"),function(){describe(t.name,function(){it("Setup",t.setup.bind(t));for(var e=0;e<t.actions.length;e++){var n=t.actions[e];it(n.label,n.func.bind(t))}})})};this.run=function(){n.each(this.tests,function(e){t(e)},this)}};e.exports=i},{"./test_runner":213,"substance-util":219,underscore:225}],213:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util"),i=t("../test"),o=function(t){function e(){return{label:"unknown",func:null}}function r(){i.push(o),o=e()}var i=[],o=null;return o=e(),n.each(t.actions,function(t){var e=Object.prototype.toString.call(t);"[object String]"===e?o.label=t:"[object Function]"===e?(o.func=t,r()):(t.func&&(o.func=t.func),t.label&&(o.label=t.label),r())}),i},s=function(){this.tests={},this.reports={};var t=function(t){var e=new i;return n.extend(e,t),e.name=n.last(t.path),e.path=t.path.slice(0,t.path.length-1),e.actions=o(t),e};this.loadTests=function(){n.each(i.testSpecs,function(e){var n=t(e);this.tests[n.id]=n},this)},this.getTestSuites=function(){var t={};return n.each(this.tests,function(e){var n=e.path[0];t[n]=t[n]||{name:n,tests:[]},t[n].tests.push(e)}),t},this.runSuite=function(t,e){var i=this,o=this.getTestSuites(),s=o[t];if(void 0===s)return e("Unknown testsuite: "+t);var a={name:t,tests:[]},c=n.map(s.tests,function(t){return function(e,n){t.run(function(e,r){a.tests.push({name:t.name,actions:r}),e&&(a.error=e),n(e)})}});r.async.sequential({functions:c,stopOnError:!1},function(n){i.reports[t]=a,i.trigger("report:ready",t,a),e(n,a)})},this.loadTests()};s.prototype=r.Events,e.exports=s},{"../test":214,"substance-util":219,underscore:225}],214:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util"),i=function(){};i.Prototype=function(){this.run=function(t){function e(t){try{console.log("## Setup"),0===s.setup.length?(s.setup(),t(null)):s.setup(t)}catch(e){console.log("Caught error during setup:",e),r.printStackTrace(e,1),t(e)}}function i(t){var e={items:s.actions,stopOnError:!1,iterator:function(t,e){var i={label:t.label,sourcecode:t.func.toString(),duration:0};try{if(0===t.func.length){var o=Date.now();t.func.call(s),i.duration=Date.now()-o,s.trigger("action:success",null,t),a.push(i),void 0!==s.delay?n.delay(e,s.delay,null):e(null)}else{var o=Date.now();t.func.call(s,function(c,p){i.duration=Date.now()-o,c?(console.error(c.toString()),r.printStackTrace(c),s.trigger("action:error",c,t),i.error=c):s.trigger("action:success",null,t),a.push(i),s.delay?n.delay(e,s.delay,c,p):e(c,p)})}}catch(c){console.error(c.name+":",c.message),r.printStackTrace(c),s.trigger("action:error",c,t),i.error=c,a.push(i),e(c)}}};r.async.each(e,t)}function o(t){console.log("# Finished Test: ",s.name),t(null)}var s=this,a=[];this.setDelay=function(t){this.delay=t},console.log("# Test:",s.path.join("/"),"/",s.name);var c={functions:[e,i,o],"finally":function(e){s.tearDown(),t(e,a)}};void 0===t&&(t=function(t){t&&console.log(t,a)}),r.async.sequential(c,t)},this.setup=function(){},this.tearDown=function(){}},i.prototype=n.extend(new i.Prototype,r.Events),i.testSpecs=i.testSpecs||{};var o=function(t){var e=t.join("_");return e=e.replace(/[:@/()]/g,"").replace(/\s/g,"_")};i.registerTest=function(t,e){var n=o(t);e.id=n,e.path=t,i.testSpecs[n]=e},e.exports=i},{"substance-util":219,underscore:225}],215:[function(t,e){"use strict";var n=t("substance-application"),r=t("substance-util"),i=t("./test_report"),o=n.View;r.html;var s=t("underscore"),a=n.$$,c=function(t){var e=document.createDocumentFragment(),n=a(".test-suites",{children:s.map(t.test_suites,function(t){return a("a.test-suite."+t.name,{"sbs-click":"showReport("+t.name+")",href:"#tests/"+t.name,text:t.name,children:[a(".status")]})})});return e.appendChild(n),e.appendChild(a(".test-report")),e.appendChild(a(".test-output")),e},p=function(t,e){o.call(this),this.testRunner=t,this.reports={},this.$el.addClass("test-center"),this.testSuites=this.testRunner.getTestSuites(),this.currentReport=e.report||s.pluck(this.testSuites,"name")[0],this.listenTo(this.testRunner,"report:ready",this.onReportReady)};p.Prototype=function(){this.showReport=function(t){var e=this.reports[t],n=this;e?(this.currentReport=e,this.reportView&&this.reportView.dispose(),this.reportView=new i(e),this.$(".test-report").html(this.reportView.render().el),this.$(".test-suite").removeClass("active"),this.$(".test-suite."+t).addClass("active")):(this.currentReport=t,n.testRunner.runSuite(t,function(t){t&&console.log(t.stack)}))},this.onReportReady=function(t,e){this.reports[t]=e,this.registerReport(e),this.currentReport===t&&this.showReport(t)},this.registerReport=function(t){this.$(".test-suite."+t.name+" .status").addClass(t.error?"error":"success")},this.render=function(){return this.el.appendChild(new c({test_suites:this.testSuites})),this},this.dispose=function(){this.stopListening()}},p.Prototype.prototype=o.prototype,p.prototype=new p.Prototype,e.exports=p},{"./test_report":216,"substance-application":63,"substance-util":219,underscore:225}],216:[function(t,e){"use strict";var n=t("substance-application"),r=t("substance-util"),i=n.View,o=t("substance-application");r.html;var s=t("underscore"),a=o.$$,c=function(t){function e(t){return s.map(t,function(t,e){var n=[];return t.error&&(n.push(a(".error-message",{text:t.error.message})),n.push(a(".error-source",{children:[a("pre",{text:t.sourcecode})]})),n.push(a(".stack-trace",{children:[a("pre",{text:t.error.stack})]}))),n.push(a(".duration",{text:t.duration+" ms"})),a("div.action."+(t.error?"error":"success"),{text:[e,t.label].join(" "),children:n})})}var n=a(".tests",{children:s.map(t.tests,function(t){return a(".test",{children:[a(".div.name",{text:t.name}),a(".actions",{children:e(t.actions)})]})})}),r=document.createDocumentFragment();return r.appendChild(a(".border-right")),r.appendChild(a("h2",{text:t.name})),r.appendChild(n),r},p=function(t){i.call(this),this.report=t};p.Prototype=function(){this.render=function(){return this.el.appendChild(new c(this.report)),this},this.dispose=function(){this.stopListening()}},p.Prototype.prototype=i.prototype,p.prototype=new p.Prototype,e.exports=p},{"substance-application":63,"substance-util":219,underscore:225}],217:[function(t,e){"use strict";var n=t("./toc_view");e.exports=n},{"./toc_view":218}],218:[function(t,e){"use strict";var n=t("substance-application").View,r=t("substance-application").$$,i=t("substance-data");i.Graph.Index;var o=t("underscore"),s=function(t){n.call(this),this.doc=t,this.headings=o.filter(this.doc.content.getNodes(),function(t){return"heading"===t.type}),this.$el.addClass("toc")};s.Prototype=function(){this.render=function(){return o.each(this.headings,function(t){this.el.appendChild(r("a.heading-ref.level-"+t.level,{id:"toc_"+t.id,text:t.content,"sbs-click":"jumpToNode("+t.id+")"}))},this),this},this.setActiveNode=function(t){this.$(".heading-ref.active").removeClass("active"),this.$("#toc_"+t).addClass("active")}},s.Prototype.prototype=n.prototype,s.prototype=new s.Prototype,e.exports=s},{"substance-application":63,"substance-data":119,underscore:225}],219:[function(t,e){"use strict";var n=t("./src/util");n.errors=t("./src/errors"),n.html=t("./src/html"),n.dom=t("./src/dom"),e.exports=n},{"./src/dom":220,"./src/errors":221,"./src/html":223,"./src/util":224}],220:[function(t,e){"use strict";var n=t("underscore"),r={};r.ChildNodeIterator=function(t){this.nodes=n.isArray(t)?t:t.childNodes,this.length=this.nodes.length,this.pos=-1},r.ChildNodeIterator.prototype={hasNext:function(){return this.pos<this.length-1},next:function(){return this.pos+=1,this.nodes[this.pos]},back:function(){return this.pos-=1,this}},r.getChildren=function(t){if(void 0!==t.children)return t.children;for(var e=[],n=t.firstElementChild;n;)e.push(n),n=n.nextElementSibling;return e},r.getNodeType=function(t){if(t.nodeType===Node.TEXT_NODE)return"text";if(t.nodeType===Node.COMMENT_NODE)return"comment";if(t.tagName)return t.tagName.toLowerCase();throw new Error("Unknown node type")},e.exports=r},{underscore:225}],221:[function(t,e){"use strict";t("underscore");var n=t("./util"),r={};r.SubstanceError=function(t,e,r){1==arguments.length&&(r=t,t="SubstanceError",e=-1),this.message=r,this.name=t,this.code=e,this.__stack=n.callstack(1)},r.SubstanceError.Prototype=function(){this.toString=function(){return this.name+":"+this.message},this.toJSON=function(){return{name:this.name,message:this.message,code:this.code,stack:this.stack}},this.printStackTrace=function(){n.printStackTrace(this)}},r.SubstanceError.prototype=new r.SubstanceError.Prototype,Object.defineProperty(r.SubstanceError.prototype,"stack",{get:function(){for(var t=[],e=0;e<this.__stack.length;e++){var n=this.__stack[e];t.push(n.file+":"+n.line+":"+n.col+" ("+n.func+")")}return t.join("\n")},set:function(){throw new Error("immutable.")}}),r.define=function(t,e){return void 0===e&&(e=-1),r[t]=r.SubstanceError.bind(null,t,e),r[t].prototype=r.SubstanceError.prototype,r[t]},e.exports=r},{"./util":224,underscore:225}],222:[function(t,e){var n=self,r={};r.readFile=function(e,r,i,o,s){3===arguments.length&&(o=i,i=void 0);var a=e+"/"+r;if(void 0===n.window){var c=t("fs");i.encoding?c.readFile(a,i.encoding,function(t,e){o.call(s,t,e)}):c.readFile(a,function(t,e){o.call(s,t,e)})}else{for(var p=[],u=a.split("/"),h=0;h<u.length;h++){var l=u[h];h>0&&""===l||(".."!==l?p.push(l):p.pop())}p=p.join("/"),$.get(p).done(function(t){o.call(s,null,t)}).fail(function(t){o.call(s,t)})}},e.exports=r},{fs:229}],223:[function(t,e){"use strict";var n={},r=t("underscore");n.templates={},n.renderTemplate=function(t,e){return n.templates[t](e)},"undefined"!=typeof window&&(window.console||(window.console={log:function(){}})),n.tpl=function(t,e){e=e||{};var n=$("script[name="+t+"]").html();return r.template(n,e)},e.exports=n},{underscore:225}],224:[function(t,e,n){"use strict";function r(t,e){function n(t){var e=a[c];if(!e)return u.length>0?r(new Error("Multiple errors occurred.",t)):r(null,t);var i=h(function(t,e){if(t){if(p)return r(t,null);u.push(t)}c+=1,n(e)});try{1===e.length?e(i):e(t,i)}catch(o){console.log("util.async caught error:",o),s.printStackTrace(o),r(o)}}var r=t.finally||function(t,n){e(t,n)};r=h(r);var i=t.data||{},a=t.functions;if(!o.isFunction(e))return e("Illegal arguments: a callback function must be provided");var c=0,p=void 0===t.stopOnError?!0:t.stopOnError,u=[];n(i)}function i(t){return function(e,n){function i(t,e){return function(n,r){2===h.length?h(t,r):3===h.length?h(t,e,r):h(t,e,n,r)}}function s(t,e){return function(n,r){2===h.length?h(t,r):3===h.length?h(t,e,r):h(t,e,n,r)}}var a=t.selector?t.selector(e):t.items,c=t.finally||function(t,e){n(t,e)};if(!a)return c(null,e);var p=o.isArray(a);t.before&&t.before(e);var u=[],h=t.iterator;if(p)for(var l=0;l<a.length;l++)u.push(i(a[l],l));else for(var d in a)u.push(s(a[d],d));var f={functions:u,data:e,"finally":c,stopOnError:t.stopOnError};r(f,n)}}var o=t("underscore"),s={};s.uuid=function(t,e){var n,r="0123456789abcdefghijklmnopqrstuvwxyz".split(""),i=[],o=16;if(e=e||32)for(n=0;e>n;n++)i[n]=r[0|Math.random()*o];else{var s;for(i[8]=i[13]=i[18]=i[23]="-",i[14]="4",n=0;36>n;n++)i[n]||(s=0|16*Math.random(),i[n]=r[19==n?8|3&s:s])}return(t?t:"")+i.join("")},s.uuidGen=function(t){var e=1;return t=void 0!==t?t:"uuid_",function(n){return n=n||t,n+e++}};var a=function(t,e){var n,r=-1,i=t.length,o=e[0],s=e[1],a=e[2];switch(e.length){case 0:for(;++r<i;)(n=t[r]).callback.call(n.ctx);return;case 1:for(;++r<i;)(n=t[r]).callback.call(n.ctx,o);return;case 2:for(;++r<i;)(n=t[r]).callback.call(n.ctx,o,s);return;case 3:for(;++r<i;)(n=t[r]).callback.call(n.ctx,o,s,a);return;default:for(;++r<i;)(n=t[r]).callback.apply(n.ctx,e)}},c=/\s+/,p=function(t,e,n,r){if(!n)return!0;if("object"==typeof n){for(var i in n)t[e].apply(t,[i,n[i]].concat(r));return!1}if(c.test(n)){for(var o=n.split(c),s=0,a=o.length;a>s;s++)t[e].apply(t,[o[s]].concat(r));return!1}return!0};s.Events={on:function(t,e,n){if(!p(this,"on",t,[e,n])||!e)return this;this._events=this._events||{};var r=this._events[t]||(this._events[t]=[]);return r.push({callback:e,context:n,ctx:n||this}),this},once:function(t,e,n){if(!p(this,"once",t,[e,n])||!e)return this;var r=this,i=o.once(function(){r.off(t,i),e.apply(this,arguments)});return i._callback=e,this.on(t,i,n)},off:function(t,e,n){var r,i,s,a,c,u,h,l;if(!this._events||!p(this,"off",t,[e,n]))return this;if(!t&&!e&&!n)return this._events={},this;for(a=t?[t]:o.keys(this._events),c=0,u=a.length;u>c;c++)if(t=a[c],s=this._events[t]){if(this._events[t]=r=[],e||n)for(h=0,l=s.length;l>h;h++)i=s[h],(e&&e!==i.callback&&e!==i.callback._callback||n&&n!==i.context)&&r.push(i);r.length||delete this._events[t]}return this},trigger:function(t){if(!this._events)return this;var e=Array.prototype.slice.call(arguments,1);if(!p(this,"trigger",t,e))return this;var n=this._events[t],r=this._events.all;return n&&a(n,e),r&&a(r,arguments),this},triggerLater:function(){var t=this,e=arguments;setTimeout(function(){t.trigger.apply(t,e)},0)},stopListening:function(t,e,n){var r=this._listeners;if(!r)return this;var i=!e&&!n;"object"==typeof e&&(n=this),t&&((r={})[t._listenerId]=t);for(var o in r)r[o].off(e,n,this),i&&delete this._listeners[o];return this}};var u={listenTo:"on",listenToOnce:"once"};o.each(u,function(t,e){s.Events[e]=function(e,n,r){var i=this._listeners||(this._listeners={}),s=e._listenerId||(e._listenerId=o.uniqueId("l"));return i[s]=e,"object"==typeof n&&(r=this),e[t](n,r,this),this}}),s.Events.bind=s.Events.on,s.Events.unbind=s.Events.off,s.Events.Listener={listenTo:function(t,e,n){if(!o.isFunction(n))throw new Error("Illegal argument: expecting function as callback, was: "+n);return this._handlers=this._handlers||[],t.on(e,n,this),this._handlers.push({unbind:function(){t.off(e,n)}}),this},stopListening:function(){for(var t=0;t<this._handlers.length;t++)this._handlers[t].unbind()}};var h=o.once;s.async={},s.async.sequential=function(t,e){o.isArray(t)&&(t={functions:t}),r(t,e)},s.async.iterator=function(t,e){var n;return n=1==arguments.length?t:{items:t,iterator:e},i(n)},s.async.each=function(t,e){var n=i(t);n(null,e)},s.propagate=function(t,e){if(!o.isFunction(e))throw"Illegal argument: provided callback is not a function";return function(n){return n?e(n):(e(null,t),void 0)}};var l=function(){};s.inherits=function(t,e,n){var r;return r=e&&e.hasOwnProperty("constructor")?e.constructor:function(){t.apply(this,arguments)},o.extend(r,t),l.prototype=t.prototype,r.prototype=new l,e&&o.extend(r.prototype,e),n&&o.extend(r,n),r.prototype.constructor=r,r.__super__=t.prototype,r},s.getJSON=function(e,r){if("undefined"!=typeof n){var i=t("fs"),o=JSON.parse(i.readFileSync(e,"utf8"));r(null,o)}else $.getJSON(e).done(function(t){r(null,t)}).error(function(t){r(t,null)})},s.prototype=function(t){return Object.getPrototypeOf?Object.getPrototypeOf(t):t.__proto__},s.inherit=function(t,e){var n,r=o.isFunction(t)?new t:t;if(o.isFunction(e))e.prototype=r,n=new e;else{var i=function(){};i.prototype=r,n=o.extend(new i,e)}return n},s.pimpl=function(t){var e=function(t){this.self=t};return e.prototype=t,function(t){return t=t||this,new e(t)}},s.parseStackTrace=function(t){var e,n=/([^@]*)@(.*):(\d+)/,r=/\s*at ([^(]*)[(](.*):(\d+):(\d+)[)]/,i=t.stack.split("\n"),o=[];for(e=0;e<i.length;e++){var s=n.exec(i[e]);if(s||(s=r.exec(i[e])),s){var a={func:s[1],file:s[2],line:s[3],col:s[4]||0};""===a.func&&(a.func="<anonymous>"),o.push(a)}}return o},s.callstack=function(t){var e;try{throw new Error}catch(n){e=n}var r=s.parseStackTrace(e);return t=t||0,r.splice(t+1)},s.stacktrace=function(t){var e=0===arguments.length?s.callstack().splice(1):s.parseStackTrace(t),n=[];return o.each(e,function(t){n.push(t.file+":"+t.line+":"+t.col+" ("+t.func+")")}),n.join("\n")},s.printStackTrace=function(t,e){if(t.stack){var n;if(void 0!==t.__stack)n=t.__stack;else{if(!o.isString(t.stack))return;n=s.parseStackTrace(t)}e=e||n.length,e=Math.min(e,n.length);for(var r=0;e>r;r++){var i=n[r];console.log(i.file+":"+i.line+":"+i.col,"("+i.func+")")}}},s.diff=function(t,e){var n;return o.isArray(t)&&o.isArray(e)?(n=o.difference(e,t),0===n.length?null:n):o.isObject(t)&&o.isObject(e)?(n={},o.each(Object.keys(e),function(r){var i=s.diff(t[r],e[r]);i&&(n[r]=i)}),o.isEmpty(n)?null:n):t!==e?e:void 0},s.deepclone=function(t){return JSON.parse(JSON.stringify(t))},s.clone=function(t){return null===t||void 0===t?t:o.isFunction(t.clone)?t.clone():s.deepclone(t)},s.freeze=function(t){var e;if(o.isObject(t)){if(Object.isFrozen(t))return t;var n=Object.keys(t);for(e=0;e<n.length;e++){var r=n[e];t[r]=s.freeze(t[r])}return Object.freeze(t)}if(o.isArray(t)){var i=t;for(e=0;e<i.length;e++)i[e]=s.freeze(i[e]);return Object.freeze(i)}return t},s.later=function(t,e){return function(){var n=arguments;setTimeout(function(){t.apply(e,n)},0)}},s.isEmpty=function(t){return!t.match(/\w/)},e.exports=s},{fs:229,underscore:225}],225:[function(t,e,n){(function(){var t=this,r=t._,i={},o=Array.prototype,s=Object.prototype,a=Function.prototype,c=o.push,p=o.slice,u=o.concat,h=s.toString,l=s.hasOwnProperty,d=o.forEach,f=o.map,g=o.reduce,y=o.reduceRight,m=o.filter,v=o.every,b=o.some,S=o.indexOf,w=o.lastIndexOf,_=Array.isArray,x=Object.keys,E=a.bind,C=function(t){return t instanceof C?t:this instanceof C?(this._wrapped=t,void 0):new C(t)};"undefined"!=typeof n?("undefined"!=typeof e&&e.exports&&(n=e.exports=C),n._=C):t._=C,C.VERSION="1.5.2";var P=C.each=C.forEach=function(t,e,n){if(null!=t)if(d&&t.forEach===d)t.forEach(e,n);else if(t.length===+t.length){for(var r=0,o=t.length;o>r;r++)if(e.call(n,t[r],r,t)===i)return}else for(var s=C.keys(t),r=0,o=s.length;o>r;r++)if(e.call(n,t[s[r]],s[r],t)===i)return};C.map=C.collect=function(t,e,n){var r=[];return null==t?r:f&&t.map===f?t.map(e,n):(P(t,function(t,i,o){r.push(e.call(n,t,i,o))}),r)};var k="Reduce of empty array with no initial value";C.reduce=C.foldl=C.inject=function(t,e,n,r){var i=arguments.length>2;if(null==t&&(t=[]),g&&t.reduce===g)return r&&(e=C.bind(e,r)),i?t.reduce(e,n):t.reduce(e);if(P(t,function(t,o,s){i?n=e.call(r,n,t,o,s):(n=t,i=!0)}),!i)throw new TypeError(k);return n},C.reduceRight=C.foldr=function(t,e,n,r){var i=arguments.length>2;if(null==t&&(t=[]),y&&t.reduceRight===y)return r&&(e=C.bind(e,r)),i?t.reduceRight(e,n):t.reduceRight(e);var o=t.length;if(o!==+o){var s=C.keys(t);o=s.length}if(P(t,function(a,c,p){c=s?s[--o]:--o,i?n=e.call(r,n,t[c],c,p):(n=t[c],i=!0)}),!i)throw new TypeError(k);return n},C.find=C.detect=function(t,e,n){var r;return O(t,function(t,i,o){return e.call(n,t,i,o)?(r=t,!0):void 0}),r},C.filter=C.select=function(t,e,n){var r=[];return null==t?r:m&&t.filter===m?t.filter(e,n):(P(t,function(t,i,o){e.call(n,t,i,o)&&r.push(t)}),r)},C.reject=function(t,e,n){return C.filter(t,function(t,r,i){return!e.call(n,t,r,i)},n)
},C.every=C.all=function(t,e,n){e||(e=C.identity);var r=!0;return null==t?r:v&&t.every===v?t.every(e,n):(P(t,function(t,o,s){return(r=r&&e.call(n,t,o,s))?void 0:i}),!!r)};var O=C.some=C.any=function(t,e,n){e||(e=C.identity);var r=!1;return null==t?r:b&&t.some===b?t.some(e,n):(P(t,function(t,o,s){return r||(r=e.call(n,t,o,s))?i:void 0}),!!r)};C.contains=C.include=function(t,e){return null==t?!1:S&&t.indexOf===S?-1!=t.indexOf(e):O(t,function(t){return t===e})},C.invoke=function(t,e){var n=p.call(arguments,2),r=C.isFunction(e);return C.map(t,function(t){return(r?e:t[e]).apply(t,n)})},C.pluck=function(t,e){return C.map(t,function(t){return t[e]})},C.where=function(t,e,n){return C.isEmpty(e)?n?void 0:[]:C[n?"find":"filter"](t,function(t){for(var n in e)if(e[n]!==t[n])return!1;return!0})},C.findWhere=function(t,e){return C.where(t,e,!0)},C.max=function(t,e,n){if(!e&&C.isArray(t)&&t[0]===+t[0]&&t.length<65535)return Math.max.apply(Math,t);if(!e&&C.isEmpty(t))return-1/0;var r={computed:-1/0,value:-1/0};return P(t,function(t,i,o){var s=e?e.call(n,t,i,o):t;s>r.computed&&(r={value:t,computed:s})}),r.value},C.min=function(t,e,n){if(!e&&C.isArray(t)&&t[0]===+t[0]&&t.length<65535)return Math.min.apply(Math,t);if(!e&&C.isEmpty(t))return 1/0;var r={computed:1/0,value:1/0};return P(t,function(t,i,o){var s=e?e.call(n,t,i,o):t;s<r.computed&&(r={value:t,computed:s})}),r.value},C.shuffle=function(t){var e,n=0,r=[];return P(t,function(t){e=C.random(n++),r[n-1]=r[e],r[e]=t}),r},C.sample=function(t,e,n){return arguments.length<2||n?t[C.random(t.length-1)]:C.shuffle(t).slice(0,Math.max(0,e))};var T=function(t){return C.isFunction(t)?t:function(e){return e[t]}};C.sortBy=function(t,e,n){var r=T(e);return C.pluck(C.map(t,function(t,e,i){return{value:t,index:e,criteria:r.call(n,t,e,i)}}).sort(function(t,e){var n=t.criteria,r=e.criteria;if(n!==r){if(n>r||void 0===n)return 1;if(r>n||void 0===r)return-1}return t.index-e.index}),"value")};var q=function(t){return function(e,n,r){var i={},o=null==n?C.identity:T(n);return P(e,function(n,s){var a=o.call(r,n,s,e);t(i,a,n)}),i}};C.groupBy=q(function(t,e,n){(C.has(t,e)?t[e]:t[e]=[]).push(n)}),C.indexBy=q(function(t,e,n){t[e]=n}),C.countBy=q(function(t,e){C.has(t,e)?t[e]++:t[e]=1}),C.sortedIndex=function(t,e,n,r){n=null==n?C.identity:T(n);for(var i=n.call(r,e),o=0,s=t.length;s>o;){var a=o+s>>>1;n.call(r,t[a])<i?o=a+1:s=a}return o},C.toArray=function(t){return t?C.isArray(t)?p.call(t):t.length===+t.length?C.map(t,C.identity):C.values(t):[]},C.size=function(t){return null==t?0:t.length===+t.length?t.length:C.keys(t).length},C.first=C.head=C.take=function(t,e,n){return null==t?void 0:null==e||n?t[0]:p.call(t,0,e)},C.initial=function(t,e,n){return p.call(t,0,t.length-(null==e||n?1:e))},C.last=function(t,e,n){return null==t?void 0:null==e||n?t[t.length-1]:p.call(t,Math.max(t.length-e,0))},C.rest=C.tail=C.drop=function(t,e,n){return p.call(t,null==e||n?1:e)},C.compact=function(t){return C.filter(t,C.identity)};var I=function(t,e,n){return e&&C.every(t,C.isArray)?u.apply(n,t):(P(t,function(t){C.isArray(t)||C.isArguments(t)?e?c.apply(n,t):I(t,e,n):n.push(t)}),n)};C.flatten=function(t,e){return I(t,e,[])},C.without=function(t){return C.difference(t,p.call(arguments,1))},C.uniq=C.unique=function(t,e,n,r){C.isFunction(e)&&(r=n,n=e,e=!1);var i=n?C.map(t,n,r):t,o=[],s=[];return P(i,function(n,r){(e?r&&s[s.length-1]===n:C.contains(s,n))||(s.push(n),o.push(t[r]))}),o},C.union=function(){return C.uniq(C.flatten(arguments,!0))},C.intersection=function(t){var e=p.call(arguments,1);return C.filter(C.uniq(t),function(t){return C.every(e,function(e){return C.indexOf(e,t)>=0})})},C.difference=function(t){var e=u.apply(o,p.call(arguments,1));return C.filter(t,function(t){return!C.contains(e,t)})},C.zip=function(){for(var t=C.max(C.pluck(arguments,"length").concat(0)),e=new Array(t),n=0;t>n;n++)e[n]=C.pluck(arguments,""+n);return e},C.object=function(t,e){if(null==t)return{};for(var n={},r=0,i=t.length;i>r;r++)e?n[t[r]]=e[r]:n[t[r][0]]=t[r][1];return n},C.indexOf=function(t,e,n){if(null==t)return-1;var r=0,i=t.length;if(n){if("number"!=typeof n)return r=C.sortedIndex(t,e),t[r]===e?r:-1;r=0>n?Math.max(0,i+n):n}if(S&&t.indexOf===S)return t.indexOf(e,n);for(;i>r;r++)if(t[r]===e)return r;return-1},C.lastIndexOf=function(t,e,n){if(null==t)return-1;var r=null!=n;if(w&&t.lastIndexOf===w)return r?t.lastIndexOf(e,n):t.lastIndexOf(e);for(var i=r?n:t.length;i--;)if(t[i]===e)return i;return-1},C.range=function(t,e,n){arguments.length<=1&&(e=t||0,t=0),n=arguments[2]||1;for(var r=Math.max(Math.ceil((e-t)/n),0),i=0,o=new Array(r);r>i;)o[i++]=t,t+=n;return o};var N=function(){};C.bind=function(t,e){var n,r;if(E&&t.bind===E)return E.apply(t,p.call(arguments,1));if(!C.isFunction(t))throw new TypeError;return n=p.call(arguments,2),r=function(){if(!(this instanceof r))return t.apply(e,n.concat(p.call(arguments)));N.prototype=t.prototype;var i=new N;N.prototype=null;var o=t.apply(i,n.concat(p.call(arguments)));return Object(o)===o?o:i}},C.partial=function(t){var e=p.call(arguments,1);return function(){return t.apply(this,e.concat(p.call(arguments)))}},C.bindAll=function(t){var e=p.call(arguments,1);if(0===e.length)throw new Error("bindAll must be passed function names");return P(e,function(e){t[e]=C.bind(t[e],t)}),t},C.memoize=function(t,e){var n={};return e||(e=C.identity),function(){var r=e.apply(this,arguments);return C.has(n,r)?n[r]:n[r]=t.apply(this,arguments)}},C.delay=function(t,e){var n=p.call(arguments,2);return setTimeout(function(){return t.apply(null,n)},e)},C.defer=function(t){return C.delay.apply(C,[t,1].concat(p.call(arguments,1)))},C.throttle=function(t,e,n){var r,i,o,s=null,a=0;n||(n={});var c=function(){a=n.leading===!1?0:new Date,s=null,o=t.apply(r,i)};return function(){var p=new Date;a||n.leading!==!1||(a=p);var u=e-(p-a);return r=this,i=arguments,0>=u?(clearTimeout(s),s=null,a=p,o=t.apply(r,i)):s||n.trailing===!1||(s=setTimeout(c,u)),o}},C.debounce=function(t,e,n){var r,i,o,s,a;return function(){o=this,i=arguments,s=new Date;var c=function(){var p=new Date-s;e>p?r=setTimeout(c,e-p):(r=null,n||(a=t.apply(o,i)))},p=n&&!r;return r||(r=setTimeout(c,e)),p&&(a=t.apply(o,i)),a}},C.once=function(t){var e,n=!1;return function(){return n?e:(n=!0,e=t.apply(this,arguments),t=null,e)}},C.wrap=function(t,e){return function(){var n=[t];return c.apply(n,arguments),e.apply(this,n)}},C.compose=function(){var t=arguments;return function(){for(var e=arguments,n=t.length-1;n>=0;n--)e=[t[n].apply(this,e)];return e[0]}},C.after=function(t,e){return function(){return--t<1?e.apply(this,arguments):void 0}},C.keys=x||function(t){if(t!==Object(t))throw new TypeError("Invalid object");var e=[];for(var n in t)C.has(t,n)&&e.push(n);return e},C.values=function(t){for(var e=C.keys(t),n=e.length,r=new Array(n),i=0;n>i;i++)r[i]=t[e[i]];return r},C.pairs=function(t){for(var e=C.keys(t),n=e.length,r=new Array(n),i=0;n>i;i++)r[i]=[e[i],t[e[i]]];return r},C.invert=function(t){for(var e={},n=C.keys(t),r=0,i=n.length;i>r;r++)e[t[n[r]]]=n[r];return e},C.functions=C.methods=function(t){var e=[];for(var n in t)C.isFunction(t[n])&&e.push(n);return e.sort()},C.extend=function(t){return P(p.call(arguments,1),function(e){if(e)for(var n in e)t[n]=e[n]}),t},C.pick=function(t){var e={},n=u.apply(o,p.call(arguments,1));return P(n,function(n){n in t&&(e[n]=t[n])}),e},C.omit=function(t){var e={},n=u.apply(o,p.call(arguments,1));for(var r in t)C.contains(n,r)||(e[r]=t[r]);return e},C.defaults=function(t){return P(p.call(arguments,1),function(e){if(e)for(var n in e)void 0===t[n]&&(t[n]=e[n])}),t},C.clone=function(t){return C.isObject(t)?C.isArray(t)?t.slice():C.extend({},t):t},C.tap=function(t,e){return e(t),t};var A=function(t,e,n,r){if(t===e)return 0!==t||1/t==1/e;if(null==t||null==e)return t===e;t instanceof C&&(t=t._wrapped),e instanceof C&&(e=e._wrapped);var i=h.call(t);if(i!=h.call(e))return!1;switch(i){case"[object String]":return t==String(e);case"[object Number]":return t!=+t?e!=+e:0==t?1/t==1/e:t==+e;case"[object Date]":case"[object Boolean]":return+t==+e;case"[object RegExp]":return t.source==e.source&&t.global==e.global&&t.multiline==e.multiline&&t.ignoreCase==e.ignoreCase}if("object"!=typeof t||"object"!=typeof e)return!1;for(var o=n.length;o--;)if(n[o]==t)return r[o]==e;var s=t.constructor,a=e.constructor;if(s!==a&&!(C.isFunction(s)&&s instanceof s&&C.isFunction(a)&&a instanceof a))return!1;n.push(t),r.push(e);var c=0,p=!0;if("[object Array]"==i){if(c=t.length,p=c==e.length)for(;c--&&(p=A(t[c],e[c],n,r)););}else{for(var u in t)if(C.has(t,u)&&(c++,!(p=C.has(e,u)&&A(t[u],e[u],n,r))))break;if(p){for(u in e)if(C.has(e,u)&&!c--)break;p=!c}}return n.pop(),r.pop(),p};C.isEqual=function(t,e){return A(t,e,[],[])},C.isEmpty=function(t){if(null==t)return!0;if(C.isArray(t)||C.isString(t))return 0===t.length;for(var e in t)if(C.has(t,e))return!1;return!0},C.isElement=function(t){return!(!t||1!==t.nodeType)},C.isArray=_||function(t){return"[object Array]"==h.call(t)},C.isObject=function(t){return t===Object(t)},P(["Arguments","Function","String","Number","Date","RegExp"],function(t){C["is"+t]=function(e){return h.call(e)=="[object "+t+"]"}}),C.isArguments(arguments)||(C.isArguments=function(t){return!(!t||!C.has(t,"callee"))}),"function"!=typeof/./&&(C.isFunction=function(t){return"function"==typeof t}),C.isFinite=function(t){return isFinite(t)&&!isNaN(parseFloat(t))},C.isNaN=function(t){return C.isNumber(t)&&t!=+t},C.isBoolean=function(t){return t===!0||t===!1||"[object Boolean]"==h.call(t)},C.isNull=function(t){return null===t},C.isUndefined=function(t){return void 0===t},C.has=function(t,e){return l.call(t,e)},C.noConflict=function(){return t._=r,this},C.identity=function(t){return t},C.times=function(t,e,n){for(var r=Array(Math.max(0,t)),i=0;t>i;i++)r[i]=e.call(n,i);return r},C.random=function(t,e){return null==e&&(e=t,t=0),t+Math.floor(Math.random()*(e-t+1))};var D={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"}};D.unescape=C.invert(D.escape);var j={escape:new RegExp("["+C.keys(D.escape).join("")+"]","g"),unescape:new RegExp("("+C.keys(D.unescape).join("|")+")","g")};C.each(["escape","unescape"],function(t){C[t]=function(e){return null==e?"":(""+e).replace(j[t],function(e){return D[t][e]})}}),C.result=function(t,e){if(null==t)return void 0;var n=t[e];return C.isFunction(n)?n.call(t):n},C.mixin=function(t){P(C.functions(t),function(e){var n=C[e]=t[e];C.prototype[e]=function(){var t=[this._wrapped];return c.apply(t,arguments),$.call(this,n.apply(C,t))}})};var M=0;C.uniqueId=function(t){var e=++M+"";return t?t+e:e},C.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var R=/(.)^/,L={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},V=/\\|'|\r|\n|\t|\u2028|\u2029/g;C.template=function(t,e,n){var r;n=C.defaults({},n,C.templateSettings);var i=new RegExp([(n.escape||R).source,(n.interpolate||R).source,(n.evaluate||R).source].join("|")+"|$","g"),o=0,s="__p+='";t.replace(i,function(e,n,r,i,a){return s+=t.slice(o,a).replace(V,function(t){return"\\"+L[t]}),n&&(s+="'+\n((__t=("+n+"))==null?'':_.escape(__t))+\n'"),r&&(s+="'+\n((__t=("+r+"))==null?'':__t)+\n'"),i&&(s+="';\n"+i+"\n__p+='"),o=a+e.length,e}),s+="';\n",n.variable||(s="with(obj||{}){\n"+s+"}\n"),s="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+s+"return __p;\n";try{r=new Function(n.variable||"obj","_",s)}catch(a){throw a.source=s,a}if(e)return r(e,C);var c=function(t){return r.call(this,t,C)};return c.source="function("+(n.variable||"obj")+"){\n"+s+"}",c},C.chain=function(t){return C(t).chain()};var $=function(t){return this._chain?C(t).chain():t};C.mixin(C),P(["pop","push","reverse","shift","sort","splice","unshift"],function(t){var e=o[t];C.prototype[t]=function(){var n=this._wrapped;return e.apply(n,arguments),"shift"!=t&&"splice"!=t||0!==n.length||delete n[0],$.call(this,n)}}),P(["concat","join","slice"],function(t){var e=o[t];C.prototype[t]=function(){return $.call(this,e.apply(this._wrapped,arguments))}}),C.extend(C.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}})}).call(this)},{}],226:[function(t,e){"use strict";t("underscore");var n=t("substance-application"),r=t("./lens_controller");t("substance-commander").Keyboard;var i=t("substance-util");i.html;var o=t("../config/config.json"),s=function(e){e=e||o,e.routes=t("../config/routes.json"),n.call(this,e),this.controller=new r(e)};s.Article=t("lens-article"),s.Reader=t("lens-reader"),s.Outline=t("lens-outline"),s.Prototype=function(){this.render=function(){this.view=this.controller.createView(),this.$el.html(this.view.render().el)}},s.Prototype.prototype=n.prototype,s.prototype=new s.Prototype,s.prototype.constructor=s;var a={util:t("substance-util"),Test:t("substance-test"),Application:t("substance-application"),Commander:t("substance-commander"),Document:t("substance-document"),Operator:t("substance-operator"),Chronicle:t("substance-chronicle"),Data:t("substance-data"),RegExp:t("substance-regexp"),Surface:t("substance-surface")};t("lens-converter/tests"),t("substance-application/tests"),t("substance-converter/tests"),t("substance-operator/tests"),t("substance-chronicle/tests"),t("substance-data/tests"),t("substance-document/tests"),t("substance-store/tests"),t("substance-surface/tests"),s.Substance=a,e.exports=s},{"../config/config.json":2,"../config/routes.json":3,"./lens_controller":227,"lens-article":5,"lens-converter/tests":57,"lens-outline":58,"lens-reader":60,"substance-application":63,"substance-application/tests":70,"substance-chronicle":76,"substance-chronicle/tests":92,"substance-commander":93,"substance-converter/tests":116,"substance-data":119,"substance-data/tests":131,"substance-document":133,"substance-document/tests":147,"substance-operator":184,"substance-operator/tests":194,"substance-regexp":195,"substance-store/tests":201,"substance-surface":205,"substance-surface/tests":208,"substance-test":210,"substance-util":219,underscore:225}],227:[function(t,e){"use strict";var n=t("underscore"),r=t("substance-util"),i=t("substance-application").Controller,o=t("./lens_view"),s=t("substance-test"),a=t("substance-library"),c=a.Controller,p=t("lens-article"),u=t("substance-article"),h=t("lens-reader").Controller,l=t("lens-converter"),d=function(t){i.call(this),this.config=t,this.on("open:reader",this.openReader),this.on("open:library",this.openLibrary),this.on("open:login",this.openLogin),this.on("open:test_center",this.openTestCenter)};d.Prototype=function(){this.createView=function(){var t=new o(this);return this.view=t,t},this.storeXML=function(t){var e=new l.Importer,n=e.import(t);n.id="last";try{localStorage.setItem("localdoc",JSON.stringify(n))}catch(r){console.log(r)}app.router.navigate("/mydocs",!0),app.router.navigate("/mydocs/last",!0)},this.populateLibWithLocalDocs=function(t){var e=null;try{e=JSON.parse(localStorage.getItem("localdoc"))}catch(r){console.log(r)}if(e){e.nodes.document.guid,t.nodes.mydocs.records=["last"];var i={id:"last",type:"record",title:e.nodes.document.title,authors:[],url:"localstore://last"};n.each(e.nodes.document.authors,function(t){i.authors.push(e.nodes[t].name)}),t.nodes.last=i}return t},this.loadLibrary=function(t,e){var n=this;return this.__library?e(null):($.getJSON(t,function(r){t.match(/lens_library\.json/)&&(r=n.populateLibWithLocalDocs(r)),n.__library=new a({seed:r}),e(null)}).error(e),void 0)},this.updatePath=function(t){var e=[this.state.collection,this.state.document];e.push(t.context),t.node?e.push(t.node):e.push("all"),t.resource&&e.push(t.resource),t.fullscreen&&e.push("fullscreen"),window.app.router.navigate(e.join("/"),{trigger:!1,replace:!1})};var t=new RegExp("^localstore://(.*)"),e=function(e,n){var r=this,i=function(t,n){if(t)throw console.log(t.stack),t;r.reader=new h(n,e),r.reader.on("state-changed",function(){r.updatePath(r.reader.state)}),r.modifyState({context:"reader"})},o=this.__library.get(n),s=t.exec(o.url);if(s){s[1];var a=JSON.parse(localStorage.getItem("localdoc")),c=p.fromSnapshot(a,{});i(null,c)}else $.get(o.url).done(function(t){var e,r,o=$.isXMLDoc(t);if(o){var s=new l.Importer;e=s.import(t),e.id=n,console.log("ON THE FLY CONVERTED DOC",e.toJSON())}else"string"==typeof t&&(t=$.parseJSON(t)),e=t.schema&&"lens-article"===t.schema[0]?p.fromSnapshot(t):u.fromSnapshot(t);i(r,e)}).fail(function(t){console.error(t)})};this.openReader=function(t,n,r,i,o,s){var a={context:r||"toc",node:i,resource:o,fullscreen:!!s};return this.state={collection:t,document:n},"lens"===t&&"lens_article"===n?this.openLensArticle(a):(this.loadLibrary(this.config.library_url,e.bind(this,a,n)),void 0)},this.openAbout=function(){this.openReader("lens","about","toc"),app.router.navigate("lens/about",!1)},this.openLensArticle=function(t){var e=this,n=p.describe();this.reader=new h(n,t),e.reader.on("state-changed",function(){e.updatePath(e.reader.state)}),this.modifyState({context:"reader"}),this.state={collection:"lens",document:"lens_article"}},this.openLibrary=function(t){function e(){var e={collection:t||n.__library.collections[0].id};n.library=new c(n.__library,e),n.modifyState({context:"library"})}var n=this;this.loadLibrary(this.config.library_url,e)},this.openTestCenter=function(t){this.testRunner=new s.Runner,this.modifyState({context:"test_center",report:t}),this.runSuite(t)},this.getActiveControllers=function(){var t=[["sandbox",this]],e=this.state.context;return"article"===e?t=t.concat(this.article.getActiveControllers()):"library"===e?t=t.concat(["library",this.library]):"test_center"===e&&t.push(["test_center",this.testRunner]),t},this.runSuite=function(t,e){return e=e||function(t){t&&console.log("ERROR",t)},t?(this.testRunner.runSuite(t,e),void 0):this.runAllSuites(e)},this.runAllSuites=function(t){var e=this.testRunner.getTestSuites(),i=this.testRunner,o=n.map(e,function(t,e){return function(t,n){i.runSuite(e,n)}});r.async.sequential({functions:o,stopOnError:!1},t)}},d.Prototype.prototype=i.prototype,d.prototype=new d.Prototype,n.extend(d.prototype,r.Events),e.exports=d},{"./lens_view":228,"lens-article":5,"lens-converter":50,"lens-reader":60,"substance-application":63,"substance-article":71,"substance-library":150,"substance-test":210,"substance-util":219,underscore:225}],228:[function(t,e){"use strict";t("underscore");var n=t("substance-util"),r=n.html,i=t("substance-application").View,o=t("substance-test").TestCenter,s=function(t){i.call(this),this.controller=t,this.$el.attr({id:"container"}),this.listenTo(this.controller,"context-changed",this.onContextChanged),$(document).on("dragover",function(){return!1}),$(document).on("ondragend",function(){return!1}),$(document).on("drop",this.handleDroppedFile.bind(this))};s.Prototype=function(){this.handleDroppedFile=function(){var t=this.controller,e=event.dataTransfer.files,n=e[0],r=new FileReader;return r.onload=function(e){t.storeXML(e.target.result)},r.readAsText(n),!1},this.onContextChanged=function(t){"reader"===t?this.openReader():"library"===t?this.openLibrary():"test_center"===t?this.openTestCenter():console.log("Unknown application state: "+t),this.updateMenu()},this.updateMenu=function(){var t=window.location.hash;this.$(".toggle-view").removeClass("active"),t.match(/#examples/)?this.$(".toggle-view.examples").addClass("active"):t.match(/lens_article/)?this.$(".toggle-view.lens-article").addClass("active"):t.match(/manual/)?this.$(".toggle-view.manual").addClass("active"):t.match(/tests/)?this.$(".toggle-view.tests").addClass("active"):this.$(".toggle-view.about").addClass("active")},this.convertDocument=function(){console.log("converting..")},this.openLibrary=function(){var t=this.controller.library.createView();this.replaceMainView("library",t)},this.openReader=function(){var t=this.controller.reader.createView();this.replaceMainView("reader",t)},this.openTestCenter=function(){var t=new o(this.controller.testRunner,this.controller.state);this.replaceMainView("test_center",t)},this.replaceMainView=function(t,e){$("body").removeClass().addClass("current-view "+t),this.mainView=e,this.$("#main").html(e.render().el)},this.render=function(){return this.$el.html(r.tpl("lens",this.controller.session)),this},this.dispose=function(){this.stopListening(),this.mainView&&this.mainView.dispose()}},s.Prototype.prototype=i.prototype,s.prototype=new s.Prototype,e.exports=s},{"substance-application":63,"substance-test":210,"substance-util":219,underscore:225}],229:[function(){},{}]},{},[1]);